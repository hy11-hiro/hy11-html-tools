<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>現場用AR黒板カメラ</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kosugi+Maru&family=M+PLUS+Rounded+1c:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'M PLUS Rounded 1c', sans-serif;
            background-color: #000;
            color: white;
            overflow: hidden; 
            touch-action: manipulation;
        }
        #cameraVideo {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 1;
        }
        #overlayCanvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; pointer-events: none;
        }
        #uiLayer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none;
            display: flex; flex-direction: column; justify-content: space-between;
        }
        .interactive { pointer-events: auto; }
        .panel-bg { background-color: rgba(0, 0, 0, 0.6); backdrop-filter: blur(4px); }
    </style>
</head>
<body>
    <video id="cameraVideo" autoplay playsinline muted></video>
    <canvas id="overlayCanvas"></canvas>
    <div id="uiLayer">
        <div class="p-4 panel-bg interactive flex justify-between items-start" id="topBar">
            <div class="flex flex-col gap-2 w-full">
                <div class="flex justify-between items-center">
                    <h1 class="font-bold text-lg flex items-center gap-2"><span class="material-icons text-green-400">view_in_ar</span> 現場カメラ</h1>
                    <button onclick="toggleSettings()" class="p-2 bg-gray-700 rounded-full border border-gray-500"><span class="material-icons text-white">settings</span></button>
                </div>
                <div id="settingsPanel" class="hidden mt-2 space-y-3 text-sm">
                    <div class="grid grid-cols-2 gap-2">
                        <input type="text" id="inpProject" placeholder="工事件名" class="bg-gray-800 border border-gray-600 rounded p-2 text-white placeholder-gray-400">
                        <input type="text" id="inpPlace" placeholder="工事場所" class="bg-gray-800 border border-gray-600 rounded p-2 text-white placeholder-gray-400">
                    </div>
                    <textarea id="inpMemo" rows="2" placeholder="備考・内容" class="w-full bg-gray-800 border border-gray-600 rounded p-2 text-white placeholder-gray-400"></textarea>
                    <div class="flex gap-2">
                        <select id="selSize" class="bg-gray-800 border border-gray-600 rounded p-2 text-white flex-1">
                            <option value="medium">サイズ: 中</option>
                            <option value="large">サイズ: 大</option>
                            <option value="small">サイズ: 小</option>
                        </select>
                        <select id="selPos" class="bg-gray-800 border border-gray-600 rounded p-2 text-white flex-1">
                            <option value="right">位置: 右下</option>
                            <option value="left">位置: 左下</option>
                        </select>
                    </div>
                    <button onclick="updateBoard()" class="w-full bg-blue-600 py-2 rounded font-bold mt-2">黒板を更新</button>
                </div>
            </div>
        </div>
        <div class="flex-1"></div>
        <div class="p-6 pb-10 panel-bg interactive flex justify-around items-center">
            <button onclick="switchCamera()" class="p-3 bg-gray-700 rounded-full border border-gray-500 active:bg-gray-600"><span class="material-icons text-2xl">flip_camera_ios</span></button>
            <button onclick="takePhoto()" class="w-20 h-20 rounded-full border-4 border-white bg-transparent flex items-center justify-center active:scale-95 transition-transform"><div class="w-16 h-16 rounded-full bg-white"></div></button>
            <div id="previewThumb" class="w-12 h-12 bg-gray-800 rounded overflow-hidden border border-gray-500 relative"><span class="material-icons text-gray-500 absolute inset-0 m-auto text-xl">image</span></div>
        </div>
    </div>
    <div id="startOverlay" class="fixed inset-0 z-50 bg-gray-900 flex flex-col items-center justify-center p-6 text-center interactive">
        <span class="material-icons text-6xl text-green-500 mb-4">camera_enhance</span>
        <h2 class="text-2xl font-bold mb-2">現場用ARカメラ</h2>
        <p class="text-gray-300 mb-8">画面を見ながら黒板の位置を確認して<br>そのまま撮影できます。</p>
        <div class="bg-yellow-900/50 border border-yellow-600 p-4 rounded-lg mb-8 text-left text-sm text-yellow-200">
            <p class="font-bold mb-1"><span class="material-icons text-sm align-middle">warning</span> 注意</p>
            <p>・必ず「カメラの許可」をしてください。</p>
            <p>・ブラウザ版のため、標準カメラより画質が落ちる場合があります。</p>
        </div>
        <button onclick="startCamera()" class="bg-green-600 hover:bg-green-500 text-white font-bold py-4 px-10 rounded-full text-xl shadow-lg flex items-center gap-2"><span class="material-icons">camera_alt</span> カメラを開始する</button>
    </div>
    <div id="resultModal" class="hidden fixed inset-0 z-50 bg-black flex flex-col interactive">
        <div class="flex-1 relative bg-black flex items-center justify-center"><img id="resultImage" src="" alt="Result" class="max-w-full max-h-full object-contain"></div>
        <div class="p-4 bg-gray-900 flex justify-between gap-4">
            <button onclick="closeResult()" class="flex-1 py-3 bg-gray-700 rounded text-white font-bold">撮り直す</button>
            <button onclick="saveResult()" class="flex-1 py-3 bg-blue-600 rounded text-white font-bold flex items-center justify-center gap-2"><span class="material-icons">save_alt</span> 保存する</button>
        </div>
    </div>
    <script>
        const video = document.getElementById('cameraVideo');
        const canvas = document.getElementById('overlayCanvas');
        const ctx = canvas.getContext('2d');
        let stream = null;
        let isSettingsOpen = false;
        const boardState = { pos: 'right', size: 'medium', text: { project: '', place: '', memo: '', date: '' } };
        window.addEventListener('load', () => { resizeCanvas(); const now = new Date(); boardState.text.date = `${now.getFullYear()}/${String(now.getMonth()+1).padStart(2,'0')}/${String(now.getDate()).padStart(2,'0')}`; document.getElementById('selPos').value = boardState.pos; document.getElementById('selSize').value = boardState.size; });
        window.addEventListener('resize', resizeCanvas);
        function resizeCanvas() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; drawBoardLoop(); }
        async function startCamera() { try { const constraints = { audio: false, video: { facingMode: { ideal: "environment" }, width: { ideal: 1920 }, height: { ideal: 1080 } } }; stream = await navigator.mediaDevices.getUserMedia(constraints); video.srcObject = stream; video.onloadedmetadata = () => { video.play(); document.getElementById('startOverlay').classList.add('hidden'); drawBoardLoop(); }; } catch (err) { console.error(err); alert('カメラの起動に失敗しました。'); } }
        function drawBoardLoop() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const screenW = canvas.width;
            const screenH = canvas.height;
            let boardW;
            if(boardState.size === 'large') boardW = screenW * 0.5;
            else if(boardState.size === 'small') boardW = screenW * 0.3;
            else boardW = screenW * 0.4;
            const boardH = boardW * 0.75;
            // 修正箇所: 実際のツールに合わせてマージンを0にし、UI回避用のオフセットを削除
            const margin = 0;
            let x = margin;
            let y = screenH - boardH - margin; // 画面下端ピッタリに配置
            if(boardState.pos === 'right') x = screenW - boardW - margin;
            
            // 描画
            ctx.fillStyle = "#004d40"; ctx.fillRect(x, y, boardW, boardH);
            ctx.strokeStyle = "#e0e0e0"; ctx.lineWidth = 2; ctx.strokeRect(x, y, boardW, boardH);
            ctx.strokeStyle = "#ffffff"; ctx.lineWidth = 1; ctx.beginPath();
            ctx.moveTo(x, y + boardH * 0.15); ctx.lineTo(x + boardW, y + boardH * 0.15);
            ctx.moveTo(x, y + boardH * 0.30); ctx.lineTo(x + boardW, y + boardH * 0.30);
            ctx.moveTo(x + boardW * 0.25, y); ctx.lineTo(x + boardW * 0.25, y + boardH * 0.30);
            ctx.stroke();
            ctx.fillStyle = "#ffffff"; ctx.textAlign = "center"; ctx.textBaseline = "middle";
            const baseSize = boardW * 0.055;
            ctx.font = `${baseSize * 0.7}px sans-serif`;
            ctx.fillText("工事件名", x + boardW * 0.125, y + boardH * 0.075);
            ctx.fillText("工事場所", x + boardW * 0.125, y + boardH * 0.225);
            ctx.textAlign = "left"; ctx.font = `bold ${baseSize}px sans-serif`;
            ctx.fillText(boardState.text.project || '', x + boardW * 0.27, y + boardH * 0.075);
            ctx.fillText(boardState.text.place || '', x + boardW * 0.27, y + boardH * 0.225);
            const memoLines = (boardState.text.memo || '').split('\n');
            ctx.textBaseline = "top"; let memoY = y + boardH * 0.35;
            memoLines.forEach(line => { ctx.fillText(line, x + 10, memoY); memoY += baseSize * 1.2; });
            ctx.textAlign = "right"; ctx.textBaseline = "bottom"; ctx.font = `${baseSize * 0.8}px sans-serif`;
            ctx.fillText(boardState.text.date, x + boardW - 5, y + boardH - 5);
        }
        function updateBoard() { boardState.text.project = document.getElementById('inpProject').value; boardState.text.place = document.getElementById('inpPlace').value; boardState.text.memo = document.getElementById('inpMemo').value; boardState.pos = document.getElementById('selPos').value; boardState.size = document.getElementById('selSize').value; drawBoardLoop(); toggleSettings(); }
        function toggleSettings() { const panel = document.getElementById('settingsPanel'); isSettingsOpen = !isSettingsOpen; if(isSettingsOpen) { panel.classList.remove('hidden'); } else { panel.classList.add('hidden'); } }
        function takePhoto() {
            const captureCanvas = document.createElement('canvas'); captureCanvas.width = video.videoWidth; captureCanvas.height = video.videoHeight; const capCtx = captureCanvas.getContext('2d');
            capCtx.drawImage(video, 0, 0, captureCanvas.width, captureCanvas.height);
            capCtx.drawImage(canvas, 0, 0, captureCanvas.width, captureCanvas.height);
            document.getElementById('resultImage').src = captureCanvas.toDataURL('image/jpeg');
            document.getElementById('resultModal').classList.remove('hidden');
        }
        function closeResult() { document.getElementById('resultModal').classList.add('hidden'); }
        function saveResult() { const dataUrl = document.getElementById('resultImage').src; const link = document.createElement('a'); const now = new Date(); const timestamp = `${now.getFullYear()}${now.getMonth()+1}${now.getDate()}_${now.getHours()}${now.getMinutes()}`; link.download = `site_photo_${timestamp}.jpg`; link.href = dataUrl; link.click(); closeResult(); }
        let currentFacingMode = "environment";
        async function switchCamera() { if(stream) { stream.getTracks().forEach(t => t.stop()); } currentFacingMode = currentFacingMode === "environment" ? "user" : "environment"; const constraints = { audio: false, video: { facingMode: { ideal: currentFacingMode }, width: { ideal: 1920 }, height: { ideal: 1080 } } }; try { stream = await navigator.mediaDevices.getUserMedia(constraints); video.srcObject = stream; video.play(); } catch(e) { console.error(e); } }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>現場用AR黒板カメラ</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kosugi+Maru&family=M+PLUS+Rounded+1c:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'M PLUS Rounded 1c', sans-serif;
            background-color: #000;
            color: white;
            overflow: hidden; 
            touch-action: manipulation;
            -webkit-user-select: none;
            user-select: none;
        }
        #cameraVideo {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 1;
        }
        #overlayCanvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; pointer-events: none;
        }
        
        /* UIレイヤー */
        #uiLayer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none;
        }

        /* 操作可能な要素 */
        .interactive { pointer-events: auto; }
        
        /* ボタン共通スタイル */
        .icon-btn {
            width: 48px; height: 48px;
            border-radius: 50%;
            background-color: rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.5);
            display: flex; align-items: center; justify-content: center;
            color: white;
            transition: background-color 0.2s;
        }
        .icon-btn:active { background-color: rgba(255,255,255,0.2); }

        /* シャッターボタン (目立つように) */
        .shutter-btn {
            width: 80px; height: 80px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.3);
            border: 4px solid white;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        .shutter-btn:active { transform: scale(0.95); background-color: rgba(255, 255, 255, 0.5); }
        .shutter-inner {
            width: 64px; height: 64px;
            border-radius: 50%;
            background-color: white;
        }

        /* 横画面(Landscape)レイアウト */
        @media (orientation: landscape) {
            /* 左側エリア（戻る・設定） */
            .control-area-left {
                position: absolute; top: 0; left: 0; bottom: 0; width: 80px;
                display: flex; flex-direction: column; align-items: center; padding-top: 20px; gap: 20px;
                background: linear-gradient(to right, rgba(0,0,0,0.3), transparent);
            }
            /* 右側エリア（シャッター） */
            .control-area-right {
                position: absolute; top: 0; right: 0; bottom: 0; width: 120px;
                display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 30px;
                background: linear-gradient(to left, rgba(0,0,0,0.3), transparent);
            }
            /* 設定パネル位置 */
            #settingsPanel {
                top: 20px; left: 80px;
            }
        }

        /* 縦画面(Portrait)レイアウト - フォールバック用 */
        @media (orientation: portrait) {
            .control-area-left {
                position: absolute; top: 0; left: 0; right: 0; height: 80px;
                display: flex; flex-direction: row; align-items: center; justify-content: space-between; padding: 0 20px;
                background: linear-gradient(to bottom, rgba(0,0,0,0.3), transparent);
            }
            .control-area-right {
                position: absolute; bottom: 0; left: 0; right: 0; height: 120px;
                display: flex; flex-direction: row; align-items: center; justify-content: center; gap: 40px;
                background: linear-gradient(to top, rgba(0,0,0,0.3), transparent);
            }
             /* 設定パネル位置 */
             #settingsPanel {
                top: 80px; left: 20px;
            }
        }

        /* 設定パネルのデザイン */
        .glass-panel {
            background-color: rgba(20, 20, 20, 0.85);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 16px;
            width: 200px;
        }
    </style>
</head>
<body>
    <video id="cameraVideo" autoplay playsinline muted></video>
    <canvas id="overlayCanvas"></canvas>
    
    <div id="uiLayer">
        <!-- 左（上）エリア：設定・戻る -->
        <div class="control-area-left">
            <button onclick="history.back()" class="icon-btn interactive">
                <span class="material-icons">arrow_back</span>
            </button>
            
            <div class="relative">
                <button onclick="toggleSettings()" class="icon-btn interactive">
                    <span class="material-icons">tune</span>
                </button>
                
                <!-- 設定パネル (絶対配置) -->
                <div id="settingsPanel" class="hidden absolute z-50 glass-panel interactive text-left">
                    <div class="flex justify-between items-center mb-2 border-b border-gray-600 pb-1">
                        <span class="font-bold text-sm text-gray-200">黒板サイズ</span>
                        <span class="material-icons text-gray-400 text-base cursor-pointer" onclick="toggleSettings()">close</span>
                    </div>
                    <div class="flex flex-col gap-2">
                        <label class="flex items-center gap-2 cursor-pointer p-1 hover:bg-white/10 rounded">
                            <input type="radio" name="boardSize" value="small" onchange="changeSize('small')">
                            <span class="text-sm">小 (Small)</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer p-1 hover:bg-white/10 rounded">
                            <input type="radio" name="boardSize" value="medium" checked onchange="changeSize('medium')">
                            <span class="text-sm">中 (Medium)</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer p-1 hover:bg-white/10 rounded">
                            <input type="radio" name="boardSize" value="large" onchange="changeSize('large')">
                            <span class="text-sm">大 (Large)</span>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!-- 右（下）エリア：シャッター・カメラ切替 -->
        <div class="control-area-right">
            <!-- カメラ切り替え -->
            <button onclick="switchCamera()" class="icon-btn interactive" style="width:40px; height:40px; background-color:rgba(0,0,0,0.3);">
                <span class="material-icons text-xl">flip_camera_ios</span>
            </button>

            <!-- シャッター -->
            <button onclick="takePhoto()" class="shutter-btn interactive">
                <div class="shutter-inner"></div>
            </button>
            
            <!-- スペーサー（バランス用） -->
            <div style="width:40px; height:40px;"></div>
        </div>
    </div>

    <!-- 開始オーバーレイ -->
    <div id="startOverlay" class="fixed inset-0 z-50 bg-black flex flex-col items-center justify-center p-4 text-center interactive">
        <span class="material-icons text-6xl text-green-500 mb-4">camera_enhance</span>
        <h2 class="text-2xl font-bold mb-2">ARカメラ</h2>
        <p class="text-gray-400 text-sm mb-6">スマホを横向きにして使用してください。</p>
        <button onclick="startCamera()" class="bg-green-600 hover:bg-green-500 text-white font-bold py-3 px-8 rounded-full text-lg shadow-lg flex items-center gap-2">
            <span class="material-icons">camera_alt</span> カメラ起動
        </button>
    </div>

    <!-- 確認モーダル -->
    <div id="resultModal" class="hidden fixed inset-0 z-50 bg-black flex flex-col interactive">
        <div class="flex-1 relative bg-black flex items-center justify-center p-2">
            <img id="resultImage" src="" alt="Result" class="max-w-full max-h-full object-contain border border-gray-800">
        </div>
        <div class="p-4 bg-gray-900 flex justify-center gap-6 pb-8">
            <button onclick="closeResult()" class="py-3 px-8 bg-gray-700 rounded-full text-white font-bold border border-gray-600">撮り直す</button>
            <button onclick="saveResult()" class="py-3 px-8 bg-blue-600 rounded-full text-white font-bold flex items-center justify-center gap-2 shadow-lg">
                <span class="material-icons">save_alt</span> 保存
            </button>
        </div>
    </div>

    <script>
        const video = document.getElementById('cameraVideo');
        const canvas = document.getElementById('overlayCanvas');
        const ctx = canvas.getContext('2d');
        let stream = null;
        
        // シンプルな設定管理
        const state = { 
            size: 'medium' 
        };

        // 初期化
        window.addEventListener('load', () => {
            resizeCanvas();
            const now = new Date();
            state.dateStr = `${now.getFullYear()}/${String(now.getMonth()+1).padStart(2,'0')}/${String(now.getDate()).padStart(2,'0')}`;
        });

        window.addEventListener('resize', resizeCanvas);

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            drawBoardLoop();
        }

        // サイズ変更（ラジオボタンから呼ばれる）
        function changeSize(newSize) {
            state.size = newSize;
            // 設定パネルを閉じる
            toggleSettings();
        }

        function toggleSettings() {
            const panel = document.getElementById('settingsPanel');
            panel.classList.toggle('hidden');
        }

        // カメラ起動
        async function startCamera() {
            try {
                const constraints = {
                    audio: false,
                    video: {
                        facingMode: { ideal: "environment" },
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    }
                };
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    video.play();
                    document.getElementById('startOverlay').classList.add('hidden');
                    drawBoardLoop();
                };
            } catch (err) {
                console.error(err);
                alert('カメラを起動できませんでした。\nブラウザの権限設定を確認してください。');
            }
        }

        // 描画ループ
        function drawBoardLoop() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const screenW = canvas.width;
            const screenH = canvas.height;
            
            // 横画面判定
            const isLandscape = screenW > screenH;
            
            // サイズ計算
            let boardW;
            // 画面に対する比率
            const ratio = {
                'small': isLandscape ? 0.25 : 0.4,
                'medium': isLandscape ? 0.35 : 0.5,
                'large': isLandscape ? 0.45 : 0.6
            }[state.size];
            
            boardW = screenW * ratio;
            const boardH = boardW * 0.75; // 4:3

            // 右下固定 (マージン0)
            const x = screenW - boardW;
            const y = screenH - boardH;

            // --- 黒板描画 ---
            ctx.save();
            
            // 本体
            ctx.fillStyle = "#004d40"; 
            ctx.fillRect(x, y, boardW, boardH);

            // 枠線
            ctx.strokeStyle = "#e0e0e0";
            ctx.lineWidth = Math.max(2, boardW * 0.005);
            ctx.strokeRect(x, y, boardW, boardH);

            // 罫線 (Type C準拠)
            ctx.strokeStyle = "#ffffff";
            ctx.lineWidth = Math.max(1, boardW * 0.003);
            ctx.beginPath();
            ctx.moveTo(x, y + boardH * 0.15); ctx.lineTo(x + boardW, y + boardH * 0.15);
            ctx.moveTo(x, y + boardH * 0.30); ctx.lineTo(x + boardW, y + boardH * 0.30);
            ctx.moveTo(x + boardW * 0.25, y); ctx.lineTo(x + boardW * 0.25, y + boardH * 0.30);
            ctx.stroke();

            // プレースホルダー文字
            ctx.fillStyle = "#ffffff";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            const baseSize = boardW * 0.055; 

            // ラベル
            ctx.font = `${baseSize * 0.7}px sans-serif`;
            ctx.fillText("工事件名", x + boardW * 0.125, y + boardH * 0.075);
            ctx.fillText("工事場所", x + boardW * 0.125, y + boardH * 0.225);

            // 内容ダミー
            ctx.textAlign = "left";
            ctx.font = `bold ${baseSize}px sans-serif`;
            ctx.fillStyle = "rgba(255,255,255,0.5)"; // 半透明でプレースホルダー感
            ctx.fillText("（ここに件名）", x + boardW * 0.27, y + boardH * 0.075);
            ctx.fillText("（ここに場所）", x + boardW * 0.27, y + boardH * 0.225);
            
            // 日付
            ctx.fillStyle = "#ffffff";
            ctx.textAlign = "right";
            ctx.textBaseline = "bottom";
            ctx.font = `${baseSize * 0.8}px sans-serif`;
            ctx.fillText(state.dateStr, x + boardW - 5, y + boardH - 5);
            
            ctx.restore();

            requestAnimationFrame(drawBoardLoop);
        }

        // 撮影
        function takePhoto() {
            const captureCanvas = document.createElement('canvas');
            captureCanvas.width = video.videoWidth;
            captureCanvas.height = video.videoHeight;
            const capCtx = captureCanvas.getContext('2d');

            // 映像
            capCtx.drawImage(video, 0, 0, captureCanvas.width, captureCanvas.height);
            // 黒板
            capCtx.drawImage(canvas, 0, 0, captureCanvas.width, captureCanvas.height);

            document.getElementById('resultImage').src = captureCanvas.toDataURL('image/jpeg');
            document.getElementById('resultModal').classList.remove('hidden');
        }

        function closeResult() {
            document.getElementById('resultModal').classList.add('hidden');
        }

        function saveResult() {
            const dataUrl = document.getElementById('resultImage').src;
            const link = document.createElement('a');
            const now = new Date();
            const timestamp = `${now.getFullYear()}${now.getMonth()+1}${now.getDate()}_${now.getHours()}${now.getMinutes()}`;
            link.download = `site_photo_${timestamp}.jpg`;
            link.href = dataUrl;
            link.click();
            closeResult();
        }

        let currentFacingMode = "environment";
        async function switchCamera() {
            if(stream) stream.getTracks().forEach(t => t.stop());
            currentFacingMode = currentFacingMode === "environment" ? "user" : "environment";
            const constraints = {
                audio: false,
                video: {
                    facingMode: { ideal: currentFacingMode },
                    width: { ideal: 1920 },
                    height: { ideal: 1080 }
                }
            };
            try {
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                video.play();
            } catch(e) {
                console.error(e);
            }
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»•å…¥ã‚Œæ˜ç´°å…¥åŠ›ãƒ„ãƒ¼ãƒ«</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Encoding.js: UTF-16LEå‡ºåŠ›ç”¨ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/encoding-japanese/2.0.0/encoding.min.js"></script>
    <style>
        body { background-color: #f0f2f5; font-family: "Yu Gothic UI", sans-serif; font-size: 0.9rem; }
        .container-fluid { max-width: 1600px; padding: 15px; }
        
        .card { margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border: none; }
        .card-header { background-color: #d1e7dd; color: #0a3622; font-weight: bold; padding: 8px 15px; }
        .card-header.input-area { background-color: #cfe2ff; color: #084298; }
        
        /* Grid Styles */
        .excel-grid th { background-color: #f8f9fa; font-size: 0.8rem; text-align: center; vertical-align: middle; border: 1px solid #dee2e6; padding: 5px; white-space: nowrap; }
        .excel-grid td { padding: 0; border: 1px solid #dee2e6; }
        .excel-grid input { border: 1px solid #ced4da; border-radius: 0; font-size: 0.9rem; padding: 4px; width: 100%; box-sizing: border-box; }
        .excel-grid input:focus { border-color: #86b7fe; outline: 0; box-shadow: 0 0 0 0.25rem rgba(13,110,253,.25); z-index: 10; position: relative; }
        .excel-grid input[readonly] { background-color: #e9ecef; color: #495057; }
        
        .valid-input { background-color: #d4edda !important; border-color: #28a745 !important; }
        .invalid-input { background-color: #f8d7da !important; border-color: #dc3545 !important; }
        
        /* Drag & Drop */
        #dropArea { border: 3px dashed #a8aeb3; border-radius: 10px; background-color: #ffffff; color: #6c757d; transition: all 0.3s; cursor: pointer; }
        #dropArea:hover, #dropArea.dragover { border-color: #0d6efd; background-color: #e9ecef; color: #0d6efd; }
        
        /* Status Text */
        .diff-alert { color: #dc3545; font-weight: bold; font-size: 0.85rem; margin-left: 10px; }
        .diff-ok { color: #198754; font-weight: bold; font-size: 0.85rem; margin-left: 10px; }

        /* Template List */
        #templateSelectBox { max-height: 200px; overflow-y: auto; border: 1px solid #ced4da; background: #fff; font-size: 0.85rem; }
        .template-item { padding: 6px 10px; cursor: pointer; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; }
        .template-item:hover { background-color: #e9ecef; }
        .template-item.active { background-color: #cfe2ff; color: #084298; }
        .template-del-btn { color: #dc3545; font-size: 1.1em; padding: 0 5px; opacity: 0.5; }
        .template-del-btn:hover { opacity: 1; transform: scale(1.2); }
    </style>
</head>
<body>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="mb-0 fw-bold">ğŸ—ï¸ ä»•å…¥ã‚Œæ˜ç´°å…¥åŠ›ãƒ„ãƒ¼ãƒ«</h5>
        <div>
            <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#masterModal">âš™ï¸ ãƒã‚¹ã‚¿ç®¡ç†</button>
            <button class="btn btn-sm btn-outline-primary ms-1" data-bs-toggle="modal" data-bs-target="#templateModal">ğŸ“‘ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç®¡ç†</button>
        </div>
    </div>

    <!-- åŸºæœ¬æƒ…å ±å…¥åŠ› -->
    <div class="card">
        <div class="card-header input-area d-flex justify-content-between align-items-center py-2">
            <span>åŸºæœ¬æƒ…å ± (è«‹æ±‚æ›¸æƒ…å ±)</span>
            <button class="btn btn-sm btn-light border" onclick="saveCurrentAsTemplate()">ğŸ’¾ ç¾åœ¨ã‚’ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¿å­˜</button>
        </div>
        <div class="card-body py-2">
            <div class="row g-2">
                <!-- å·¦ã‚«ãƒ©ãƒ : å…¥åŠ›é …ç›® + é‡‘é¡åˆè¨ˆã‚¨ãƒªã‚¢ -->
                <div class="col-md-9 d-flex flex-column justify-content-between">
                    <div>
                        <div class="row g-2 align-items-end">
                            <div class="col-md-3">
                                <label class="form-label small fw-bold mb-0">ä¼ç¥¨æ—¥ä»˜</label>
                                <input type="date" class="form-control form-control-sm" id="txtDate">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label small fw-bold mb-0">æ‹…å½“è€… (ã‚³ãƒ¼ãƒ‰/æ°å)</label>
                                <div class="input-group input-group-sm">
                                    <input type="text" class="form-control" id="cmbStaff" list="staffOptions" placeholder="ã‚³ãƒ¼ãƒ‰ ã¾ãŸã¯ æ°å" onchange="formatStaffInput()">
                                    <datalist id="staffOptions">
                                        <!-- ãƒã‚¹ã‚¿ã‹ã‚‰ç”Ÿæˆ -->
                                    </datalist>
                                    <span class="input-group-text bg-white text-muted" id="staffStatus" style="font-size:0.7rem; width: 40px; justify-content: center;">â”</span>
                                </div>
                            </div>
                            
                            <!-- ä»•å…¥ã‚ŒåŒºåˆ† -->
                            <div class="col-md-6">
                                <label class="form-label small fw-bold mb-0 d-block">ä»•å…¥ã‚ŒåŒºåˆ†</label>
                                <div class="border rounded p-1 px-2 bg-light d-flex gap-3">
                                    <div class="form-check form-check-inline mb-0">
                                        <input class="form-check-input" type="radio" name="purchaseType" id="type1" value="å¤–æ³¨" checked onchange="filterTemplates()">
                                        <label class="form-check-label small" for="type1">å¤–æ³¨</label>
                                    </div>
                                    <div class="form-check form-check-inline mb-0">
                                        <input class="form-check-input" type="radio" name="purchaseType" id="type2" value="è·äºº" onchange="filterTemplates()">
                                        <label class="form-check-label small" for="type2">è·äºº</label>
                                    </div>
                                    <div class="form-check form-check-inline mb-0">
                                        <input class="form-check-input" type="radio" name="purchaseType" id="type3" value="ãã®ä»–" onchange="filterTemplates()">
                                        <label class="form-check-label small" for="type3">ãã®ä»–</label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row g-2 mt-1 align-items-end">
                            <div class="col-md-4">
                                <label class="form-label small fw-bold mb-0">ä»•å…¥å…ˆå</label>
                                <div class="input-group input-group-sm">
                                    <input type="text" class="form-control" id="cmbSupplier" list="suppOptions" placeholder="ä»•å…¥å…ˆã‚’å…¥åŠ›" onchange="resolveSupplier()">
                                    <datalist id="suppOptions"></datalist>
                                    <input type="text" class="form-control bg-light text-center" id="txtSupplierCode" readonly placeholder="CD" style="max-width:80px;">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label small fw-bold mb-0">å•†å“å (ç¨æŠœã / ç¨è¾¼)</label>
                                <div class="input-group input-group-sm">
                                    <!-- å•†å“ã‚³ãƒ¼ãƒ‰ã¯JSã§å‹•çš„ç”Ÿæˆ -->
                                    <select class="form-select form-select-sm" id="cmbProduct" onchange="resolveProduct()">
                                        <!-- åˆæœŸå€¤ï¼ˆãƒ­ãƒ¼ãƒ‰å‰ï¼‰ -->
                                        <option value="2">ç¨æŠœã</option>
                                        <option value="3">ç¨è¾¼</option>
                                    </select>
                                    <input type="text" class="form-control bg-light text-center" id="txtProdCode" value="2" readonly style="max-width:60px;">
                                </div>
                            </div>
                            <div class="col-md-2">
                                <span id="taxStatusBadge" class="badge bg-secondary w-100">ç¨æŠœå…¥åŠ›</span>
                            </div>
                        </div>
                    </div>

                    <!-- ä¸‹æ®µ: é‡‘é¡ãƒ»èª¿æ•´ãƒ»ãƒœã‚¿ãƒ³ -->
                    <div class="row g-2 mt-3 pt-2 border-top align-items-end">
                        <div class="col-auto">
                            <label class="form-label small fw-bold mb-0 text-danger">è«‹æ±‚æ›¸è¨˜è¼‰é‡‘é¡ï¼ˆç¨è¾¼ã¿ï¼‰</label>
                            <input type="number" class="form-control form-control-sm text-end border-danger fw-bold" id="txtInvoiceTotal" style="width: 140px; font-size: 1.1em;" oninput="calcTotal()" placeholder="é‡‘é¡å…¥åŠ›">
                        </div>
                        <div class="col-auto">
                            <label class="form-label small text-muted mb-0">è¨ˆç®—åˆè¨ˆ(ç¨è¾¼)</label>
                            <div class="form-control-plaintext form-control-sm fw-bold" id="lblCalcTotal" style="width: 100px;">0</div>
                        </div>
                        <div class="col-auto">
                            <label class="form-label small text-muted mb-0">å·®é¡</label>
                            <div class="form-control-plaintext form-control-sm fw-bold" id="lblDiff" style="width: 100px;">0</div>
                        </div>
                        <div class="col-auto"><div id="diffMessage"></div></div>
                        
                        <div class="col text-end">
                            <button class="btn btn-info btn-sm px-4 fw-bold text-white me-1" onclick="executeTransfer()">ç·¨é›†</button>
                            <button class="btn btn-primary btn-sm px-4 fw-bold" onclick="executeTransfer()">è»¢è¨˜</button>
                            <button class="btn btn-success btn-sm px-4 fw-bold" onclick="exportTextFile()">textå‡ºåŠ›</button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="clearDetails()">ã‚¯ãƒªã‚¢</button>
                        </div>
                    </div>
                </div>

                <!-- å³ã‚«ãƒ©ãƒ : ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒªã‚¹ãƒˆ -->
                <div class="col-md-3">
                    <label class="form-label small fw-bold mb-0">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ (åŒºåˆ†ã§çµè¾¼)</label>
                    <input type="text" class="form-control form-control-sm mb-1" id="templateSearch" placeholder="ğŸ” æ¤œç´¢..." oninput="filterTemplates()">
                    <div id="templateSelectBox" class="rounded">
                        <!-- JSã§å‹•çš„ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ˜ç´°å…¥åŠ› -->
    <div class="card">
        <div class="card-header d-flex justify-content-between py-1">
            <span>æ˜ç´°å…¥åŠ› <span class="badge bg-light text-dark ms-2 border">Excelè²¼ä»˜å¯¾å¿œ</span></span>
            <span id="masterStatus" class="small align-self-center">ç¾å ´ãƒã‚¹ã‚¿: <span class="badge bg-secondary">æœªèª­è¾¼</span></span>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive" style="max-height: 50vh;">
                <table class="table table-bordered mb-0 excel-grid" id="gridTable">
                    <thead class="sticky-top z-1">
                        <tr>
                            <th style="width: 50px;">No</th>
                            <th style="width: 120px;">å·¥ç•ª</th>
                            <th style="width: 40px;">è¡Œ</th>
                            <th style="width: 250px;">ç¾å ´å (è‡ªå‹•)</th>
                            <th style="width: 150px;">ç¾å ´æ‹…å½“è€… (è‡ªå‹•)</th>
                            <th style="width: 150px;">æ–½å·¥ä¸» (è‡ªå‹•)</th>
                            <th style="width: 150px;">é‡‘é¡</th>
                            <th style="width: 50px;">-</th>
                        </tr>
                    </thead>
                    <tbody id="gridBody"></tbody>
                </table>
            </div>
            <div class="p-2 border-top bg-light">
                <button class="btn btn-sm btn-secondary" onclick="addRows(5)">ï¼‹ è¡Œè¿½åŠ </button>
            </div>
        </div>
    </div>
</div>

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-light py-2">
                <h6 class="modal-title fw-bold">è»¢è¨˜çµæœãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-2">
                <div class="alert alert-info py-1 mb-2 small d-flex justify-content-between align-items-center">
                    <div>
                        <strong>ç¢ºèª:</strong> å•†å“ã‚³ãƒ¼ãƒ‰ã€Œ<span id="previewTaxType"></span>ã€ã§è¨ˆç®—ã—ã¾ã—ãŸã€‚<br>
                        â€»ã€Œå‰Šé™¤ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€ãã®å‡¦ç†é€£ç•ªã«å«ã¾ã‚Œã‚‹ãƒ‡ãƒ¼ã‚¿ä¸€å¼ãŒå‰Šé™¤ã•ã‚Œã¾ã™ã€‚
                    </div>
                </div>
                <div style="overflow: auto; max-height: 50vh;">
                    <table class="table table-bordered table-striped" id="previewTable" style="font-size: 0.75rem; white-space: nowrap;"></table>
                </div>
            </div>
            <div class="modal-footer py-1">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">é–‰ã˜ã‚‹</button>
                <button type="button" class="btn btn-success btn-sm fw-bold" onclick="exportTextFile()">ãƒ†ã‚­ã‚¹ãƒˆå‡ºåŠ›</button>
            </div>
        </div>
    </div>
</div>

<!-- Master Modal -->
<div class="modal fade" id="masterModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header py-2 bg-light">
                <h6 class="modal-title fw-bold">ãƒã‚¹ã‚¿ç®¡ç†</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <div id="dropArea" class="p-4 text-center mb-3">
                            <div class="h3">ğŸ“‚</div>
                            <div class="fw-bold">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ­ãƒƒãƒ—</div>
                            <div class="small text-muted mt-2">
                                <strong>ç¾å ´ãƒ»ä»•å…¥ãƒ»æ‹…å½“ãƒ»å•†å“ãƒã‚¹ã‚¿ (TXT/CSV/TSV)</strong><br>
                                â€»ä¸€æ‹¬ãƒ‰ãƒ­ãƒƒãƒ—ã§è‡ªå‹•å–è¾¼ï¼ˆåˆ—å›ºå®šãƒ»é¸æŠä¸è¦ï¼‰<br>
                                â€»å•†å“ãƒã‚¹ã‚¿ã‚‚å–è¾¼å¯èƒ½ã«ãªã‚Šã¾ã—ãŸ
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6 class="small fw-bold border-bottom pb-1">ç™»éŒ²çŠ¶æ³</h6>
                        <ul class="list-group list-group-flush small" id="masterStatusList">
                            <li class="list-group-item d-flex justify-content-between">ç¾å ´ãƒã‚¹ã‚¿ <span id="st_genba">0ä»¶</span></li>
                            <li class="list-group-item d-flex justify-content-between">ä»•å…¥ãƒã‚¹ã‚¿ <span id="st_supp">0ä»¶</span></li>
                            <li class="list-group-item d-flex justify-content-between">å•†å“ãƒã‚¹ã‚¿ <span id="st_prod">å›ºå®š</span></li>
                            <li class="list-group-item d-flex justify-content-between">æ‹…å½“ãƒã‚¹ã‚¿ <span id="st_staff">0ä»¶</span></li>
                            <li class="list-group-item d-flex justify-content-between">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ <span id="st_temp">0ä»¶</span></li>
                        </ul>
                        <!-- æ‹…å½“è€…åˆæœŸé¸æŠæ©Ÿèƒ½ -->
                        <div class="mt-3 p-2 bg-white border rounded">
                            <label class="form-label small fw-bold">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ‹…å½“è€…è¨­å®š</label>
                            <select class="form-select form-select-sm" id="initialStaffSelect" onchange="saveDefaultStaff()">
                                <option value="">(æœªé¸æŠ)</option>
                            </select>
                            <div class="small text-muted mt-1">â€»ã“ã“ã§é¸æŠã—ãŸæ‹…å½“è€…ãŒå¸¸ã«åˆæœŸè¡¨ç¤ºã•ã‚Œã¾ã™</div>
                        </div>

                        <button class="btn btn-sm btn-outline-danger w-100 mt-3" onclick="clearMasters()">å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤</button>
                    </div>
                </div>
                <!-- ãƒ­ã‚°è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                <div id="importLog" class="mt-3 p-2 bg-light border small text-muted" style="max-height: 100px; overflow-y: auto;"></div>
            </div>
        </div>
    </div>
</div>

<!-- Template Management Modal -->
<div class="modal fade" id="templateModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header py-2 bg-light">
                <h6 class="modal-title fw-bold">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç®¡ç†</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="card mb-3 border-0 bg-light">
                    <div class="card-body py-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="small fw-bold">CSVä¸€æ‹¬ç·¨é›†</span>
                            <div>
                                <button class="btn btn-sm btn-outline-success me-1" onclick="downloadTemplateCSV()">ğŸ“¥ CSVå‡ºåŠ›</button>
                                <label class="btn btn-sm btn-primary">
                                    ğŸ“¤ CSVå–è¾¼ <input type="file" hidden accept=".csv,.txt" onchange="importTemplateCSV(this)">
                                </label>
                            </div>
                        </div>
                        <div class="small text-muted mt-1">
                            â€»å–è¾¼æ§˜å¼: <strong>ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå, ä»•å…¥ã‚ŒåŒºåˆ†, ä»•å…¥å…ˆå</strong><br>
                            â€»å•†å“åã¨æ‹…å½“è€…ã¯ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã§ã¯ç®¡ç†ã—ã¾ã›ã‚“
                        </div>
                    </div>
                </div>
                <div class="alert alert-secondary small">
                    â€»ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®è¿½åŠ ãƒ»ç·¨é›†ã¯ãƒ¡ã‚¤ãƒ³ç”»é¢ã®ã€Œä¿å­˜ã€ã¾ãŸã¯CSVå–è¾¼ã§è¡Œã£ã¦ãã ã•ã„ã€‚
                </div>
                <div class="text-center mt-3 pt-2 border-top">
                    <button class="btn btn-sm btn-outline-secondary" onclick="resetDefaultTemplates()">åˆæœŸåŒ–</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// ==========================================
// å®šæ•°ãƒ»å¤‰æ•°
// ==========================================
// ä¿®æ­£: å•†å“ãƒã‚¹ã‚¿(PROD)ã®ä¿å­˜ã‚­ãƒ¼ã‚’è¿½åŠ 
const STORAGE_KEYS = { GENBA: 'P_MST_GENBA', SUPP: 'P_MST_SUPP', STAFF: 'P_MST_STAFF', PROD: 'P_MST_PROD', TEMP: 'P_MST_TEMPLATE', DEFAULT_STAFF: 'P_DEFAULT_STAFF' };
// æ–½å·¥ä¸»å(SEKO)ã¨ã—ã¦AVåˆ—(47)ã‚’è¿½åŠ å®šç¾©
const MST_GENBA_IDX = { CODE: 0, SUB: 1, NAME: 2, STAFF: 49, SEKO: 47 }; 

// ä¿®æ­£: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå•†å“ãƒã‚¹ã‚¿å®šç¾©
const DEFAULT_PRODUCTS = [
    { c: "2", n: "ç¨æŠœã" },
    { c: "3", n: "ç¨è¾¼" }
];

let M_GENBA=[], M_SUPP=[], M_STAFF=[], M_TEMPLATES=[], M_PROD=[];
let exportData = [], currentImportFile = "";

// Aåˆ—(0) ï½ ASåˆ—(44)
const HEADERS_A_TO_AS = [
    "ä¼ç¥¨æ—¥ä»˜", "ä¼ç¥¨â„–", "å‡¦ç†é€£ç•ª", "æ˜ç´°åŒºåˆ†", "è¡Œ", "ä»•å…¥å…ˆã‚³ãƒ¼ãƒ‰", "ä»•å…¥å…ˆåï¼‘", "ä»•å…¥å…ˆåï¼’", "æ‹…å½“è€…ã‚³ãƒ¼ãƒ‰", "æœªä½¿ç”¨", "æœªä½¿ç”¨", 
    "æ”¯æ‰•åŒºåˆ†", "è²·æ›åŒºåˆ†", "å–å¼•åŒºåˆ†", "å–å¼•åŒºåˆ†å±æ€§", "æœªä½¿ç”¨", "å•†å“ã‚³ãƒ¼ãƒ‰", "å•†å“å", "æœªä½¿ç”¨", "æœªä½¿ç”¨", "æœªä½¿ç”¨", 
    "æ•°é‡", "æ•°é‡å˜ä½", "å˜ä¾¡", "é‡‘é¡", "æœªä½¿ç”¨", "å˜ä¾¡æ›ç‡", "èª²ç¨åŒºåˆ†", "æœªä½¿ç”¨", "æ¶ˆè²»ç¨ç‡", "å†…æ¶ˆè²»ç¨ç­‰", "æœªä½¿ç”¨", 
    "è¡Œæ‘˜è¦ã‚³ãƒ¼ãƒ‰", "è¡Œæ‘˜è¦ï¼‘", "è¡Œæ‘˜è¦ï¼’", "å‚™è€ƒã‚³ãƒ¼ãƒ‰", "å‚™è€ƒ", "ç™ºæ³¨â„–", "ç™ºæ³¨è¡Œ", "è‡ªå‹•ç”ŸæˆåŒºåˆ†", "æœªä½¿ç”¨", 
    "ä¼ç¥¨æ¶ˆè²»ç¨è¨ˆç®—åŒºåˆ†", "æœªä½¿ç”¨", "ãƒ‡ãƒ¼ã‚¿ç™ºç”ŸåŒºåˆ†", "ç›¸æ‰‹å‡¦ç†é€£ç•ª"
];

let headerList = [...HEADERS_A_TO_AS];

// AT(45) ï½ CJ(87) : æœªä½¿ç”¨ (43å€‹)
for(let i=0; i < (87 - 45 + 1); i++) headerList.push("æœªä½¿ç”¨");

// CK(88), CL(89), CM(90)
headerList.push("ç¾å ´ãƒ¡ã‚¤ãƒ³ã‚³ãƒ¼ãƒ‰");
headerList.push("ç¾å ´ã‚µãƒ–ã‚³ãƒ¼ãƒ‰");
headerList.push("è¦ç´ ã‚³ãƒ¼ãƒ‰");

// CN(91) ï½ CU(98) : æœªä½¿ç”¨ (8å€‹)
for(let i=0; i < (98 - 91 + 1); i++) headerList.push("æœªä½¿ç”¨");

// CV(99)
headerList.push("ãƒã‚§ãƒƒã‚¯ãƒãƒ¼ã‚¯åŒºåˆ†");

// CW(100) ï½ DR(121) : æœªä½¿ç”¨ (22å€‹)
for(let i=0; i < (121 - 100 + 1); i++) headerList.push("æœªä½¿ç”¨");

// DS(122)
headerList.push("æ¶ˆè²»ç¨åˆ†é¡");

// DT(123) ï½ EA(130) : æœªä½¿ç”¨ (8å€‹)
for(let i=0; i < (130 - 123 + 1); i++) headerList.push("æœªä½¿ç”¨");

// ã‚¿ãƒ–åŒºåˆ‡ã‚Šãƒ˜ãƒƒãƒ€ãƒ¼æ–‡å­—åˆ—ã‚’ç”Ÿæˆ
const RAW_LAYOUT = headerList.join("\t");
const LAYOUT_HEADER = headerList.map(s => `"${s}"`).join('\t');
const LAYOUT_COLS = headerList.length;

const DEFAULT_TEMPLATES = [
    { label: "ã‚µãƒ³ãƒ—ãƒ«å¤–æ³¨", type: "å¤–æ³¨", supp: "ã‚µãƒ³ãƒ—ãƒ«å»ºè¨­" },
    { label: "ã‚µãƒ³ãƒ—ãƒ«è·äºº", type: "è·äºº", supp: "ã€‡ã€‡ä¸€äººè¦ªæ–¹" }
];

document.addEventListener('DOMContentLoaded', () => {
    loadMasters();
    initGrid(5); // åˆæœŸè¡¨ç¤º5è¡Œ
    document.getElementById('txtDate').valueAsDate = new Date();
    setupDropArea();
    setupPasteHandler();
    resolveProduct();
    filterTemplates();
});

// ==========================================
// ã‚°ãƒªãƒƒãƒ‰æ“ä½œ
// ==========================================
function initGrid(count) {
    document.getElementById('gridBody').innerHTML = '';
    addRows(count);
}

function addRows(count) {
    const tbody = document.getElementById('gridBody');
    const startNo = tbody.children.length + 1;
    for (let i = 0; i < count; i++) {
        const tr = document.createElement('tr');
        // æ–½å·¥ä¸»(seko-name)ã‚«ãƒ©ãƒ ã‚’è¿½åŠ 
        tr.innerHTML = `
            <td class="text-center bg-light text-muted small align-middle">${startNo + i}</td>
            <td><input type="text" class="job-code" onchange="resolveJob(this)"></td>
            <td><input type="text" class="row-num text-center bg-light text-primary fw-bold" readonly tabindex="-1"></td>
            <td><input type="text" class="genba-name" readonly tabindex="-1"></td>
            <td><input type="text" class="genba-staff" readonly tabindex="-1"></td>
            <td><input type="text" class="seko-name" readonly tabindex="-1"></td>
            <td><input type="number" class="amount-col text-end" oninput="handleAmountInput(this)"></td>
            <input type="hidden" class="sub-code">
            <input type="hidden" class="genba-address">
            <td class="text-center p-1"><button class="btn btn-outline-danger btn-sm p-0 px-1" onclick="this.closest('tr').remove(); calcTotal(); updateRowNumbers();" tabindex="-1">Ã—</button></td>
        `;
        tbody.appendChild(tr);
    }
}

// è¡Œç•ªå·è‡ªå‹•è¨ˆç®—
function updateRowNumbers() {
    const rows = document.querySelectorAll('#gridBody tr');
    let prevJob = "";
    let counter = 0;
    
    rows.forEach(tr => {
        const jobInp = tr.querySelector('.job-code');
        const rowNumInp = tr.querySelector('.row-num');
        const currentJob = jobInp.value.trim();
        
        if (currentJob === "") {
            rowNumInp.value = "";
            prevJob = ""; 
            counter = 0;
        } else {
            if (currentJob === prevJob) {
                counter++;
            } else {
                counter = 1;
            }
            rowNumInp.value = counter;
            prevJob = currentJob;
        }
    });
}

function resolveJob(input) {
    const row = input.closest('tr');
    const val = input.value.trim();
    // ã‚¯ãƒªã‚¢
    row.querySelector('.genba-name').value = "";
    row.querySelector('.genba-staff').value = "";
    row.querySelector('.seko-name').value = "";
    row.querySelector('.sub-code').value = "";
    input.classList.remove('valid-input', 'invalid-input');

    if (val) {
        // ç¾å ´ãƒã‚¹ã‚¿æ¤œç´¢ (Aåˆ—=Codeã§æ¤œç´¢)
        const hit = M_GENBA.find(m => m[MST_GENBA_IDX.CODE] == val);
        if (hit) {
            input.classList.add('valid-input');
            row.querySelector('.sub-code').value = hit[MST_GENBA_IDX.SUB] || "";
            row.querySelector('.genba-name').value = hit[MST_GENBA_IDX.NAME] || "";
            // æ‰‹æœ¬Excelã§ã¯AXåˆ—(49)ã«æ‹…å½“è€…åãŒå…¥ã£ã¦ã„ã‚‹
            row.querySelector('.genba-staff').value = hit[MST_GENBA_IDX.STAFF] || "";
            // AVåˆ—(47)ã®æ–½å·¥ä¸»åã‚’ã‚»ãƒƒãƒˆ
            row.querySelector('.seko-name').value = hit[MST_GENBA_IDX.SEKO] || "";
        } else {
            input.classList.add('invalid-input');
        }
    }
    updateRowNumbers();
}

// â˜… Sheet1 ãƒ­ã‚¸ãƒƒã‚¯: é‡‘é¡å…¥åŠ›æ™‚ã«å·¥ç•ªãŒç©ºæ¬„ãªã‚‰ä¸Šã®è¡Œã‚’ã‚³ãƒ”ãƒ¼ â˜…
function handleAmountInput(input) {
    calcTotal();
    
    const row = input.closest('tr');
    const jobInp = row.querySelector('.job-code');
    const val = input.value;
    
    // é‡‘é¡ãŒå…¥ã£ãŸ ã‹ã¤ å·¥ç•ªãŒç©º
    if (val !== "" && jobInp.value === "") {
        const prevRow = row.previousElementSibling;
        if (prevRow) {
            const prevJob = prevRow.querySelector('.job-code').value;
            if (prevJob) {
                // ä¸Šã®è¡Œã®æƒ…å ±ã‚’ã‚³ãƒ”ãƒ¼
                jobInp.value = prevJob;
                // ã‚³ãƒ”ãƒ¼å¾Œã«ãƒã‚¹ã‚¿å‚ç…§å‡¦ç†ã‚’èµ°ã‚‰ã›ã¦åå‰ç­‰ã‚’åŸ‹ã‚ã‚‹
                resolveJob(jobInp);
            }
        }
    }
}

function resolveSupplier() {
    const val = document.getElementById('cmbSupplier').value;
    const hit = M_SUPP.find(m => m.n === val);
    document.getElementById('txtSupplierCode').value = hit ? hit.c : "";
}

// ä¿®æ­£: ãƒã‚¹ã‚¿ã‹ã‚‰é¸æŠè‚¢ã‚’å‹•çš„ç”Ÿæˆã™ã‚‹ãŸã‚ã€å€¤ã®å–å¾—æ–¹æ³•ã‚’æ•´ç†
function resolveProduct() {
    const sel = document.getElementById('cmbProduct');
    const code = sel.value; 
    document.getElementById('txtProdCode').value = code;
    
    const badge = document.getElementById('taxStatusBadge');
    // ã‚³ãƒ¼ãƒ‰3ã®ã¿ã€Œç¨è¾¼ã€æ‰±ã„ã€ãã‚Œä»¥å¤–ã¯ã€Œç¨æŠœã€ã¨ã—ã¦å¤–ç¨è¨ˆç®—å¯¾è±¡
    if (code === "3") {
        badge.innerText = "ç¨è¾¼/éèª²ç¨";
        badge.className = "badge bg-success";
    } else {
        badge.innerText = "ç¨æŠœå…¥åŠ›";
        badge.className = "badge bg-secondary";
    }
    calcTotal();
}

// â˜…â˜…â˜… æ‹…å½“è€…å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆè‡ªå‹•åŒ– â˜…â˜…â˜…
function formatStaffInput() {
    const input = document.getElementById('cmbStaff');
    const val = input.value.trim();
    const status = document.getElementById('staffStatus');
    
    if(!val) { 
        status.innerText = "â”"; 
        status.className="input-group-text bg-white text-muted"; 
        // ç©ºæ¬„æ™‚ã¯å…¨ä»¶è¡¨ç¤ºãƒªã‚¹ãƒˆã«æˆ»ã™
        updateStaffDatalist(M_STAFF); 
        return; 
    }

    // ãƒã‚¹ã‚¿ã‹ã‚‰æ¤œç´¢
    // 1. å®Œå…¨ä¸€è‡´ (ã‚³ãƒ¼ãƒ‰ : åå‰)
    let hit = M_STAFF.find(s => `${s.c} : ${s.n}` === val);
    // 2. ã‚³ãƒ¼ãƒ‰ä¸€è‡´
    if (!hit) hit = M_STAFF.find(s => s.c === val);
    // 3. åå‰ä¸€è‡´
    if (!hit) hit = M_STAFF.find(s => s.n === val);

    if (hit) {
        input.value = `${hit.c} : ${hit.n}`;
        status.innerText = "OK";
        status.className = "input-group-text bg-success text-white fw-bold";
        // ç¢ºå®šæ™‚ã¯å…¨ä»¶ã«æˆ»ã™
        updateStaffDatalist(M_STAFF);
    } else {
        status.innerText = "NG";
        status.className = "input-group-text bg-danger text-white fw-bold";
    }
}

// æ‹…å½“è€…datalistã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
function updateStaffDatalist(list) {
    const datalist = document.getElementById('staffOptions');
    datalist.innerHTML = list.map(s => `<option value="${s.c} : ${s.n}">`).join('');
    
    // ãƒã‚¹ã‚¿ç®¡ç†ç”»é¢ã®ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚‚æ›´æ–°
    const initSelect = document.getElementById('initialStaffSelect');
    const currentVal = initSelect.value;
    initSelect.innerHTML = '<option value="">(æœªé¸æŠ)</option>' + list.map(s => `<option value="${s.c} : ${s.n}">${s.c} : ${s.n}</option>`).join('');
    // é¸æŠçŠ¶æ…‹ã‚’å¾©å…ƒ
    if(currentVal) initSelect.value = currentVal;
}

// ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ‹…å½“è€…ã‚’ä¿å­˜
function saveDefaultStaff() {
    const val = document.getElementById('initialStaffSelect').value;
    localStorage.setItem(STORAGE_KEYS.DEFAULT_STAFF, val);
    // åŸºæœ¬æƒ…å ±æ¬„ã«ã‚‚å³æ™‚åæ˜ 
    document.getElementById('cmbStaff').value = val;
    formatStaffInput();
}

// ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ‹…å½“è€…ã‚’èª­ã¿è¾¼ã¿
function loadDefaultStaff() {
    const val = localStorage.getItem(STORAGE_KEYS.DEFAULT_STAFF);
    if(val) {
        document.getElementById('initialStaffSelect').value = val;
        document.getElementById('cmbStaff').value = val;
        formatStaffInput(); 
    }
}


function calcTotal() {
    let sum = 0;
    document.querySelectorAll('.amount-col').forEach(i => sum += (parseFloat(i.value) || 0));
    
    const prodCode = document.getElementById('txtProdCode').value;
    let calcTotal = sum;
    
    // å¤–ç¨è¨ˆç®— (ã‚³ãƒ¼ãƒ‰2ä»¥å¤–ã®å ´åˆ) â€»ã‚³ãƒ¼ãƒ‰3ä»¥å¤–ã¯å…¨ã¦å¤–ç¨ã¨ã—ã¦æ‰±ã†ä»•æ§˜ç¶­æŒ
    if (prodCode !== "3") {
        calcTotal = Math.floor(sum * 1.1);
    }
    
    document.getElementById('lblCalcTotal').innerText = calcTotal.toLocaleString();
    
    const inv = parseFloat(document.getElementById('txtInvoiceTotal').value);
    const diffInfo = document.getElementById('diffMessage');
    const lblDiff = document.getElementById('lblDiff');
    
    if (!isNaN(inv)) {
        const diff = inv - calcTotal;
        lblDiff.innerText = diff.toLocaleString();
        if (diff !== 0) {
            lblDiff.className = "form-control-plaintext form-control-sm fw-bold text-danger";
            diffInfo.innerHTML = '<span class="diff-alert">å·®é¡ã‚ã‚Š (è‡ªå‹•èª¿æ•´ã•ã‚Œã¾ã™)</span>';
        } else {
            lblDiff.className = "form-control-plaintext form-control-sm fw-bold text-success";
            diffInfo.innerHTML = '<span class="diff-ok">OK</span>';
        }
    } else {
        lblDiff.innerText = "0";
        diffInfo.innerHTML = "";
    }
}

// ==========================================
// è»¢è¨˜å‡¦ç† (Excelãƒ­ã‚¸ãƒƒã‚¯å®Œå…¨æº–æ‹ )
// ==========================================
function executeTransfer() {
    const dateStr = document.getElementById('txtDate').value.replace(/-/g, '');
    const suppCode = document.getElementById('txtSupplierCode').value;
    if (!dateStr || !suppCode) { alert("æ—¥ä»˜ã¨ä»•å…¥å…ˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆã‚³ãƒ¼ãƒ‰å¿…é ˆï¼‰"); return; }

    const suppName = document.getElementById('cmbSupplier').value;
    const sel = document.getElementById('cmbProduct');
    const prodName = sel.options[sel.selectedIndex].text; // "ç¨æŠœã" or "ç¨è¾¼"
    const prodCode = sel.value;
    const staffInput = document.getElementById('cmbStaff').value;
    // æ‹…å½“è€…ã‚³ãƒ¼ãƒ‰æŠ½å‡º (ã‚³ãƒ¼ãƒ‰ : åå‰ å½¢å¼ã‹ã‚‰)
    const staff = staffInput.includes(":") ? staffInput.split(":")[0].trim() : staffInput.trim();
    
    // å·®é¡å–å¾—
    let diff = 0;
    const invVal = document.getElementById('txtInvoiceTotal').value;
    if (invVal !== "") {
        diff = parseFloat(document.getElementById('lblDiff').innerText.replace(/,/g,'')) || 0;
    }
    let isDiffApplied = false;

    // ã‚°ãƒªãƒƒãƒ‰ãƒ‡ãƒ¼ã‚¿
    const rows = Array.from(document.querySelectorAll('#gridBody tr')).map(tr => ({
        job: tr.querySelector('.job-code').value.trim(),
        sub: tr.querySelector('.sub-code').value.trim(),
        rowNum: tr.querySelector('.row-num').value.trim(),
        amt: parseFloat(tr.querySelector('.amount-col').value) || 0
    })).filter(r => r.job !== "");

    if (rows.length === 0) { alert("æ˜ç´°ãŒã‚ã‚Šã¾ã›ã‚“ã€‚"); return; }

    exportData = [];
    let currentSeq = 1;
    let groupRows = [];
    let groupKey = "";
    let groupSum = 0;

    // ãƒ«ãƒ¼ãƒ—å‡¦ç†
    [...rows, {job: "EOF"}].forEach((row, idx) => {
        if (idx > 0 && row.job !== groupKey) {
            // --- ã‚°ãƒ«ãƒ¼ãƒ—çµ‚äº†æ™‚ã®å‡¦ç† ---
            
            // 1. æ¶ˆè²»ç¨è¨ˆç®— (å¤–ç¨ç”¨)
            let tax = Math.floor(groupSum * 0.1);
            let applyDiffHere = false;
            
            // 2. å·®é¡èª¿æ•´ (æœ€åˆã®ã‚°ãƒ«ãƒ¼ãƒ—ã®æ¶ˆè²»ç¨è¡Œã§èª¿æ•´)
            if (!isDiffApplied && diff !== 0 && prodCode !== "3") {
                tax += diff;
                isDiffApplied = true;
                applyDiffHere = true;
            }
            
            // APåˆ—ã®å€¤æ±ºå®š (å·®é¡èª¿æ•´ã—ãŸã‚°ãƒ«ãƒ¼ãƒ—ãªã‚‰2, ä»¥å¤–ã¯0)
            const apVal = (applyDiffHere) ? "2" : "0";

            // 3. æ˜ç´°è¡Œå‡ºåŠ›
            groupRows.forEach(gr => {
                const ln = new Array(LAYOUT_COLS).fill("");
                ln[0] = dateStr;    // A: æ—¥ä»˜
                ln[2] = currentSeq; // C: å‡¦ç†é€£ç•ª(ä»®)
                ln[3] = "0";        // D: æ˜ç´°åŒºåˆ†=0
                ln[4] = gr.rowNum;  // E: è¡Œç•ªå·
                ln[5] = suppCode;   // F
                ln[6] = suppName;   // G
                ln[8] = staff;      // I (æ‹…å½“è€…ã‚³ãƒ¼ãƒ‰)
                
                ln[11]="0"; ln[12]="1"; ln[13]="1"; ln[14]="1"; 
                ln[16] = prodCode;  // Q
                ln[17] = prodName;  // R
                ln[21] = "0"; // æ•°é‡(U) -> 0
                ln[22] = "å¼"; // æ•°é‡å˜ä½(W) -> æ˜ç´°è¡Œã¯"å¼"
                ln[23] = "0"; // å˜ä¾¡(X) -> 0
                ln[24] = gr.amt;    // Y
                ln[26] = "0"; // å˜ä¾¡æ›ç‡(AA) -> 0
                
                // ç¨åŒºåˆ† (ABåˆ—)
                if (prodCode === "3") { // ç¨è¾¼
                    ln[27] = "1"; // AB=1
                    ln[30] = Math.floor(gr.amt - (gr.amt / 1.1)); // AE=å†…ç¨
                } else { // ç¨æŠœ
                    ln[27] = "0"; // AB=0
                    ln[30] = "0"; // AE=0
                }
                ln[29] = "10"; // AD
                
                ln[32] = "0"; // AG
                ln[35] = "0"; // AJ
                ln[37] = "0"; // AL
                ln[38] = "0"; // AM
                ln[39] = "0"; // AN
                ln[41] = apVal; // AP
                ln[43] = "0"; // AR
                ln[44] = "0"; // AS
                
                // ä¿®æ­£: é…åˆ—ã¯0å§‹ã¾ã‚Šãªã®ã§ã€CKåˆ—ã¯ index 88
                ln[88] = gr.job; // CK: ç¾å ´ãƒ¡ã‚¤ãƒ³
                ln[89] = gr.sub; // CL: ç¾å ´ã‚µãƒ–
                ln[90] = "0";    // CM: è¦ç´ 
                ln[99] = "0";    // CV: ãƒã‚§ãƒƒã‚¯ãƒãƒ¼ã‚¯
                ln[122] = "0";   // DS: æ¶ˆè²»ç¨åˆ†é¡

                exportData.push(ln);
            });

            // 4. æ¶ˆè²»ç¨è¡Œå‡ºåŠ›
            if (prodCode !== "3") {
                const txLn = new Array(LAYOUT_COLS).fill("");
                txLn[0] = dateStr;
                txLn[2] = currentSeq;
                txLn[3] = "1"; // D
                txLn[4] = "1"; // E
                txLn[5] = suppCode; txLn[6] = suppName;
                txLn[8] = staff;
                txLn[11]="0"; txLn[12]="1"; txLn[13]="1"; txLn[14]="1";
                
                // æ¶ˆè²»ç¨è¡Œãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆä¿®æ­£: "æ¶ˆè²»ç¨ç­‰ï¼ˆèª²ç¨å¯¾è±¡é¡       1,500)"
                txLn[17] = formatTaxSummary(tax);
                
                txLn[21] = ""; // U:ç©ºæ¬„
                txLn[22] = ""; // W:ç©ºæ¬„
                txLn[23] = ""; // X:ç©ºæ¬„
                txLn[24] = tax; // Y
                txLn[26] = ""; // AA:ç©ºæ¬„
                txLn[27] = "9"; txLn[30] = tax; txLn[29] = "10";
                
                txLn[32] = "0"; // AG
                txLn[35] = "0"; // AJ
                txLn[37] = "0"; // AL
                txLn[38] = "0"; // AM
                txLn[39] = "0"; // AN
                txLn[41] = apVal; // AP
                txLn[43] = "0"; // AR
                txLn[44] = "0"; // AS
                
                txLn[88] = groupKey;
                txLn[90] = ""; // CM: ç©º
                txLn[99] = "0"; // CV

                exportData.push(txLn);
            }

            // ãƒªã‚»ãƒƒãƒˆ
            groupRows = [];
            groupSum = 0;
        }

        if (row.job !== "EOF") {
            groupKey = row.job;
            groupRows.push(row);
            groupSum += row.amt;
        }
    });

    // 5. å‡¦ç†é€£ç•ª(Cåˆ—)ã®æŒ¯ã‚Šç›´ã— (Module1 Logic)
    let pKey = "";
    let grpNum = 0;
    exportData.forEach((row, i) => {
        const isTaxRow = (row[90] === ""); // CMåˆ—ãŒç©ºãªã‚‰æ¶ˆè²»ç¨è¡Œ
        const currentKey = `${row[88]}_${row[0]}_${row[5]}`; // ç¾å ´_æ—¥ä»˜_ä»•å…¥å…ˆ
        
        let effKey = isTaxRow ? pKey : currentKey;
        
        if (i === 0 || effKey !== pKey) {
            grpNum++;
        }
        row[2] = grpNum; 
        pKey = effKey;
    });

    document.getElementById('previewTaxType').innerText = (prodCode === "3" ? "ç¨è¾¼" : "ç¨æŠœ");
    renderPreview();
    new bootstrap.Modal(document.getElementById('previewModal')).show();
}

function formatTaxSummary(taxAmount) {
    // åŠè§’ã‚¹ãƒšãƒ¼ã‚¹7ã¤ + ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šé‡‘é¡
    const formattedNum = taxAmount.toLocaleString();
    const spaces = "       "; 
    return `æ¶ˆè²»ç¨ç­‰ï¼ˆèª²ç¨å¯¾è±¡é¡${spaces}${formattedNum})`;
}

// ----------------------------------------------------
// ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»é¢æ“ä½œ (è¡¨ç¤º & å‰Šé™¤)
// ----------------------------------------------------
function renderPreview() {
    const tbl = document.getElementById('previewTable');
    tbl.innerHTML = "";
    
    // ãƒ˜ãƒƒãƒ€ãƒ¼ç”Ÿæˆ
    const th = document.createElement('tr');
    
    // æ“ä½œåˆ—è¿½åŠ 
    const opTh = document.createElement('th');
    opTh.innerText = "æ“ä½œ";
    opTh.className = "bg-light sticky-top";
    opTh.style.top = "0";
    opTh.style.width = "60px";
    th.appendChild(opTh);

    const showCols = [
        { idx: 0, label: "æ—¥ä»˜(A)" },
        { idx: 2, label: "é€£ç•ª(C)" },
        { idx: 3, label: "åŒºåˆ†(D)" },
        { idx: 4, label: "è¡Œ(E)" },
        { idx: 5, label: "ä»•å…¥CD(F)" },
        { idx: 17, label: "å•†å“å(R)" }, 
        { idx: 24, label: "é‡‘é¡(Y)" },
        { idx: 27, label: "èª²ç¨(AB)" },
        { idx: 30, label: "å†…ç¨(AE)" },
        { idx: 41, label: "èª¿æ•´(AP)" },
        { idx: 88, label: "ç¾å ´(CK)" }
    ];

    showCols.forEach(col => {
        const t = document.createElement('th');
        t.innerText = col.label;
        t.className = "bg-light sticky-top";
        t.style.top = "0";
        th.appendChild(t);
    });
    tbl.appendChild(document.createElement('thead')).appendChild(th);

    // ãƒœãƒ‡ã‚£ç”Ÿæˆ
    const tbody = document.createElement('tbody');
    exportData.forEach((row, rIdx) => {
        const tr = document.createElement('tr');
        const serialNo = row[2]; // é€£ç•ª(Cåˆ—)

        // å‰Šé™¤ãƒœã‚¿ãƒ³ã‚»ãƒ«
        const tdOp = document.createElement('td');
        tdOp.className = "text-center align-middle p-0";
        const btn = document.createElement('button');
        btn.className = "btn btn-outline-danger btn-sm py-0";
        btn.style.fontSize = "0.75rem";
        btn.innerText = "å‰Šé™¤";
        btn.onclick = () => deleteBySerialNo(serialNo);
        tdOp.appendChild(btn);
        tr.appendChild(tdOp);

        // ãƒ‡ãƒ¼ã‚¿ã‚»ãƒ« (ç·¨é›†ä¸å¯ãƒ†ã‚­ã‚¹ãƒˆ)
        showCols.forEach(col => {
            const td = document.createElement('td');
            td.innerText = row[col.idx];
            tr.appendChild(td);
        });
        tbody.appendChild(tr);
    });
    tbl.appendChild(tbody);
}

// é€£ç•ªã‚’æŒ‡å®šã—ã¦å‰Šé™¤ã™ã‚‹é–¢æ•°
function deleteBySerialNo(targetSerial) {
    if(!targetSerial) return;
    
    // æŒ‡å®šã•ã‚ŒãŸé€£ç•ªã¨ä¸€è‡´ã—ãªã„è¡Œã ã‘æ®‹ã™
    // â€»Cåˆ—ã¯ index 2
    exportData = exportData.filter(row => row[2] != targetSerial);
    
    // å†æç”»
    renderPreview();
    
    // ãƒ‡ãƒ¼ã‚¿ãŒç©ºã«ãªã£ãŸå ´åˆã®å‡¦ç†
    if (exportData.length === 0) {
        bootstrap.Modal.getInstance(document.getElementById('previewModal')).hide();
        alert("å…¨ãƒ‡ãƒ¼ã‚¿ãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸã€‚");
    }
}

// UTF-16LE (BOMä»˜ã) å¤‰æ›é–¢æ•°
function strToUTF16LE(str) {
    const buffer = new ArrayBuffer(2 + (str.length * 2));
    const view = new DataView(buffer);
    // BOM
    view.setUint8(0, 0xFF);
    view.setUint8(1, 0xFE);
    
    for (let i = 0; i < str.length; i++) {
        const code = str.charCodeAt(i);
        view.setUint16(2 + (i * 2), code, true); // true = Little Endian
    }
    return buffer;
}

function exportTextFile() {
    if(exportData.length===0) return;
    
    // â˜…ä¿®æ­£ç®‡æ‰€: ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’1è¡Œç›®ã«è¿½åŠ â˜…
    let txt = LAYOUT_HEADER + "\r\n";
    
    exportData.forEach(r => {
        // å„è¦ç´ ã‚’ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã§å›²ã¿ã€ã‚¿ãƒ–åŒºåˆ‡ã‚Šã§çµåˆ
        txt += r.map(c => `"${String(c).replace(/"/g, '""')}"`).join("\t") + "\r\n";
    });
    
    const blob = new Blob([strToUTF16LE(txt)], { type: "text/plain;charset=UTF-16LE" });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `å–è¾¼ãƒ‡ãƒ¼ã‚¿_${getNowStr()}.txt`;
    a.click();
}

function getNowStr() {
    const d = new Date();
    return d.getFullYear() + String(d.getMonth()+1).padStart(2,'0') + String(d.getDate()).padStart(2,'0') + "_" +
           String(d.getHours()).padStart(2,'0') + String(d.getMinutes()).padStart(2,'0') + String(d.getSeconds()).padStart(2,'0');
}

// ==========================================
// ãƒã‚¹ã‚¿ & ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç®¡ç† (ä¸€æ‹¬å–è¾¼ãƒ»å›ºå®šåˆ—)
// ==========================================
function setupDropArea() {
    const d = document.getElementById('dropArea');
    d.ondragover = e => { e.preventDefault(); d.classList.add('dragover'); };
    d.ondragleave = e => { e.preventDefault(); d.classList.remove('dragover'); };
    d.ondrop = e => {
        e.preventDefault(); d.classList.remove('dragover');
        if(e.dataTransfer.files.length) {
            Array.from(e.dataTransfer.files).forEach(f => processFile(f));
        }
    };
}

function processFile(file) {
    const reader = new FileReader();
    reader.onload = e => {
        const txt = e.target.result;
        // TSV/CSVåˆ¤å®šã¨ã‚¯ã‚©ãƒ¼ãƒˆå‰Šé™¤
        const rows = txt.split(/\r\n|\n/).filter(l => l.trim()).map(l => l.split(txt.includes('\t') ? '\t' : ',').map(c => c.replace(/^"|"$/g,'')));
        handleParsedData(rows, file.name);
    };
    reader.readAsText(file, "Shift_JIS");
}

function handleParsedData(rows, fileName) {
    if(rows.length < 1) return;
    // Skip definition rows like <00001>
    const validRows = rows.filter(r => r.length > 0 && !r[0].startsWith("<"));
    // Header check
    const startIdx = (validRows[0][0].includes("ã‚³ãƒ¼ãƒ‰") || validRows[0][2]?.includes("åç§°")) ? 1 : 0;
    const dataRows = validRows.slice(startIdx);

    const logDiv = document.getElementById('importLog');
    let msg = "";

    // è‡ªå‹•åˆ¤åˆ¥ã¨å›ºå®šåˆ—å–è¾¼
    if (fileName.includes("ç¾å ´")) {
        // ç¾å ´ãƒã‚¹ã‚¿: å…¨åˆ—ä¿å­˜
        // æ‰‹æœ¬ä»•æ§˜: [0]:å·¥ç•ª, [1]:ã‚µãƒ–, [2]:åç§°, [49]:æ‹…å½“è€…
        M_GENBA = dataRows; 
        saveMasters();
        msg = "ç¾å ´ãƒã‚¹ã‚¿å–è¾¼: " + dataRows.length + "ä»¶";
    } else if (fileName.includes("ä»•å…¥") || fileName.includes("å¾—æ„å…ˆ")) {
        // ä»•å…¥ãƒã‚¹ã‚¿: A(0)=Code, B(1)=Name
        M_SUPP = dataRows.map(r => ({ c: r[0], n: r[1] }));
        saveMasters();
        msg = "ä»•å…¥ãƒã‚¹ã‚¿å–è¾¼: " + dataRows.length + "ä»¶";
    } else if (fileName.includes("å•†å“")) {
        // ä¿®æ­£: å•†å“ãƒã‚¹ã‚¿ã®å–è¾¼ã‚’æœ‰åŠ¹åŒ– (A=Code, B=Name)
        M_PROD = dataRows.map(r => ({ c: r[0], n: r[1] }));
        saveMasters();
        msg = "å•†å“ãƒã‚¹ã‚¿å–è¾¼: " + dataRows.length + "ä»¶";
    } else if (fileName.includes("æ‹…å½“")) {
        // æ‹…å½“ãƒã‚¹ã‚¿: A(0)=Code, B(1)=Name
        M_STAFF = dataRows.map(r => ({ c: r[0], n: r[1] }));
        saveMasters();
        msg = "æ‹…å½“ãƒã‚¹ã‚¿å–è¾¼: " + dataRows.length + "ä»¶";
    } else if (fileName.includes("ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ")) {
        importTemplateData(dataRows);
        msg = "ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’å–ã‚Šè¾¼ã¿ã¾ã—ãŸ";
    } else {
        msg = "ä¸æ˜ãªãƒ•ã‚¡ã‚¤ãƒ«ã§ã™: " + fileName;
    }
    
    logDiv.innerHTML += `<div>${msg}</div>`;
    logDiv.scrollTop = logDiv.scrollHeight;
    loadMasters();
}

// ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå–è¾¼ (3åˆ—ã®ã¿)
function importTemplateData(rows) {
    let newTemps = [];
    rows.forEach((cols, i) => {
        // cols[0]=Label, cols[1]=Type, cols[2]=Supp
        if (cols.length >= 3 && !cols[0].includes("ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå")) {
            newTemps.push({
                label: cols[0].trim(),
                type: cols[1].trim(), // ä»•å…¥ã‚ŒåŒºåˆ†
                supp: cols[2].trim()  // ä»•å…¥å…ˆå
                // prod, staff ã¯ä¿å­˜ã—ãªã„
            });
        }
    });
    if (newTemps.length > 0) {
        M_TEMPLATES = [...M_TEMPLATES, ...newTemps];
        localStorage.setItem(STORAGE_KEYS.TEMP, JSON.stringify(M_TEMPLATES));
        loadMasters();
        alert(`${newTemps.length}ä»¶ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’å–ã‚Šè¾¼ã¿ã¾ã—ãŸã€‚`);
    }
}

// ãƒã‚¹ã‚¿ä¿å­˜ãƒ»èª­è¾¼å…±é€š
function saveMasters() {
    localStorage.setItem(STORAGE_KEYS.GENBA, JSON.stringify(M_GENBA));
    localStorage.setItem(STORAGE_KEYS.SUPP, JSON.stringify(M_SUPP));
    // ä¿®æ­£: å•†å“ãƒã‚¹ã‚¿ä¿å­˜ã‚’è¿½åŠ 
    localStorage.setItem(STORAGE_KEYS.PROD, JSON.stringify(M_PROD));
    localStorage.setItem(STORAGE_KEYS.STAFF, JSON.stringify(M_STAFF));
    loadMasters();
}

function loadMasters() {
    M_GENBA = JSON.parse(localStorage.getItem(STORAGE_KEYS.GENBA)) || [];
    M_SUPP = JSON.parse(localStorage.getItem(STORAGE_KEYS.SUPP)) || [];
    // ä¿®æ­£: å•†å“ãƒã‚¹ã‚¿èª­è¾¼ï¼ˆãªã‘ã‚Œã°åˆæœŸå€¤ã‚’ä½¿ç”¨ï¼‰
    const storedProd = localStorage.getItem(STORAGE_KEYS.PROD);
    M_PROD = storedProd ? JSON.parse(storedProd) : DEFAULT_PRODUCTS;
    
    M_STAFF = JSON.parse(localStorage.getItem(STORAGE_KEYS.STAFF)) || [];
    M_TEMPLATES = JSON.parse(localStorage.getItem(STORAGE_KEYS.TEMP)) || DEFAULT_TEMPLATES;
    
    document.getElementById('st_genba').innerText = M_GENBA.length + "ä»¶";
    document.getElementById('st_supp').innerText = M_SUPP.length + "ä»¶";
    // ä¿®æ­£: å›ºå®šè¡¨è¨˜ã‚’ã‚„ã‚ã€ä»¶æ•°ã¾ãŸã¯åˆæœŸå€¤ã‚’è¡¨ç¤º
    document.getElementById('st_prod').innerText = (storedProd ? M_PROD.length + "ä»¶" : "åˆæœŸå€¤(2ä»¶)");
    document.getElementById('st_staff').innerText = M_STAFF.length + "ä»¶";
    document.getElementById('st_temp').innerText = M_TEMPLATES.length + "ä»¶";
    
    // Datalistæ›´æ–°
    document.getElementById('suppOptions').innerHTML = M_SUPP.map(s => `<option value="${s.n}">${s.c}</option>`).join('');
    // ä¿®æ­£: å•†å“é¸æŠãƒœãƒƒã‚¯ã‚¹ã‚’ãƒã‚¹ã‚¿ã‹ã‚‰ç”Ÿæˆ
    updateProductSelect();
    
    // æ‹…å½“è€…ãƒªã‚¹ãƒˆã¯ ã‚³ãƒ¼ãƒ‰ : åå‰ å½¢å¼ã§ä½œæˆ
    // åˆæœŸçŠ¶æ…‹ã§ã¯å…¨ä»¶ã‚’è¡¨ç¤º
    updateStaffDatalist(M_STAFF);
    
    filterTemplates(); // Refresh template list
    loadDefaultStaff(); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ‹…å½“è€…åæ˜ 
}

// å•†å“ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹æ›´æ–°é–¢æ•°
function updateProductSelect() {
    const sel = document.getElementById('cmbProduct');
    const currentVal = sel.value; // ç¾åœ¨ã®é¸æŠå€¤ã‚’ä¿æŒ
    sel.innerHTML = M_PROD.map(p => `<option value="${p.c}">${p.n}</option>`).join('');
    
    // ä¿æŒã—ã¦ã„ãŸå€¤ãŒã‚ã‚Œã°å¾©å…ƒã€ãªã‘ã‚Œã°å…ˆé ­ã‚’é¸æŠ
    if (currentVal && M_PROD.some(p => p.c === currentVal)) {
        sel.value = currentVal;
    } else if (M_PROD.length > 0) {
        sel.value = M_PROD[0].c;
    }
    // è¡¨ç¤ºæ›´æ–°
    resolveProduct();
}

function clearMasters() { if(confirm("å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")){ localStorage.clear(); location.reload(); } }
function clearDetails() { if(confirm("å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ")) { initGrid(10); document.getElementById('txtInvoiceTotal').value = ""; calcTotal(); } }

// Paste Handler (ä¿®æ­£: ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã‹ã‚‰è²¼ã‚Šä»˜ã‘)
function setupPasteHandler() {
    document.getElementById('gridBody').addEventListener('paste', e => {
        // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªè¦ç´ ã‚’å–å¾— (ãƒšãƒ¼ã‚¹ãƒˆã®èµ·ç‚¹)
        const activeEl = document.activeElement;
        
        // inputã‚¿ã‚°ã§ãªã‘ã‚Œã°å‡¦ç†ã—ãªã„
        if (!activeEl || activeEl.tagName !== 'INPUT') return;
        
        // èµ·ç‚¹ã¨ãªã‚‹è¡Œã¨åˆ—ã‚’ç‰¹å®š
        const startRowTr = activeEl.closest('tr');
        if (!startRowTr) return;

        const gridBody = document.getElementById('gridBody');
        const rowsList = Array.from(gridBody.children);
        const startRowIdx = rowsList.indexOf(startRowTr);
        
        // èµ·ç‚¹ã®inputãŒãã®è¡Œã®ä¸­ã§ä½•ç•ªç›®ã®inputã‹ç‰¹å®š (hiddené™¤ã)
        const startRowInputs = Array.from(startRowTr.querySelectorAll('input:not([type=hidden])'));
        const startColIdx = startRowInputs.indexOf(activeEl);
        
        if (startRowIdx === -1 || startColIdx === -1) return;

        e.preventDefault();
        const clipboardData = (e.clipboardData || window.clipboardData).getData('text');
        const pasteRows = clipboardData.split(/\r\n|\n/).filter(r => r.trim() !== ""); // ç©ºè¡Œã¯ç„¡è¦–

        // è¡Œæ•°ãŒè¶³ã‚Šãªã„å ´åˆã¯äº‹å‰ã«è¿½åŠ 
        const neededRows = (startRowIdx + pasteRows.length) - rowsList.length;
        if (neededRows > 0) {
            addRows(neededRows);
        }
        
        // å†åº¦è¡Œãƒªã‚¹ãƒˆã‚’å–å¾—ï¼ˆè¿½åŠ ã•ã‚ŒãŸãŸã‚ï¼‰
        const updatedRowsList = document.querySelectorAll('#gridBody tr');

        pasteRows.forEach((r, i) => {
            const cols = r.split('\t');
            const targetRow = updatedRowsList[startRowIdx + i];
            
            if (targetRow) {
                const targetInputs = targetRow.querySelectorAll('input:not([type=hidden])');
                
                cols.forEach((c, j) => {
                    const targetInput = targetInputs[startColIdx + j];
                    // å­˜åœ¨ã™ã‚‹å ´åˆã®ã¿å€¤ã‚’ã‚»ãƒƒãƒˆ
                    if (targetInput) {
                        targetInput.value = c;
                        if (targetInput.classList.contains('job-code')) resolveJob(targetInput);
                        if (targetInput.classList.contains('amount-col')) handleAmountInput(targetInput);
                    }
                });
            }
        });
        calcTotal();
    });
}

// ----------------------------------------------------
// ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ©Ÿèƒ½ (ãƒªã‚¹ãƒˆè¡¨ç¤º & ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°)
// ----------------------------------------------------
function filterTemplates() {
    const selectedType = document.querySelector('input[name="purchaseType"]:checked').value;
    const list = document.getElementById('templateSelectBox');
    const searchVal = document.getElementById('templateSearch').value.toLowerCase(); // æ¤œç´¢èª
    
    list.innerHTML = "";
    
    const filtered = M_TEMPLATES.filter(t => {
        // ä»•å…¥ã‚ŒåŒºåˆ†ãŒä¸€è‡´ ã‹ã¤ æ¤œç´¢èªãŒåå‰ã«å«ã¾ã‚Œã‚‹
        return t.type === selectedType && t.label.toLowerCase().includes(searchVal);
    });
    
    if(filtered.length === 0) {
        list.innerHTML = `<div class="p-2 text-muted text-center small">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãªã—</div>`;
        return;
    }

    filtered.forEach((t) => {
        const originalIdx = M_TEMPLATES.indexOf(t);
        const div = document.createElement('div');
        div.className = 'template-item';
        div.innerHTML = `
            <div class="text-truncate flex-grow-1" onclick="applyTemplate(${originalIdx})">
                <div class="fw-bold small">${t.label}</div>
                <div class="text-muted" style="font-size:0.75rem;">${t.supp}</div>
            </div>
            <span class="template-del-btn" onclick="deleteTemplate(${originalIdx})">Ã—</span>
        `;
        list.appendChild(div);
    });
}

function applyTemplate(idx) {
    const t = M_TEMPLATES[idx];
    document.getElementById('cmbSupplier').value = t.supp || "";
    
    // å•†å“åãƒ»æ‹…å½“è€…ã¯ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‹ã‚‰åæ˜ ã—ãªã„ (ç¾çŠ¶ç¶­æŒ)
    // æ‹…å½“è€…ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šãŒç¶­æŒã•ã‚Œã‚‹ã€ã¾ãŸã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒåˆ¥é€”é¸æŠæ¸ˆã¿ã§ã‚ã‚Œã°ç¶­æŒã•ã‚Œã‚‹

    const radios = document.getElementsByName('purchaseType');
    for(let r of radios) { if(r.value === t.type) r.checked = true; }
    
    // ä»•å…¥å…ˆåã‹ã‚‰ã‚³ãƒ¼ãƒ‰ã‚’é€†å¼•ã
    resolveSupplier();
    resolveProduct();
}

function saveCurrentAsTemplate() {
    const lbl = prompt("ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå:"); if (!lbl) return;
    // å•†å“åãƒ»æ‹…å½“è€…ã¯ä¿å­˜ã—ãªã„
    const newTemp = {
        label: lbl,
        supp: document.getElementById('cmbSupplier').value,
        type: document.querySelector('input[name="purchaseType"]:checked').value
    };
    M_TEMPLATES.push(newTemp);
    localStorage.setItem(STORAGE_KEYS.TEMP, JSON.stringify(M_TEMPLATES));
    loadMasters(); 
}

function deleteTemplate(idx) {
    if(!confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
    M_TEMPLATES.splice(idx, 1);
    localStorage.setItem(STORAGE_KEYS.TEMP, JSON.stringify(M_TEMPLATES));
    loadMasters();
}

function resetDefaultTemplates() {
    if(!confirm("åˆæœŸåŒ–ã—ã¾ã™ã‹ï¼Ÿ")) return;
    localStorage.removeItem(STORAGE_KEYS.TEMP);
    location.reload();
}

function downloadTemplateCSV() {
    // å‡ºåŠ›å½¢å¼: ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå, ä»•å…¥ã‚ŒåŒºåˆ†, ä»•å…¥å…ˆå (3åˆ—ã®ã¿)
    let csv = "ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå,ä»•å…¥ã‚ŒåŒºåˆ†,ä»•å…¥å…ˆå\r\n";
    M_TEMPLATES.forEach(t => {
        csv += `${t.label},${t.type},${t.supp}\r\n`;
    });
    const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csv], { type: "text/csv;charset=utf-8" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "templates.csv";
    link.click();
}

function importTemplateCSV(input) {
    if (input.files.length === 0) return;
    const reader = new FileReader();
    reader.onload = e => {
        const rows = e.target.result.split(/\r\n|\n/).filter(r => r.trim());
        importTemplateData(rows.map(r => r.split(',')));
        input.value = ""; 
    };
    reader.readAsText(input.files[0], "Shift_JIS");
}

// ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ (Enter & Arrow Keys)
document.addEventListener('keydown', function(event) {
    const target = event.target;
    // excel-gridå†…ã®inputã®ã¿å¯¾è±¡
    if (target.tagName !== 'INPUT' || !target.closest('.excel-grid')) return;

    if (event.key === 'Enter') {
        event.preventDefault();
        moveFocus(target, 1, 0); // ä¸‹ã¸
    } else if (event.key === 'ArrowUp') {
        event.preventDefault();
        moveFocus(target, -1, 0); // ä¸Šã¸
    } else if (event.key === 'ArrowDown') {
        event.preventDefault();
        moveFocus(target, 1, 0); // ä¸‹ã¸
    } else if (event.key === 'ArrowLeft') {
        // ã‚«ãƒ¼ã‚½ãƒ«ãŒå…ˆé ­ã«ã‚ã‚‹å ´åˆã®ã¿å·¦ã¸ç§»å‹•
        if (canMoveLeft(target)) {
            event.preventDefault();
            moveFocus(target, 0, -1);
        }
    } else if (event.key === 'ArrowRight') {
        // ã‚«ãƒ¼ã‚½ãƒ«ãŒæœ«å°¾ã«ã‚ã‚‹å ´åˆã®ã¿å³ã¸ç§»å‹•
        if (canMoveRight(target)) {
            event.preventDefault();
            moveFocus(target, 0, 1);
        }
    }
});

function moveFocus(currentInput, rowDelta, colDelta) {
    const currentTd = currentInput.closest('td');
    const currentTr = currentTd.parentElement;
    const tbody = currentTr.parentElement;
    const rows = Array.from(tbody.children);
    const currentRowIdx = rows.indexOf(currentTr);
    const currentCells = Array.from(currentTr.cells);
    const currentCellIdx = currentCells.indexOf(currentTd);

    const targetRowIdx = currentRowIdx + rowDelta;
    // è¡Œç¯„å›²ãƒã‚§ãƒƒã‚¯
    if (targetRowIdx < 0 || targetRowIdx >= rows.length) return;

    const targetRow = rows[targetRowIdx];
    const targetCells = Array.from(targetRow.cells);
    let targetCellIdx = currentCellIdx + colDelta;

    if (targetCellIdx < 0 || targetCellIdx >= targetCells.length) return;
    
    const targetTd = targetCells[targetCellIdx];
    const targetInput = targetTd.querySelector('input:not([type=hidden])');

    if (targetInput && !targetInput.readOnly) {
        targetInput.focus();
        targetInput.select();
    }
}

function canMoveLeft(input) {
    if (input.type === 'number') return false; // numberã¯ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®å–å¾—ä¸å®‰å®šãªãŸã‚ç§»å‹•ãªã—ï¼ˆå®‰å…¨ç­–ï¼‰
    return input.selectionStart === 0 && input.selectionEnd === 0;
}

function canMoveRight(input) {
    if (input.type === 'number') return false; 
    return input.selectionStart === input.value.length;
}
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
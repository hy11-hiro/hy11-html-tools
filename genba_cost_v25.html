<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G-Ledger | ç¾å ´åŸä¾¡ç®¡ç†å°å¸³ã‚·ã‚¹ãƒ†ãƒ  v44</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://unpkg.com/dexie@3.2.4/dist/dexie.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <!-- ExcelJS & FileSaver -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&display=swap');
        body { font-family: 'Noto Sans JP', sans-serif; background-color: #f3f4f6; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .sidebar-link.active { background-color: #1e293b; color: #fff; border-left: 4px solid #3b82f6; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3b82f6; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .tab-btn { @apply px-4 py-3 text-sm font-bold text-slate-500 bg-white border border-slate-200 rounded-t-lg hover:bg-slate-50 hover:text-slate-700 transition-all whitespace-nowrap shadow-sm; margin-bottom: -1px; }
        .tab-btn.active { @apply text-blue-600 bg-white border-b-transparent border-t-2 border-t-blue-600 shadow-md z-10; }
        .tab-btn.tab-alert { @apply text-red-500 hover:text-red-700; }
        .tab-btn.active.tab-alert { @apply text-red-600 border-t-red-500; }
        .btn-group { @apply inline-flex rounded-md shadow-sm; }
        .btn-group-item { @apply px-4 py-2 text-sm font-medium border border-gray-300 bg-white text-gray-700 hover:bg-gray-50 focus:z-10 focus:ring-1 focus:ring-blue-500 focus:border-blue-500 transition-colors; }
        .btn-group-item:first-child { @apply rounded-l-md; }
        .btn-group-item:last-child { @apply rounded-r-md; }
        .btn-group-item.active { @apply bg-blue-600 text-white border-blue-600 hover:bg-blue-700; }
        #drop-zone { transition: all 0.3s ease; }
        #drop-zone.dragover { background-color: #eff6ff; border-color: #3b82f6; transform: scale(1.01); }
        .autocomplete-list { @apply absolute z-50 w-full bg-white border border-gray-300 rounded-b-lg shadow-lg max-h-60 overflow-y-auto mt-1; }
        .autocomplete-item { @apply px-4 py-2 cursor-pointer hover:bg-blue-50 text-sm text-gray-700 border-b border-gray-100 last:border-0; }
        th.sortable { @apply cursor-pointer hover:bg-slate-100 select-none; }
        th.sortable:after { content: 'â†•'; font-size: 0.7em; margin-left: 5px; color: #94a3b8; }
        th.sortable.asc:after { content: 'â†‘'; color: #3b82f6; }
        th.sortable.desc:after { content: 'â†“'; color: #3b82f6; }
        .badge-base { @apply inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium; }
        .badge-cost { @apply bg-indigo-100 text-indigo-800; }
        .badge-detail { @apply bg-green-100 text-green-800; }
        .badge-alert { @apply bg-red-100 text-red-800 border border-red-200; }
        
        .check-group { @apply flex items-center mb-2; }
        .check-input { @apply w-4 h-4 text-orange-600 bg-gray-100 border-gray-300 rounded focus:ring-orange-500 focus:ring-2; }
        .check-label { @apply ml-2 text-sm font-medium text-gray-900 cursor-pointer; }

        .pagination-btn { @apply px-3 py-1 border border-slate-300 bg-white text-slate-600 rounded text-sm hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors; }
        .pagination-btn.active { @apply bg-indigo-600 text-white border-indigo-600 hover:bg-indigo-700; }
    </style>
</head>
<body class="text-slate-800 h-screen flex overflow-hidden">

    <!-- Sidebar -->
    <aside class="w-64 bg-slate-900 text-slate-300 flex flex-col shadow-2xl z-20 flex-shrink-0">
        <div class="p-6 border-b border-slate-800 flex items-center gap-3">
            <div class="w-8 h-8 bg-blue-600 rounded flex items-center justify-center text-white font-bold">G</div>
            <h1 class="text-lg font-bold text-white tracking-wide">G-Ledger <span class="text-xs font-normal text-slate-400 block">System v44</span></h1>
        </div>
        <nav class="flex-1 overflow-y-auto py-4">
            <ul class="space-y-1">
                <li><button onclick="window.showPage('dashboard')" id="nav-dashboard" class="sidebar-link active w-full text-left px-6 py-3 hover:bg-slate-800 transition-colors flex items-center gap-3"><i class="fa-solid fa-magnifying-glass-chart"></i> ç¾å ´ç…§ä¼šãƒ»åˆ†æ</button></li>
                <li><button onclick="window.showPage('cost-search')" id="nav-cost-search" class="sidebar-link w-full text-left px-6 py-3 hover:bg-slate-800 transition-colors flex items-center gap-3"><i class="fa-solid fa-magnifying-glass-dollar"></i> åŸä¾¡æ¤œç´¢</button></li>
                <li><button onclick="window.showPage('ranking')" id="nav-ranking" class="sidebar-link w-full text-left px-6 py-3 hover:bg-slate-800 transition-colors flex items-center gap-3"><i class="fa-solid fa-chart-pie"></i> é›†è¨ˆãƒ»ãƒ©ãƒ³ã‚­ãƒ³ã‚°</button></li>
                <li><button onclick="window.showPage('check')" id="nav-check" class="sidebar-link w-full text-left px-6 py-3 hover:bg-slate-800 transition-colors flex items-center gap-3"><i class="fa-solid fa-list-check"></i> ãƒ‡ãƒ¼ã‚¿ãƒã‚§ãƒƒã‚¯</button></li>
                <li><button onclick="window.showPage('import')" id="nav-import" class="sidebar-link w-full text-left px-6 py-3 hover:bg-slate-800 transition-colors flex items-center gap-3"><i class="fa-solid fa-database"></i> ãƒ‡ãƒ¼ã‚¿å–è¾¼ãƒ»ç®¡ç†</button></li>
            </ul>
        </nav>
        <div class="p-4 border-t border-slate-800 text-xs text-slate-500"><div class="flex items-center gap-2 mb-2"><div class="w-2 h-2 rounded-full bg-green-500"></div>IndexedDB Active</div><p>&copy; 2025 Construction Cost Mgt.</p></div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col h-screen overflow-hidden relative bg-slate-100">
        <header class="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-8 shadow-sm z-10 flex-shrink-0">
            <h2 id="page-title" class="text-xl font-bold text-slate-700">ç¾å ´ç…§ä¼šãƒ»åˆ†æ</h2>
            <div class="flex items-center gap-4">
                <div id="header-period" class="text-xs font-bold text-slate-600 bg-slate-100 px-3 py-1 rounded border border-slate-300 hidden"><i class="fa-regular fa-clock mr-1"></i> ãƒ‡ãƒ¼ã‚¿æœŸé–“: <span id="period-text"></span></div>
                <div class="px-3 py-1 bg-blue-50 text-blue-700 rounded-full text-sm border border-blue-100"><i class="fa-solid fa-shield-halved mr-1"></i> ãƒ­ãƒ¼ã‚«ãƒ«ã‚»ã‚­ãƒ¥ã‚¢ãƒ¢ãƒ¼ãƒ‰</div>
            </div>
        </header>

        <div class="flex-1 overflow-auto p-6 relative">
            <!-- 1. DASHBOARD PAGE -->
            <div id="page-dashboard" class="page-content space-y-6">
                <!-- Single Search -->
                <div class="glass-panel p-8 rounded-xl max-w-4xl mx-auto">
                    <h3 class="text-lg font-bold mb-4 text-slate-600 text-center">ç¾å ´æ¤œç´¢</h3>
                    <div class="flex flex-col md:flex-row gap-6 justify-center">
                        <div class="relative w-full md:w-1/3">
                            <label class="block text-xs font-bold text-slate-400 mb-1 ml-1">ç¾å ´ã‚³ãƒ¼ãƒ‰æ¤œç´¢</label>
                            <div class="flex items-center">
                                <input type="text" id="search-input" placeholder="ä¾‹: 01, 100" class="w-full pl-4 pr-12 py-3 rounded-lg border border-slate-300 focus:outline-none focus:ring-2 focus:ring-blue-500 shadow-inner text-lg bg-white">
                                <button onclick="window.searchSite()" class="absolute right-1 top-7 bottom-1 px-3 bg-blue-600 hover:bg-blue-700 text-white rounded-md transition-colors h-10 my-auto"><i class="fa-solid fa-arrow-right"></i></button>
                            </div>
                        </div>
                        <div class="hidden md:flex items-center text-slate-300 font-bold pt-6">OR</div>
                        <div class="relative w-full md:w-1/2">
                            <label class="block text-xs font-bold text-slate-400 mb-1 ml-1">ç¾å ´åãƒ»æ–½å·¥ä¸»åã§æ¤œç´¢</label>
                            <div class="flex items-center relative">
                                <i class="fa-solid fa-magnifying-glass absolute left-3 text-slate-400"></i>
                                <input type="text" id="site-name-search" placeholder="ç¾å ´åã¾ãŸã¯æ–½å·¥ä¸»åã‚’å…¥åŠ›..." class="w-full pl-10 pr-4 py-3 rounded-lg border border-slate-300 focus:outline-none focus:ring-2 focus:ring-blue-500 shadow-inner text-lg bg-white" autocomplete="off">
                            </div>
                            <div id="site-autocomplete-list" class="autocomplete-list hidden"></div>
                        </div>
                    </div>
                    <!-- Clear Button -->
                    <div class="text-center mt-4">
                        <button onclick="window.clearSiteSearch()" class="text-sm text-slate-500 hover:text-slate-700 underline flex items-center justify-center mx-auto gap-1">
                            <i class="fa-solid fa-eraser"></i> æ¤œç´¢æ¡ä»¶ã¨çµæœã‚’ã‚¯ãƒªã‚¢
                        </button>
                    </div>
                    <p class="text-xs text-center text-slate-400 mt-3">â€»ã‚³ãƒ¼ãƒ‰ã€Œ01ã€ã¨ã€Œ1ã€ã¯åˆ¥æ‰±ã„ã§ã™ã€‚ã‚µãƒ–ã‚³ãƒ¼ãƒ‰ãŒã‚ã‚‹å ´åˆã¯ã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
                </div>

                <!-- Multi-Site Comparison -->
                <div id="multi-compare-panel" class="glass-panel p-6 rounded-xl max-w-4xl mx-auto border-t-4 border-indigo-500 transition-all duration-300 ease-in-out">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-base font-bold text-slate-700 flex items-center gap-2">
                            <i class="fa-solid fa-list-check text-indigo-500"></i>
                            è¤‡æ•°ç¾å ´ ç°¡æ˜“æ¯”è¼ƒãƒ»ä¸€è¦§
                        </h3>
                        <button onclick="document.getElementById('multi-compare-content').classList.toggle('hidden')" class="text-xs text-blue-600 hover:text-blue-800 underline">
                            <i class="fa-solid fa-chevron-down mr-1"></i>é–‹é–‰
                        </button>
                    </div>
                    
                    <div id="multi-compare-content" class="hidden animate-fade-in-up mt-4">
                        <div class="bg-indigo-50 p-4 rounded-lg mb-4">
                            <p class="text-xs text-indigo-800 mb-2 font-bold">å·¥ç•ªå…¥åŠ› (è¤‡æ•°å¯)</p>
                            <!-- UPDATED: Added placeholder for better guidance -->
                            <textarea id="multi-code-input" rows="3" class="w-full p-3 border border-indigo-200 rounded bg-white text-sm font-mono placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="å·¥ç•ªã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚&#13;&#10;è²¼ã‚Šä»˜ã‘ã‚‹ã¨è‡ªå‹•çš„ã«ã‚¹ãƒšãƒ¼ã‚¹åŒºåˆ‡ã‚Šã«å¤‰æ›ã•ã‚Œã¾ã™ã€‚&#13;&#10;ä¾‹: 0001 0002 0003"></textarea>
                            <div class="flex justify-between items-center mt-2">
                                <div class="flex items-center gap-4">
                                    <div class="bg-indigo-200 p-1 rounded-md flex">
                                        <button onclick="window.switchViewMode('card')" id="btn-view-card" class="px-3 py-1 rounded text-xs font-bold bg-white text-indigo-800 shadow-sm transition-all"><i class="fa-solid fa-grip mr-1"></i>ã‚«ãƒ¼ãƒ‰</button>
                                        <button onclick="window.switchViewMode('table')" id="btn-view-table" class="px-3 py-1 rounded text-xs font-bold text-indigo-600 hover:bg-indigo-100 hover:text-indigo-800 transition-all"><i class="fa-solid fa-table-list mr-1"></i>è¡¨å½¢å¼</button>
                                    </div>
                                    <div class="text-xs text-indigo-400">
                                        <i class="fa-solid fa-circle-info mr-1"></i>å…¥åŠ›ã•ã‚ŒãŸå…¨ã¦ã®ç¾å ´ã‚’è¡¨ç¤ºã—ã¾ã™
                                    </div>
                                </div>
                                <button onclick="window.compareSites()" class="bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-bold py-2 px-6 rounded shadow transition-colors flex items-center gap-2">
                                    <i class="fa-solid fa-magnifying-glass"></i> è¡¨ç¤ºå®Ÿè¡Œ
                                </button>
                            </div>
                        </div>

                        <div id="multi-result-container" class="hidden">
                            <div id="multi-content-area"></div>
                        </div>
                    </div>
                </div>

                <div id="search-result" class="hidden space-y-6 animate-fade-in-up">
                    <div class="grid grid-cols-1 md:grid-cols-12 gap-6">
                        <div class="md:col-span-8 glass-panel p-6 rounded-xl border-l-4 border-blue-600 relative">
                            <div class="absolute top-4 right-4 flex gap-2">
                                <button onclick="window.exportSiteReport()" class="bg-green-600 hover:bg-green-700 text-white text-xs font-bold py-2 px-4 rounded shadow flex items-center gap-2"><i class="fa-solid fa-file-excel"></i> Excelãƒ¬ãƒãƒ¼ãƒˆå‡ºåŠ›</button>
                                <button onclick="window.clearSiteSearch()" class="bg-slate-500 hover:bg-slate-600 text-white text-xs font-bold py-2 px-3 rounded shadow flex items-center gap-2"><i class="fa-solid fa-xmark"></i> é–‰ã˜ã‚‹</button>
                            </div>
                            <div class="flex justify-between items-start mb-2">
                                <span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded font-bold" id="res-code">CODE</span>
                                <span class="text-slate-500 text-sm" id="res-branch">æ‹ ç‚¹å</span>
                            </div>
                            <h2 class="text-2xl font-bold text-slate-800 mb-1" id="res-name">ç¾å ´åç§°</h2>
                            <div class="text-xs text-slate-500 mb-2 flex gap-2">
                                <span class="bg-slate-100 px-2 py-1 rounded">ç¾å ´ã‚µãƒ–åç§°: <span id="res-sub-name" class="font-bold">-</span></span>
                                <span class="bg-slate-100 px-2 py-1 rounded">ã‚µãƒ–ã‚³ãƒ¼ãƒ‰: <span id="res-sub-code" class="font-bold font-mono">-</span></span>
                            </div>
                            <div class="flex gap-4 mb-4">
                                <p class="text-slate-500"><span class="text-xs text-slate-400 block">æ–½å·¥ä¸»</span><span id="res-owner" class="font-bold">-</span></p>
                                <p class="text-slate-500"><span class="text-xs text-slate-400 block">å¾—æ„å…ˆ</span><span id="res-customer" class="font-bold">-</span></p>
                            </div>
                            <div id="res-subcodes-container" class="mb-4 hidden">
                                <h4 class="text-xs font-bold text-slate-500 mb-1"><i class="fa-solid fa-link mr-1"></i> ç´ã¥ãã‚µãƒ–ã‚³ãƒ¼ãƒ‰ (é–¢é€£å·¥äº‹)</h4>
                                <div id="res-subcodes-list" class="flex flex-wrap gap-2"></div>
                            </div>
                            <div class="grid grid-cols-4 gap-4 text-sm bg-slate-50 p-3 rounded-lg border border-slate-200">
                                <div><span class="block text-slate-400 text-xs">ç¾å ´ç›£ç£</span><span class="font-bold text-slate-700" id="res-manager">-</span></div>
                                <div><span class="block text-slate-400 text-xs">ç€æ‰‹æ—¥</span><span class="font-bold text-slate-700" id="res-start">-</span></div>
                                <div><span class="block text-slate-400 text-xs">å®Œäº†æ—¥</span><span class="font-bold text-slate-700" id="res-end">-</span></div>
                                <div><span class="block text-slate-400 text-xs">ç´æœŸ</span><span class="font-bold text-slate-700" id="res-delivery">-</span></div>
                            </div>
                        </div>
                        
                        <div class="md:col-span-4 glass-panel p-6 rounded-xl flex flex-col justify-center space-y-6">
                            <div class="text-center">
                                <span class="text-sm text-slate-500 font-bold uppercase tracking-wider block mb-1">ç²—åˆ©ç›Šç‡</span>
                                <div class="flex items-baseline justify-center gap-2">
                                    <span class="text-6xl font-extrabold text-blue-600" id="res-margin">0.0%</span>
                                </div>
                                <div class="w-full bg-slate-200 rounded-full h-3 mt-4 overflow-hidden">
                                    <div id="res-margin-bar" class="bg-blue-600 h-3 rounded-full transition-all duration-1000" style="width: 0%"></div>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 gap-4 pt-4 border-t border-slate-100">
                                <div class="flex justify-between items-end border-b border-slate-50 pb-2">
                                    <span class="text-sm text-slate-400 font-bold">å£²ä¸Šç´¯è¨ˆ(ç¨æŠœ)</span>
                                    <div class="text-3xl font-bold text-slate-800" id="res-sales">Â¥0</div>
                                </div>
                                <div class="flex justify-between items-end border-b border-slate-50 pb-2">
                                    <span class="text-sm text-slate-400 font-bold">åŸä¾¡ç´¯è¨ˆ</span>
                                    <div class="text-3xl font-bold text-slate-800" id="res-cost">Â¥0</div>
                                </div>
                                 <div class="flex justify-between items-end">
                                    <span class="text-sm text-slate-400 font-bold">ç²—åˆ©ç›Š (ç¨æŠœ)</span>
                                    <div class="text-xl font-bold text-slate-600" id="res-profit">Â¥0</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="glass-panel p-6 rounded-xl"><h4 class="font-bold text-slate-600 mb-4 border-l-4 border-indigo-500 pl-2">æœˆæ¬¡ å£²ä¸Š/åŸä¾¡ æ¨ç§» (ç¨æŠœ)</h4><div class="h-64"><canvas id="chart-trend"></canvas></div></div>
                        <div class="glass-panel p-6 rounded-xl"><h4 class="font-bold text-slate-600 mb-4 border-l-4 border-teal-500 pl-2">åŸä¾¡æ§‹æˆ (ä¸Šä½5è¦ç´ )</h4><div class="h-64 flex justify-center"><canvas id="chart-composition"></canvas></div></div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="glass-panel rounded-xl overflow-hidden"><div class="bg-slate-50 px-6 py-3 border-b border-slate-200 flex justify-between items-center"><div><h4 class="font-bold text-slate-600">å£²ä¸Šæ˜ç´°</h4><span class="text-[10px] text-slate-400">â€»ç¨æŠœãƒ»ç¨è¾¼ã‚’è¡¨ç¤º</span></div><span class="text-xs bg-white border border-slate-300 px-2 py-0.5 rounded text-slate-500" id="count-sales">0ä»¶</span></div><div class="overflow-y-auto max-h-80"><table class="w-full text-sm text-left"><thead class="text-xs text-slate-500 uppercase bg-slate-50 sticky top-0"><tr><th class="px-3 py-3">æ—¥ä»˜</th><th class="px-3 py-3">å¾—æ„å…ˆ</th><th class="px-3 py-3 text-right">é‡‘é¡(ç¨æŠœ)</th><th class="px-3 py-3 text-right text-slate-400">é‡‘é¡(ç¨è¾¼)</th></tr></thead><tbody id="table-sales-body" class="divide-y divide-slate-100"></tbody></table></div></div>
                        <div class="glass-panel rounded-xl overflow-hidden"><div class="bg-slate-50 px-6 py-3 border-b border-slate-200 flex justify-between items-center"><div><h4 class="font-bold text-slate-600">ä»•å…¥æ˜ç´° (åŸä¾¡)</h4><span class="text-[10px] text-slate-400">â€»ãƒ‡ãƒ¼ã‚¿å€¤ã‚’è¡¨ç¤º(ç¨æŠœ+ç¨)</span></div><span class="text-xs bg-white border border-slate-300 px-2 py-0.5 rounded text-slate-500" id="count-purchase">0ä»¶</span></div><div class="overflow-y-auto max-h-80"><table class="w-full text-sm text-left"><thead class="text-xs text-slate-500 uppercase bg-slate-50 sticky top-0"><tr><th class="px-3 py-3">æ—¥ä»˜</th><th class="px-3 py-3">æ¥­è€…å</th><th class="px-3 py-3">é …ç›®(ææ–™/å¤–æ³¨/æ®‹åœŸ)</th><th class="px-3 py-3 text-right">é‡‘é¡(ç¨æŠœ+ç¨)</th></tr></thead><tbody id="table-purchase-body" class="divide-y divide-slate-100"></tbody></table></div></div>
                    </div>
                </div>
            </div>
            
            <!-- 2. COST SEARCH PAGE -->
            <div id="page-cost-search" class="page-content hidden space-y-6">
                <div class="glass-panel p-8 rounded-xl"><h3 class="text-xl font-bold mb-4 text-slate-700 flex items-center"><i class="fa-solid fa-search mr-2"></i> åŸä¾¡æ¤œç´¢ (æ¥­è€…ãƒ»æ˜ç´°æ¤œç´¢)</h3><div class="flex flex-col md:flex-row gap-4 items-start"><div class="relative w-full md:w-1/2"><div class="flex items-center border border-slate-300 rounded-lg bg-white shadow-sm focus-within:ring-2 focus-within:ring-blue-500"><i class="fa-solid fa-magnifying-glass text-slate-400 ml-3"></i><input type="text" id="cost-search-input" placeholder="æ¥­è€…åã‚’å…¥åŠ› (ä¾‹: ã€‡ã€‡å»ºæ, éˆ´æœ¨...)" class="w-full p-3 focus:outline-none rounded-r-lg" autocomplete="off"></div><div id="cost-autocomplete-list" class="autocomplete-list hidden"></div></div><div class="w-full md:w-auto flex gap-2"><select id="cost-search-branch" class="p-3 border border-slate-300 rounded-lg bg-white text-sm font-bold"><option value="ALL">å…¨æ‹ ç‚¹</option></select></div></div><p class="text-xs text-slate-400 mt-2 ml-1">â€» ã‚¹ãƒšãƒ¼ã‚¹åŒºåˆ‡ã‚Šã§è¤‡æ•°ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å¯ã€‚Enterã‚­ãƒ¼ã§æ¤œç´¢ã€‚</p></div>
                <div id="cost-search-result" class="hidden space-y-6"><div class="grid grid-cols-1 md:grid-cols-3 gap-6"><div class="md:col-span-1 glass-panel p-6 rounded-xl border-l-4 border-green-500"><h4 class="text-sm text-slate-500 font-bold mb-1">é¸æŠä¸­ã®æ¥­è€…</h4><h2 id="cs-vendor-name" class="text-2xl font-bold text-slate-800 mb-4">-</h2><div class="grid grid-cols-2 gap-4 mb-4"><div><span class="text-xs text-slate-400 block">ç™ºç”Ÿç·é¡(ç¨æŠœ)</span><span id="cs-total-amount" class="text-xl font-bold text-slate-700">Â¥0</span></div><div><span class="text-xs text-slate-400 block">å–å¼•ä»¶æ•°</span><span id="cs-total-count" class="text-xl font-bold text-slate-700">0ä»¶</span></div></div><div><span class="text-xs text-slate-400 block mb-1">ä¸»ãªå“ç›®ã‚«ãƒ†ã‚´ãƒª</span><div id="cs-top-items" class="flex flex-wrap gap-1"></div></div></div><div class="md:col-span-2 glass-panel p-6 rounded-xl"><h4 class="font-bold text-slate-600 mb-4">æœˆåˆ¥ ç™ºç”Ÿé¡æ¨ç§»</h4><div class="h-64"><canvas id="chart-cost-trend"></canvas></div></div></div><div class="glass-panel p-6 rounded-xl"><h4 class="font-bold text-slate-600 mb-4">æœˆåˆ¥é›†è¨ˆè¡¨</h4><div class="overflow-x-auto"><table class="w-full text-sm text-left text-slate-500"><thead class="text-xs text-slate-700 uppercase bg-slate-50"><tr><th class="px-4 py-2">å¹´æœˆ</th><th class="px-4 py-2 text-right">ç™ºç”Ÿé¡(ç¨æŠœ)</th><th class="px-4 py-2 text-center">ä»¶æ•°</th><th class="px-4 py-2 text-center">æ§‹æˆæ¯”</th></tr></thead><tbody id="cs-table-monthly" class="bg-white border-b hover:bg-slate-50"></tbody></table></div></div><div class="glass-panel p-6 rounded-xl"><h4 class="font-bold text-slate-600 mb-4">é–¢é€£ã™ã‚‹å·¥ç•ªä¸€è¦§ (ã‚½ãƒ¼ãƒˆå¯èƒ½)</h4><div class="overflow-x-auto max-h-96"><table class="w-full text-sm text-left text-slate-500"><thead class="text-xs text-slate-700 uppercase bg-slate-50 sticky top-0"><tr><th class="px-4 py-2 sortable" onclick="window.sortCostDetails('date')">ç™ºç”Ÿæ—¥(æœˆ)</th><th class="px-4 py-2 sortable" onclick="window.sortCostDetails('code')">å·¥ç•ª</th><th class="px-4 py-2 sortable" onclick="window.sortCostDetails('name')">ç¾å ´å</th><th class="px-4 py-2 sortable" onclick="window.sortCostDetails('branch')">æ‹ ç‚¹</th><th class="px-4 py-2 sortable" onclick="window.sortCostDetails('item')">å“ç›®ãƒ»å‚™è€ƒ</th><th class="px-4 py-2 sortable text-right" onclick="window.sortCostDetails('amount')">é‡‘é¡</th></tr></thead><tbody id="cs-table-details" class="bg-white border-b hover:bg-slate-50"></tbody></table></div></div></div>
            </div>

            <!-- 3. RANKING PAGE -->
            <div id="page-ranking" class="page-content hidden space-y-6">
                <div class="flex flex-col md:flex-row justify-between items-center bg-white p-4 rounded-xl shadow-sm border border-slate-200 mb-4">
                    <div class="flex items-center gap-2 mb-2 md:mb-0"><label class="text-sm font-bold text-slate-600">é›†è¨ˆæœŸé–“ (å®Œäº†æ—¥):</label><input type="date" id="rank-date-start" class="border rounded p-1 text-sm"><span class="text-slate-400">ï½</span><input type="date" id="rank-date-end" class="border rounded p-1 text-sm"><button onclick="window.applyDateFilter()" class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700">é©ç”¨</button></div><div id="rank-date-status" class="text-xs text-red-500 font-bold"></div>
                </div>
                <div class="flex items-end gap-2 border-b border-slate-300 mb-6 overflow-x-auto px-2 pb-1">
                    <button onclick="window.switchRankingTab('owner')" id="tab-owner" class="tab-btn active"><i class="fa-solid fa-building-user mr-1"></i> æ–½å·¥ä¸»åˆ¥</button>
                    <button onclick="window.switchRankingTab('branch')" id="tab-branch" class="tab-btn"><i class="fa-solid fa-map-location-dot mr-1"></i> æ‹ ç‚¹åˆ¥é›†è¨ˆ</button>
                    <button onclick="window.switchRankingTab('manager')" id="tab-manager" class="tab-btn"><i class="fa-solid fa-user-tie mr-1"></i> æ‹…å½“è€…åˆ¥</button>
                    <button onclick="window.switchRankingTab('worst')" id="tab-worst" class="tab-btn tab-alert"><i class="fa-solid fa-triangle-exclamation mr-1"></i> åˆ©ç›Šç‡ãƒ¯ãƒ¼ã‚¹ãƒˆ</button>
                    <div class="border-l border-slate-300 h-6 mx-2"></div>
                    <button onclick="window.switchRankingTab('monthly-manager')" id="tab-monthly-manager" class="tab-btn bg-green-50 hover:bg-green-100 text-green-700"><i class="fa-solid fa-users-viewfinder mr-1"></i> æœˆåˆ¥ãƒ»æ‹ ç‚¹å†…</button>
                    <button onclick="window.switchRankingTab('month')" id="tab-month" class="tab-btn bg-green-50 hover:bg-green-100 text-green-700"><i class="fa-solid fa-calendar-days mr-1"></i> æœˆæ¬¡æ¨ç§»</button>
                </div>
                <!-- 1. Owner Ranking -->
                <div id="ranking-owner" class="ranking-tab-content space-y-6">
                    <div class="glass-panel p-6 rounded-xl">
                        <div class="flex justify-between items-center mb-6"><div><h3 class="text-lg font-bold text-slate-700">æ–½å·¥ä¸»åˆ¥ ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h3><span class="badge-base badge-cost">ğŸ› ï¸ é›†è¨ˆãƒ™ãƒ¼ã‚¹: åŸä¾¡é›†è¨ˆ (å®Œäº†æ—¥åŸºæº–ãƒ»ç¨æŠœ)</span></div><div class="flex items-center gap-4"><select id="rank-owner-branch" onchange="window.renderOwnerRanking()" class="text-sm border rounded p-1 font-bold"><option value="ALL">å…¨æ‹ ç‚¹</option></select><select id="rank-sort-owner" onchange="window.renderOwnerRanking()" class="text-sm border rounded p-1"><option value="profit">åˆ©ç›Šé¡é †</option><option value="sales">å£²ä¸Šé«˜é †</option></select></div></div>
                        <div class="overflow-x-auto"><table class="w-full text-sm text-left text-slate-500"><thead class="text-xs text-slate-700 uppercase bg-slate-50"><tr><th class="px-6 py-3">é †ä½</th><th class="px-6 py-3">æ–½å·¥ä¸»å</th><th class="px-6 py-3 text-right">ç·å£²ä¸Š(ç¨æŠœ)</th><th class="px-6 py-3 text-right">ç·åŸä¾¡</th><th class="px-6 py-3 text-right">ç·åˆ©ç›Š(ç¨æŠœ)</th><th class="px-6 py-3 text-right">ç²—åˆ©ç‡</th><th class="px-6 py-3 text-center">ç¾å ´æ•°</th></tr></thead><tbody id="ranking-body-owner" class="bg-white border-b hover:bg-slate-50"></tbody></table></div>
                    </div>
                </div>
                <!-- 2. Branch Ranking -->
                <div id="ranking-branch" class="ranking-tab-content hidden space-y-6">
                    <div class="glass-panel p-6 rounded-xl mb-6"><div><h3 class="text-lg font-bold text-slate-700 mb-2">æ‹ ç‚¹åˆ¥ æç›Šé›†è¨ˆ</h3><span class="badge-base badge-cost mb-4">ğŸ› ï¸ é›†è¨ˆãƒ™ãƒ¼ã‚¹: åŸä¾¡é›†è¨ˆ (å®Œäº†æ—¥åŸºæº–ãƒ»ç¨æŠœ)</span></div><div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6"><div class="h-64 flex justify-center"><canvas id="chart-branch-sales"></canvas></div><div class="h-64 flex justify-center"><canvas id="chart-branch-profit"></canvas></div></div><div class="overflow-x-auto"><table class="w-full text-sm text-left text-slate-500"><thead class="text-xs text-slate-700 uppercase bg-slate-50"><tr><th class="px-6 py-3">é †ä½</th><th class="px-6 py-3">æ‹ ç‚¹å</th><th class="px-6 py-3 text-right">ç·å£²ä¸Š(ç¨æŠœ)</th><th class="px-6 py-3 text-right">ç·åŸä¾¡</th><th class="px-6 py-3 text-right">ç·åˆ©ç›Š(ç¨æŠœ)</th><th class="px-6 py-3 text-right">ç²—åˆ©ç‡</th><th class="px-6 py-3 text-center">ç¾å ´æ•°</th></tr></thead><tbody id="ranking-body-branch" class="bg-white border-b hover:bg-slate-50"></tbody></table></div></div>
                </div>
                <!-- 3. Manager Ranking -->
                <div id="ranking-manager" class="ranking-tab-content hidden space-y-6">
                    <div class="glass-panel p-6 rounded-xl">
                        <div class="flex flex-wrap justify-between items-center mb-6 gap-4"><div><h3 class="text-lg font-bold text-slate-700">æ‹…å½“è€…åˆ¥ ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h3><span class="badge-base badge-cost">ğŸ› ï¸ é›†è¨ˆãƒ™ãƒ¼ã‚¹: åŸä¾¡é›†è¨ˆ (å®Œå·¥æ—¥åŸºæº–ãƒ»ç¨æŠœ)</span></div><div class="flex items-center gap-2"><select id="rank-manager-month" onchange="window.renderManagerRanking()" class="text-sm border rounded p-1 bg-slate-50"></select><select id="rank-manager-branch" onchange="window.renderManagerRanking()" class="text-sm border rounded p-1 bg-slate-50"><option value="ALL">å…¨æ‹ ç‚¹</option></select><div class="border-l border-slate-300 h-6 mx-2"></div><select id="rank-sort-manager" onchange="window.renderManagerRanking()" class="text-sm border rounded p-1"><option value="profit">åˆ©ç›Šé¡é †</option><option value="sales">å£²ä¸Šé«˜é †</option><option value="margin">ç²—åˆ©ç‡é †</option><option value="count">ç¾å ´æ•°é †</option></select></div></div>
                        <div class="overflow-x-auto"><table class="w-full text-sm text-left text-slate-500"><thead class="text-xs text-slate-700 uppercase bg-slate-50"><tr><th class="px-6 py-3">é †ä½</th><th class="px-6 py-3">æ‹…å½“è€…å</th><th class="px-6 py-3 text-right">ç·å£²ä¸Š(ç¨æŠœ)</th><th class="px-6 py-3 text-right">ç·åŸä¾¡</th><th class="px-6 py-3 text-right">ç·åˆ©ç›Š(ç¨æŠœ)</th><th class="px-6 py-3 text-right">ç²—åˆ©ç‡</th><th class="px-6 py-3 text-center">ç¾å ´æ•°</th></tr></thead><tbody id="ranking-body-manager" class="bg-white border-b hover:bg-slate-50"></tbody></table></div>
                    </div>
                </div>
                <!-- 4. Monthly Manager/Owner Ranking -->
                <div id="ranking-monthly-manager" class="ranking-tab-content hidden space-y-6">
                    <div class="glass-panel p-6 rounded-xl border-l-4 border-green-500">
                        <div class="flex flex-wrap justify-between items-center mb-6 gap-4"><div><h3 class="text-lg font-bold text-slate-700">æœˆåˆ¥ãƒ»æ‹ ç‚¹å†…ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h3><span class="badge-base badge-detail">ğŸ“… é›†è¨ˆãƒ™ãƒ¼ã‚¹: æ˜ç´°ãƒ‡ãƒ¼ã‚¿ (ç™ºç”Ÿæ—¥åŸºæº–ãƒ»ç¨æŠœ)</span></div><div class="btn-group"><button onclick="window.setMonthlyMode('manager')" id="btn-mode-manager" class="btn-group-item active">æ‹…å½“è€…åˆ¥</button><button onclick="window.setMonthlyMode('owner')" id="btn-mode-owner" class="btn-group-item">æ–½å·¥ä¸»åˆ¥</button></div><div class="flex gap-2"><select id="mm-filter-month" onchange="window.renderMonthlyManagerRanking()" class="text-sm border rounded p-1"></select><select id="mm-filter-branch" onchange="window.renderMonthlyManagerRanking()" class="text-sm border rounded p-1"><option value="ALL">å…¨æ‹ ç‚¹</option></select></div></div>
                        <div class="overflow-x-auto"><table class="w-full text-sm text-left text-slate-500"><thead class="text-xs text-slate-700 uppercase bg-slate-50"><tr><th class="px-6 py-3">é †ä½</th><th class="px-6 py-3" id="mm-header-name">æ‹…å½“è€…å</th><th class="px-6 py-3">æ‹ ç‚¹</th><th class="px-6 py-3 text-right">å£²ä¸Š(ç¨æŠœ)</th><th class="px-6 py-3 text-right text-slate-300">-</th><th class="px-6 py-3 text-right text-slate-300">-</th></tr></thead><tbody id="ranking-body-monthly-manager" class="bg-white border-b hover:bg-slate-50"></tbody></table></div>
                    </div>
                </div>
                <!-- 5. Monthly Trend -->
                <div id="ranking-month" class="ranking-tab-content hidden space-y-6">
                    <div class="glass-panel p-6 rounded-xl border-l-4 border-green-500">
                        <div class="flex justify-between items-center mb-6"><div><h3 class="text-lg font-bold text-slate-700">æœˆæ¬¡å£²ä¸Šãƒ»åŸä¾¡æ¨ç§»</h3><span class="badge-base badge-detail">ğŸ“… é›†è¨ˆãƒ™ãƒ¼ã‚¹: æ˜ç´°ãƒ‡ãƒ¼ã‚¿ (ç™ºç”Ÿæ—¥åŸºæº–ãƒ»ç¨æŠœ)</span></div><div class="flex items-center gap-2 bg-slate-50 p-2 rounded border"><span class="text-sm text-slate-500 font-bold">è¡¨ç¤ºå¯¾è±¡:</span><select id="month-filter-branch" onchange="window.renderMonthlyRanking()" class="text-sm border-none bg-transparent font-bold text-slate-700 focus:ring-0"><option value="ALL">å…¨ç¤¾</option></select></div></div>
                        <div class="h-80 mb-8"><canvas id="chart-monthly-total"></canvas></div>
                        <div class="overflow-x-auto"><table class="w-full text-sm text-left text-slate-500 border-collapse border border-slate-200"><thead class="text-xs text-slate-700 uppercase bg-slate-50" id="monthly-table-head"></thead><tbody id="ranking-table-month" class="bg-white"></tbody><tfoot id="ranking-footer-month" class="bg-slate-100 font-bold"></tfoot></table></div>
                    </div>
                </div>
                 <!-- 6. Worst Ranking -->
                 <div id="ranking-worst" class="ranking-tab-content hidden space-y-6">
                    <div class="glass-panel p-6 rounded-xl border-l-4 border-red-500">
                        <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                            <div><h3 class="text-lg font-bold text-red-600">åˆ©ç›Šç‡ãƒ¯ãƒ¼ã‚¹ãƒˆåˆ†æ</h3><span class="badge-base badge-cost">ğŸ› ï¸ é›†è¨ˆãƒ™ãƒ¼ã‚¹: åŸä¾¡é›†è¨ˆ (å®Œäº†æ—¥åŸºæº–ãƒ»ç¨æŠœ)</span></div>
                            <div class="flex flex-wrap items-center gap-2">
                                <button onclick="window.exportWorstExcel()" class="bg-green-600 hover:bg-green-700 text-white text-xs font-bold py-1 px-3 rounded flex items-center gap-1 mr-4 shadow"><i class="fa-solid fa-file-excel"></i> Excelå‡ºåŠ›</button>
                                <div class="btn-group mr-4"><button onclick="window.setWorstType('ranking')" id="btn-wt-ranking" class="btn-group-item active">å…¨ä½“ãƒ©ãƒ³ã‚­ãƒ³ã‚°</button><button onclick="window.setWorstType('alert')" id="btn-wt-alert" class="btn-group-item">ä½åˆ©ç›Šç‡ã‚¢ãƒ©ãƒ¼ãƒˆ (20%ä»¥ä¸‹)</button></div>
                                <div id="worst-controls-ranking" class="flex items-center gap-2"><span class="text-sm text-slate-500">é †åº:</span><div class="btn-group"><button onclick="window.setWorstSort('rate')" id="btn-worst-rate" class="btn-group-item active text-red-600">åˆ©ç›Šç‡é †</button><button onclick="window.setWorstSort('amount')" id="btn-worst-amount" class="btn-group-item">åˆ©ç›Šé¡é †</button></div></div>
                                <div id="worst-controls-alert" class="hidden flex items-center gap-2"><span class="badge-base badge-alert mr-2"><i class="fa-solid fa-triangle-exclamation mr-1"></i>20%ä»¥ä¸‹æŠ½å‡º</span><select id="worst-alert-month" onchange="window.renderWorstRanking()" class="text-sm border rounded p-1 bg-red-50 text-red-900 border-red-200"></select><select id="worst-alert-branch" onchange="window.renderWorstRanking()" class="text-sm border rounded p-1 bg-red-50 text-red-900 border-red-200"><option value="ALL">å…¨æ‹ ç‚¹</option></select></div>
                            </div>
                        </div>
                        <div class="overflow-x-auto"><table class="w-full text-sm text-left text-slate-500"><thead class="text-xs text-slate-700 uppercase bg-red-50"><tr><th class="px-6 py-3">é †ä½</th><th class="px-6 py-3">å·¥ç•ª</th><th class="px-6 py-3">ç¾å ´å</th><th class="px-6 py-3">æ‹…å½“è€…</th><th class="px-6 py-3">æ–½å·¥ä¸»</th><th class="px-6 py-3">æ‹ ç‚¹/å®Œå·¥</th><th class="px-6 py-3 text-right">ç²—åˆ©ç‡</th><th class="px-6 py-3 text-right">ç·åˆ©ç›Š(ç¨æŠœ)</th><th class="px-6 py-3 text-right">ç·å£²ä¸Š(ç¨æŠœ)</th></tr></thead><tbody id="ranking-body-worst" class="bg-white border-b hover:bg-slate-50"></tbody></table></div>
                    </div>
                </div>
            </div>
            
            <!-- 4. DATA CHECK PAGE (NEW TAB) -->
            <div id="page-check" class="page-content hidden max-w-4xl mx-auto space-y-6">
                <div class="bg-white p-6 rounded-xl border-b border-slate-200 shadow-sm mb-4">
                    <h2 class="text-xl font-bold text-slate-700 flex items-center gap-2">
                        <i class="fa-solid fa-list-check text-blue-500"></i> ãƒ‡ãƒ¼ã‚¿ä¸å‚™ãƒ»æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
                    </h2>
                    <p class="text-sm text-slate-500 mt-2">å–ã‚Šè¾¼ã‚“ã ãƒ‡ãƒ¼ã‚¿ã®å¿…é ˆé …ç›®æ¼ã‚Œã‚„ã€å£²ä¸Šãƒ»åŸä¾¡ã®æ•´åˆæ€§ï¼ˆ0å††ãƒ‡ãƒ¼ã‚¿ç­‰ï¼‰ã‚’ãƒã‚§ãƒƒã‚¯ã—ã€Excelãƒ¬ãƒãƒ¼ãƒˆã‚’å‡ºåŠ›ã—ã¾ã™ã€‚</p>
                </div>

                <!-- 1. Master Data Check -->
                <div class="glass-panel p-6 rounded-xl border-l-4 border-orange-400">
                    <h4 class="font-bold text-slate-700 mb-3 flex items-center gap-2"><i class="fa-solid fa-clipboard-check text-orange-500"></i> ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ä¸å‚™ãƒã‚§ãƒƒã‚¯</h4>
                    <div class="bg-orange-50 p-4 rounded-lg mb-4">
                        <p class="text-xs text-orange-800 font-bold mb-2">ãƒã‚§ãƒƒã‚¯å¯¾è±¡è¨­å®š:</p>
                        <div class="flex flex-col gap-3 mb-4">
                            <div class="flex items-center">
                                <i class="fa-solid fa-filter text-orange-500 mr-2"></i>
                                <span class="text-xs font-bold text-slate-700 mr-2">å¯¾è±¡ç¯„å›²:</span>
                                <span class="text-xs bg-orange-200 text-orange-900 px-2 py-1 rounded font-bold">åŸä¾¡ãƒ‡ãƒ¼ã‚¿ã«å­˜åœ¨ã™ã‚‹å·¥ç•ªã®ã¿å¯¾è±¡</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <i class="fa-regular fa-calendar-check text-orange-500 mr-1"></i>
                                <span class="text-xs font-bold text-slate-700">å®Œäº†æ—¥ æœŸé–“æŒ‡å®š (YYYYMMDD):</span>
                                <input type="number" id="chk-period-start" placeholder="é–‹å§‹ (ä¾‹:20250401)" class="text-xs border rounded p-1 w-28 bg-white focus:outline-none focus:ring-1 focus:ring-orange-500">
                                <span class="text-xs text-slate-400">ï½</span>
                                <input type="number" id="chk-period-end" placeholder="çµ‚äº† (ä¾‹:20250630)" class="text-xs border rounded p-1 w-28 bg-white focus:outline-none focus:ring-1 focus:ring-orange-500">
                            </div>
                            <p class="text-[10px] text-slate-400 ml-6">â€»æœŸé–“ã‚’æŒ‡å®šã™ã‚‹ã¨ã€å®Œäº†æ—¥ãŒãã®ç¯„å›²ã«å«ã¾ã‚Œã‚‹ç¾å ´ã®ã¿ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã™ã€‚</p>
                        </div>
                        
                        <p class="text-xs font-bold text-slate-700 mb-2">ãƒã‚§ãƒƒã‚¯é …ç›® (é¸æŠå¯):</p>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-2 mb-3">
                            <div class="check-group"><input type="checkbox" id="chk-name" checked class="check-input"><label for="chk-name" class="check-label">ç¾å ´å</label></div>
                            <div class="check-group"><input type="checkbox" id="chk-customer" checked class="check-input"><label for="chk-customer" class="check-label">å¾—æ„å…ˆå</label></div>
                            <div class="check-group"><input type="checkbox" id="chk-owner" checked class="check-input"><label for="chk-owner" class="check-label">æ–½å·¥ä¸»</label></div>
                            <div class="check-group"><input type="checkbox" id="chk-manager" checked class="check-input"><label for="chk-manager" class="check-label">æ‹…å½“è€…</label></div>
                            <div class="check-group"><input type="checkbox" id="chk-branch" checked class="check-input"><label for="chk-branch" class="check-label">æ‹ ç‚¹</label></div>
                            <div class="check-group"><input type="checkbox" id="chk-start" checked class="check-input"><label for="chk-start" class="check-label">ç€æ‰‹æ—¥</label></div>
                            <div class="check-group"><input type="checkbox" id="chk-end" checked class="check-input"><label for="chk-end" class="check-label">å®Œäº†æ—¥</label></div>
                            <div class="check-group"><input type="checkbox" id="chk-delivery" checked class="check-input"><label for="chk-delivery" class="check-label">ç´æœŸ</label></div>
                            <div class="check-group"><input type="checkbox" id="chk-subname" class="check-input"><label for="chk-subname" class="check-label">ç¾å ´ã‚µãƒ–åç§°</label></div>
                        </div>
                        <p class="text-[10px] text-orange-600">â€»ãƒã‚§ãƒƒã‚¯ONã«ã—ãŸé …ç›®ãŒã€Œç©ºæ¬„ã€ã¾ãŸã¯ã€Œ0ã€ã®å ´åˆã«ä¸å‚™ã¨ã—ã¦ãƒªã‚¹ãƒˆã‚¢ãƒƒãƒ—ã—ã¾ã™ã€‚</p>
                    </div>
                    <div class="text-right">
                        <button onclick="window.exportMasterCheck()" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-6 rounded-lg shadow flex items-center gap-2 ml-auto">
                            <i class="fa-solid fa-file-circle-exclamation"></i> ä¸å‚™ãƒã‚§ãƒƒã‚¯ãƒ¬ãƒãƒ¼ãƒˆå‡ºåŠ›
                        </button>
                    </div>
                </div>

                <!-- 2. Cost Integrity Check -->
                <div class="glass-panel p-6 rounded-xl border-l-4 border-red-500">
                    <h4 class="font-bold text-slate-700 mb-3 flex items-center gap-2"><i class="fa-solid fa-file-invoice-dollar text-red-500"></i> åŸä¾¡ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯</h4>
                    <div class="bg-red-50 p-4 rounded-lg mb-4">
                        <p class="text-xs text-red-800 font-bold mb-2">ãƒã‚§ãƒƒã‚¯æ¡ä»¶ (å£²ä¸Š/åŸä¾¡ 0å††æ¤œå‡º):</p>
                        <ul class="list-disc list-inside space-y-1 text-xs text-red-700">
                            <li><strong>å®Œäº†æ¸ˆã‹ã¤ãƒ‡ãƒ¼ã‚¿0:</strong> 8æ¡ã®å®Œäº†æ—¥ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã‚‹ã®ã«ã€å£²ä¸Šã¾ãŸã¯åŸä¾¡ãŒã€Œ0ã€ã®ãƒ‡ãƒ¼ã‚¿</li>
                            <li><strong>é€²è¡Œä¸­ãƒ»æœªè¨ˆä¸Š:</strong> å®Œäº†æ—¥ãŒæœªå…¥åŠ›(ã¾ãŸã¯0)ã ãŒã€å£²ä¸Šã¾ãŸã¯åŸä¾¡ãŒã€Œ0ã€ã®ãƒ‡ãƒ¼ã‚¿</li>
                        </ul>
                        <p class="text-[10px] text-red-600 mt-3">â€»åŸä¾¡é›†è¨ˆãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ãã€ã©ã¡ã‚‰ã‹ãŒ0å††ã®å ´åˆã«ãƒªã‚¹ãƒˆã‚¢ãƒƒãƒ—ã—ã¾ã™ã€‚</p>
                    </div>
                    <div class="text-right">
                        <button onclick="window.exportCostCheck()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg shadow flex items-center gap-2 ml-auto">
                            <i class="fa-solid fa-file-circle-xmark"></i> æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ãƒ¬ãƒãƒ¼ãƒˆå‡ºåŠ›
                        </button>
                    </div>
                </div>
            </div>

            <div id="page-import" class="page-content hidden max-w-4xl mx-auto space-y-6">
                <div id="drop-zone" class="glass-panel p-10 rounded-xl border-2 border-dashed border-blue-300 text-center cursor-pointer hover:bg-blue-50 transition-colors relative"><input type="file" id="file-input-multi" multiple class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="handleFileSelect(this.files)"><div class="pointer-events-none"><i class="fa-solid fa-cloud-arrow-up text-6xl text-blue-400 mb-4"></i><h3 class="text-xl font-bold text-slate-700 mb-2">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã“ã“ã«ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—</h3><p class="text-slate-500 mb-4">ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</p></div></div><div class="glass-panel p-6 rounded-xl border border-red-100"><div class="bg-red-50 border-l-4 border-red-500 p-4 mb-6 rounded-r"><div class="flex items-center gap-2 text-red-700 font-bold mb-1"><i class="fa-solid fa-triangle-exclamation"></i><span>ã”æ³¨æ„ï¼šãƒ‡ãƒ¼ã‚¿ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™</span></div><p class="text-sm text-red-600">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–ã‚Šè¾¼ã‚€ã¨ã€ä»¥å‰ã®ãƒ‡ãƒ¼ã‚¿ã¯å…¨ã¦<strong>å‰Šé™¤ãƒ»ä¸Šæ›¸ã</strong>ã•ã‚Œã¾ã™ã€‚</p></div><h4 class="font-bold text-slate-600 mb-3">å–ã‚Šè¾¼ã¿ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h4><div id="import-log" class="bg-slate-800 text-green-400 font-mono text-xs p-4 rounded h-40 overflow-y-auto mb-4">å¾…æ©Ÿä¸­...</div><div class="flex justify-end gap-3"><button id="btn-process-files" onclick="window.processDroppedFiles()" disabled class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg shadow disabled:bg-slate-400 disabled:cursor-not-allowed flex items-center gap-2"><span id="import-spinner" class="loader hidden"></span><span>ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ›´æ–°ã‚’å®Ÿè¡Œ</span></button></div></div>
                <div class="glass-panel p-6 rounded-xl"><h4 class="font-bold text-slate-600 mb-4">ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ç™»éŒ²çŠ¶æ³</h4><div class="grid grid-cols-4 gap-4 text-center"><div class="p-3 bg-white rounded border border-slate-200"><div class="text-xs text-slate-500">åŸä¾¡é›†è¨ˆ</div><div class="text-xl font-bold text-slate-800" id="db-count-cost">-</div></div><div class="p-3 bg-white rounded border border-slate-200"><div class="text-xs text-slate-500">ç¾å ´ãƒã‚¹ã‚¿ãƒ¼</div><div class="text-xl font-bold text-slate-800" id="db-count-master">-</div></div><div class="p-3 bg-white rounded border border-slate-200"><div class="text-xs text-slate-500">ä»•å…¥æ˜ç´°</div><div class="text-xl font-bold text-slate-800" id="db-count-purchase">-</div></div><div class="p-3 bg-white rounded border border-slate-200"><div class="text-xs text-slate-500">å£²ä¸Šæ˜ç´°</div><div class="text-xl font-bold text-slate-800" id="db-count-sales">-</div></div></div><div class="mt-4 text-right"><button onclick="window.clearDatabase()" class="text-xs text-red-500 hover:text-red-700 underline">å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã™ã‚‹</button></div></div>
            </div>
        </div>
    </main>

<script>
    // 1. DB Config
    const db = new Dexie("ConstructionLedgerDB_System_v44_MultiInputFix"); 
    db.version(1).stores({ costs: 'code', masters: 'code, owner, branch, manager', purchases: '++id, siteCode, date, vendor', sales: '++id, siteCode, date', meta: 'key' });
    
    // 2. Global Vars
    let pendingFiles = { cost: null, master: null, purchase: null, sales: null };
    let currentMonthlyMode = 'manager'; 
    let currentWorstType = 'ranking'; 
    let currentWorstSort = 'rate';    
    let rankingFilter = { start: null, end: null };
    let currentCostDetails = [];
    let currentCostVendor = null;
    let costSortState = { key: 'date', order: 'desc' };
    let currentWorstList = []; 
    let currentSiteData = null; 
    let multiCompareData = [];
    let currentViewMode = 'card';
    let chartBranchSales = null, chartBranchProfit = null, chartMonthly = null, chartCostTrend = null, chartTrend = null, chartComposition = null;
    let cachedMasters = [];
    let cachedVendors = [];
    let dropZone, importLog, processBtn;

    // 3. Helper Functions & Core Utilities (MOVED TO TOP)
    window.destroyChart = function(chartInstance) {
        if (chartInstance) { try { chartInstance.destroy(); } catch(e) { console.warn("Chart destroy error", e); } }
        return null;
    }
    window.formatCurrency = function(n) { return new Intl.NumberFormat('ja-JP', { style: 'currency', currency: 'JPY' }).format(n); }
    window.normalizeStr = function(s) { return s.replace(/[ï¼¡-ï¼ºï½-ï½šï¼-ï¼™]/g, function(s) { return String.fromCharCode(s.charCodeAt(0) - 0xFEE0); }).toLowerCase().replace(/\s+/g, ''); }

    window.toISODate = function(m) { 
        const y = parseInt(m[1]) + 2000; 
        const mo = String(m[2]).padStart(2,'0'); 
        const d = String(m[3]).padStart(2,'0'); 
        return `${y}-${mo}-${d}`; 
    }
    
    window.parseAndSetDefaultPeriod = function(text) {
        const regex = /(\d{1,2})å¹´\s*(\d{1,2})æœˆ\s*(\d{1,2})æ—¥/g; 
        const matches = [...text.matchAll(regex)];
        const startEl = document.getElementById('rank-date-start');
        const endEl = document.getElementById('rank-date-end');
        const statusEl = document.getElementById('rank-date-status');

        if (matches.length >= 1) {
            const start = window.toISODate(matches[0]); 
            const end = matches.length >= 2 ? window.toISODate(matches[1]) : null;
            if (start && startEl) startEl.value = start;
            if (end && endEl) endEl.value = end;
            if (start) rankingFilter = { start, end: end || start };
            if (statusEl) statusEl.textContent = "";
        } else {
            const today = new Date(); 
            const s = `${today.getFullYear()}-01-01`; 
            const e = `${today.getFullYear()}-12-31`;
            if(startEl) startEl.value = s; 
            if(endEl) endEl.value = e; 
            if(statusEl) statusEl.textContent = "â€»ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæœŸé–“(ä»Šå¹´)ã‚’è¡¨ç¤º"; 
            rankingFilter = { start: s, end: e };
        }
    }

    window.parseDateValue = function(value) {
        if (!value) return null;
        if (typeof value === 'number') { return (value - 25569) * 86400 * 1000; }
        if (typeof value === 'string') {
            const ymdMatch = value.match(/^20\d{6}$/); 
            if (ymdMatch) {
                const y = parseInt(value.substring(0, 4));
                const m = parseInt(value.substring(4, 6));
                const d = parseInt(value.substring(6, 8));
                return new Date(y, m - 1, d).getTime();
            }
            let ts = Date.parse(value);
            if (!isNaN(ts)) return ts;
            const jpRegex = /(\d{1,2})å¹´\s*(\d{1,2})æœˆ\s*(\d{1,2})æ—¥/;
            const match = value.match(jpRegex);
            if (match) { const y = parseInt(match[1]) + 2000; const m = parseInt(match[2]); const d = parseInt(match[3]); return new Date(y, m-1, d).getTime(); }
        }
        return null;
    }

    window.applyDateFilter = function() {
        const s = document.getElementById('rank-date-start').value; 
        const e = document.getElementById('rank-date-end').value;
        rankingFilter = { start: s, end: e }; 
        const statusEl = document.getElementById('rank-date-status');
        if(statusEl) statusEl.textContent = "";
        const activeTab = document.querySelector('.tab-btn.active');
        if (activeTab) { const tabId = activeTab.id.replace('tab-', ''); window.switchRankingTab(tabId); }
    }

    window.updateDBStats = async function() {
        const elCost = document.getElementById('db-count-cost'); if (elCost) elCost.textContent = (await db.costs.count()) + "ä»¶";
        const elMaster = document.getElementById('db-count-master'); if (elMaster) elMaster.textContent = (await db.masters.count()) + "ä»¶";
        const elPurchase = document.getElementById('db-count-purchase'); if (elPurchase) elPurchase.textContent = (await db.purchases.count()) + "ä»¶";
        const elSales = document.getElementById('db-count-sales'); if (elSales) elSales.textContent = (await db.sales.count()) + "ä»¶";
        const meta = await db.meta.get('period');
        if(meta && meta.value) { 
            const headerP = document.getElementById('header-period');
            if(headerP) headerP.classList.remove('hidden'); 
            const pText = document.getElementById('period-text');
            if(pText) pText.textContent = meta.value; 
            window.parseAndSetDefaultPeriod(meta.value); 
        }
    }

    window.clearDatabase = async function() { 
        if(confirm("å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) { 
            await Promise.all([db.costs.clear(), db.masters.clear(), db.purchases.clear(), db.sales.clear(), db.meta.clear()]); 
            window.updateDBStats(); 
        } 
    }

    // 4. File Processing Logic
    function handleFileSelect(files) { handleFiles(files); }
    function handleFiles(files) {
        if (!importLog) return;
        let logMsg = "";
        for (let file of files) {
            const name = file.name.toLowerCase();
            if (name.includes('åŸä¾¡é›†è¨ˆ')) { pendingFiles.cost = file; logMsg += `âœ“ åŸä¾¡é›†è¨ˆè¡¨: ${file.name}\n`; }
            else if (name.includes('ç¾å ´ãƒã‚¹ã‚¿ãƒ¼')) { pendingFiles.master = file; logMsg += `âœ“ ç¾å ´ãƒã‚¹ã‚¿ãƒ¼: ${file.name}\n`; }
            else if (name.includes('ä»•å…¥æ˜ç´°')) { pendingFiles.purchase = file; logMsg += `âœ“ ä»•å…¥æ˜ç´°: ${file.name}\n`; }
            else if (name.includes('å£²ä¸Šæ˜ç´°')) { pendingFiles.sales = file; logMsg += `âœ“ å£²ä¸Šæ˜ç´°: ${file.name}\n`; }
            else { logMsg += `? ã‚¹ã‚­ãƒƒãƒ—: ${file.name}\n`; }
        }
        importLog.textContent = logMsg || "èªè­˜ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚";
        if (processBtn) processBtn.disabled = !(pendingFiles.cost || pendingFiles.master || pendingFiles.purchase || pendingFiles.sales);
    }
    function excelColToIndex(col) { let n=0; for(let i=0;i<col.length;i++){n=n*26+(col.toUpperCase().charCodeAt(i)-64);} return n-1; }
    
    async function parseTextUTF16LE_ByIndex(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const decoder = new TextDecoder('utf-16le');
                const text = decoder.decode(e.target.result);
                const cleanText = text.replace(/"/g, ''); 
                Papa.parse(cleanText, { header: false, skipEmptyLines: true, complete: (results) => resolve(results.data) });
            };
            reader.readAsArrayBuffer(file);
        });
    }

    async function parseExcel(file, headerRowIndex) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const json = XLSX.utils.sheet_to_json(sheet, {header: 1, defval: null});
                const headers = json[headerRowIndex];
                const rows = json.slice(headerRowIndex + 1).map(row => { let obj={}; headers.forEach((h,i)=>{if(h)obj[h]=row[i]}); return obj; });
                resolve({ rows, rawJson: json });
            };
            reader.readAsArrayBuffer(file);
        });
    }

    window.processDroppedFiles = async function() {
        const btn = document.getElementById('btn-process-files');
        const spinner = document.getElementById('import-spinner');
        if(btn) btn.disabled = true; 
        if(spinner) spinner.classList.remove('hidden');
        if(importLog) importLog.textContent += "\n--- å‡¦ç†é–‹å§‹ ---\n";
        
        try {
            let costData=[], masterData=[], purchaseData=[], salesData=[], periodStr = "";
            
            if (pendingFiles.cost) {
                if(importLog) importLog.textContent += "èª­è¾¼: åŸä¾¡é›†è¨ˆè¡¨(Excel)...\n";
                const { rows, rawJson } = await parseExcel(pendingFiles.cost, 5); 
                for(let i=0; i<5; i++) {
                    const rowArr = Object.values(rawJson[i] || {});
                    const found = rowArr.find(s => typeof s === 'string' && s.includes("å®Œ äº† æ—¥"));
                    if(found) { periodStr = found; break; }
                }
                let validRows = rows;
                if (validRows.length > 0) {
                     const firstRow = validRows[0];
                     const codeVal = String(firstRow['ã‚³ãƒ¼ãƒ‰'] || '');
                     if (codeVal === '1' || (codeVal.includes('<') && codeVal.includes('>'))) {
                          validRows = rows.slice(1);
                          if(importLog) importLog.textContent += "  -> é …ç›®ç•ªå·è¡Œã‚’æ¤œå‡ºã€‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚\n";
                     }
                }
                costData = validRows.map(r => ({
                    code: String(r['ã‚³ãƒ¼ãƒ‰'] || ''), 
                    name: String(r['ç¾å ´ãƒ¡ã‚¤ãƒ³å'] || ''),
                    salesTotal: parseFloat(String(r['å£²ä¸Šç´¯è¨ˆ'] || '0').replace(/,/g, '')),
                    costTotal: parseFloat(String(r['åŸä¾¡ç´¯è¨ˆ'] || '0').replace(/,/g, '')),
                    profitTotal: parseFloat(String(r['å£²ä¸Šï¼åŸä¾¡(ç´¯è¨ˆ)'] || '0').replace(/,/g, '')),
                    marginRatio: parseFloat(String(r['(å£²ä¸Šç´¯è¨ˆï¼åŸä¾¡ç´¯è¨ˆ)ï¼å£²ä¸Šç´¯è¨ˆ'] || r['ç²—åˆ©ç‡'] || '0').replace(/%/g, ''))
                })).filter(r => {
                     return r.code && r.code.trim() !== '' && !r.name.includes('ç·åˆè¨ˆ') && !r.name.includes('åˆè¨ˆ');
                });
            }

            if (pendingFiles.master) {
                const isText = pendingFiles.master.name.endsWith('.txt') || pendingFiles.master.name.endsWith('.csv');
                let rawData = [];
                
                if (isText) {
                    if(importLog) importLog.textContent += "èª­è¾¼: ç¾å ´ãƒã‚¹ã‚¿ãƒ¼(Text)...\n";
                    rawData = await parseTextUTF16LE_ByIndex(pendingFiles.master);
                } else {
                    if(importLog) importLog.textContent += "èª­è¾¼: ç¾å ´ãƒã‚¹ã‚¿ãƒ¼(Excel)...\n";
                    const { rawJson } = await parseExcel(pendingFiles.master, 0); 
                    rawData = rawJson;
                }
                if(rawData.length > 0) rawData = rawData.slice(1); 
                if(rawData.length > 0) {
                    const row2 = rawData[0];
                    const valA = String(row2[0] || ''); 
                    if (valA === '1' || (valA.includes('<') && valA.includes('>'))) {
                        rawData = rawData.slice(1);
                        if(importLog) importLog.textContent += "  -> ç¾å ´ãƒã‚¹ã‚¿ãƒ¼é …ç›®ç•ªå·è¡Œã‚’æ¤œå‡ºã€‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚\n";
                    }
                }

                const mastersMap = new Map();
                rawData.forEach(r => {
                    const code = String(r[0] || ''); 
                    if (!code) return;
                    
                    const subCode = String(r[1] || '').trim(); 
                    const subName = r[5]; 
                    const isParent = (subCode === '');
                    
                    const rowObj = {
                        code: code,
                        name: r[2],       
                        subCode: subCode,
                        subName: subName,
                        customer: r[22],  
                        delivery: r[44],  
                        owner: r[47],     
                        manager: r[49],   
                        branch: r[55],    
                        startDate: r[43], 
                        endDate: r[45],   
                    };
                    
                    if (!mastersMap.has(code)) {
                        const parentRecord = { ...rowObj, subCodes: [] };
                        if (!isParent) {
                             parentRecord.subCodes.push(rowObj);
                        }
                        mastersMap.set(code, parentRecord);
                    } else {
                        const existing = mastersMap.get(code);
                        if (isParent) { 
                            existing.name = rowObj.name;
                            existing.customer = rowObj.customer;
                            existing.delivery = rowObj.delivery;
                            existing.owner = rowObj.owner;
                            existing.manager = rowObj.manager;
                            existing.branch = rowObj.branch;
                            existing.startDate = rowObj.startDate;
                            existing.endDate = rowObj.endDate;
                        } else { 
                            if (!rowObj.name || rowObj.name.trim() === '') {
                                rowObj.name = existing.name; 
                            }
                            existing.subCodes.push(rowObj); 
                        }
                    }
                });
                masterData = Array.from(mastersMap.values());
            }

            if (pendingFiles.purchase) {
                const raw = await parseTextUTF16LE_ByIndex(pendingFiles.purchase);
                const idxDate = excelColToIndex('A');
                const idxVendor = excelColToIndex('I');
                const idxItemM = excelColToIndex('M'); 
                const idxItemN = excelColToIndex('N'); 
                const idxItemO = excelColToIndex('O'); 
                const idxItemQ = excelColToIndex('Q'); 
                const idxAmount = excelColToIndex('DE');
                const idxSite = excelColToIndex('EB');

                purchaseData = raw.slice(1).map(r => {
                    if (!r[idxSite]) return null;
                    const txtM = (r[idxItemM] || '').trim(); const txtO = (r[idxItemO] || '').trim(); const txtQ = (r[idxItemQ] || '').trim();
                    let itemName = (txtM || txtO || txtQ) ? [txtM, txtO, txtQ].filter(Boolean).join(' ') : '00000000';
                    let d = r[idxDate] || ''; if (typeof d !== 'string') d = String(d);
                    return { siteCode: String(r[idxSite]).trim(), date: d.trim(), vendor: r[idxVendor], item: itemName, amount: parseFloat(String(r[idxAmount] || '0').replace(/,/g, '')) };
                }).filter(r => r && r.siteCode);
            }
            if (pendingFiles.sales) {
                const raw = await parseTextUTF16LE_ByIndex(pendingFiles.sales);
                const idxDate = excelColToIndex('A');
                const idxCustomer = excelColToIndex('I');
                const idxAmountInc = excelColToIndex('DG');
                const idxAmountExc = excelColToIndex('DJ');
                const idxSite = excelColToIndex('EI');

                salesData = raw.slice(1).map(r => {
                    if (!r[idxSite]) return null;
                    let d = r[idxDate] || ''; if (typeof d !== 'string') d = String(d);
                    return { siteCode: String(r[idxSite]).trim(), date: d.trim(), customer: r[idxCustomer], amountInc: parseFloat(String(r[idxAmountInc] || '0').replace(/,/g, '')), amountExc: parseFloat(String(r[idxAmountExc] || '0').replace(/,/g, '')) };
                }).filter(r => r && r.siteCode);
            }
            await db.transaction('rw', db.costs, db.masters, db.purchases, db.sales, db.meta, async () => {
                if (pendingFiles.cost) { await db.costs.clear(); await db.costs.bulkPut(costData); await db.meta.put({ key: 'period', value: periodStr }); }
                if (pendingFiles.master) { await db.masters.clear(); await db.masters.bulkPut(masterData); }
                if (pendingFiles.purchase) { await db.purchases.clear(); await db.purchases.bulkAdd(purchaseData); }
                if (pendingFiles.sales) { await db.sales.clear(); await db.sales.bulkAdd(salesData); }
            });
            if(importLog) importLog.textContent += "å®Œäº†ï¼\n"; 
            await window.updateDBStats(); 
            alert("å®Œäº†ã—ã¾ã—ãŸã€‚");
            window.showPage('dashboard');
        } catch (e) { 
            console.error(e); 
            if(importLog) importLog.textContent += `ã‚¨ãƒ©ãƒ¼: ${e.message}\n`; 
            alert(`ã‚¨ãƒ©ãƒ¼: ${e.message}`); 
        } 
        finally { 
            if(spinner) spinner.classList.add('hidden'); 
        }
    }

    // 5. Render Functions
    window.renderTable = function(tbodyId, data, cols) { 
        const tbody = document.getElementById(tbodyId); if(!tbody) return; tbody.innerHTML = ''; 
        data.forEach(r => { 
            const tr = document.createElement('tr'); 
            cols.forEach(c => { 
                const td = document.createElement('td'); td.className = "px-3 py-2 border-b whitespace-nowrap"; 
                if (c.includes('amount') || c === 'cost' || c === 'profit') { td.className += " text-right font-mono"; td.textContent = window.formatCurrency(r[c]); } 
                else { td.textContent = r[c]; } 
                tr.appendChild(td); 
            }); 
            tbody.appendChild(tr); 
        }); 
    }

    window.renderCharts = function(sales, purchases) { 
        if (chartTrend) chartTrend = window.destroyChart(chartTrend); 
        if (chartComposition) chartComposition = window.destroyChart(chartComposition); 
        
        const monthly = {}; 
        sales.forEach(s => { const m = s.date.substring(0,6); if(!monthly[m]) monthly[m]={s:0, p:0}; monthly[m].s += s.amountExc; }); 
        purchases.forEach(p => { const m = p.date ? p.date.substring(0,6) : ''; if(m) { if(!monthly[m]) monthly[m]={s:0, p:0}; monthly[m].p += p.amount; } }); 
        const labels = Object.keys(monthly).sort(); 
        
        const ctxTrend = document.getElementById('chart-trend');
        if(ctxTrend) {
            chartTrend = new Chart(ctxTrend, { type: 'bar', data: { labels: labels.map(l=>l.slice(0,4)+'/'+l.slice(4)), datasets: [ { label: 'å£²ä¸Š(ç¨æŠœ)', data: labels.map(l=>monthly[l].s), backgroundColor: '#3b82f6' }, { label: 'åŸä¾¡', data: labels.map(l=>monthly[l].p), backgroundColor: '#ef4444' } ] }, options: { responsive:true, maintainAspectRatio:false } }); 
        }

        const vendors = {}; let totalCost = 0; 
        purchases.forEach(p => { const v = p.vendor||'ä¸æ˜'; vendors[v] = (vendors[v]||0)+p.amount; totalCost += p.amount; }); 
        let sorted = Object.entries(vendors).sort((a,b)=>b[1]-a[1]); 
        const top5 = sorted.slice(0,5); const others = sorted.slice(5).reduce((a,c)=>a+c[1],0); if(others>0) top5.push(['ãã®ä»–', others]); 
        
        const ctxComp = document.getElementById('chart-composition');
        if(ctxComp) {
            chartComposition = new Chart(ctxComp, { type: 'doughnut', data: { labels: top5.map(i => `${i[0]} (${Math.round(i[1]/totalCost*100)}%)`), datasets: [{ data: top5.map(i => i[1]), backgroundColor: ['#10b981','#3b82f6','#f59e0b','#ef4444','#8b5cf6','#cbd5e1'] }] }, options: { responsive:true, maintainAspectRatio:false, plugins: { legend: { position:'right' } } } }); 
        }
    }
    
    // --- PORTED FUNCTION START: Export Site Report ---
// â–¼â–¼â–¼ è¿½åŠ ãƒ»ä¿®æ­£é–‹å§‹ï¼šExcelå‡ºåŠ›æ©Ÿèƒ½ (v25ã‚ˆã‚Šç§»æ¤) â–¼â–¼â–¼

    // è¿½åŠ : Excelå‡ºåŠ›ç”¨ã«ãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆå€¤ã‚’æ­£è¦åŒ–ã™ã‚‹é–¢æ•°
    function normalizePercentForExcel(val) {
        if (val === null || val === undefined || val === '') return null;
        let s = String(val).trim().replace('%','').replace(/,/g,'');
        const n = Number(s);
        if (isNaN(n)) return null;
        // 1ä»¥ä¸‹ãªã‚‰ãã®ã¾ã¾(0.726)ã€1ã‚ˆã‚Šå¤§ãã‘ã‚Œã°ãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆå€¤(72.6)ã¨ã¿ãªã—ã¦100ã§å‰²ã‚‹
        return Math.abs(n) <= 1 ? n : n / 100;
    }

    // ä¿®æ­£: v25ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’é©ç”¨ã—ãŸExcelãƒ¬ãƒãƒ¼ãƒˆå‡ºåŠ›é–¢æ•°
    window.exportSiteReport = async function() {
        if (!currentSiteData) { alert("å‡ºåŠ›ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ç¾å ´ã‚’æ¤œç´¢ã—ã¦ãã ã•ã„ã€‚"); return; }
        
        const wb = new ExcelJS.Workbook();
        const ws = wb.addWorksheet('ç¾å ´è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆ');

        ws.mergeCells('A1:E1'); ws.getCell('A1').value = 'ç¾å ´è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆ'; ws.getCell('A1').style = { font: { bold: true, size: 18 } };
        
        ws.getCell('A3').value = 'ç¾å ´ã‚³ãƒ¼ãƒ‰'; ws.getCell('B3').value = currentSiteData.code;
        ws.getCell('A4').value = 'ç¾å ´å'; ws.getCell('B4').value = currentSiteData.name;
        ws.getCell('A5').value = 'æ–½å·¥ä¸»'; ws.getCell('B5').value = currentSiteData.owner;
        ws.getCell('A6').value = 'å¾—æ„å…ˆ'; ws.getCell('B6').value = currentSiteData.customer; 
        
        ws.getCell('D3').value = 'æ‹…å½“è€…'; ws.getCell('E3').value = currentSiteData.manager;
        ws.getCell('D4').value = 'æ‹ ç‚¹'; ws.getCell('E4').value = currentSiteData.branch;
        ws.getCell('D5').value = 'å·¥æœŸ'; ws.getCell('E5').value = `${currentSiteData.start} ï½ ${currentSiteData.end}`;
        ws.getCell('D6').value = 'ç´æœŸ'; ws.getCell('E6').value = currentSiteData.delivery;
        
        ws.getRow(3).font = { bold: true };
        
        ws.getCell('A8').value = 'å£²ä¸Šç´¯è¨ˆ(ç¨æŠœ)'; ws.getCell('B8').value = currentSiteData.sales;
        ws.getCell('A9').value = 'åŸä¾¡ç´¯è¨ˆ'; ws.getCell('B9').value = currentSiteData.cost;
        ws.getCell('A10').value = 'ç²—åˆ©ç›Š'; ws.getCell('B10').value = currentSiteData.profit;
        
        // --- ä¿®æ­£ç®‡æ‰€: ç²—åˆ©ç‡ã®å†è¨ˆç®—ã¨æ›¸ãè¾¼ã¿ (v25ãƒ­ã‚¸ãƒƒã‚¯) ---
        ws.getCell('A11').value = 'ç²—åˆ©ç‡';
        
        // æ—¢å­˜ã® margin æ–‡å­—åˆ—ã¯ä¸¸ã‚èª¤å·®ã‚’å«ã‚€å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã€é‡‘é¡ã‹ã‚‰å†è¨ˆç®—ã—ãŸæ­£ç¢ºãªå€¤ã‚’ä½¿ç”¨ã™ã‚‹
        let calcMargin = currentSiteData.margin;
        const sVal = parseFloat(String(currentSiteData.sales).replace(/[^0-9.-]/g, ''));
        const pVal = parseFloat(String(currentSiteData.profit).replace(/[^0-9.-]/g, ''));
        
        // å£²ä¸ŠãŒ0ã§ãªã‘ã‚Œã°å†è¨ˆç®— (ä¾‹: 0.726...)
        if (!isNaN(sVal) && sVal !== 0 && !isNaN(pVal)) {
            calcMargin = pVal / sVal; 
        }

        const gpDecimal = normalizePercentForExcel(calcMargin);
        if (gpDecimal === null) {
            ws.getCell('B11').value = currentSiteData.margin;
        } else {
            const cell = ws.getCell('B11');
            cell.value = gpDecimal;
            cell.numFmt = '0.0%'; // Excelã®æ›¸å¼è¨­å®šã§ãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆè¡¨ç¤º
        }
        // -------------------------------------------
        
        // Add Charts if available
        if (chartTrend) {
            const trendImg = chartTrend.toBase64Image();
            const imageId1 = wb.addImage({ base64: trendImg, extension: 'png' });
            ws.addImage(imageId1, 'G3:L15');
        }
        if (chartComposition) {
            const compImg = chartComposition.toBase64Image();
            const imageId2 = wb.addImage({ base64: compImg, extension: 'png' });
            ws.addImage(imageId2, 'M3:R15');
        }

        let row = 18;
        ws.getCell(`A${row}`).value = 'â–  å£²ä¸Šæ˜ç´°'; ws.getCell(`A${row}`).font = { bold: true, size: 12 };
        row++;
        ws.getRow(row).values = ['æ—¥ä»˜', 'å¾—æ„å…ˆ', 'é‡‘é¡(ç¨æŠœ)', 'é‡‘é¡(ç¨è¾¼)'];
        ws.getRow(row).font = { bold: true };
        row++;
        currentSiteData.salesDetails.forEach(s => {
            ws.getRow(row).values = [s.date, s.customer, s.amountExc, s.amountInc];
            row++;
        });

        row += 2;
        ws.getCell(`A${row}`).value = 'â–  ä»•å…¥æ˜ç´°'; ws.getCell(`A${row}`).font = { bold: true, size: 12 };
        row++;
        ws.getRow(row).values = ['æ—¥ä»˜', 'æ¥­è€…å', 'é …ç›®', 'é‡‘é¡(ç¨æŠœ+ç¨)'];
        ws.getRow(row).font = { bold: true };
        row++;
        currentSiteData.purchaseDetails.forEach(p => {
            ws.getRow(row).values = [p.date, p.vendor, p.item, p.amount];
            row++;
        });

        ws.columns = [ { width: 15 }, { width: 30 }, { width: 15 }, { width: 15 }, { width: 20 }, { width: 10 } ];

        const buffer = await wb.xlsx.writeBuffer();
        saveAs(new Blob([buffer]), `ç¾å ´è©³ç´°_${currentSiteData.code}_${new Date().toISOString().slice(0,10)}.xlsx`);
    }
    // â–²â–²â–² è¿½åŠ ãƒ»ä¿®æ­£çµ‚äº† â–²â–²â–²
    // 6. Search & Ranking Logic
    window.initSiteSearch = async function() { 
        const masters = await db.masters.toArray(); 
        cachedMasters = masters.map(m => ({ name: m.name || '', owner: m.owner || '', code: m.code })); 
    }

    window.clearSiteSearch = function() {
        const i1 = document.getElementById('search-input');
        const i2 = document.getElementById('site-name-search');
        if(i1) i1.value = '';
        if(i2) i2.value = '';
        
        // Also clear multi-input
        const i3 = document.getElementById('multi-code-input');
        if(i3) i3.value = '';
        
        // Hide result panels
        const res = document.getElementById('search-result');
        if(res) res.classList.add('hidden');
        
        const multiRes = document.getElementById('multi-result-container');
        if(multiRes) multiRes.classList.add('hidden');
        
        const multiContent = document.getElementById('multi-content-area');
        if(multiContent) multiContent.innerHTML = '';
        
        const auto = document.getElementById('site-autocomplete-list');
        if(auto) auto.classList.add('hidden');
        
        currentSiteData = null;
        multiCompareData = [];
    }

    window.searchSite = async function() { 
        try {
            const inputCode = document.getElementById('search-input').value.trim(); if (!inputCode) return; 
            const master = await db.masters.get(inputCode); const cost = await db.costs.get(inputCode); 
            const sales = await db.sales.where('siteCode').equals(inputCode).toArray(); 
            const purchases = await db.purchases.where('siteCode').equals(inputCode).toArray(); 
            
            if (!master && !cost) { alert("è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ã‚³ãƒ¼ãƒ‰ã‚’ç¢ºèªã—ã¦ãã ã•ã„: " + inputCode); return; } 
            
            currentSiteData = {
                code: inputCode,
                name: master ? master.name : (cost ? cost.name : '-'),
                owner: master ? master.owner : '-',
                manager: master ? master.manager : '-',
                branch: master ? master.branch : '-',
                start: master ? master.startDate : '-',
                end: master ? master.endDate : '-',
                customer: master ? master.customer : '-',
                delivery: master ? master.delivery : '-',
                sales: window.formatCurrency(cost ? cost.salesTotal : 0),
                cost: window.formatCurrency(cost ? cost.costTotal : 0),
                profit: window.formatCurrency(cost ? cost.profitTotal : 0),
                margin: (cost ? cost.marginRatio : 0).toFixed(1) + '%',
                salesDetails: sales,
                purchaseDetails: purchases
            };

            document.getElementById('search-result').classList.remove('hidden'); 
            document.getElementById('res-code').textContent = inputCode; 
            document.getElementById('res-name').textContent = master ? master.name : (cost ? cost.name : '-'); 
            
            const subNameEl = document.getElementById('res-sub-name');
            const subCodeEl = document.getElementById('res-sub-code');
            if(subNameEl) subNameEl.textContent = master ? (master.subName || '-') : '-'; 
            if(subCodeEl) subCodeEl.textContent = master ? (master.subCode || '-') : '-'; 
            
            document.getElementById('res-owner').textContent = master ? master.owner : '-'; 
            document.getElementById('res-customer').textContent = master ? master.customer : '-';
            document.getElementById('res-manager').textContent = master ? master.manager : '-'; 
            document.getElementById('res-branch').textContent = master ? master.branch : '-'; 
            document.getElementById('res-start').textContent = master ? master.startDate : '-'; 
            document.getElementById('res-end').textContent = master ? master.endDate : '-'; 
            document.getElementById('res-delivery').textContent = master ? master.delivery : '-';
            
            const subCont = document.getElementById('res-subcodes-container');
            const subList = document.getElementById('res-subcodes-list');
            if(subCont && subList) {
                subCont.classList.add('hidden'); subList.innerHTML = ''; 
                if (master && master.subCodes && master.subCodes.length > 0) { 
                    subCont.classList.remove('hidden'); 
                    master.subCodes.forEach(s => { const span = document.createElement('span'); span.className = "bg-blue-50 text-blue-700 text-xs px-2 py-1 rounded border border-blue-100"; span.textContent = `${s.code}: ${s.name}`; subList.appendChild(span); }); 
                }
            }
            
            const salesTotal = cost ? cost.salesTotal : 0; const costTotal = cost ? cost.costTotal : 0; const profitTotal = cost ? cost.profitTotal : 0; const margin = salesTotal !== 0 ? (profitTotal / salesTotal * 100) : 0; 
            document.getElementById('res-sales').textContent = window.formatCurrency(salesTotal); document.getElementById('res-cost').textContent = window.formatCurrency(costTotal); document.getElementById('res-profit').textContent = window.formatCurrency(profitTotal); document.getElementById('res-margin').textContent = margin.toFixed(1) + '%'; document.getElementById('res-margin-bar').style.width = Math.min(Math.max(margin, 0), 100) + '%'; 
            
            window.renderTable('table-sales-body', sales, ['date', 'customer', 'amountExc', 'amountInc']); 
            window.renderTable('table-purchase-body', purchases, ['date', 'vendor', 'item', 'amount']); 
            document.getElementById('count-sales').textContent = sales.length + "ä»¶"; 
            document.getElementById('count-purchase').textContent = purchases.length + "ä»¶"; 
            window.renderCharts(sales, purchases);
        } catch(e) { console.error("Search Error:", e); alert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + e.message); }
    }

    window.initCostSearch = async function() { 
        const purchases = await db.purchases.toArray(); 
        const vendorCounts = {}; 
        purchases.forEach(p => { if(p.vendor) vendorCounts[p.vendor] = (vendorCounts[p.vendor] || 0) + 1; }); 
        cachedVendors = Object.entries(vendorCounts).sort((a,b) => b[1] - a[1]).map(e => e[0]); 
        const masters = await db.masters.toArray(); 
        const brSet = new Set(masters.map(m => m.branch).filter(Boolean)); 
        const sel = document.getElementById('cost-search-branch'); 
        if(sel && sel.options.length === 1) Array.from(brSet).sort().forEach(b => sel.add(new Option(b,b))); 
    }

    window.executeCostSearch = async function(vendorName) { 
        currentCostVendor = vendorName; 
        const targetBranch = document.getElementById('cost-search-branch').value; 
        let purchases = await db.purchases.where('vendor').equals(vendorName).toArray(); 
        const masters = await db.masters.toArray(); 
        const masterMap = new Map(); 
        masters.forEach(m => masterMap.set(m.code, m)); 
        if(targetBranch !== 'ALL') purchases = purchases.filter(p => { const m = masterMap.get(p.siteCode); return m && m.branch === targetBranch; }); 
        document.getElementById('cost-search-result').classList.remove('hidden'); 
        document.getElementById('cs-vendor-name').textContent = vendorName; 
        const totalAmt = purchases.reduce((sum, p) => sum + p.amount, 0); 
        document.getElementById('cs-total-amount').textContent = window.formatCurrency(totalAmt); 
        document.getElementById('cs-total-count').textContent = purchases.length + 'ä»¶'; 
        const catCounts = {}; 
        purchases.forEach(p => { let cat = 'ãã®ä»–'; if(p.item && p.item.length < 15) cat = p.item; catCounts[cat] = (catCounts[cat]||0)+1; }); 
        const topCats = Object.entries(catCounts).sort((a,b)=>b[1]-a[1]).slice(0,3).map(e=>e[0]); 
        document.getElementById('cs-top-items').innerHTML = topCats.map(c => `<span class="px-2 py-1 bg-slate-100 text-xs rounded text-slate-600">${c}</span>`).join(''); 
        const monthly = {}; 
        purchases.forEach(p => { const m = p.date ? p.date.substring(0,6) : 'ä¸æ˜'; if(!monthly[m]) monthly[m] = {amt:0, cnt:0}; monthly[m].amt += p.amount; monthly[m].cnt++; }); 
        const labels = Object.keys(monthly).sort().filter(k=>k!=='ä¸æ˜'); 
        chartCostTrend = window.destroyChart(chartCostTrend); 
        chartCostTrend = new Chart(document.getElementById('chart-cost-trend'), { type: 'bar', data: { labels: labels.map(l=>l.slice(0,4)+'/'+l.slice(4)), datasets: [{ label:'ç™ºç”Ÿé¡', data:labels.map(l=>monthly[l].amt), backgroundColor:'#3b82f6' }] }, options:{ maintainAspectRatio:false } }); 
        const tbodyM = document.getElementById('cs-table-monthly'); tbodyM.innerHTML = ''; 
        labels.reverse().forEach(m => { const d = monthly[m]; const ratio = totalAmt ? (d.amt/totalAmt*100) : 0; tbodyM.innerHTML += `<tr class="border-b"><td class="px-4 py-2">${m}</td><td class="px-4 py-2 text-right font-mono">${window.formatCurrency(d.amt)}</td><td class="px-4 py-2 text-center">${d.cnt}</td><td class="px-4 py-2 text-center">${ratio.toFixed(1)}%</td></tr>`; }); 
        currentCostDetails = purchases.map(p => { const m = masterMap.get(p.siteCode) || {}; return { date: p.date || '-', code: p.siteCode, name: m.name || '-', branch: m.branch || '-', item: p.item, amount: p.amount }; }); 
        window.renderCostDetailsTable(); 
    }
    
    // RESTORED: Cost Details Table Rendering
    window.sortCostDetails = function(key) { 
        if (costSortState.key === key) costSortState.order = costSortState.order === 'asc' ? 'desc' : 'asc'; 
        else { costSortState.key = key; costSortState.order = 'desc'; } 
        window.renderCostDetailsTable(); 
    }

    window.renderCostDetailsTable = function() { 
        const { key, order } = costSortState; 
        const sorted = [...currentCostDetails].sort((a,b) => { 
            let valA = a[key]; let valB = b[key]; 
            if(key === 'amount') { valA = parseFloat(valA); valB = parseFloat(valB); } 
            if (valA < valB) return order === 'asc' ? -1 : 1; 
            if (valA > valB) return order === 'asc' ? 1 : -1; 
            return 0; 
        }); 
        const tbody = document.getElementById('cs-table-details'); 
        if(tbody) {
            tbody.innerHTML = ''; 
            sorted.slice(0, 500).forEach(p => { 
                tbody.innerHTML += `<tr class="border-b hover:bg-slate-50"><td class="px-4 py-2">${p.date}</td><td class="px-4 py-2 font-mono text-xs">${p.code}</td><td class="px-4 py-2 text-xs truncate max-w-[150px]">${p.name}</td><td class="px-4 py-2 text-xs">${p.branch}</td><td class="px-4 py-2 text-xs truncate max-w-[150px]">${p.item}</td><td class="px-4 py-2 text-right font-mono">${window.formatCurrency(p.amount)}</td></tr>`; 
            }); 
        }
    }
    
    // --- RANKING LOGIC ---
    window.switchRankingTab = function(tab) {
        try {
            document.querySelectorAll('.ranking-tab-content').forEach(el=>el.classList.add('hidden'));
            const content = document.getElementById(`ranking-${tab}`);
            if(content) content.classList.remove('hidden');
            
            document.querySelectorAll('.tab-btn').forEach(el=>el.classList.remove('active'));
            const btn = document.getElementById(`tab-${tab}`);
            if(btn) btn.classList.add('active');

            if(tab==='owner') window.initOwnerRanking();
            if(tab==='branch') window.renderBranchRanking();
            if(tab==='manager') window.initManagerRanking();
            if(tab==='monthly-manager') window.renderMonthlyManagerRanking();
            if(tab==='month') setTimeout(window.initMonthlyRanking, 50); 
            if(tab==='worst') window.initWorstRanking();
        } catch (e) { console.error(e); alert("ã‚¿ãƒ–åˆ‡æ›¿ã‚¨ãƒ©ãƒ¼: " + e.message); }
    }

    async function getAggregatedData_CostBase(keyType) {
        const costs = await db.costs.toArray(); const masters = await db.masters.toArray(); const groups = {};
        const fStart = rankingFilter.start ? new Date(rankingFilter.start).setHours(0,0,0,0) : 0;
        const fEnd = rankingFilter.end ? new Date(rankingFilter.end).setHours(23,59,59,999) : 9999999999999;
        costs.forEach(c => {
            const m = masters.find(ma => ma.code === c.code); if (!m) return;
            const endTs = window.parseDateValue(m.endDate); 
            if (!endTs || endTs < fStart || endTs > fEnd) return;
            let k = 'ä¸æ˜'; if (keyType==='owner') k = m.owner || 'ä¸æ˜'; else if(keyType==='branch') k = m.branch || 'ä¸æ˜'; else if(keyType==='manager') k = m.manager || 'ä¸æ˜';
            if(!groups[k]) groups[k] = { name:k, sales:0, cost:0, profit:0, count:0 };
            groups[k].sales += c.salesTotal; groups[k].cost += c.costTotal; groups[k].profit += c.profitTotal; groups[k].count++;
        });
        return Object.values(groups);
    }

    window.initOwnerRanking = async function() {
        const masters = await db.masters.toArray(); const branches = new Set(masters.map(m => m.branch).filter(b => b));
        const select = document.getElementById('rank-owner-branch'); 
        if (select && select.options.length <= 1) Array.from(branches).sort().forEach(b => select.add(new Option(b, b)));
        window.renderOwnerRanking();
    }
    window.renderOwnerRanking = async function() {
        const select = document.getElementById('rank-owner-branch');
        const targetBranch = select ? select.value : 'ALL';
        const costs = await db.costs.toArray(); const masters = await db.masters.toArray(); const groups = {};
        const fStart = rankingFilter.start ? new Date(rankingFilter.start).setHours(0,0,0,0) : 0;
        const fEnd = rankingFilter.end ? new Date(rankingFilter.end).setHours(23,59,59,999) : 9999999999999;
        costs.forEach(c => {
            const m = masters.find(ma => ma.code === c.code); if (!m) return;
            const endTs = window.parseDateValue(m.endDate); 
            if (!endTs || endTs < fStart || endTs > fEnd) return;
            if (targetBranch !== 'ALL' && m.branch !== targetBranch) return;
            const k = m.owner || 'ä¸æ˜';
            if(!groups[k]) groups[k] = { name:k, sales:0, cost:0, profit:0, count:0 };
            groups[k].sales += c.salesTotal; groups[k].cost += c.costTotal; groups[k].profit += c.profitTotal; groups[k].count++;
        });
        window.sortAndRender(Object.values(groups), 'ranking-body-owner', 'rank-sort-owner');
    }

    window.renderBranchRanking = async function() {
        const data = await getAggregatedData_CostBase('branch'); window.sortAndRender(data, 'ranking-body-branch', null);
        chartBranchSales = window.destroyChart(chartBranchSales); chartBranchProfit = window.destroyChart(chartBranchProfit);
        const ctxS = document.getElementById('chart-branch-sales'); const ctxP = document.getElementById('chart-branch-profit');
        if(ctxS && ctxP) {
            const sorted = [...data].sort((a,b)=>b.sales - a.sales);
            chartBranchSales = new Chart(ctxS, { type:'pie', data:{ labels:sorted.map(d=>d.name), datasets:[{data:sorted.map(d=>d.sales), backgroundColor:['#3b82f6','#10b981','#f59e0b','#ef4444','#8b5cf6']}] }, options:{plugins:{legend:{position:'right'}}} });
            chartBranchProfit = new Chart(ctxP, { type:'pie', data:{ labels:sorted.map(d=>d.name), datasets:[{data:sorted.map(d=>d.profit), backgroundColor:['#3b82f6','#10b981','#f59e0b','#ef4444','#8b5cf6']}] }, options:{plugins:{legend:{position:'right'}}} });
        }
    }

    window.initManagerRanking = async function() {
        const masters = await db.masters.toArray(); const branches = new Set(); const months = new Set();
        masters.forEach(m => { if(m.branch) branches.add(m.branch); const ts = window.parseDateValue(m.endDate); if(ts) { const d = new Date(ts); const yyyymm = d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0'); months.add(yyyymm); } });
        const selMonth = document.getElementById('rank-manager-month'); const selBranch = document.getElementById('rank-manager-branch');
        if(selMonth && selMonth.options.length === 0) { selMonth.add(new Option('å…¨æœŸé–“', 'ALL')); Array.from(months).sort().reverse().forEach(m => selMonth.add(new Option(m + ' å®Œå·¥', m))); }
        if(selBranch && selBranch.options.length === 1) { Array.from(branches).sort().forEach(b => selBranch.add(new Option(b, b))); }
        window.renderManagerRanking();
    }
    window.renderManagerRanking = async function() {
        const selMonth = document.getElementById('rank-manager-month');
        const selBranch = document.getElementById('rank-manager-branch');
        const targetMonth = selMonth ? selMonth.value : 'ALL'; 
        const targetBranch = selBranch ? selBranch.value : 'ALL';
        const costs = await db.costs.toArray(); const masters = await db.masters.toArray(); const groups = {};
        costs.forEach(c => {
            const m = masters.find(ma => ma.code === c.code); if (!m) return;
            const endTs = window.parseDateValue(m.endDate); 
            if (!endTs) return;
            if (targetMonth !== 'ALL') { const d = new Date(endTs); const yyyymm = d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0'); if (yyyymm !== targetMonth) return; }
            if (targetBranch !== 'ALL' && m.branch !== targetBranch) return;
            const k = m.manager || 'ä¸æ˜';
            if(!groups[k]) groups[k] = { name:k, sales:0, cost:0, profit:0, count:0 };
            groups[k].sales += c.salesTotal; groups[k].cost += c.costTotal; groups[k].profit += c.profitTotal; groups[k].count++;
        });
        window.sortAndRender(Object.values(groups), 'ranking-body-manager', 'rank-sort-manager');
    }

    window.setMonthlyMode = function(mode) { currentMonthlyMode = mode; document.getElementById('btn-mode-manager').className = mode==='manager'?'btn-group-item active':'btn-group-item'; document.getElementById('btn-mode-owner').className = mode==='owner'?'btn-group-item active':'btn-group-item'; document.getElementById('mm-header-name').textContent = mode==='manager'?'æ‹…å½“è€…å':'æ–½å·¥ä¸»å'; window.renderMonthlyManagerRanking(); }
    window.renderMonthlyManagerRanking = async function() {
        const allSales = await db.sales.toArray(); const allMasters = await db.masters.toArray(); const masterMap = new Map(); allMasters.forEach(m => masterMap.set(m.code, { mgr: m.manager, br: m.branch, owner: m.owner }));
        const monthSelect = document.getElementById('mm-filter-month'); const branchSelect = document.getElementById('mm-filter-branch');
        const agg = {}; const months = new Set(); const branches = new Set();
        allSales.forEach(s => {
            const mInfo = masterMap.get(s.siteCode); const manager = mInfo ? mInfo.mgr : 'ä¸æ˜'; const branch = mInfo ? mInfo.br : 'ä¸æ˜'; const owner = mInfo ? mInfo.owner : 'ä¸æ˜';
            const yyyymm = s.date.substring(0, 6); if (!yyyymm) return;
            months.add(yyyymm); if (branch !== 'ä¸æ˜') branches.add(branch);
            const targetName = currentMonthlyMode === 'manager' ? manager : owner; const key = `${yyyymm}_${targetName}_${branch}`;
            if (!agg[key]) agg[key] = { month: yyyymm, name: targetName, branch, sales: 0 }; agg[key].sales += s.amountExc; 
        });
        if (monthSelect && monthSelect.options.length === 0) Array.from(months).sort().reverse().forEach(m => monthSelect.add(new Option(m, m))); 
        if (branchSelect && branchSelect.options.length === 1) Array.from(branches).sort().forEach(b => branchSelect.add(new Option(b, b)));
        const selMonth = monthSelect ? monthSelect.value : ''; 
        const selBranch = branchSelect ? branchSelect.value : 'ALL';
        const list = Object.values(agg).filter(a => { if (selMonth && a.month !== selMonth) return false; if (selBranch !== 'ALL' && a.branch !== selBranch) return false; return true; });
        list.sort((a,b) => b.sales - a.sales);
        const tbody = document.getElementById('ranking-body-monthly-manager'); 
        if(tbody) {
            tbody.innerHTML = '';
            list.forEach((r, i) => { tbody.innerHTML += `<tr><td class="px-6 py-4 font-bold">${i+1}</td><td class="px-6 py-4">${r.name}</td><td class="px-6 py-4">${r.branch}</td><td class="px-6 py-4 text-right font-bold">${formatCurrency(r.sales)}</td><td class="px-6 py-4 text-right text-slate-300">-</td><td class="px-6 py-4 text-right text-slate-300">-</td></tr>`; });
        }
    }

    window.initMonthlyRanking = async function() { const selBranch = document.getElementById('month-filter-branch'); if (selBranch && selBranch.options.length === 1) { const masters = await db.masters.toArray(); const brSet = new Set(masters.map(m=>m.branch).filter(b=>b)); Array.from(brSet).sort().forEach(b => selBranch.add(new Option(b,b))); } window.renderMonthlyRanking(); }
    window.renderMonthlyRanking = async function() {
        try {
            const selBranch = document.getElementById('month-filter-branch');
            const targetB = selBranch ? selBranch.value : 'ALL';
            const sales = await db.sales.toArray(); const purchases = await db.purchases.toArray(); const masters = await db.masters.toArray(); const masterMap = new Map(); masters.forEach(m => masterMap.set(m.code, m.branch));
            const stats = {}; 
            sales.forEach(s => { if (targetB !== 'ALL') { const b = masterMap.get(s.siteCode); if (b !== targetB) return; } const m = s.date.substring(0,6); if(m) { if(!stats[m]) stats[m]={s:0, p:0}; stats[m].s += s.amountExc; } });
            purchases.forEach(p => { if (targetB !== 'ALL') { const b = masterMap.get(p.siteCode); if (b !== targetB) return; } const m = p.date ? p.date.substring(0,6) : ''; if(m) { if(!stats[m]) stats[m]={s:0, p:0}; stats[m].p += p.amount; } });
            const labels = Object.keys(stats).sort();
            chartMonthly = window.destroyChart(chartMonthly);
            const ctx = document.getElementById('chart-monthly-total');
            if (ctx) { chartMonthly = new Chart(ctx, { type: 'bar', data: { labels: labels, datasets: [{ label: `å£²ä¸Š(ç¨æŠœ)`, data: labels.map(l=>stats[l].s), backgroundColor: '#3b82f6' }, { label: 'åŸä¾¡', data: labels.map(l=>stats[l].p), backgroundColor: '#ef4444' }] }, options:{maintainAspectRatio:false} }); }
            const tbody = document.getElementById('ranking-table-month'); const tfoot = document.getElementById('ranking-footer-month'); 
            if(tbody) tbody.innerHTML = ''; 
            let sumS=0, sumP=0;
            const th = document.getElementById('monthly-table-head');
            if(th) {
                if(targetB === 'ALL') { th.innerHTML = `<tr><th class="px-4 py-2 border border-slate-300">å¹´æœˆ</th><th class="px-4 py-2 border border-slate-300 text-right">å£²ä¸Š(ç¨æŠœ)</th><th class="px-4 py-2 border border-slate-300 text-right">åŸä¾¡(ç¨æŠœ)</th><th class="px-4 py-2 border border-slate-300 text-right">ç²—åˆ©ç›Š</th><th class="px-4 py-2 border border-slate-300 text-right">ç²—åˆ©ç‡</th></tr>`; } else { th.innerHTML = `<tr><th class="px-4 py-2 border border-slate-300">å¹´æœˆ</th><th class="px-4 py-2 border border-slate-300 text-right">å£²ä¸Š(ç¨æŠœ)</th></tr>`; }
            }
            labels.forEach(m => {
                const d = stats[m]; sumS += d.s; sumP += d.p; const profit = d.s - d.p; const margin = d.s ? (profit/d.s*100) : 0;
                let row = `<td class="px-4 py-2">${m}</td><td class="px-4 py-2 text-right font-mono">${formatCurrency(d.s)}</td>`;
                if(targetB === 'ALL') { row += `<td class="px-4 py-2 text-right font-mono text-red-600">${formatCurrency(d.p)}</td><td class="px-4 py-2 text-right font-mono ${profit<0?'text-red-600':'text-blue-600'}">${formatCurrency(profit)}</td><td class="px-4 py-2 text-right">${margin.toFixed(1)}%</td>`; }
                if(tbody) tbody.innerHTML += `<tr class="border-b">${row}</tr>`;
            });
            let footRow = `<td class="px-4 py-2">åˆè¨ˆ</td><td class="px-4 py-2 text-right">${formatCurrency(sumS)}</td>`;
            if(targetB === 'ALL') { const tp = sumS - sumP; const tm = sumS ? (tp/sumS*100) : 0; footRow += `<td class="px-4 py-2 text-right">${formatCurrency(sumP)}</td><td class="px-4 py-2 text-right">${formatCurrency(tp)}</td><td class="px-4 py-2 text-right">${tm.toFixed(1)}%</td>`; }
            if(tfoot) tfoot.innerHTML = `<tr>${footRow}</tr>`;
        } catch (e) { console.error("Monthly Render Error:", e); }
    }

    window.setWorstType = function(type) {
        currentWorstType = type;
        document.getElementById('btn-wt-ranking').className = type==='ranking'?'btn-group-item active':'btn-group-item';
        document.getElementById('btn-wt-alert').className = type==='alert'?'btn-group-item active text-red-600':'btn-group-item';
        if(type === 'ranking') { document.getElementById('worst-controls-ranking').classList.remove('hidden'); document.getElementById('worst-controls-alert').classList.add('hidden'); }
        else { document.getElementById('worst-controls-ranking').classList.add('hidden'); document.getElementById('worst-controls-alert').classList.remove('hidden'); }
        window.renderWorstRanking();
    }
    window.setWorstSort = function(sort) {
        currentWorstSort = sort;
        document.getElementById('btn-worst-rate').className = sort==='rate'?'btn-group-item active text-red-600':'btn-group-item';
        document.getElementById('btn-worst-amount').className = sort==='amount'?'btn-group-item active text-red-600':'btn-group-item';
        window.renderWorstRanking();
    }
    window.initWorstRanking = async function() {
        const masters = await db.masters.toArray(); const branches = new Set(); const months = new Set();
        masters.forEach(m => { if(m.branch) branches.add(m.branch); const ts = window.parseDateValue(m.endDate); if(ts) { const d = new Date(ts); const yyyymm = d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0'); months.add(yyyymm); } });
        const selMonth = document.getElementById('worst-alert-month'); const selBranch = document.getElementById('worst-alert-branch');
        if(selMonth && selMonth.options.length === 0) { selMonth.add(new Option('å…¨æœŸé–“', 'ALL')); Array.from(months).sort().reverse().forEach(m => selMonth.add(new Option(m + ' å®Œå·¥', m))); }
        if(selBranch && selBranch.options.length === 1) { Array.from(branches).sort().forEach(b => selBranch.add(new Option(b, b))); }
        window.renderWorstRanking();
    }
    window.renderWorstRanking = async function() {
        const costs = await db.costs.toArray(); const masters = await db.masters.toArray(); const tbody = document.getElementById('ranking-body-worst'); if(tbody) tbody.innerHTML = ''; 
        let list = [];
        if (currentWorstType === 'ranking') {
            const fStart = rankingFilter.start ? new Date(rankingFilter.start).setHours(0,0,0,0) : 0; const fEnd = rankingFilter.end ? new Date(rankingFilter.end).setHours(23,59,59,999) : 9999999999999;
            costs.forEach(c => {
                const m = masters.find(ma => ma.code === c.code); if (!m) return; const endTs = window.parseDateValue(m.endDate); 
                if (!endTs || endTs < fStart || endTs > fEnd) return; if (c.salesTotal <= 0) return;
                list.push({ code: c.code, name: c.name, manager: m.manager || '-', owner: m.owner || '-', branch: m.branch || '-', endStr: m.endDate, sales: c.salesTotal, profit: c.profitTotal, margin: (c.profitTotal / c.salesTotal * 100) });
            });
            if (currentWorstSort === 'rate') list.sort((a,b) => a.margin - b.margin); else list.sort((a,b) => a.profit - b.profit); list = list.slice(0, 20);
        } else {
            const selMonth = document.getElementById('worst-alert-month');
            const selBranch = document.getElementById('worst-alert-branch');
            const targetMonth = selMonth ? selMonth.value : 'ALL'; 
            const targetBranch = selBranch ? selBranch.value : 'ALL';
            costs.forEach(c => {
                const m = masters.find(ma => ma.code === c.code); if (!m) return; const endTs = window.parseDateValue(m.endDate); 
                if (!endTs) return;
                if (targetMonth !== 'ALL') { const d = new Date(endTs); const yyyymm = d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0'); if (yyyymm !== targetMonth) return; }
                if (targetBranch !== 'ALL' && m.branch !== targetBranch) return; if (c.salesTotal <= 0) return;
                const margin = (c.profitTotal / c.salesTotal * 100); if (margin > 20) return;
                list.push({ code: c.code, name: c.name, manager: m.manager || '-', owner: m.owner || '-', branch: m.branch || '-', endStr: m.endDate, sales: c.salesTotal, profit: c.profitTotal, margin: margin });
            });
            list.sort((a,b) => a.margin - b.margin);
        }
        currentWorstList = list;
        if(tbody) {
            if (list.length === 0) { tbody.innerHTML = '<tr><td colspan="8" class="px-6 py-4 text-center text-slate-400">è©²å½“ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>'; return; }
            list.forEach((r,i) => {
                let dateDisp = '-'; const ts = window.parseDateValue(r.endStr); if(ts) { const d = new Date(ts); dateDisp = `${d.getMonth()+1}æœˆ (${r.branch})`; } else { dateDisp = r.branch; }
                tbody.innerHTML += `<tr>
                    <td class="px-6 py-4 font-bold text-red-600">${i+1}</td>
                    <td class="px-6 py-4 text-xs font-mono text-slate-500">${r.code}</td>
                    <td class="px-6 py-4 text-xs"><div class="font-bold text-sm text-slate-800 mb-1 truncate max-w-xs" title="${r.name}">${r.name}</div></td>
                    <td class="px-6 py-4 text-xs text-slate-700">${r.manager}</td>
                    <td class="px-6 py-4 text-xs text-slate-600 truncate max-w-[100px]">${r.owner}</td>
                    <td class="px-6 py-4 text-xs text-slate-500">${dateDisp}</td>
                    <td class="px-6 py-4 text-right font-bold text-red-600">${r.margin.toFixed(1)}%</td>
                    <td class="px-6 py-4 text-right text-red-500 text-xs font-mono">${formatCurrency(r.profit)}</td>
                    <td class="px-6 py-4 text-right text-xs font-mono">${formatCurrency(r.sales)}</td>
                </tr>`;
            });
        }
    }
    window.exportWorstExcel = function() { if(!currentWorstList || currentWorstList.length === 0) { alert("å‡ºåŠ›ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“"); return; } const exportData = currentWorstList.map((r, i) => ({ "é †ä½": i+1, "å·¥ç•ª": r.code, "ç¾å ´å": r.name, "æ‹…å½“è€…": r.manager, "æ–½å·¥ä¸»": r.owner, "æ‹ ç‚¹": r.branch, "å®Œå·¥æ—¥": r.endStr, "ç²—åˆ©ç‡": r.margin.toFixed(2) + "%", "ç²—åˆ©ç›Š(ç¨æŠœ)": r.profit, "å£²ä¸Š(ç¨æŠœ)": r.sales })); const ws = XLSX.utils.json_to_sheet(exportData); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "ãƒ¯ãƒ¼ã‚¹ãƒˆåˆ†æ"); XLSX.writeFile(wb, `åˆ©ç›Šç‡ãƒ¯ãƒ¼ã‚¹ãƒˆåˆ†æ_${new Date().toISOString().slice(0,10)}.xlsx`); }
    window.sortAndRender = function(data, tbodyId, sortSelectId) { 
        const sel = document.getElementById(sortSelectId);
        const sortKey = sel ? sel.value : 'profit'; 
        data.sort((a,b) => b[sortKey] - a[sortKey]); 
        const tbody = document.getElementById(tbodyId); 
        if(tbody) {
            tbody.innerHTML = ''; 
            data.forEach((r,i) => { const margin = r.sales? (r.profit/r.sales*100) : 0; tbody.innerHTML += `<tr><td class="px-6 py-4 font-bold">${i+1}</td><td class="px-6 py-4">${r.name}</td><td class="px-6 py-4 text-right">${formatCurrency(r.sales)}</td><td class="px-6 py-4 text-right">${formatCurrency(r.cost)}</td><td class="px-6 py-4 text-right font-bold">${formatCurrency(r.profit)}</td><td class="px-6 py-4 text-right font-bold ${margin<10?'text-red-500':'text-green-600'}">${margin.toFixed(1)}%</td><td class="px-6 py-4 text-center">${r.count}</td></tr>`; }); 
        }
    }
    
    // --- Global ShowPage ---
    window.showPage = function(p) {
        document.querySelectorAll('.page-content').forEach(el=>el.classList.add('hidden'));
        document.getElementById(`page-${p}`).classList.remove('hidden');
        document.querySelectorAll('.sidebar-link').forEach(el=>el.classList.remove('active'));
        document.getElementById(`nav-${p}`).classList.add('active');
        const titles = { 'dashboard': 'ç¾å ´ç…§ä¼šãƒ»åˆ†æ', 'cost-search': 'åŸä¾¡æ¤œç´¢', 'ranking': 'é›†è¨ˆãƒ»ãƒ©ãƒ³ã‚­ãƒ³ã‚°', 'import': 'ãƒ‡ãƒ¼ã‚¿å–è¾¼ãƒ»ç®¡ç†', 'check': 'ãƒ‡ãƒ¼ã‚¿ä¸å‚™ãƒ»æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯' };
        document.getElementById('page-title').textContent = titles[p] || 'G-Ledger';
        
        if(p==='import') window.updateDBStats();
        if(p==='ranking') window.switchRankingTab('owner');
        if(p==='cost-search') window.initCostSearch();
        if(p==='dashboard') window.initSiteSearch();
    }

    // --- DOMContentLoaded EVENT LISTENERS ---
    window.addEventListener('DOMContentLoaded', () => {
        // DropZone
        dropZone = document.getElementById('drop-zone');
        importLog = document.getElementById('import-log');
        processBtn = document.getElementById('btn-process-files');
        
        if(dropZone) {
            dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
            dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); dropZone.classList.remove('dragover'); });
            dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.classList.remove('dragover'); window.handleFileSelect(e.dataTransfer.files); });
        }

        // Site Search Inputs
        const siteNameInput = document.getElementById('site-name-search');
        const siteAutoList = document.getElementById('site-autocomplete-list');
        const searchInput = document.getElementById('search-input');

        if(siteNameInput && siteAutoList) {
            siteNameInput.addEventListener('input', function() { 
                const val = this.value.trim(); 
                siteAutoList.innerHTML = ''; 
                siteAutoList.classList.add('hidden'); 
                if(!val) return; 
                const normVal = window.normalizeStr(val); 
                const matches = cachedMasters.filter(m => window.normalizeStr(m.name).includes(normVal) || window.normalizeStr(m.owner).includes(normVal)).slice(0, 10); 
                if(matches.length === 0) return; 
                siteAutoList.classList.remove('hidden'); 
                matches.forEach(m => { 
                    const div = document.createElement('div'); 
                    div.className = 'autocomplete-item'; 
                    div.innerHTML = `<div class="font-bold text-sm">${m.name}</div><div class="text-xs text-slate-500">${m.owner} (${m.code})</div>`; 
                    div.addEventListener('click', () => { 
                        if(searchInput) searchInput.value = m.code; 
                        siteNameInput.value = ''; 
                        siteAutoList.classList.add('hidden'); 
                        window.searchSite(); 
                    }); 
                    siteAutoList.appendChild(div); 
                }); 
            });
            siteNameInput.addEventListener('keydown', function(e) { 
                if(e.key === 'Enter') { 
                    e.preventDefault(); 
                    const firstItem = siteAutoList.querySelector('.autocomplete-item'); 
                    if (firstItem) { firstItem.click(); } 
                } 
            });
        }
        
        if(searchInput) {
            searchInput.addEventListener('keydown', function(e) { if(e.key === 'Enter') { e.preventDefault(); window.searchSite(); } });
        }

        // Cost Search Inputs
        const searchInputCost = document.getElementById('cost-search-input');
        const autocompleteListCost = document.getElementById('cost-autocomplete-list');
        const selCostBranch = document.getElementById('cost-search-branch');

        if(searchInputCost && autocompleteListCost) {
            searchInputCost.addEventListener('input', function() { 
                const val = this.value.toLowerCase().trim(); 
                autocompleteListCost.innerHTML = ''; 
                autocompleteListCost.classList.add('hidden'); 
                if(!val) return; 
                const matches = cachedVendors.filter(v => window.normalizeStr(v).includes(window.normalizeStr(val))).slice(0, 10); 
                if(matches.length === 0) return; 
                autocompleteListCost.classList.remove('hidden'); 
                matches.forEach(vendor => { 
                    const div = document.createElement('div'); 
                    div.className = 'autocomplete-item'; 
                    div.innerHTML = `<strong>${vendor}</strong>`; 
                    div.addEventListener('click', () => { 
                        searchInputCost.value = vendor; 
                        autocompleteListCost.classList.add('hidden'); 
                        window.executeCostSearch(vendor); 
                    }); 
                    autocompleteListCost.appendChild(div); 
                }); 
            });
            searchInputCost.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const firstItem = !autocompleteListCost.classList.contains('hidden') ? autocompleteListCost.querySelector('.autocomplete-item') : null;
                    if (firstItem) { firstItem.click(); } else { const val = this.value.trim(); if (val) { window.executeCostSearch(val); autocompleteListCost.classList.add('hidden'); } }
                }
            });
        }
        
        if(selCostBranch) {
            selCostBranch.addEventListener('change', () => { if(currentCostVendor) window.executeCostSearch(currentCostVendor); });
        }

        // Multi-Code Input Formatter
        const multiCodeInput = document.getElementById('multi-code-input');
        if(multiCodeInput) {
            // Paste event: Format text to be space-separated
            multiCodeInput.addEventListener('paste', (e) => {
                e.preventDefault();
                const text = (e.clipboardData || window.clipboardData).getData('text');
                // Replace newlines and commas with spaces, remove multiple spaces
                const formatted = text.replace(/[\r\n,]+/g, ' ').replace(/\s+/g, ' ').trim();
                
                // Insert at cursor position
                const start = multiCodeInput.selectionStart;
                const end = multiCodeInput.selectionEnd;
                const val = multiCodeInput.value;
                multiCodeInput.value = val.substring(0, start) + formatted + val.substring(end);
                
                // Move cursor
                multiCodeInput.selectionStart = multiCodeInput.selectionEnd = start + formatted.length;
            });
            
            // Keydown (Enter): Insert space instead of newline
            multiCodeInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const start = multiCodeInput.selectionStart;
                    const end = multiCodeInput.selectionEnd;
                    const val = multiCodeInput.value;
                    multiCodeInput.value = val.substring(0, start) + ' ' + val.substring(end);
                    multiCodeInput.selectionStart = multiCodeInput.selectionEnd = start + 1;
                }
            });
        }

        // Initial Load
        window.updateDBStats();
        window.showPage('dashboard');
    });

    // --- Export Master Check Report ---
    window.exportMasterCheck = async function() {
        try {
            if ((await db.masters.count()) === 0) { alert("ç¾å ´ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚"); return; }
            
            // Safe getter
            const getChecked = (id) => { const el = document.getElementById(id); return el ? el.checked : false; };
            const getVal = (id) => { const el = document.getElementById(id); return el ? el.value.trim() : ''; };

            const checks = {
                name: getChecked('chk-name'),
                customer: getChecked('chk-customer'),
                owner: getChecked('chk-owner'),
                manager: getChecked('chk-manager'),
                branch: getChecked('chk-branch'),
                start: getChecked('chk-start'),
                end: getChecked('chk-end'),
                delivery: getChecked('chk-delivery'),
                subname: getChecked('chk-subname')
            };

            if (!Object.values(checks).includes(true)) { alert("å°‘ãªãã¨ã‚‚1ã¤ã®ãƒã‚§ãƒƒã‚¯é …ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚"); return; }

            const pStart = getVal('chk-period-start');
            const pEnd = getVal('chk-period-end');
            const hasPeriodFilter = pStart !== '' || pEnd !== '';
            const nStart = pStart ? parseInt(pStart) : 0;
            const nEnd = pEnd ? parseInt(pEnd) : 99999999;

            const costKeys = new Set(await db.costs.toCollection().keys());
            
            const wb = new ExcelJS.Workbook();
            const ws = wb.addWorksheet('ãƒã‚¹ã‚¿ãƒ¼ä¸å‚™ãƒã‚§ãƒƒã‚¯');

            const headerStyle = { font: { bold: true, color: { argb: 'FFFFFFFF' } }, fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFED7D31' } }, alignment: { horizontal: 'center' } };

            ws.columns = [
                { header: 'è¦ªã‚³ãƒ¼ãƒ‰', key: 'code', width: 12 },
                { header: 'ã‚µãƒ–ã‚³ãƒ¼ãƒ‰', key: 'subCode', width: 12 },
                { header: 'ç¾å ´å', key: 'name', width: 35 },
                { header: 'ç¾å ´ã‚µãƒ–åç§°', key: 'subName', width: 25 },
                { header: 'åˆ¤å®š', key: 'result', width: 10 },
                { header: 'æœªå…¥åŠ›é …ç›®', key: 'missing', width: 40 },
                { header: 'å¾—æ„å…ˆ', key: 'customer', width: 15 },
                { header: 'æ–½å·¥ä¸»', key: 'owner', width: 15 },
                { header: 'æ‹…å½“è€…', key: 'manager', width: 12 },
                { header: 'æ‹ ç‚¹', key: 'branch', width: 10 },
                { header: 'ç€æ‰‹æ—¥', key: 'start', width: 12 },
                { header: 'å®Œäº†æ—¥', key: 'end', width: 12 },
                { header: 'ç´æœŸ', key: 'delivery', width: 12 }
            ];
            
            ws.getRow(1).eachCell((cell) => { cell.style = headerStyle; });

            const masters = await db.masters.toArray();
            let errorCount = 0;
            let checkedCount = 0;

            const checkItem = (val) => {
                if (val === null || val === undefined) return false;
                const s = String(val).trim();
                return s !== '' && s !== '0';
            };

            const processRecord = (rec) => {
                let targetCode = rec.subCode ? rec.subCode : rec.code;
                if (!costKeys.has(targetCode)) {
                    if (!costKeys.has(rec.code)) return; 
                }

                if (hasPeriodFilter) {
                    const rawEnd = String(rec.endDate || '').trim();
                    const nEndVal = parseInt(rawEnd);
                    if (!rawEnd || isNaN(nEndVal) || nEndVal === 0) return; 
                    if (nEndVal < nStart || nEndVal > nEnd) return;
                }

                checkedCount++;
                const missing = [];
                
                let isNameNG = false;
                if (checks.name) {
                    if (rec.subCode && (!rec.name || rec.name.trim() === '')) {
                        if (!checkItem(rec.name)) isNameNG = true;
                    } else {
                        if (!checkItem(rec.name)) isNameNG = true;
                    }
                }
                if (isNameNG) missing.push('ç¾å ´å');

                if (checks.subname && !checkItem(rec.subName)) missing.push('ç¾å ´ã‚µãƒ–åç§°');
                if (checks.customer && !checkItem(rec.customer)) missing.push('å¾—æ„å…ˆå');
                if (checks.owner && !checkItem(rec.owner)) missing.push('æ–½å·¥ä¸»');
                if (checks.manager && !checkItem(rec.manager)) missing.push('æ‹…å½“è€…');
                if (checks.branch && !checkItem(rec.branch)) missing.push('æ‹ ç‚¹');
                if (checks.start && !checkItem(rec.startDate)) missing.push('ç€æ‰‹æ—¥');
                if (checks.end && !checkItem(rec.endDate)) missing.push('å®Œäº†æ—¥');
                if (checks.delivery && !checkItem(rec.delivery)) missing.push('ç´æœŸ');

                const isNG = missing.length > 0;
                if(isNG) errorCount++;

                const rowData = {
                    code: rec.code || '',
                    subCode: rec.subCode || '',
                    name: rec.name || '',
                    subName: rec.subName || '',
                    result: isNG ? 'ä¸å‚™ã‚ã‚Š' : 'OK',
                    missing: missing.join(', '),
                    customer: rec.customer,
                    owner: rec.owner,
                    manager: rec.manager,
                    branch: rec.branch,
                    start: rec.startDate,
                    end: rec.endDate,
                    delivery: rec.delivery
                };

                const newRow = ws.addRow(rowData);
                if(isNG) {
                    newRow.eachCell({ includeEmpty: true }, (cell) => { cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFE6E6' } }; });
                    newRow.getCell('result').font = { color: { argb: 'FFFF0000' }, bold: true };
                }
            };

            masters.forEach(m => {
                processRecord({ ...m, subCode: '' });
                if (m.subCodes && m.subCodes.length > 0) {
                    m.subCodes.forEach(s => {
                        const subRec = { ...s, code: m.code, subCode: s.subCode };
                        processRecord(subRec);
                    });
                }
            });

            if (checkedCount === 0) {
                alert("æ¡ä»¶ã«ä¸€è‡´ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");
                return;
            }

            const buffer = await wb.xlsx.writeBuffer();
            saveAs(new Blob([buffer]), `ãƒã‚¹ã‚¿ãƒ¼ä¸å‚™ãƒã‚§ãƒƒã‚¯_${new Date().toISOString().slice(0,10)}.xlsx`);
            alert(`å‡ºåŠ›å®Œäº†: ${checkedCount}ä»¶ä¸­ã€${errorCount}ä»¶ã®ä¸å‚™ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚`);
        } catch (e) {
            console.error(e);
            alert("ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + e.message);
        }
    }

    // --- Export Cost Data Integrity Check ---
    window.exportCostCheck = async function() {
        try {
            if ((await db.costs.count()) === 0) { alert("åŸä¾¡ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚"); return; }
            
            const wb = new ExcelJS.Workbook();
            const ws = wb.addWorksheet('åŸä¾¡æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯');

            const headerStyle = { font: { bold: true, color: { argb: 'FFFFFFFF' } }, fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFC00000' } }, alignment: { horizontal: 'center' } };

            ws.columns = [
                { header: 'å·¥ç•ª', key: 'code', width: 12 },
                { header: 'ç¾å ´å', key: 'name', width: 35 },
                { header: 'å®Œäº†æ—¥', key: 'end', width: 12 },
                { header: 'å£²ä¸Šç´¯è¨ˆ(ç¨æŠœ)', key: 'sales', width: 15 },
                { header: 'åŸä¾¡ç´¯è¨ˆ', key: 'cost', width: 15 },
                { header: 'åˆ¤å®šã‚³ãƒ¡ãƒ³ãƒˆ', key: 'comment', width: 25 },
            ];
            
            ws.getRow(1).eachCell((cell) => { cell.style = headerStyle; });

            const costs = await db.costs.toArray();
            const masters = await db.masters.toArray();
            const masterMap = new Map();
            masters.forEach(m => masterMap.set(m.code, m));

            let alertCount = 0;

            costs.forEach(c => {
                const m = masterMap.get(c.code) || {};
                const rawEndDate = m.endDate;
                
                let isCompleted = false;
                if (rawEndDate) {
                    const sDate = String(rawEndDate).trim();
                    if (sDate.length === 8 && sDate !== '0') {
                        isCompleted = true;
                    }
                }
                
                const sales = c.salesTotal || 0;
                const cost = c.costTotal || 0;
                
                if (sales === 0 || cost === 0) {
                    alertCount++;
                    let comment = '';
                    let isCritical = false;

                    if (isCompleted) {
                        comment = 'ã€è¦æ³¨æ„ã€‘å®Œäº†æ¸ˆã ãŒ0å††';
                        isCritical = true;
                    } else {
                        comment = 'é€²è¡Œä¸­ãƒ»æœªè¨ˆä¸Š';
                    }
                    
                    if (sales === 0 && cost === 0) comment += ' (å£²ä¸Šãƒ»åŸä¾¡å…±ã«0)';
                    else if (sales === 0) comment += ' (å£²ä¸Š0)';
                    else if (cost === 0) comment += ' (åŸä¾¡0)';

                    const newRow = ws.addRow({
                        code: c.code,
                        name: c.name,
                        end: rawEndDate || '-',
                        sales: sales,
                        cost: cost,
                        comment: comment
                    });

                    if (isCritical) {
                        newRow.eachCell({ includeEmpty: true }, (cell) => { cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFE6E6' } }; }); 
                        newRow.getCell('comment').font = { color: { argb: 'FFFF0000' }, bold: true };
                    } else {
                         newRow.eachCell({ includeEmpty: true }, (cell) => { cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFFFE0' } }; }); 
                    }
                }
            });

            const buffer = await wb.xlsx.writeBuffer();
            saveAs(new Blob([buffer]), `åŸä¾¡æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯_${new Date().toISOString().slice(0,10)}.xlsx`);
            alert(`å‡ºåŠ›å®Œäº†: ${alertCount}ä»¶ã®è©²å½“ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚`);
        } catch (e) {
            console.error(e);
            alert("ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + e.message);
        }
    }

    // --- Multi-Site Comparison Logic ---
    window.switchViewMode = function(mode) {
        currentViewMode = mode;
        const btnCard = document.getElementById('btn-view-card');
        const btnTable = document.getElementById('btn-view-table');
        const panel = document.getElementById('multi-compare-panel');
        if (mode === 'card') {
            if(btnCard) btnCard.className = 'px-3 py-1 rounded text-xs font-bold bg-white text-indigo-800 shadow-sm transition-all';
            if(btnTable) btnTable.className = 'px-3 py-1 rounded text-xs font-bold text-indigo-600 hover:bg-indigo-100 hover:text-indigo-800 transition-all';
            if(panel) { panel.classList.remove('max-w-[95%]'); panel.classList.add('max-w-4xl'); }
        } else {
            if(btnTable) btnTable.className = 'px-3 py-1 rounded text-xs font-bold bg-white text-indigo-800 shadow-sm transition-all';
            if(btnCard) btnCard.className = 'px-3 py-1 rounded text-xs font-bold text-indigo-600 hover:bg-indigo-100 hover:text-indigo-800 transition-all';
            if(panel) { panel.classList.remove('max-w-4xl'); panel.classList.add('max-w-[95%]'); }
        }
        if (multiCompareData.length > 0) { window.renderMultiCompare(); }
    }

    window.compareSites = async function() {
        const input = document.getElementById('multi-code-input').value;
        if (!input.trim()) { alert("å·¥ç•ªã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"); return; }
        const codes = input.split(/[\s,]+/).filter(c => c.trim() !== '');
        if (codes.length === 0) return;

        try {
            document.getElementById('multi-result-container').classList.remove('hidden');
            const contentArea = document.getElementById('multi-content-area');
            contentArea.innerHTML = '<div class="text-center py-6"><div class="loader mx-auto"></div></div>';

            const masters = await Promise.all(codes.map(c => db.masters.get(c)));
            const costs = await Promise.all(codes.map(c => db.costs.get(c)));
            multiCompareData = [];
            
            codes.forEach((code, index) => {
                const m = masters[index] || {};
                const c = costs[index] || {};
                const name = m.name || c.name || '-';
                const manager = m.manager || '-';
                const owner = m.owner || '-';
                const branch = m.branch || '-';
                const endDate = m.endDate || '-';
                const subCodes = m.subCodes || [];
                const sales = c.salesTotal || 0;
                const cost = c.costTotal || 0;
                const profit = c.profitTotal || 0;
                const margin = sales ? (profit / sales * 100) : 0;
                const exists = (m.code || c.code);
                multiCompareData.push({ code, name, manager, owner, branch, endDate, subCodes, sales, cost, profit, margin, exists });
            });
            window.renderMultiCompare();
        } catch (e) { console.error(e); alert("ã‚¨ãƒ©ãƒ¼: " + e.message); }
    }

    window.renderMultiCompare = function() {
        const contentArea = document.getElementById('multi-content-area');
        if (multiCompareData.length === 0) { contentArea.innerHTML = '<div class="text-center py-6 text-slate-400">ãƒ‡ãƒ¼ã‚¿ãªã—</div>'; return; }
        if (currentViewMode === 'card') { window.renderMultiCompareCards(contentArea); } else { window.renderMultiCompareTable(contentArea); }
    }

    // Card Render
    window.renderMultiCompareCards = function(container) {
        let html = '<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">';
        multiCompareData.forEach(d => {
            if (!d.exists) {
                html += `
                    <div class="bg-red-50 p-4 rounded-lg border border-red-200 shadow-sm opacity-75">
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-2xl font-black text-black font-mono">${d.code}</span>
                            <span class="text-xs text-red-500 font-bold"><i class="fa-solid fa-circle-exclamation mr-1"></i>ãƒ‡ãƒ¼ã‚¿ãªã—</span>
                        </div>
                        <div class="text-xs text-red-400">æŒ‡å®šã•ã‚ŒãŸå·¥ç•ªã®ãƒ‡ãƒ¼ã‚¿ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</div>
                    </div>`;
            } else {
                let subHtml = '';
                if(d.subCodes && d.subCodes.length > 0) {
                    subHtml = `<div class="mt-3 pt-2 border-t border-slate-100"><span class="text-xs text-slate-400 block mb-1">é–¢é€£ã‚µãƒ–ã‚³ãƒ¼ãƒ‰</span><div class="flex flex-wrap gap-1">` + 
                        d.subCodes.map(s => `<span class="bg-blue-50 text-blue-600 text-xs px-2 py-1 rounded border border-blue-100 font-bold" title="${s.name}">${s.subCode || ''}</span>`).join('') +
                        `</div></div>`;
                }
                html += `
                    <div class="bg-white p-5 rounded-lg border border-slate-200 shadow-sm hover:shadow-md transition-shadow relative group">
                        <div class="mb-3">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-2xl font-black text-black font-mono tracking-tight">${d.code}</span>
                            </div>
                            <h4 class="font-bold text-slate-800 text-lg mb-2 line-clamp-1" title="${d.name}">${d.name}</h4>
                            <div class="flex flex-wrap gap-2 text-sm text-slate-600 mb-2">
                                <span class="bg-slate-100 px-2 py-1 rounded border border-slate-200"><i class="fa-solid fa-user mr-1 text-slate-400"></i>${d.manager}</span>
                                <span class="bg-slate-100 px-2 py-1 rounded border border-slate-200"><i class="fa-solid fa-building mr-1 text-slate-400"></i>${d.branch}</span>
                            </div>
                            <div class="flex flex-wrap gap-2 text-sm text-slate-600">
                                <span class="bg-orange-50 text-orange-800 px-2 py-1 rounded border border-orange-100"><i class="fa-solid fa-briefcase mr-1 text-orange-400"></i>${d.owner}</span>
                                <span class="bg-green-50 text-green-800 px-2 py-1 rounded border border-green-100"><i class="fa-regular fa-calendar-check mr-1 text-green-500"></i>${d.endDate}</span>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-x-4 gap-y-4 pt-4 border-t border-slate-100">
                            <div>
                                <span class="text-xs text-slate-400 block font-bold">å£²ä¸Š(ç¨æŠœ)</span>
                                <div class="font-mono font-bold text-slate-700 text-lg">${window.formatCurrency(d.sales)}</div>
                            </div>
                            <div class="text-right">
                                <span class="text-xs text-slate-400 block font-bold">åŸä¾¡</span>
                                <div class="font-mono font-bold text-slate-500 text-lg">${window.formatCurrency(d.cost)}</div>
                            </div>
                            <div class="col-span-2 flex justify-between items-center bg-slate-50 rounded px-3 py-2 mt-1">
                                <div>
                                    <span class="text-xs text-slate-400 block font-bold">ç²—åˆ©ç›Š</span>
                                    <div class="font-mono font-bold ${d.profit<0?'text-red-600':'text-indigo-600'} text-xl">${window.formatCurrency(d.profit)}</div>
                                </div>
                                <div class="text-right">
                                    <span class="text-xs text-slate-400 block font-bold">åˆ©ç›Šç‡</span>
                                    <div class="font-mono font-bold ${d.margin<10?'text-red-600':'text-blue-600'} text-xl">${d.margin.toFixed(1)}%</div>
                                </div>
                            </div>
                        </div>
                        ${subHtml}
                    </div>
                `;
            }
        });
        html += '</div>';
        container.innerHTML = html;
    }

    // Table Render
    window.renderMultiCompareTable = function(container) {
        let html = `
            <div class="rounded border border-slate-200 shadow-sm bg-white overflow-hidden w-full">
                <div class="overflow-x-auto w-full">
                    <table class="w-full text-sm text-left text-slate-600 border-collapse whitespace-nowrap">
                        <thead class="bg-slate-100 text-slate-700 uppercase text-xs">
                            <tr>
                                <th class="px-3 py-2 border-b border-r border-slate-200">å·¥ç•ª</th>
                                <th class="px-3 py-2 border-b border-r border-slate-200">ç¾å ´å</th>
                                <th class="px-3 py-2 border-b border-r border-slate-200">æ‹…å½“è€…</th>
                                <th class="px-3 py-2 border-b border-r border-slate-200">æ–½å·¥ä¸»</th>
                                <th class="px-3 py-2 border-b border-r border-slate-200">æ‹ ç‚¹</th>
                                <th class="px-3 py-2 border-b border-r border-slate-200">å®Œå·¥æ—¥</th>
                                <th class="px-3 py-2 border-b border-r border-slate-200 text-right">å£²ä¸Š(ç¨æŠœ)</th>
                                <th class="px-3 py-2 border-b border-r border-slate-200 text-right">åŸä¾¡</th>
                                <th class="px-3 py-2 border-b border-r border-slate-200 text-right">ç²—åˆ©ç›Š</th>
                                <th class="px-3 py-2 border-b border-slate-200 text-right">ç²—åˆ©ç‡</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-slate-100">
        `;
        multiCompareData.forEach(d => {
            if (!d.exists) {
                html += `<tr class="bg-red-50"><td class="px-3 py-2 border text-red-900 font-black font-mono">${d.code}</td><td colspan="9" class="px-3 py-2 border text-red-400 text-xs">ãƒ‡ãƒ¼ã‚¿ãªã—</td></tr>`;
            } else {
                html += `
                    <tr class="hover:bg-slate-50 transition-colors">
                        <td class="px-3 py-2 border font-mono text-base font-black text-black bg-slate-50/50">${d.code}</td>
                        <td class="px-3 py-2 border truncate max-w-[200px] text-xs font-bold text-slate-700" title="${d.name}">${d.name}</td>
                        <td class="px-3 py-2 border text-xs">${d.manager}</td>
                        <td class="px-3 py-2 border text-xs truncate max-w-[120px]" title="${d.owner}">${d.owner}</td>
                        <td class="px-3 py-2 border text-center text-xs">${d.branch}</td>
                        <td class="px-3 py-2 border text-center text-xs font-mono">${d.endDate}</td>
                        <td class="px-3 py-2 border text-right font-mono text-slate-700">${window.formatCurrency(d.sales)}</td>
                        <td class="px-3 py-2 border text-right font-mono text-slate-500">${window.formatCurrency(d.cost)}</td>
                        <td class="px-3 py-2 border text-right font-mono font-bold ${d.profit < 0 ? 'text-red-600' : 'text-slate-700'}">${window.formatCurrency(d.profit)}</td>
                        <td class="px-3 py-2 border text-right font-mono font-bold ${d.margin < 10 ? 'text-red-600' : 'text-blue-600'}">${d.margin.toFixed(1)}%</td>
                    </tr>
                `;
            }
        });
        html += `</tbody></table></div></div>`;
        container.innerHTML = html;
    }
</script>
</body>
</html>
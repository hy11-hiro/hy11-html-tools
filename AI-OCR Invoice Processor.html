<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI-OCR Invoice Processor (Advanced Extraction)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://docs.opencv.org/4.x/opencv.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        .loader { border-top-color: #3498db; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        #previewContainer {
            position: relative;
            width: 100%;
            height: 500px;
            overflow: hidden;
            background: #f1f5f9;
            cursor: grab;
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem;
        }
        #previewContainer:active { cursor: grabbing; }
        
        #canvasOutput {
            position: absolute;
            transform-origin: 0 0;
            transition: transform 0.1s ease-out;
            max-width: none;
        }

        .selected-row { background-color: #ebf8ff; border-left: 4px solid #3182ce; }
        .table-container { max-height: 500px; overflow-y: auto; }
        .diff-error { background-color: #fff5f5; color: #c53030; border: 1px solid #feb2b2; }
        .diff-ok { background-color: #f0fff4; color: #276749; border: 1px solid #9ae6b4; }
        
        .input-cell { font-size: 10px; padding: 2px 4px; border: 1px solid #e2e8f0; border-radius: 4px; width: 100%; background: transparent; }
        .input-cell:focus { background: white; border-color: #3182ce; outline: none; }
        
        .placeholder-message { 
            display: flex; align-items: center; justify-content: center; 
            height: 100%; color: #718096; text-align: center; font-size: 0.875rem;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans text-gray-900">
    <div class="max-w-full mx-auto p-4">
        <header class="mb-4 flex flex-col md:flex-row justify-between items-center bg-white p-4 rounded-xl shadow-sm">
            <div>
                <h1 class="text-xl font-bold text-blue-700">AI-OCR 請求監査システム</h1>
                <p class="text-gray-500 text-xs">日付・工番(英字+数字4桁)・各番号の照合チェック</p>
            </div>
            <div class="flex space-x-2 mt-4 md:mt-0">
                <button id="downloadCsv" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-sm transition text-nowrap">
                    CSV保存
                </button>
            </div>
        </header>

        <div class="grid grid-cols-1 xl:grid-cols-12 gap-4">
            <!-- ファイル・プレビュー -->
            <div class="xl:col-span-4 space-y-4">
                <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200">
                    <input type="file" id="fileInput" accept="image/*,application/pdf" class="text-sm w-full">
                    <div class="mt-3 flex gap-4">
                        <label class="flex items-center text-xs text-gray-600 cursor-pointer">
                            <input type="checkbox" id="autoRotate" checked class="mr-1"> 傾き補正
                        </label>
                        <button id="processBtn" class="flex-1 bg-blue-600 text-white py-2 rounded-lg font-bold hover:bg-blue-700 transition">
                            AI解析開始
                        </button>
                    </div>
                </div>
                
                <div class="bg-white p-2 rounded-xl shadow-sm border border-gray-200 sticky top-4">
                    <div class="flex justify-between items-center px-2 py-1 mb-1">
                        <span class="text-[10px] text-gray-400">マウスホイールで拡大・ドラッグで移動</span>
                        <button id="resetZoom" class="text-[10px] bg-gray-200 hover:bg-gray-300 px-2 py-1 rounded">リセット</button>
                    </div>
                    <div id="previewContainer">
                        <div id="canvasPlaceholder" class="placeholder-message italic">
                            <p class="px-4">解析完了後、右側の表の行をクリックすると<br>ここにプレビューが表示されます</p>
                        </div>
                        <canvas id="canvasOutput" class="hidden"></canvas>
                    </div>
                </div>
            </div>

            <!-- 解析結果 -->
            <div class="xl:col-span-8 space-y-4">
                <div id="auditBanner" class="hidden p-4 rounded-xl shadow-sm flex flex-col md:flex-row md:items-center justify-between gap-4">
                    <div class="flex items-center">
                        <span id="auditIcon" class="text-2xl mr-3"></span>
                        <div>
                            <p id="auditStatusTitle" class="font-bold text-sm"></p>
                            <p id="auditDetails" class="text-xs opacity-90"></p>
                        </div>
                    </div>
                    <div class="bg-white/20 p-2 rounded text-[10px] font-mono whitespace-pre" id="calcBreakdown"></div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    <table class="w-full text-left text-xs">
                        <thead class="bg-gray-50 text-gray-500 uppercase border-b text-[10px]">
                            <tr>
                                <th class="px-3 py-2 w-10">P.</th>
                                <th class="px-3 py-2 w-20">請求日</th>
                                <th class="px-3 py-2 w-24">請求番号</th>
                                <th class="px-3 py-2">ベンダー</th>
                                <th class="px-3 py-2 text-right">記載合計</th>
                                <th class="px-3 py-2 text-right">明細計</th>
                                <th class="px-3 py-2 text-center">判定</th>
                            </tr>
                        </thead>
                        <tbody id="summaryBody" class="divide-y divide-gray-100 italic text-gray-400">
                            <tr><td colspan="7" class="p-4 text-center text-xs">ファイルをアップロードしてください</td></tr>
                        </tbody>
                    </table>
                </div>

                <div id="detailSection" class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden hidden text-xs">
                    <div class="p-3 bg-blue-50 border-b flex justify-between items-center">
                        <h2 class="font-bold text-blue-900">明細項目エディタ</h2>
                        <span id="detailPageInfo" class="text-[10px] bg-blue-200 text-blue-800 px-2 py-1 rounded"></span>
                    </div>
                    <div class="table-container overflow-x-auto">
                        <table class="w-full text-left text-[11px] min-w-[1000px]">
                            <thead class="bg-gray-100 text-gray-600 border-b">
                                <tr>
                                    <th class="px-2 py-2 w-24">利用日</th>
                                    <th class="px-2 py-2 w-20">工番</th>
                                    <th class="px-2 py-2 w-24">発注番号</th>
                                    <th class="px-2 py-2 w-24">管理番号</th>
                                    <th class="px-3 py-2">商品名・内容（テキスト内工番も抽出）</th>
                                    <th class="px-2 py-2 w-12 text-right">数量</th>
                                    <th class="px-2 py-2 w-20 text-right">単価</th>
                                    <th class="px-2 py-2 w-24 text-right">金額</th>
                                </tr>
                            </thead>
                            <tbody id="detailBody" class="divide-y divide-gray-100 text-[10px]"></tbody>
                        </table>
                    </div>
                </div>

                <div class="bg-black rounded-xl p-3 h-20 overflow-y-auto font-mono text-[10px] text-green-400" id="logContent">
                    > System ready.
                </div>
            </div>
        </div>
    </div>

    <div id="loadingOverlay" class="fixed inset-0 bg-black/70 hidden flex flex-col items-center justify-center z-50">
        <div class="loader ease-linear rounded-full border-4 border-white h-12 w-12 mb-4"></div>
        <p id="loadingStatus" class="text-white font-bold">AI処理中...</p>
    </div>

    <script type="module">
        const apiKey = "AIzaSyAq03bdf-hZHaFTqEllCXQBO3ul-s6V2lo";
        
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        const elements = {
            fileInput: document.getElementById('fileInput'),
            processBtn: document.getElementById('processBtn'),
            summaryBody: document.getElementById('summaryBody'),
            detailBody: document.getElementById('detailBody'),
            detailSection: document.getElementById('detailSection'),
            auditBanner: document.getElementById('auditBanner'),
            loadingOverlay: document.getElementById('loadingOverlay'),
            canvasOutput: document.getElementById('canvasOutput'),
            canvasPlaceholder: document.getElementById('canvasPlaceholder'),
            previewContainer: document.getElementById('previewContainer'),
            resetZoom: document.getElementById('resetZoom'),
            log: document.getElementById('logContent')
        };

        let extractionResults = [];
        let pageImages = [];
        let scale = 1;
        let originX = 0;
        let originY = 0;
        let isDragging = false;
        let startX, startY;

        const addLog = (msg) => {
            const div = document.createElement('div');
            div.textContent = `> ${msg}`;
            elements.log.appendChild(div);
            elements.log.scrollTop = elements.log.scrollHeight;
        };

        function updateTransform() {
            elements.canvasOutput.style.transform = `translate(${originX}px, ${originY}px) scale(${scale})`;
        }

        function resetZoomState() {
            if (!elements.canvasOutput.width) return;
            const containerWidth = elements.previewContainer.clientWidth;
            scale = containerWidth / elements.canvasOutput.width;
            originX = 0;
            originY = 0;
            updateTransform();
        }

        elements.previewContainer.addEventListener('wheel', (e) => {
            e.preventDefault();
            const zoomSpeed = 0.1;
            const delta = e.deltaY > 0 ? -zoomSpeed : zoomSpeed;
            const newScale = Math.min(Math.max(0.1, scale + delta), 5);
            const rect = elements.previewContainer.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;
            const beforeX = (mouseX - originX) / scale;
            const beforeY = (mouseY - originY) / scale;
            scale = newScale;
            originX = mouseX - beforeX * scale;
            originY = mouseY - beforeY * scale;
            updateTransform();
        }, { passive: false });

        elements.previewContainer.addEventListener('mousedown', (e) => {
            isDragging = true;
            startX = e.clientX - originX;
            startY = e.clientY - originY;
        });

        window.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            originX = e.clientX - startX;
            originY = e.clientY - startY;
            updateTransform();
        });

        window.addEventListener('mouseup', () => { isDragging = false; });
        elements.resetZoom.onclick = resetZoomState;

        async function fileToImages(file) {
            if (file.type.startsWith('image/')) return [URL.createObjectURL(file)];
            const pdf = await pdfjsLib.getDocument({ data: await file.arrayBuffer() }).promise;
            const urls = [];
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const viewport = page.getViewport({ scale: 2.0 });
                const canvas = document.createElement('canvas');
                canvas.height = viewport.height; canvas.width = viewport.width;
                await page.render({ canvasContext: canvas.getContext('2d'), viewport }).promise;
                urls.push(canvas.toDataURL('image/png'));
            }
            return urls;
        }

        async function callGemini(base64Image) {
            const schema = {
                type: "OBJECT",
                properties: {
                    summary: {
                        type: "OBJECT",
                        properties: {
                            Vendor: { type: "STRING" },
                            InvoiceDate: { type: "STRING" },
                            InvoiceNo: { type: "STRING" },
                            TotalAmount: { type: "NUMBER" }
                        }
                    },
                    items: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                Date: { type: "STRING" },
                                JobCode: { type: "STRING" },
                                OrderNo: { type: "STRING" },
                                RefNo: { type: "STRING" },
                                Description: { type: "STRING" },
                                Quantity: { type: "NUMBER" },
                                UnitPrice: { type: "NUMBER" },
                                LineAmount: { type: "NUMBER" }
                            }
                        }
                    }
                }
            };

            const payload = {
                contents: [{
                    parts: [
                        { text: "請求明細を抽出してください。工番(JobCode: 英1字+数字4桁。例:A1234, i1400)が商品名や備考のテキスト内に埋め込まれている場合も、正規表現的に探し出してJobCodeとして抽出してください。" },
                        { inlineData: { mimeType: "image/png", data: base64Image.split(',')[1] } }
                    ]
                }],
                generationConfig: { responseMimeType: "application/json", responseSchema: schema }
            };

            const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                method: 'POST',
                body: JSON.stringify(payload)
            });
            const data = await resp.json();
            return JSON.parse(data.candidates[0].content.parts[0].text);
        }

        elements.processBtn.addEventListener('click', async () => {
            const file = elements.fileInput.files[0];
            if (!file) return;
            elements.loadingOverlay.classList.remove('hidden');
            extractionResults = []; pageImages = [];
            
            try {
                const rawImages = await fileToImages(file);
                for (let i = 0; i < rawImages.length; i++) {
                    document.getElementById('loadingStatus').textContent = `${i+1}/${rawImages.length} ページ解析中...`;
                    const result = await callGemini(rawImages[i]);
                    const itemSum = (result.items || []).reduce((acc, cur) => acc + (parseFloat(cur.LineAmount) || 0), 0);
                    extractionResults.push({ page: i + 1, ...result, itemSum });
                    pageImages.push(rawImages[i]);
                    renderSummary();
                }
                addLog("解析が完了しました。行をクリックして詳細を確認してください。");
            } catch (e) {
                addLog(`Error: ${e.message}`);
                console.error(e);
            } finally {
                elements.loadingOverlay.classList.add('hidden');
            }
        });

        function renderSummary() {
            elements.summaryBody.innerHTML = '';
            extractionResults.forEach((res, idx) => {
                const diff = Math.abs((res.summary.TotalAmount || 0) - res.itemSum);
                const isMatch = diff < 5;
                const tr = document.createElement('tr');
                tr.className = "border-b cursor-pointer hover:bg-blue-50 transition text-[11px]";
                tr.innerHTML = `
                    <td class="px-3 py-3 text-center text-gray-400 font-mono">${res.page}</td>
                    <td class="px-3 py-3">${res.summary.InvoiceDate || "-"}</td>
                    <td class="px-3 py-3 font-mono">${res.summary.InvoiceNo || "-"}</td>
                    <td class="px-3 py-3 font-medium truncate max-w-[120px]">${res.summary.Vendor || "不明"}</td>
                    <td class="px-3 py-3 text-right font-bold">¥${(res.summary.TotalAmount||0).toLocaleString()}</td>
                    <td class="px-3 py-3 text-right text-gray-600">¥${res.itemSum.toLocaleString()}</td>
                    <td class="px-3 py-3 text-center">
                        <span class="px-2 py-0.5 rounded text-[10px] font-bold ${isMatch ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">
                            ${isMatch ? 'OK' : '要確認'}
                        </span>
                    </td>
                `;
                tr.onclick = () => showDetails(idx);
                elements.summaryBody.appendChild(tr);
            });
        }

        async function showDetails(index) {
            const res = extractionResults[index];
            document.querySelectorAll('#summaryBody tr').forEach((r, i) => r.classList.toggle('selected-row', i === index));
            elements.canvasPlaceholder.classList.add('hidden');
            elements.canvasOutput.classList.remove('hidden');

            const img = new Image(); 
            img.onload = () => {
                elements.canvasOutput.width = img.width; 
                elements.canvasOutput.height = img.height;
                elements.canvasOutput.getContext('2d').drawImage(img, 0, 0);
                resetZoomState();
            }; 
            img.src = pageImages[index];

            const diff = (res.summary.TotalAmount || 0) - res.itemSum;
            const isMatch = Math.abs(diff) < 5;
            elements.auditBanner.classList.remove('hidden', 'diff-error', 'diff-ok');
            elements.auditBanner.classList.add(isMatch ? 'diff-ok' : 'diff-error');
            document.getElementById('auditIcon').textContent = isMatch ? "✅" : "⚠️";
            document.getElementById('auditStatusTitle').textContent = isMatch ? "金額は一致しています" : "不一致の原因をチェックしてください";
            document.getElementById('auditDetails').textContent = `記載合計: ¥${(res.summary.TotalAmount||0).toLocaleString()} / 明細計: ¥${res.itemSum.toLocaleString()}`;
            document.getElementById('calcBreakdown').textContent = `[監査ログ] P.${res.page}\n記載合計: ${res.summary.TotalAmount}\n明細合計: ${res.itemSum}\n差分: ${diff}`;

            elements.detailSection.classList.remove('hidden');
            document.getElementById('detailPageInfo').textContent = `P.${res.page} | ${res.summary.Vendor}`;
            elements.detailBody.innerHTML = '';
            
            res.items.forEach((item, i) => {
                const tr = document.createElement('tr');
                const createInput = (field, val, placeholder) => {
                    const input = document.createElement('input');
                    input.value = val !== undefined ? val : ""; 
                    input.placeholder = placeholder;
                    input.className = "input-cell";
                    input.onchange = (e) => { 
                        extractionResults[index].items[i][field] = e.target.value;
                        if(['Quantity','UnitPrice','LineAmount'].includes(field)) {
                             const q = parseFloat(extractionResults[index].items[i].Quantity) || 0;
                             const u = parseFloat(extractionResults[index].items[i].UnitPrice) || 0;
                             if(field !== 'LineAmount') extractionResults[index].items[i].LineAmount = q * u;
                             extractionResults[index].itemSum = extractionResults[index].items.reduce((a,c)=>a+(parseFloat(c.LineAmount)||0),0);
                             renderSummary();
                        }
                    };
                    return input;
                };

                tr.innerHTML = `<td class="p-1"></td><td class="p-1"></td><td class="p-1"></td><td class="p-1"></td>
                                <td class="px-3 py-1 font-medium text-gray-700">${item.Description || ""}</td>
                                <td class="px-2 text-right"></td><td class="px-2 text-right"></td><td class="px-2 text-right font-bold text-blue-800"></td>`;
                
                tr.cells[0].appendChild(createInput('Date', item.Date, "MM.DD"));
                tr.cells[1].appendChild(createInput('JobCode', item.JobCode, "A1234"));
                tr.cells[2].appendChild(createInput('OrderNo', item.OrderNo, "注文#"));
                tr.cells[3].appendChild(createInput('RefNo', item.RefNo, "管理#"));
                tr.cells[5].appendChild(createInput('Quantity', item.Quantity, "0"));
                tr.cells[6].appendChild(createInput('UnitPrice', item.UnitPrice, "0"));
                tr.cells[7].appendChild(createInput('LineAmount', item.LineAmount, "0"));

                elements.detailBody.appendChild(tr);
            });
        }

        document.getElementById('downloadCsv').addEventListener('click', () => {
            if (extractionResults.length === 0) return;

            // CSVヘッダー: 会計・管理用レイアウト
            const headers = [
                "ページ", "行番号", "請求日", "請求番号", "ベンダー名", 
                "利用日", "工番", "発注番号", "管理番号", "内容", 
                "数量", "単価", "金額", "判定エラー"
            ];

            let csvContent = "\uFEFF"; // BOM for Excel
            csvContent += headers.join(",") + "\n";

            extractionResults.forEach(res => {
                const diff = Math.abs((res.summary.TotalAmount || 0) - res.itemSum);
                const isError = diff >= 5 ? "金額不一致" : "";

                (res.items || []).forEach((it, idx) => {
                    // 安全な値取得関数
                    const safe = (val) => {
                        if (val === undefined || val === null) return '""';
                        // カンマ、改行、ダブルクォートが含まれる場合はエスケープ
                        const s = String(val).replace(/"/g, '""');
                        return `"${s}"`;
                    };

                    const row = [
                        res.page,
                        idx + 1,
                        safe(res.summary.InvoiceDate),
                        safe(res.summary.InvoiceNo),
                        safe(res.summary.Vendor),
                        safe(it.Date),
                        safe(it.JobCode),
                        safe(it.OrderNo),
                        safe(it.RefNo),
                        safe(it.Description),
                        it.Quantity || 0,
                        it.UnitPrice || 0,
                        it.LineAmount || 0,
                        safe(isError)
                    ];
                    csvContent += row.join(",") + "\n";
                });
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const fileName = `請求監査結果_${new Date().toISOString().slice(0,10)}.csv`;
            
            if (navigator.msSaveBlob) { // IE 10+
                navigator.msSaveBlob(blob, fileName);
            } else {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", fileName);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
            addLog("CSVファイルを出力しました。");
        });
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>工事用黒板編集ツール</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kosugi+Maru&family=M+PLUS+Rounded+1c:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body {
            font-family: 'M PLUS Rounded 1c', sans-serif;
            background-color: #f3f4f6;
            touch-action: manipulation;
        }
        
        .canvas-container {
            background-image: repeating-linear-gradient(45deg, #e5e7eb 25%, transparent 25%, transparent 75%, #e5e7eb 75%, #e5e7eb), repeating-linear-gradient(45deg, #e5e7eb 25%, #f3f4f6 25%, #f3f4f6 75%, #e5e7eb 75%, #e5e7eb);
            background-position: 0 0, 10px 10px;
            background-size: 20px 20px;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.1);
        }

        input[type=range] {
            height: 24px;
            -webkit-appearance: none;
            margin: 5px 0;
            width: 100%;
            background: transparent;
        }
        input[type=range]:focus {
            outline: none;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 6px;
            cursor: pointer;
            background: #cbd5e1;
            border-radius: 4px;
        }
        input[type=range]::-webkit-slider-thumb {
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            -webkit-appearance: none;
            margin-top: -7px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        .tab-active {
            background-color: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        
        .sr-input {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            border: 0;
            opacity: 0;
        }
    </style>
</head>
<body class="text-gray-800 pb-10">

    <header class="bg-slate-800 text-white p-4 shadow-md sticky top-0 z-50 flex justify-between items-center">
        <h1 class="text-lg font-bold flex items-center gap-2">
            <span class="material-icons">construction</span>
            工事用黒板ツール
        </h1>
        <div id="saveStatus" class="text-xs font-bold bg-white/20 px-2 py-1 rounded text-white flex items-center gap-1 opacity-0 transition-opacity duration-500">
            <span class="material-icons text-xs">cloud_done</span> 保存済み
        </div>
    </header>

    <div class="container mx-auto px-4 mt-6 max-w-6xl">
        
        <div class="flex flex-col md:flex-row gap-6">

            <!-- 左側: キャンバスエリア -->
            <div class="editor-area w-full md:w-2/3 flex flex-col gap-4">
                
                <!-- 撮影ルール -->
                <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded-r shadow-sm">
                    <div class="flex items-center mb-2">
                        <span class="material-icons text-yellow-600 mr-2">campaign</span>
                        <h3 class="font-bold text-gray-800 text-lg">撮影時のルール</h3>
                    </div>
                    <ul class="list-none space-y-2 text-sm md:text-base font-bold text-gray-700">
                        <li class="flex items-start">
                            <span class="material-icons text-blue-500 mr-2 text-base md:text-lg">screen_rotation</span>
                            <span>撮影カメラの向きは<span class="text-red-600 underline decoration-2 decoration-red-400">横向き</span>で</span>
                        </li>
                        <li class="flex items-start">
                            <span class="material-icons text-green-600 mr-2 text-base md:text-lg">local_shipping</span>
                            <span><span class="text-red-600">積載量・ナンバー</span>が映るように</span>
                        </li>
                        <li class="flex items-start">
                            <span class="material-icons text-red-500 mr-2 text-base md:text-lg">do_not_disturb_on</span>
                            <span>アップすぎる写真は×（全体を入れてください）</span>
                        </li>
                    </ul>
                </div>

                <!-- 画像入力エリア -->
                <div class="grid grid-cols-2 gap-4 relative">
                    <input type="file" id="cameraInput" accept="image/*" capture="environment" class="sr-input">
                    <input type="file" id="fileInput" accept="image/*" class="sr-input">

                    <button type="button" onclick="document.getElementById('cameraInput').click()" class="border-2 border-dashed border-blue-300 rounded-xl p-4 text-center bg-blue-50 hover:bg-blue-100 transition-colors cursor-pointer flex flex-col items-center justify-center h-28 active:scale-95 shadow-sm select-none touch-manipulation">
                        <span class="material-icons text-3xl text-blue-500 mb-2">photo_camera</span>
                        <span class="text-sm font-bold text-blue-700">カメラ起動</span>
                    </button>

                    <button type="button" onclick="document.getElementById('fileInput').click()" class="border-2 border-dashed border-gray-300 rounded-xl p-4 text-center bg-white hover:bg-gray-50 transition-colors cursor-pointer flex flex-col items-center justify-center h-28 active:scale-95 shadow-sm select-none touch-manipulation">
                        <span class="material-icons text-3xl text-gray-400 mb-2">photo_library</span>
                        <span class="text-sm font-bold text-gray-600">アルバム選択</span>
                    </button>
                </div>

                <!-- キャンバス -->
                <div class="canvas-container w-full rounded-lg overflow-hidden border border-gray-200 bg-white relative">
                    <div id="loading" class="hidden absolute inset-0 bg-white/80 z-20 flex items-center justify-center">
                        <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600"></div>
                    </div>
                    <canvas id="mainCanvas" class="w-full h-auto block mx-auto" style="max-height: 80vh;"></canvas>
                </div>
                
                <button onclick="downloadImage()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-6 rounded-lg shadow-lg flex items-center justify-center gap-2 text-lg active:scale-95 transition-transform touch-manipulation">
                    <span class="material-icons">download</span>
                    画像を保存
                </button>
            </div>

            <!-- 右側: 操作パネル -->
            <div class="controls w-full md:w-1/3 flex flex-col gap-4">

                <!-- タブボタン -->
                <div class="flex rounded-lg shadow-sm overflow-hidden border border-blue-600 bg-white">
                    <button type="button" onclick="switchTab('settings')" id="btn-tab-settings" class="tab-btn flex-1 py-3 text-sm font-bold text-blue-600 border-r border-blue-600 hover:bg-blue-50 active:bg-blue-100 transition-colors flex items-center justify-center gap-1 tab-active touch-manipulation">
                        <span class="material-icons text-base">dashboard</span>設定
                    </button>
                    <button type="button" onclick="switchTab('content')" id="btn-tab-content" class="tab-btn flex-1 py-3 text-sm font-bold text-blue-600 border-r border-blue-600 hover:bg-blue-50 active:bg-blue-100 transition-colors flex items-center justify-center gap-1 touch-manipulation">
                        <span class="material-icons text-base">edit</span>編集
                    </button>
                    <button type="button" onclick="switchTab('adjust')" id="btn-tab-adjust" class="tab-btn flex-1 py-3 text-sm font-bold text-blue-600 hover:bg-blue-50 active:bg-blue-100 transition-colors flex items-center justify-center gap-1 touch-manipulation">
                        <span class="material-icons text-base">tune</span>調整
                    </button>
                </div>
                
                <!-- タブコンテンツ: 設定 -->
                <div id="tab-settings" class="tab-content bg-white p-4 rounded-lg shadow-sm border border-gray-200 space-y-4">
                    <div>
                        <h3 class="font-bold text-gray-700 mb-3 flex items-center gap-2 border-b pb-2">
                            <span class="material-icons text-green-700">dashboard</span> 黒板設定
                        </h3>
                        
                        <div class="grid grid-cols-2 gap-3 mb-3">
                            <button type="button" onclick="setBoardPos('left')" class="btn-pos bg-gray-100 hover:bg-gray-200 py-2 rounded text-sm font-bold border border-gray-300 active:bg-blue-100 active:border-blue-500 touch-manipulation">
                                左下に配置
                            </button>
                            <button type="button" onclick="setBoardPos('right')" class="btn-pos bg-gray-100 hover:bg-gray-200 py-2 rounded text-sm font-bold border border-gray-300 active:bg-blue-100 active:border-blue-500 touch-manipulation">
                                右下に配置
                            </button>
                        </div>

                        <div class="grid grid-cols-2 gap-3 mb-3">
                             <div class="flex flex-col">
                                <label class="text-xs text-gray-500 mb-1">黒板の色</label>
                                <select id="boardColor" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                                    <option value="green">緑 (標準)</option>
                                    <option value="black">黒板 (黒)</option>
                                    <option value="white">ホワイトボード</option>
                                    <option value="blue">青 (現場用)</option>
                                </select>
                            </div>
                            <div class="flex flex-col">
                                <label class="text-xs text-gray-500 mb-1">サイズ</label>
                                <select id="boardSize" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                                    <option value="small">小 (Small)</option>
                                    <option value="medium">中 (Medium)</option>
                                    <option value="large" selected>大 (Large)</option>
                                    <option value="extraLarge">特大 (Ex-Large)</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="text-xs text-gray-500 mb-1">フォント</label>
                            <select id="fontFamily" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                                <option value="'M PLUS Rounded 1c', sans-serif">M PLUS Rounded 1c (丸ゴシック)</option>
                                <option value="'Kosugi Maru', monospace">Kosugi Maru (等幅風)</option>
                                <option value="sans-serif">標準ゴシック</option>
                                <option value="serif">標準明朝</option>
                            </select>
                        </div>

                        <div class="border-t pt-3 mb-3">
                            <label class="text-sm font-bold text-gray-600 flex justify-between items-center mb-2">
                                <span>施工者枠を表示</span>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="showConstructor" class="sr-only peer">
                                    <div class="w-9 h-5 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-blue-600"></div>
                                </label>
                            </label>
                            <input type="text" id="inputConstructor" placeholder="ヒューマンヤード(株)" class="w-full p-2 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-200 outline-none">
                        </div>
                    </div>

                    <div class="flex items-center justify-between border-t pt-3">
                        <label class="text-sm font-bold text-gray-600">黒板表示</label>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="toggleBoard" class="sr-only peer" checked>
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                        </label>
                    </div>
                </div>

                <!-- タブコンテンツ: 編集 -->
                <div id="tab-content" class="tab-content hidden bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                    <div class="bg-gray-50 p-3 border-b border-gray-200 font-bold text-gray-700 flex items-center gap-2">
                        <span class="material-icons text-blue-600">edit</span> 内容編集
                    </div>
                    
                    <div class="p-4 flex flex-col gap-4">

                        <div class="border-b pb-3 border-dashed border-gray-300">
                            <label class="block text-sm font-bold text-gray-700 mb-1">工事件名</label>
                            <input type="text" id="inputProject" placeholder="◯◯改修工事" class="w-full p-2 border border-gray-300 rounded mb-2 focus:ring-2 focus:ring-blue-200 outline-none">
                        </div>

                        <div class="border-b pb-3 border-dashed border-gray-300">
                            <label class="block text-sm font-bold text-gray-700 mb-1">工事場所</label>
                            <input type="text" id="inputWorkType" placeholder="東京都〇〇区..." class="w-full p-2 border border-gray-300 rounded mb-2 focus:ring-2 focus:ring-blue-200 outline-none">
                        </div>
                        
                        <div id="containerMemo" class="border-b pb-3 border-dashed border-gray-300">
                            <div class="flex justify-between items-center mb-2">
                                <label class="block text-sm font-bold text-gray-700">備考・内容</label>
                                <button type="button" onclick="clearMemo()" class="text-xs text-red-500 bg-red-50 hover:bg-red-100 border border-red-200 px-2 py-1 rounded flex items-center gap-1 touch-manipulation">
                                    <span class="material-icons text-xs">delete_outline</span>クリア
                                </button>
                            </div>
                            
                            <!-- 土砂・台数入力支援 (更新) -->
                            <div class="bg-blue-50 p-3 rounded-lg mb-2 border border-blue-100">
                                <div class="text-xs font-bold text-blue-700 mb-2">土砂・車両・台数 (即時反映)</div>
                                
                                <!-- 土種 -->
                                <div class="flex flex-wrap gap-3 mb-2">
                                    <label class="inline-flex items-center cursor-pointer">
                                        <input type="radio" name="soilType" value="残土搬出" class="text-blue-600 focus:ring-blue-500" checked onchange="updateSoilDirectly()">
                                        <span class="ml-1 text-sm text-gray-700">残土搬出</span>
                                    </label>
                                    <label class="inline-flex items-center cursor-pointer">
                                        <input type="radio" name="soilType" value="客土搬入" class="text-blue-600 focus:ring-blue-500" onchange="updateSoilDirectly()">
                                        <span class="ml-1 text-sm text-gray-700">客土搬入</span>
                                    </label>
                                    <label class="inline-flex items-center cursor-pointer">
                                        <input type="radio" name="soilType" value="" class="text-blue-600 focus:ring-blue-500" onchange="updateSoilDirectly()">
                                        <span class="ml-1 text-sm text-gray-700">（なし）</span>
                                    </label>
                                </div>

                                <!-- 積載量 -->
                                <div class="flex flex-wrap gap-2 mb-2 items-center">
                                    <span class="text-xs font-bold text-gray-600">積載:</span>
                                    <label class="inline-flex items-center cursor-pointer bg-white px-2 py-1 rounded border border-blue-100"><input type="radio" name="truckCap" value="2t" class="text-blue-600 focus:ring-blue-500" onchange="updateSoilDirectly()"><span class="ml-1 text-xs">2t</span></label>
                                    <label class="inline-flex items-center cursor-pointer bg-white px-2 py-1 rounded border border-blue-100"><input type="radio" name="truckCap" value="3t" class="text-blue-600 focus:ring-blue-500" checked onchange="updateSoilDirectly()"><span class="ml-1 text-xs">3t</span></label>
                                    <label class="inline-flex items-center cursor-pointer bg-white px-2 py-1 rounded border border-blue-100"><input type="radio" name="truckCap" value="4t" class="text-blue-600 focus:ring-blue-500" onchange="updateSoilDirectly()"><span class="ml-1 text-xs">4t</span></label>
                                    <label class="inline-flex items-center cursor-pointer bg-white px-2 py-1 rounded border border-blue-100"><input type="radio" name="truckCap" value="8t" class="text-blue-600 focus:ring-blue-500" onchange="updateSoilDirectly()"><span class="ml-1 text-xs">8t</span></label>
                                    <label class="inline-flex items-center cursor-pointer"><input type="radio" name="truckCap" value="" class="text-blue-600 focus:ring-blue-500" onchange="updateSoilDirectly()"><span class="ml-1 text-xs">なし</span></label>
                                </div>

                                <!-- カウンター -->
                                <div class="flex items-center gap-2">
                                    <div class="flex items-center border border-gray-300 rounded-md bg-white overflow-hidden flex-1">
                                        <button type="button" onclick="changeCounter(-1)" class="px-3 py-2 bg-gray-100 hover:bg-gray-200 text-gray-600 active:bg-gray-300 border-r border-gray-200 touch-manipulation">
                                            <span class="material-icons text-sm">remove</span>
                                        </button>
                                        <span id="counterValue" class="flex-1 px-2 py-2 font-bold text-center">1</span>
                                        <button type="button" onclick="changeCounter(1)" class="px-3 py-2 bg-gray-100 hover:bg-gray-200 text-gray-600 active:bg-gray-300 border-l border-gray-200 touch-manipulation">
                                            <span class="material-icons text-sm">add</span>
                                        </button>
                                    </div>
                                    <span class="text-sm text-gray-600 font-bold whitespace-nowrap">台目</span>
                                    <button type="button" onclick="updateSoilDirectly(true)" class="bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold px-3 py-2 rounded-md shadow-sm active:scale-95 transition-transform touch-manipulation">
                                        挿入/更新
                                    </button>
                                </div>
                            </div>

                            <textarea id="inputMemo" rows="3" placeholder="状況写真&#13;&#10;配筋D13&#13;&#10;@200" class="w-full p-2 border border-gray-300 rounded mb-2 focus:ring-2 focus:ring-blue-200 outline-none resize-none"></textarea>
                        </div>

                        <div>
                            <div class="flex justify-between items-center mb-1">
                                <label class="block text-sm font-bold text-gray-700">日付・時間</label>
                                <div class="flex items-center gap-3">
                                    <label class="text-xs flex items-center gap-1 cursor-pointer font-bold text-blue-600 bg-blue-50 px-2 py-1 rounded border border-blue-200">
                                        <input type="checkbox" id="toggleTime" class="rounded text-blue-600 focus:ring-blue-500" checked>
                                        時間も
                                    </label>
                                    <button type="button" onclick="setToday()" class="bg-gray-200 px-2 py-1 rounded text-xs hover:bg-gray-300 font-bold text-gray-600 flex items-center gap-1 touch-manipulation">
                                        <span class="material-icons text-xs">update</span>現在
                                    </button>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <input type="date" id="inputDate" class="flex-1 p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-200 outline-none">
                                <input type="time" id="inputTime" class="w-24 p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-200 outline-none">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- タブコンテンツ: 調整 -->
                <div id="tab-adjust" class="tab-content hidden bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                    <div class="bg-gray-50 p-3 border-b border-gray-200 font-bold text-gray-700 flex items-center gap-2">
                        <span class="material-icons text-gray-500">tune</span> サイズ・位置調整
                    </div>
                    <div class="p-4 border-t border-gray-200 space-y-4">
                        
                        <!-- 個別サイズ調整 -->
                        <div>
                            <div class="flex justify-between text-xs font-bold text-gray-700 mb-1">
                                <span>工事件名 サイズ</span>
                                <span id="valScaleProject" class="bg-gray-100 px-1 rounded text-gray-500">1.0</span>
                            </div>
                            <input type="range" id="scaleProject" min="0.5" max="2.0" step="0.1" value="1.0">
                        </div>

                        <div>
                            <div class="flex justify-between text-xs font-bold text-gray-700 mb-1">
                                <span>工事場所 サイズ</span>
                                <span id="valScaleWorkType" class="bg-gray-100 px-1 rounded text-gray-500">1.0</span>
                            </div>
                            <input type="range" id="scaleWorkType" min="0.5" max="2.0" step="0.1" value="1.0">
                        </div>

                        <div>
                            <div class="flex justify-between text-xs font-bold text-gray-700 mb-1">
                                <span>備考・内容 サイズ</span>
                                <span id="valScaleMemo" class="bg-gray-100 px-1 rounded text-gray-500">1.0</span>
                            </div>
                            <input type="range" id="scaleMemo" min="0.5" max="2.0" step="0.1" value="1.0">
                        </div>

                        <hr class="border-gray-200 my-2">

                        <div>
                            <label class="text-xs font-bold text-gray-700 mb-1 block">日付・時間の位置</label>
                            <div class="grid grid-cols-2 gap-2 text-sm">
                                <label class="flex items-center gap-2 cursor-pointer bg-gray-50 p-2 rounded border border-gray-200">
                                    <input type="radio" name="datePos" value="left" class="text-blue-600 focus:ring-blue-500">
                                    <span>左下</span>
                                </label>
                                <label class="flex items-center gap-2 cursor-pointer bg-gray-50 p-2 rounded border border-gray-200">
                                    <input type="radio" name="datePos" value="right" class="text-blue-600 focus:ring-blue-500" checked>
                                    <span>右下</span>
                                </label>
                            </div>
                        </div>

                        <hr class="border-gray-200 my-2">

                        <div>
                            <div class="flex justify-between text-xs font-bold text-gray-700 mb-1">
                                <span>行間 / 余白</span>
                                <span id="dispLineHeight" class="bg-gray-100 px-1 rounded text-gray-500">1.2</span>
                            </div>
                            <input type="range" id="lineHeight" min="0.8" max="2.0" step="0.1" value="1.2">
                        </div>

                        <div>
                            <label class="text-xs font-bold text-gray-700 block mb-2">黒板内 微調整 (Y軸)</label>
                            <div class="grid grid-cols-2 gap-2">
                                <button type="button" onclick="adjustOffset(-5)" class="bg-gray-100 p-2 rounded hover:bg-gray-200 text-sm touch-manipulation"><span class="material-icons text-sm align-middle">arrow_upward</span> 上へ</button>
                                <button type="button" onclick="adjustOffset(5)" class="bg-gray-100 p-2 rounded hover:bg-gray-200 text-sm touch-manipulation"><span class="material-icons text-sm align-middle">arrow_downward</span> 下へ</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="text-center mt-2">
                    <button type="button" onclick="resetAll()" class="text-sm text-red-500 underline hover:text-red-700 touch-manipulation">全てリセット</button>
                </div>

            </div>
        </div>
    </div>

    <!-- Core Application Logic -->
    <script>
        (function() {
            // 初期状態
            const initialState = {
                image: null,
                boardPos: 'right', 
                boardSize: 'large',
                boardColor: 'green',
                showBoard: true,
                showTime: true,
                datePos: 'right',
                showConstructor: false,
                text: {
                    project: '',
                    workType: '',
                    memo: '',
                    date: '',
                    time: '',
                    constructorName: 'ヒューマンヤード(株)'
                },
                style: {
                    fontFamily: "'M PLUS Rounded 1c', sans-serif",
                    fontSizeBase: 24, 
                    fontScaleProject: 1.0,
                    fontScaleWorkType: 1.0,
                    fontScaleMemo: 1.0,
                    lineHeight: 1.2,
                    yOffset: 0
                }
            };

            window.state = JSON.parse(JSON.stringify(initialState));
            window.requestSave = function() {}; 

            let counterValue = 1;
            let canvas, ctx, loading;

            document.addEventListener('DOMContentLoaded', () => {
                canvas = document.getElementById('mainCanvas');
                ctx = canvas.getContext('2d');
                loading = document.getElementById('loading');

                setToday();
                loadPlaceholder();
                setupEventListeners();
            });

            function setupEventListeners() {
                document.getElementById('cameraInput').addEventListener('change', handleImageUpload);
                document.getElementById('fileInput').addEventListener('change', handleImageUpload);

                ['inputProject', 'inputWorkType', 'inputMemo', 'inputDate', 'inputTime', 'inputConstructor'].forEach(id => {
                    document.getElementById(id).addEventListener('input', (e) => {
                        const map = {
                            'inputProject': 'project',
                            'inputWorkType': 'workType',
                            'inputMemo': 'memo',
                            'inputDate': 'date',
                            'inputTime': 'time',
                            'inputConstructor': 'constructorName'
                        };
                        if(map[e.target.id]) {
                            window.state.text[map[e.target.id]] = e.target.value;
                            draw();
                            window.requestSave();
                        }
                    });
                });

                document.getElementById('boardColor').addEventListener('change', (e) => { window.state.boardColor = e.target.value; draw(); window.requestSave(); });
                document.getElementById('boardSize').addEventListener('change', (e) => { window.state.boardSize = e.target.value; draw(); window.requestSave(); });
                document.getElementById('toggleBoard').addEventListener('change', (e) => { window.state.showBoard = e.target.checked; draw(); window.requestSave(); });
                document.getElementById('toggleTime').addEventListener('change', (e) => { window.state.showTime = e.target.checked; draw(); window.requestSave(); });
                document.getElementById('showConstructor').addEventListener('change', (e) => { window.state.showConstructor = e.target.checked; draw(); window.requestSave(); });
                document.getElementById('fontFamily').addEventListener('change', (e) => { window.state.style.fontFamily = e.target.value; draw(); window.requestSave(); });

                setupSlider('scaleProject', 'fontScaleProject', 'valScaleProject');
                setupSlider('scaleWorkType', 'fontScaleWorkType', 'valScaleWorkType');
                setupSlider('scaleMemo', 'fontScaleMemo', 'valScaleMemo');
                setupSlider('lineHeight', 'lineHeight', 'dispLineHeight');

                document.querySelectorAll('input[name="datePos"]').forEach(radio => {
                    radio.addEventListener('change', (e) => {
                        window.state.datePos = e.target.value;
                        draw();
                        window.requestSave();
                    });
                });
            }

            function setupSlider(id, stateKey, displayId) {
                const el = document.getElementById(id);
                if(el) {
                    el.addEventListener('input', (e) => {
                        window.state.style[stateKey] = parseFloat(e.target.value);
                        document.getElementById(displayId).innerText = window.state.style[stateKey];
                        draw();
                        window.requestSave();
                    });
                }
            }

            // Window Exposed Functions
            window.switchTab = function(tabName) {
                document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
                document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('tab-active'));
                document.getElementById(`tab-${tabName}`).classList.remove('hidden');
                document.getElementById(`btn-tab-${tabName}`).classList.add('tab-active');
            };

            window.setBoardPos = function(pos) {
                window.state.boardPos = pos;
                draw();
                window.requestSave();
            };

            window.adjustOffset = function(delta) {
                window.state.style.yOffset += delta;
                draw();
                window.requestSave();
            };

            window.resetAll = function() {
                if(confirm('設定を初期状態に戻しますか？')) {
                    location.reload();
                }
            };

            window.changeCounter = function(change) {
                counterValue += change;
                if (counterValue < 1) counterValue = 1;
                document.getElementById('counterValue').innerText = counterValue;
                window.updateSoilDirectly(); 
            };

            window.updateSoilDirectly = function(forceInsert = false) {
                const soilTypeRadio = document.querySelector('input[name="soilType"]:checked');
                let soilType = soilTypeRadio ? soilTypeRadio.value : '';
                
                const truckCapRadio = document.querySelector('input[name="truckCap"]:checked');
                let truckCap = truckCapRadio ? truckCapRadio.value : '';

                let parts = [];
                if(soilType) parts.push(soilType);
                if(truckCap) parts.push(truckCap);
                parts.push(`${counterValue}台目`);

                const newText = parts.join(' '); 
                
                // Regex: (SoilType)? (Capacity)? (Counter)台目
                // Handling potential existing variations
                const pattern = /(?:残土搬出|客土搬入|残土|客土)?[\s　]*(?:\d+t)?[\s　]*\d+台目/g;
                
                const memoInput = document.getElementById('inputMemo');
                let currentText = memoInput.value;

                if (pattern.test(currentText)) {
                    currentText = currentText.replace(pattern, newText);
                } else {
                    if (currentText && !currentText.endsWith('\n')) {
                        currentText += '\n';
                    }
                    currentText += newText;
                }

                memoInput.value = currentText;
                window.state.text.memo = currentText;
                draw();
                window.requestSave(); 
            };

            window.clearMemo = function() {
                if(confirm("備考・内容をクリアしますか？")) {
                    document.getElementById('inputMemo').value = "";
                    window.state.text.memo = "";
                    draw();
                    window.requestSave(); 
                }
            };

            window.setToday = setToday;
            function setToday() {
                const today = new Date();
                const yyyy = today.getFullYear();
                const mm = String(today.getMonth() + 1).padStart(2, '0');
                const dd = String(today.getDate()).padStart(2, '0');
                const hh = String(today.getHours()).padStart(2, '0');
                const min = String(today.getMinutes()).padStart(2, '0');
                
                const dStr = `${yyyy}-${mm}-${dd}`;
                const tStr = `${hh}:${min}`;
                document.getElementById('inputDate').value = dStr;
                document.getElementById('inputTime').value = tStr;
                window.state.text.date = dStr;
                window.state.text.time = tStr;
                draw();
                window.requestSave();
            }

            window.downloadImage = function() {
                if (!window.state.image) {
                    alert("画像が選択されていません。");
                    return;
                }
                const link = document.createElement('a');
                const safeProject = window.state.text.project.replace(/[\/\s]/g, '_') || 'photo';
                link.download = `board_${safeProject}_${window.state.text.date}.jpg`;
                link.href = canvas.toDataURL('image/jpeg', 0.95);
                link.click();
            };

            function handleImageUpload(e) {
                const file = e.target.files[0];
                if (!file) return;
                loading.classList.remove('hidden');
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        window.state.image = img;
                        canvas.width = img.width;
                        canvas.height = img.height;
                        window.state.style.fontSizeBase = Math.max(16, Math.floor(img.width * 0.015));
                        loading.classList.add('hidden');
                        draw();
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            }

            function loadPlaceholder() {
                canvas.width = 800;
                canvas.height = 600;
                window.state.style.fontSizeBase = 16;
                ctx.fillStyle = "#e2e8f0";
                ctx.fillRect(0,0,800,600);
                ctx.fillStyle = "#94a3b8";
                ctx.font = "bold 30px sans-serif";
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                ctx.fillText("ここに写真をドロップ", 400, 300);
            }

            function draw() {
                if (!window.state.image && canvas.width === 800) {} 
                if (window.state.image) ctx.drawImage(window.state.image, 0, 0);
                else {
                    ctx.fillStyle = "#e2e8f0";
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.fillStyle = "#94a3b8";
                    ctx.font = "bold 30px sans-serif";
                    ctx.textAlign = "center";
                    ctx.fillText("写真を選択してください", canvas.width/2, canvas.height/2);
                }

                if (!window.state.showBoard) return;

                let boardW, boardH;
                const ASPECT_RATIO = 0.75;

                switch (window.state.boardSize) {
                    case 'extraLarge': boardW = canvas.width * 0.6; break;
                    case 'large': boardW = canvas.width * 0.5; break;
                    case 'medium': boardW = canvas.width * 0.4; break;
                    case 'small': boardW = canvas.width * 0.3; break;
                    default: boardW = canvas.width * 0.5;
                }
                boardH = boardW * ASPECT_RATIO;

                const margin = 0;
                let boardX = margin;
                let boardY = canvas.height - boardH - margin;
                if (window.state.boardPos === 'right') boardX = canvas.width - boardW - margin;

                const colors = getBoardColors();
                drawBlackboard(ctx, boardX, boardY, boardW, boardH, colors);
                drawTextOnBoard(ctx, boardX, boardY, boardW, boardH, colors);
            }

            function getBoardColors() {
                switch(window.state.boardColor) {
                    case 'black': return { bg: "#1a1a1a", line: "#ffffff", text: "#ffffff", shadow: "rgba(0,0,0,0.5)" };
                    case 'white': return { bg: "#ffffff", line: "#333333", text: "#111111", shadow: "rgba(0,0,0,0.3)" };
                    case 'blue': return { bg: "#0d47a1", line: "#ffffff", text: "#ffffff", shadow: "rgba(0,0,0,0.5)" };
                    case 'green': default: return { bg: "#004d40", line: "#ffffff", text: "#ffffff", shadow: "rgba(0,0,0,0.5)" };
                }
            }

            function drawBlackboard(ctx, x, y, w, h, colors) {
                ctx.save();
                ctx.shadowColor = colors.shadow;
                ctx.shadowBlur = 10;
                ctx.shadowOffsetX = 5;
                ctx.shadowOffsetY = 5;
                ctx.fillStyle = colors.bg; 
                ctx.fillRect(x, y, w, h);

                ctx.shadowColor = "transparent";
                ctx.strokeStyle = "#e0e0e0"; 
                if(window.state.boardColor === 'white') ctx.strokeStyle = "#999999"; 
                ctx.lineWidth = Math.max(2, w * 0.005);
                const halfLine = ctx.lineWidth / 2;
                ctx.strokeRect(x + halfLine, y + halfLine, w - ctx.lineWidth, h - ctx.lineWidth);

                ctx.strokeStyle = colors.line;
                ctx.lineWidth = Math.max(1, w * 0.003);
                ctx.beginPath();
                ctx.moveTo(x, y + h * 0.15); ctx.lineTo(x + w, y + h * 0.15);
                ctx.moveTo(x, y + h * 0.30); ctx.lineTo(x + w, y + h * 0.30);
                ctx.moveTo(x + w * 0.25, y); ctx.lineTo(x + w * 0.25, y + h * 0.30); 

                if(window.state.showConstructor) {
                    const constH = h * 0.12; 
                    const constY = y + h - constH;
                    ctx.moveTo(x, constY);
                    ctx.lineTo(x + w, constY);
                    ctx.moveTo(x + w * 0.25, constY);
                    ctx.lineTo(x + w * 0.25, y + h);
                }

                ctx.stroke();
                ctx.restore();
            }

            function drawTextOnBoard(ctx, bx, by, bw, bh, colors) {
                ctx.save();
                ctx.fillStyle = colors.text;
                
                const responsiveBaseSize = bw * 0.055; 
                const pad = bw * 0.05; 
                const globalOffsetY = window.state.style.yOffset;

                ctx.beginPath(); ctx.rect(bx, by, bw, bh); ctx.clip();

                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                ctx.font = `${0.7 * responsiveBaseSize}px ${window.state.style.fontFamily}`;
                ctx.fillText("工事件名", bx + bw * 0.125, by + bh * 0.075);
                ctx.fillText("工事場所", bx + bw * 0.125, by + bh * 0.225);

                if(window.state.showConstructor) {
                    const constH = bh * 0.12;
                    const constCenterY = by + bh - (constH / 2);
                    ctx.fillText("施工者", bx + bw * 0.125, constCenterY);
                    ctx.textAlign = "left";
                    ctx.font = `${0.8 * responsiveBaseSize}px ${window.state.style.fontFamily}`; 
                    ctx.fillText(window.state.text.constructorName, bx + bw * 0.27, constCenterY);
                }

                ctx.textAlign = "left";

                ctx.font = `${window.state.style.fontScaleProject * responsiveBaseSize}px ${window.state.style.fontFamily}`;
                drawMultilineText(ctx, window.state.text.project, bx + bw * 0.27, by + bh * 0.075 + globalOffsetY, window.state.style.fontScaleProject * responsiveBaseSize * window.state.style.lineHeight);
                
                ctx.font = `${window.state.style.fontScaleWorkType * responsiveBaseSize}px ${window.state.style.fontFamily}`;
                drawMultilineText(ctx, window.state.text.workType, bx + bw * 0.27, by + bh * 0.225 + globalOffsetY, window.state.style.fontScaleWorkType * responsiveBaseSize * window.state.style.lineHeight);
                
                ctx.font = `${window.state.style.fontScaleMemo * responsiveBaseSize}px ${window.state.style.fontFamily}`;
                drawMultilineText(ctx, window.state.text.memo, bx + pad, by + bh * 0.55 + globalOffsetY, window.state.style.fontScaleMemo * responsiveBaseSize * window.state.style.lineHeight);
                
                let dateString = window.state.text.date;
                if (window.state.showTime && window.state.text.time) {
                    dateString += " " + window.state.text.time;
                }
                
                ctx.font = `${0.8 * responsiveBaseSize}px ${window.state.style.fontFamily}`;
                
                let dateY = by + bh - pad;
                if(window.state.showConstructor) {
                    const constH = bh * 0.12;
                    dateY = by + bh - constH - (pad * 0.5);
                }

                if(window.state.datePos === 'left') {
                    ctx.textAlign = "left";
                    ctx.fillText(dateString, bx + pad, dateY);
                } else {
                    ctx.textAlign = "right";
                    ctx.fillText(dateString, bx + bw - pad, dateY);
                }

                ctx.restore();
            }

            function drawMultilineText(ctx, text, x, y, lineHeight) {
                if(!text) return;
                const lines = text.split('\n'); 
                const offset = ((lines.length - 1) * lineHeight) / 2;
                lines.forEach((line, index) => {
                    ctx.fillText(line, x, y - offset + (index * lineHeight));
                });
            }
        })();
    </script>

    <!-- Firebase Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        let hasFirebase = false;
        try { if(typeof __firebase_config !== 'undefined') hasFirebase = true; } catch(e) {}

        if (hasFirebase) {
            const firebaseConfig = JSON.parse(__firebase_config);
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'construction-board';

            let currentUser = null;
            let saveTimeout = null;

            const initAuth = async () => {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            };
            initAuth();

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUser = user;
                    await loadData();
                }
            });

            async function loadData() {
                if (!currentUser) return;
                const userDocRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'settings', 'default');
                try {
                    const docSnap = await getDoc(userDocRef);
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        if(data.text) window.state.text = { ...window.state.text, ...data.text };
                        if(data.style) window.state.style = { ...window.state.style, ...data.style };
                        if(data.boardPos) window.state.boardPos = data.boardPos;
                        if(data.boardSize) window.state.boardSize = data.boardSize;
                        if(data.boardColor) window.state.boardColor = data.boardColor;
                        if(data.showBoard !== undefined) window.state.showBoard = data.showBoard;
                        if(data.showTime !== undefined) window.state.showTime = data.showTime;
                        if(data.datePos) window.state.datePos = data.datePos;
                        if(data.showConstructor !== undefined) window.state.showConstructor = data.showConstructor;

                        updateUIFromState();
                        window.setToday(); 
                        showSaveStatus("データ復元完了");
                    }
                } catch (e) {
                    console.warn("Load failed", e);
                }
            }

            window.requestSave = function() {
                if (saveTimeout) clearTimeout(saveTimeout);
                saveTimeout = setTimeout(() => { saveData(); }, 1000);
            };

            async function saveData() {
                if (!currentUser) return;
                const userDocRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'settings', 'default');
                
                const dataToSave = {
                    text: window.state.text,
                    style: window.state.style,
                    boardPos: window.state.boardPos,
                    boardSize: window.state.boardSize,
                    boardColor: window.state.boardColor,
                    showBoard: window.state.showBoard,
                    showTime: window.state.showTime,
                    datePos: window.state.datePos,
                    showConstructor: window.state.showConstructor,
                    lastUpdated: new Date()
                };

                try {
                    await setDoc(userDocRef, dataToSave);
                    showSaveStatus("保存済み");
                } catch (e) {
                    showSaveStatus("保存失敗");
                }
            }

            function showSaveStatus(msg) {
                const el = document.getElementById('saveStatus');
                el.innerText = msg;
                el.classList.remove('opacity-0');
                setTimeout(() => el.classList.add('opacity-0'), 2000);
            }

            function updateUIFromState() {
                document.getElementById('inputProject').value = window.state.text.project || "";
                document.getElementById('inputWorkType').value = window.state.text.workType || "";
                document.getElementById('inputMemo').value = window.state.text.memo || "";
                document.getElementById('inputDate').value = window.state.text.date || "";
                document.getElementById('inputTime').value = window.state.text.time || "";
                document.getElementById('inputConstructor').value = window.state.text.constructorName || "ヒューマンヤード(株)";

                document.getElementById('boardColor').value = window.state.boardColor;
                document.getElementById('boardSize').value = window.state.boardSize;
                document.getElementById('toggleBoard').checked = window.state.showBoard;
                document.getElementById('toggleTime').checked = window.state.showTime;
                document.getElementById('showConstructor').checked = window.state.showConstructor;
                document.getElementById('fontFamily').value = window.state.style.fontFamily;

                document.getElementById('scaleProject').value = window.state.style.fontScaleProject;
                document.getElementById('valScaleProject').innerText = window.state.style.fontScaleProject;
                document.getElementById('scaleWorkType').value = window.state.style.fontScaleWorkType;
                document.getElementById('valScaleWorkType').innerText = window.state.style.fontScaleWorkType;
                document.getElementById('scaleMemo').value = window.state.style.fontScaleMemo;
                document.getElementById('valScaleMemo').innerText = window.state.style.fontScaleMemo;
                document.getElementById('lineHeight').value = window.state.style.lineHeight;
                document.getElementById('dispLineHeight').innerText = window.state.style.lineHeight;

                const dateRadio = document.querySelector(`input[name="datePos"][value="${window.state.datePos}"]`);
                if(dateRadio) dateRadio.checked = true;
            }
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G-Ledger | ç¾å ´åŸä¾¡ç®¡ç†å°å¸³ã‚·ã‚¹ãƒ†ãƒ </title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://unpkg.com/dexie@3.2.4/dist/dexie.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans JP', sans-serif; background-color: #f3f4f6; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .sidebar-link.active { background-color: #1e293b; color: #fff; border-left: 4px solid #3b82f6; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3b82f6; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .tab-btn { @apply px-4 py-3 text-sm font-bold text-slate-500 bg-white border border-slate-200 rounded-t-lg hover:bg-slate-50 hover:text-slate-700 transition-all whitespace-nowrap shadow-sm; margin-bottom: -1px; }
        .tab-btn.active { @apply text-blue-600 bg-white border-b-transparent border-t-2 border-t-blue-600 shadow-md z-10; }
        .tab-btn.tab-alert { @apply text-red-500 hover:text-red-700; }
        .tab-btn.active.tab-alert { @apply text-red-600 border-t-red-500; }
        .btn-group { @apply inline-flex rounded-md shadow-sm; }
        .btn-group-item { @apply px-4 py-2 text-sm font-medium border border-gray-300 bg-white text-gray-700 hover:bg-gray-50 focus:z-10 focus:ring-1 focus:ring-blue-500 focus:border-blue-500 transition-colors; }
        .btn-group-item:first-child { @apply rounded-l-md; }
        .btn-group-item:last-child { @apply rounded-r-md; }
        .btn-group-item.active { @apply bg-blue-600 text-white border-blue-600 hover:bg-blue-700; }
        #drop-zone { transition: all 0.3s ease; }
        #drop-zone.dragover { background-color: #eff6ff; border-color: #3b82f6; transform: scale(1.01); }
        .autocomplete-list { @apply absolute z-50 w-full bg-white border border-gray-300 rounded-b-lg shadow-lg max-h-60 overflow-y-auto mt-1; }
        .autocomplete-item { @apply px-4 py-2 cursor-pointer hover:bg-blue-50 text-sm text-gray-700 border-b border-gray-100 last:border-0; }
        th.sortable { @apply cursor-pointer hover:bg-slate-100 select-none; }
        th.sortable:after { content: 'â†•'; font-size: 0.7em; margin-left: 5px; color: #94a3b8; }
        th.sortable.asc:after { content: 'â†‘'; color: #3b82f6; }
        th.sortable.desc:after { content: 'â†“'; color: #3b82f6; }
        .badge-base { @apply inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium; }
        .badge-cost { @apply bg-indigo-100 text-indigo-800; }
        .badge-detail { @apply bg-green-100 text-green-800; }
        .badge-alert { @apply bg-red-100 text-red-800 border border-red-200; }
    </style>
</head>
<body class="text-slate-800 h-screen flex overflow-hidden">

    <!-- Sidebar -->
    <aside class="w-64 bg-slate-900 text-slate-300 flex flex-col shadow-2xl z-20 flex-shrink-0">
        <div class="p-6 border-b border-slate-800 flex items-center gap-3">
            <div class="w-8 h-8 bg-blue-600 rounded flex items-center justify-center text-white font-bold">G</div>
            <h1 class="text-lg font-bold text-white tracking-wide">G-Ledger <span class="text-xs font-normal text-slate-400 block">System</span></h1>
        </div>
        <nav class="flex-1 overflow-y-auto py-4">
            <ul class="space-y-1">
                <li><button onclick="window.showPage('dashboard')" id="nav-dashboard" class="sidebar-link active w-full text-left px-6 py-3 hover:bg-slate-800 transition-colors flex items-center gap-3"><i class="fa-solid fa-magnifying-glass-chart"></i> ç¾å ´ç…§ä¼šãƒ»åˆ†æ</button></li>
                <li><button onclick="window.showPage('cost-search')" id="nav-cost-search" class="sidebar-link w-full text-left px-6 py-3 hover:bg-slate-800 transition-colors flex items-center gap-3"><i class="fa-solid fa-magnifying-glass-dollar"></i> åŸä¾¡æ¤œç´¢</button></li>
                <li><button onclick="window.showPage('ranking')" id="nav-ranking" class="sidebar-link w-full text-left px-6 py-3 hover:bg-slate-800 transition-colors flex items-center gap-3"><i class="fa-solid fa-chart-pie"></i> é›†è¨ˆãƒ»ãƒ©ãƒ³ã‚­ãƒ³ã‚°</button></li>
                <li><button onclick="window.showPage('import')" id="nav-import" class="sidebar-link w-full text-left px-6 py-3 hover:bg-slate-800 transition-colors flex items-center gap-3"><i class="fa-solid fa-database"></i> ãƒ‡ãƒ¼ã‚¿å–è¾¼ãƒ»ç®¡ç†</button></li>
            </ul>
        </nav>
        <div class="p-4 border-t border-slate-800 text-xs text-slate-500"><div class="flex items-center gap-2 mb-2"><div class="w-2 h-2 rounded-full bg-green-500"></div>IndexedDB Active</div><p>&copy; 2025 Construction Cost Mgt.</p></div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col h-screen overflow-hidden relative bg-slate-100">
        <header class="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-8 shadow-sm z-10 flex-shrink-0">
            <h2 id="page-title" class="text-xl font-bold text-slate-700">ç¾å ´ç…§ä¼šãƒ»åˆ†æ</h2>
            <div class="flex items-center gap-4">
                <div id="header-period" class="text-xs font-bold text-slate-600 bg-slate-100 px-3 py-1 rounded border border-slate-300 hidden"><i class="fa-regular fa-clock mr-1"></i> ãƒ‡ãƒ¼ã‚¿æœŸé–“: <span id="period-text"></span></div>
                <div class="px-3 py-1 bg-blue-50 text-blue-700 rounded-full text-sm border border-blue-100"><i class="fa-solid fa-shield-halved mr-1"></i> ãƒ­ãƒ¼ã‚«ãƒ«ã‚»ã‚­ãƒ¥ã‚¢ãƒ¢ãƒ¼ãƒ‰</div>
            </div>
        </header>

        <div class="flex-1 overflow-auto p-6 relative">
            <!-- 1. DASHBOARD PAGE -->
            <div id="page-dashboard" class="page-content space-y-6">
                <div class="glass-panel p-8 rounded-xl max-w-4xl mx-auto">
                    <h3 class="text-lg font-bold mb-4 text-slate-600 text-center">ç¾å ´æ¤œç´¢</h3>
                    <div class="flex flex-col md:flex-row gap-6 justify-center">
                        <div class="relative w-full md:w-1/3">
                            <label class="block text-xs font-bold text-slate-400 mb-1 ml-1">ç¾å ´ã‚³ãƒ¼ãƒ‰æ¤œç´¢</label>
                            <div class="flex items-center">
                                <input type="text" id="search-input" placeholder="ä¾‹: 01, 100" class="w-full pl-4 pr-12 py-3 rounded-lg border border-slate-300 focus:outline-none focus:ring-2 focus:ring-blue-500 shadow-inner text-lg bg-white">
                                <button onclick="window.searchSite()" class="absolute right-1 top-7 bottom-1 px-3 bg-blue-600 hover:bg-blue-700 text-white rounded-md transition-colors h-10 my-auto"><i class="fa-solid fa-arrow-right"></i></button>
                            </div>
                        </div>
                        <div class="hidden md:flex items-center text-slate-300 font-bold pt-6">OR</div>
                        <div class="relative w-full md:w-1/2">
                            <label class="block text-xs font-bold text-slate-400 mb-1 ml-1">ç¾å ´åãƒ»æ–½å·¥ä¸»åã§æ¤œç´¢</label>
                            <div class="flex items-center relative">
                                <i class="fa-solid fa-magnifying-glass absolute left-3 text-slate-400"></i>
                                <input type="text" id="site-name-search" placeholder="ç¾å ´åã¾ãŸã¯æ–½å·¥ä¸»åã‚’å…¥åŠ›..." class="w-full pl-10 pr-4 py-3 rounded-lg border border-slate-300 focus:outline-none focus:ring-2 focus:ring-blue-500 shadow-inner text-lg bg-white" autocomplete="off">
                            </div>
                            <div id="site-autocomplete-list" class="autocomplete-list hidden"></div>
                        </div>
                    </div>
                    <p class="text-xs text-center text-slate-400 mt-3">â€»ã‚³ãƒ¼ãƒ‰ã€Œ01ã€ã¨ã€Œ1ã€ã¯åˆ¥æ‰±ã„ã§ã™ã€‚ã‚µãƒ–ã‚³ãƒ¼ãƒ‰ãŒã‚ã‚‹å ´åˆã¯ã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
                </div>

                <div id="search-result" class="hidden space-y-6 animate-fade-in-up">
                    <div class="grid grid-cols-1 md:grid-cols-12 gap-6">
                        <div class="md:col-span-8 glass-panel p-6 rounded-xl border-l-4 border-blue-600">
                            <div class="flex justify-between items-start mb-2">
                                <span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded font-bold" id="res-code">CODE</span>
                                <span class="text-slate-500 text-sm" id="res-branch">æ‹ ç‚¹å</span>
                            </div>
                            <h2 class="text-2xl font-bold text-slate-800 mb-1" id="res-name">ç¾å ´åç§°</h2>
                            <div class="text-xs text-slate-500 mb-2 flex gap-2">
                                <span class="bg-slate-100 px-2 py-1 rounded">ç¾å ´ã‚µãƒ–åç§°: <span id="res-sub-name" class="font-bold">-</span></span>
                                <span class="bg-slate-100 px-2 py-1 rounded">ã‚µãƒ–ã‚³ãƒ¼ãƒ‰: <span id="res-sub-code" class="font-bold font-mono">-</span></span>
                            </div>
                            <p class="text-slate-500 mb-4" id="res-owner">æ–½å·¥ä¸»å</p>
                            <div id="res-subcodes-container" class="mb-4 hidden">
                                <h4 class="text-xs font-bold text-slate-500 mb-1"><i class="fa-solid fa-link mr-1"></i> ç´ã¥ãã‚µãƒ–ã‚³ãƒ¼ãƒ‰ (é–¢é€£å·¥äº‹)</h4>
                                <div id="res-subcodes-list" class="flex flex-wrap gap-2"></div>
                            </div>
                            <div class="grid grid-cols-3 gap-4 text-sm bg-slate-50 p-3 rounded-lg border border-slate-200">
                                <div><span class="block text-slate-400 text-xs">ç¾å ´ç›£ç£</span><span class="font-bold text-slate-700" id="res-manager">-</span></div>
                                <div><span class="block text-slate-400 text-xs">ç€æ‰‹æ—¥</span><span class="font-bold text-slate-700" id="res-start">-</span></div>
                                <div><span class="block text-slate-400 text-xs">å®Œäº†æ—¥</span><span class="font-bold text-slate-700" id="res-end">-</span></div>
                            </div>
                        </div>
                        <div class="md:col-span-4 glass-panel p-6 rounded-xl flex flex-col justify-center space-y-4">
                            <div><span class="text-xs text-slate-500 font-bold uppercase tracking-wider">ç²—åˆ©ç›Šç‡</span><div class="flex items-baseline gap-2"><span class="text-3xl font-bold text-slate-800" id="res-margin">0.0%</span></div><div class="w-full bg-slate-200 rounded-full h-2 mt-1"><div id="res-margin-bar" class="bg-blue-600 h-2 rounded-full" style="width: 0%"></div></div></div>
                            <div class="grid grid-cols-2 gap-2 pt-2 border-t border-slate-100">
                                <div><span class="text-xs text-slate-400">å£²ä¸Šç´¯è¨ˆ(ç¨æŠœ)</span><div class="font-bold text-slate-700" id="res-sales">Â¥0</div></div>
                                <div><span class="text-xs text-slate-400">åŸä¾¡ç´¯è¨ˆ</span><div class="font-bold text-slate-700" id="res-cost">Â¥0</div></div>
                            </div>
                            <div class="pt-2"><span class="text-xs text-slate-400">ç²—åˆ©ç›Šé¡(ç¨æŠœ)</span><div class="font-bold text-xl text-slate-800" id="res-profit">Â¥0</div></div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="glass-panel p-6 rounded-xl"><h4 class="font-bold text-slate-600 mb-4 border-l-4 border-indigo-500 pl-2">æœˆæ¬¡ å£²ä¸Š/åŸä¾¡ æ¨ç§» (ç¨æŠœ)</h4><div class="h-64"><canvas id="chart-trend"></canvas></div></div>
                        <div class="glass-panel p-6 rounded-xl"><h4 class="font-bold text-slate-600 mb-4 border-l-4 border-teal-500 pl-2">åŸä¾¡æ§‹æˆ (ä¸Šä½5è¦ç´ )</h4><div class="h-64 flex justify-center"><canvas id="chart-composition"></canvas></div></div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="glass-panel rounded-xl overflow-hidden"><div class="bg-slate-50 px-6 py-3 border-b border-slate-200 flex justify-between items-center"><div><h4 class="font-bold text-slate-600">å£²ä¸Šæ˜ç´°</h4><span class="text-[10px] text-slate-400">â€»ç¨æŠœãƒ»ç¨è¾¼ã‚’è¡¨ç¤º</span></div><span class="text-xs bg-white border border-slate-300 px-2 py-0.5 rounded text-slate-500" id="count-sales">0ä»¶</span></div><div class="overflow-y-auto max-h-80"><table class="w-full text-sm text-left"><thead class="text-xs text-slate-500 uppercase bg-slate-50 sticky top-0"><tr><th class="px-3 py-3">æ—¥ä»˜</th><th class="px-3 py-3">å¾—æ„å…ˆ</th><th class="px-3 py-3 text-right">é‡‘é¡(ç¨æŠœ)</th><th class="px-3 py-3 text-right text-slate-400">é‡‘é¡(ç¨è¾¼)</th></tr></thead><tbody id="table-sales-body" class="divide-y divide-slate-100"></tbody></table></div></div>
                        <div class="glass-panel rounded-xl overflow-hidden"><div class="bg-slate-50 px-6 py-3 border-b border-slate-200 flex justify-between items-center"><div><h4 class="font-bold text-slate-600">ä»•å…¥æ˜ç´° (åŸä¾¡)</h4><span class="text-[10px] text-slate-400">â€»ãƒ‡ãƒ¼ã‚¿å€¤ã‚’è¡¨ç¤º(ç¨æŠœ+ç¨)</span></div><span class="text-xs bg-white border border-slate-300 px-2 py-0.5 rounded text-slate-500" id="count-purchase">0ä»¶</span></div><div class="overflow-y-auto max-h-80"><table class="w-full text-sm text-left"><thead class="text-xs text-slate-500 uppercase bg-slate-50 sticky top-0"><tr><th class="px-3 py-3">æ¥­è€…å</th><th class="px-3 py-3">é …ç›®(ææ–™/å¤–æ³¨/æ®‹åœŸ)</th><th class="px-3 py-3 text-right">é‡‘é¡(ç¨æŠœ+ç¨)</th></tr></thead><tbody id="table-purchase-body" class="divide-y divide-slate-100"></tbody></table></div></div>
                    </div>
                </div>
            </div>
            
            <!-- 2. COST SEARCH PAGE -->
            <div id="page-cost-search" class="page-content hidden space-y-6">
                <div class="glass-panel p-8 rounded-xl"><h3 class="text-xl font-bold mb-4 text-slate-700 flex items-center"><i class="fa-solid fa-search mr-2"></i> åŸä¾¡æ¤œç´¢ (æ¥­è€…ãƒ»æ˜ç´°æ¤œç´¢)</h3><div class="flex flex-col md:flex-row gap-4 items-start"><div class="relative w-full md:w-1/2"><div class="flex items-center border border-slate-300 rounded-lg bg-white shadow-sm focus-within:ring-2 focus-within:ring-blue-500"><i class="fa-solid fa-magnifying-glass text-slate-400 ml-3"></i><input type="text" id="cost-search-input" placeholder="æ¥­è€…åã‚’å…¥åŠ› (ä¾‹: ã€‡ã€‡å»ºæ, éˆ´æœ¨...)" class="w-full p-3 focus:outline-none rounded-r-lg" autocomplete="off"></div><div id="cost-autocomplete-list" class="autocomplete-list hidden"></div></div><div class="w-full md:w-auto flex gap-2"><select id="cost-search-branch" class="p-3 border border-slate-300 rounded-lg bg-white text-sm font-bold"><option value="ALL">å…¨æ‹ ç‚¹</option></select></div></div><p class="text-xs text-slate-400 mt-2 ml-1">â€» ã‚¹ãƒšãƒ¼ã‚¹åŒºåˆ‡ã‚Šã§è¤‡æ•°ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å¯ã€‚Enterã‚­ãƒ¼ã§æ¤œç´¢ã€‚</p></div>
                <div id="cost-search-result" class="hidden space-y-6"><div class="grid grid-cols-1 md:grid-cols-3 gap-6"><div class="md:col-span-1 glass-panel p-6 rounded-xl border-l-4 border-green-500"><h4 class="text-sm text-slate-500 font-bold mb-1">é¸æŠä¸­ã®æ¥­è€…</h4><h2 id="cs-vendor-name" class="text-2xl font-bold text-slate-800 mb-4">-</h2><div class="grid grid-cols-2 gap-4 mb-4"><div><span class="text-xs text-slate-400 block">ç™ºç”Ÿç·é¡(ç¨æŠœ)</span><span id="cs-total-amount" class="text-xl font-bold text-slate-700">Â¥0</span></div><div><span class="text-xs text-slate-400 block">å–å¼•ä»¶æ•°</span><span id="cs-total-count" class="text-xl font-bold text-slate-700">0ä»¶</span></div></div><div><span class="text-xs text-slate-400 block mb-1">ä¸»ãªå“ç›®ã‚«ãƒ†ã‚´ãƒª</span><div id="cs-top-items" class="flex flex-wrap gap-1"></div></div></div><div class="md:col-span-2 glass-panel p-6 rounded-xl"><h4 class="font-bold text-slate-600 mb-4">æœˆåˆ¥ ç™ºç”Ÿé¡æ¨ç§»</h4><div class="h-64"><canvas id="chart-cost-trend"></canvas></div></div></div><div class="glass-panel p-6 rounded-xl"><h4 class="font-bold text-slate-600 mb-4">æœˆåˆ¥é›†è¨ˆè¡¨</h4><div class="overflow-x-auto"><table class="w-full text-sm text-left text-slate-500"><thead class="text-xs text-slate-700 uppercase bg-slate-50"><tr><th class="px-4 py-2">å¹´æœˆ</th><th class="px-4 py-2 text-right">ç™ºç”Ÿé¡(ç¨æŠœ)</th><th class="px-4 py-2 text-center">ä»¶æ•°</th><th class="px-4 py-2 text-center">æ§‹æˆæ¯”</th></tr></thead><tbody id="cs-table-monthly" class="bg-white border-b hover:bg-slate-50"></tbody></table></div></div><div class="glass-panel p-6 rounded-xl"><h4 class="font-bold text-slate-600 mb-4">é–¢é€£ã™ã‚‹å·¥ç•ªä¸€è¦§ (ã‚½ãƒ¼ãƒˆå¯èƒ½)</h4><div class="overflow-x-auto max-h-96"><table class="w-full text-sm text-left text-slate-500"><thead class="text-xs text-slate-700 uppercase bg-slate-50 sticky top-0"><tr><th class="px-4 py-2 sortable" onclick="window.sortCostDetails('date')">ç™ºç”Ÿæ—¥(æœˆ)</th><th class="px-4 py-2 sortable" onclick="window.sortCostDetails('code')">å·¥ç•ª</th><th class="px-4 py-2 sortable" onclick="window.sortCostDetails('name')">ç¾å ´å</th><th class="px-4 py-2 sortable" onclick="window.sortCostDetails('branch')">æ‹ ç‚¹</th><th class="px-4 py-2 sortable" onclick="window.sortCostDetails('item')">å“ç›®ãƒ»å‚™è€ƒ</th><th class="px-4 py-2 sortable text-right" onclick="window.sortCostDetails('amount')">é‡‘é¡</th></tr></thead><tbody id="cs-table-details" class="bg-white border-b hover:bg-slate-50"></tbody></table></div></div></div>
            </div>

            <!-- 3. RANKING PAGE -->
            <div id="page-ranking" class="page-content hidden space-y-6">
                <div class="flex flex-col md:flex-row justify-between items-center bg-white p-4 rounded-xl shadow-sm border border-slate-200 mb-4">
                    <div class="flex items-center gap-2 mb-2 md:mb-0"><label class="text-sm font-bold text-slate-600">é›†è¨ˆæœŸé–“ (å®Œäº†æ—¥):</label><input type="date" id="rank-date-start" class="border rounded p-1 text-sm"><span class="text-slate-400">ï½</span><input type="date" id="rank-date-end" class="border rounded p-1 text-sm"><button onclick="window.applyDateFilter()" class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700">é©ç”¨</button></div><div id="rank-date-status" class="text-xs text-red-500 font-bold"></div>
                </div>
                <div class="flex items-end gap-2 border-b border-slate-300 mb-6 overflow-x-auto px-2 pb-1">
                    <button onclick="window.switchRankingTab('owner')" id="tab-owner" class="tab-btn active"><i class="fa-solid fa-building-user mr-1"></i> æ–½å·¥ä¸»åˆ¥</button>
                    <button onclick="window.switchRankingTab('branch')" id="tab-branch" class="tab-btn"><i class="fa-solid fa-map-location-dot mr-1"></i> æ‹ ç‚¹åˆ¥é›†è¨ˆ</button>
                    <button onclick="window.switchRankingTab('manager')" id="tab-manager" class="tab-btn"><i class="fa-solid fa-user-tie mr-1"></i> æ‹…å½“è€…åˆ¥</button>
                    <button onclick="window.switchRankingTab('worst')" id="tab-worst" class="tab-btn tab-alert"><i class="fa-solid fa-triangle-exclamation mr-1"></i> åˆ©ç›Šç‡ãƒ¯ãƒ¼ã‚¹ãƒˆ</button>
                    <div class="border-l border-slate-300 h-6 mx-2"></div>
                    <button onclick="window.switchRankingTab('monthly-manager')" id="tab-monthly-manager" class="tab-btn bg-green-50 hover:bg-green-100 text-green-700"><i class="fa-solid fa-users-viewfinder mr-1"></i> æœˆåˆ¥ãƒ»æ‹ ç‚¹å†…</button>
                    <button onclick="window.switchRankingTab('month')" id="tab-month" class="tab-btn bg-green-50 hover:bg-green-100 text-green-700"><i class="fa-solid fa-calendar-days mr-1"></i> æœˆæ¬¡æ¨ç§»</button>
                </div>
                <!-- 1. Owner Ranking -->
                <div id="ranking-owner" class="ranking-tab-content space-y-6">
                    <div class="glass-panel p-6 rounded-xl">
                        <div class="flex justify-between items-center mb-6"><div><h3 class="text-lg font-bold text-slate-700">æ–½å·¥ä¸»åˆ¥ ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h3><span class="badge-base badge-cost">ğŸ› ï¸ é›†è¨ˆãƒ™ãƒ¼ã‚¹: åŸä¾¡é›†è¨ˆ (å®Œäº†æ—¥åŸºæº–ãƒ»ç¨æŠœ)</span></div><div class="flex items-center gap-4"><select id="rank-owner-branch" onchange="window.renderOwnerRanking()" class="text-sm border rounded p-1 font-bold"><option value="ALL">å…¨æ‹ ç‚¹</option></select><select id="rank-sort-owner" onchange="window.renderOwnerRanking()" class="text-sm border rounded p-1"><option value="profit">åˆ©ç›Šé¡é †</option><option value="sales">å£²ä¸Šé«˜é †</option></select></div></div>
                        <div class="overflow-x-auto"><table class="w-full text-sm text-left text-slate-500"><thead class="text-xs text-slate-700 uppercase bg-slate-50"><tr><th class="px-6 py-3">é †ä½</th><th class="px-6 py-3">æ–½å·¥ä¸»å</th><th class="px-6 py-3 text-right">ç·å£²ä¸Š(ç¨æŠœ)</th><th class="px-6 py-3 text-right">ç·åŸä¾¡</th><th class="px-6 py-3 text-right">ç·åˆ©ç›Š(ç¨æŠœ)</th><th class="px-6 py-3 text-right">ç²—åˆ©ç‡</th><th class="px-6 py-3 text-center">ç¾å ´æ•°</th></tr></thead><tbody id="ranking-body-owner" class="bg-white border-b hover:bg-slate-50"></tbody></table></div>
                    </div>
                </div>
                <!-- 2. Branch Ranking -->
                <div id="ranking-branch" class="ranking-tab-content hidden space-y-6">
                    <div class="glass-panel p-6 rounded-xl mb-6"><div><h3 class="text-lg font-bold text-slate-700 mb-2">æ‹ ç‚¹åˆ¥ æç›Šé›†è¨ˆ</h3><span class="badge-base badge-cost mb-4">ğŸ› ï¸ é›†è¨ˆãƒ™ãƒ¼ã‚¹: åŸä¾¡é›†è¨ˆ (å®Œäº†æ—¥åŸºæº–ãƒ»ç¨æŠœ)</span></div><div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6"><div class="h-64 flex justify-center"><canvas id="chart-branch-sales"></canvas></div><div class="h-64 flex justify-center"><canvas id="chart-branch-profit"></canvas></div></div><div class="overflow-x-auto"><table class="w-full text-sm text-left text-slate-500"><thead class="text-xs text-slate-700 uppercase bg-slate-50"><tr><th class="px-6 py-3">é †ä½</th><th class="px-6 py-3">æ‹ ç‚¹å</th><th class="px-6 py-3 text-right">ç·å£²ä¸Š(ç¨æŠœ)</th><th class="px-6 py-3 text-right">ç·åŸä¾¡</th><th class="px-6 py-3 text-right">ç·åˆ©ç›Š(ç¨æŠœ)</th><th class="px-6 py-3 text-right">ç²—åˆ©ç‡</th><th class="px-6 py-3 text-center">ç¾å ´æ•°</th></tr></thead><tbody id="ranking-body-branch" class="bg-white border-b hover:bg-slate-50"></tbody></table></div></div>
                </div>
                <!-- 3. Manager Ranking -->
                <div id="ranking-manager" class="ranking-tab-content hidden space-y-6">
                    <div class="glass-panel p-6 rounded-xl">
                        <div class="flex flex-wrap justify-between items-center mb-6 gap-4"><div><h3 class="text-lg font-bold text-slate-700">æ‹…å½“è€…åˆ¥ ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h3><span class="badge-base badge-cost">ğŸ› ï¸ é›†è¨ˆãƒ™ãƒ¼ã‚¹: åŸä¾¡é›†è¨ˆ (å®Œå·¥æ—¥åŸºæº–ãƒ»ç¨æŠœ)</span></div><div class="flex items-center gap-2"><select id="rank-manager-month" onchange="window.renderManagerRanking()" class="text-sm border rounded p-1 bg-slate-50"></select><select id="rank-manager-branch" onchange="window.renderManagerRanking()" class="text-sm border rounded p-1 bg-slate-50"><option value="ALL">å…¨æ‹ ç‚¹</option></select><div class="border-l border-slate-300 h-6 mx-2"></div><select id="rank-sort-manager" onchange="window.renderManagerRanking()" class="text-sm border rounded p-1"><option value="profit">åˆ©ç›Šé¡é †</option><option value="sales">å£²ä¸Šé«˜é †</option><option value="margin">ç²—åˆ©ç‡é †</option><option value="count">ç¾å ´æ•°é †</option></select></div></div>
                        <div class="overflow-x-auto"><table class="w-full text-sm text-left text-slate-500"><thead class="text-xs text-slate-700 uppercase bg-slate-50"><tr><th class="px-6 py-3">é †ä½</th><th class="px-6 py-3">æ‹…å½“è€…å</th><th class="px-6 py-3">æ‹ ç‚¹</th><th class="px-6 py-3 text-right">ç·å£²ä¸Š(ç¨æŠœ)</th><th class="px-6 py-3 text-right">ç·åŸä¾¡</th><th class="px-6 py-3 text-right">ç·åˆ©ç›Š(ç¨æŠœ)</th><th class="px-6 py-3 text-right">ç²—åˆ©ç‡</th><th class="px-6 py-3 text-center">ç¾å ´æ•°</th></tr></thead><tbody id="ranking-body-manager" class="bg-white border-b hover:bg-slate-50"></tbody></table></div>
                    </div>
                </div>
                <!-- 4. Monthly Manager/Owner Ranking -->
                <div id="ranking-monthly-manager" class="ranking-tab-content hidden space-y-6">
                    <div class="glass-panel p-6 rounded-xl border-l-4 border-green-500">
                        <div class="flex flex-wrap justify-between items-center mb-6 gap-4"><div><h3 class="text-lg font-bold text-slate-700">æœˆåˆ¥ãƒ»æ‹ ç‚¹å†…ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h3><span class="badge-base badge-detail">ğŸ“… é›†è¨ˆãƒ™ãƒ¼ã‚¹: æ˜ç´°ãƒ‡ãƒ¼ã‚¿ (ç™ºç”Ÿæ—¥åŸºæº–ãƒ»ç¨æŠœ)</span></div><div class="btn-group"><button onclick="window.setMonthlyMode('manager')" id="btn-mode-manager" class="btn-group-item active">æ‹…å½“è€…åˆ¥</button><button onclick="window.setMonthlyMode('owner')" id="btn-mode-owner" class="btn-group-item">æ–½å·¥ä¸»åˆ¥</button></div><div class="flex gap-2"><select id="mm-filter-month" onchange="window.renderMonthlyManagerRanking()" class="text-sm border rounded p-1"></select><select id="mm-filter-branch" onchange="window.renderMonthlyManagerRanking()" class="text-sm border rounded p-1"><option value="ALL">å…¨æ‹ ç‚¹</option></select></div></div>
                        <div class="overflow-x-auto"><table class="w-full text-sm text-left text-slate-500"><thead class="text-xs text-slate-700 uppercase bg-slate-50"><tr><th class="px-6 py-3">é †ä½</th><th class="px-6 py-3" id="mm-header-name">æ‹…å½“è€…å</th><th class="px-6 py-3">æ‹ ç‚¹</th><th class="px-6 py-3 text-right">å£²ä¸Š(ç¨æŠœ)</th><th class="px-6 py-3 text-right text-slate-300">-</th><th class="px-6 py-3 text-right text-slate-300">-</th></tr></thead><tbody id="ranking-body-monthly-manager" class="bg-white border-b hover:bg-slate-50"></tbody></table></div>
                    </div>
                </div>
                <!-- 5. Monthly Trend -->
                <div id="ranking-month" class="ranking-tab-content hidden space-y-6">
                    <div class="glass-panel p-6 rounded-xl border-l-4 border-green-500">
                        <div class="flex justify-between items-center mb-6"><div><h3 class="text-lg font-bold text-slate-700">æœˆæ¬¡å£²ä¸Šãƒ»åŸä¾¡æ¨ç§»</h3><span class="badge-base badge-detail">ğŸ“… é›†è¨ˆãƒ™ãƒ¼ã‚¹: æ˜ç´°ãƒ‡ãƒ¼ã‚¿ (ç™ºç”Ÿæ—¥åŸºæº–ãƒ»ç¨æŠœ)</span></div><div class="flex items-center gap-2 bg-slate-50 p-2 rounded border"><span class="text-sm text-slate-500 font-bold">è¡¨ç¤ºå¯¾è±¡:</span><select id="month-filter-branch" onchange="window.renderMonthlyRanking()" class="text-sm border-none bg-transparent font-bold text-slate-700 focus:ring-0"><option value="ALL">å…¨ç¤¾</option></select></div></div>
                        <div class="h-80 mb-8"><canvas id="chart-monthly-total"></canvas></div>
                        <div class="overflow-x-auto"><table class="w-full text-sm text-left text-slate-500 border-collapse border border-slate-200"><thead class="text-xs text-slate-700 uppercase bg-slate-50" id="monthly-table-head"></thead><tbody id="ranking-table-month" class="bg-white"></tbody><tfoot id="ranking-footer-month" class="bg-slate-100 font-bold"></tfoot></table></div>
                    </div>
                </div>
                 <!-- 6. Worst Ranking (UPDATED with Manager Col) -->
                 <div id="ranking-worst" class="ranking-tab-content hidden space-y-6">
                    <div class="glass-panel p-6 rounded-xl border-l-4 border-red-500">
                        <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                            <div><h3 class="text-lg font-bold text-red-600">åˆ©ç›Šç‡ãƒ¯ãƒ¼ã‚¹ãƒˆåˆ†æ</h3><span class="badge-base badge-cost">ğŸ› ï¸ é›†è¨ˆãƒ™ãƒ¼ã‚¹: åŸä¾¡é›†è¨ˆ (å®Œäº†æ—¥åŸºæº–ãƒ»ç¨æŠœ)</span></div>
                            <div class="flex flex-wrap items-center gap-2">
                                <button onclick="window.exportWorstExcel()" class="bg-green-600 hover:bg-green-700 text-white text-xs font-bold py-1 px-3 rounded flex items-center gap-1 mr-4 shadow"><i class="fa-solid fa-file-excel"></i> Excelå‡ºåŠ›</button>
                                <div class="btn-group mr-4"><button onclick="window.setWorstType('ranking')" id="btn-wt-ranking" class="btn-group-item active">å…¨ä½“ãƒ©ãƒ³ã‚­ãƒ³ã‚°</button><button onclick="window.setWorstType('alert')" id="btn-wt-alert" class="btn-group-item">ä½åˆ©ç›Šç‡ã‚¢ãƒ©ãƒ¼ãƒˆ (20%ä»¥ä¸‹)</button></div>
                                <div id="worst-controls-ranking" class="flex items-center gap-2"><span class="text-sm text-slate-500">é †åº:</span><div class="btn-group"><button onclick="window.setWorstSort('rate')" id="btn-worst-rate" class="btn-group-item active text-red-600">åˆ©ç›Šç‡é †</button><button onclick="window.setWorstSort('amount')" id="btn-worst-amount" class="btn-group-item">åˆ©ç›Šé¡é †</button></div></div>
                                <div id="worst-controls-alert" class="hidden flex items-center gap-2"><span class="badge-base badge-alert mr-2"><i class="fa-solid fa-triangle-exclamation mr-1"></i>20%ä»¥ä¸‹æŠ½å‡º</span><select id="worst-alert-month" onchange="window.renderWorstRanking()" class="text-sm border rounded p-1 bg-red-50 text-red-900 border-red-200"></select><select id="worst-alert-branch" onchange="window.renderWorstRanking()" class="text-sm border rounded p-1 bg-red-50 text-red-900 border-red-200"><option value="ALL">å…¨æ‹ ç‚¹</option></select></div>
                            </div>
                        </div>
                        <div class="overflow-x-auto"><table class="w-full text-sm text-left text-slate-500"><thead class="text-xs text-slate-700 uppercase bg-red-50"><tr><th class="px-6 py-3">é †ä½</th><th class="px-6 py-3">å·¥ç•ª</th><th class="px-6 py-3">ç¾å ´å</th><th class="px-6 py-3">æ‹…å½“è€…</th><th class="px-6 py-3">æ–½å·¥ä¸»</th><th class="px-6 py-3">æ‹ ç‚¹/å®Œå·¥</th><th class="px-6 py-3 text-right">ç²—åˆ©ç‡</th><th class="px-6 py-3 text-right">ç·åˆ©ç›Š(ç¨æŠœ)</th><th class="px-6 py-3 text-right">ç·å£²ä¸Š(ç¨æŠœ)</th></tr></thead><tbody id="ranking-body-worst" class="bg-white border-b hover:bg-slate-50"></tbody></table></div>
                    </div>
                </div>
            </div>
            <div id="page-import" class="page-content hidden max-w-4xl mx-auto space-y-6">
                <div id="drop-zone" class="glass-panel p-10 rounded-xl border-2 border-dashed border-blue-300 text-center cursor-pointer hover:bg-blue-50 transition-colors relative"><input type="file" id="file-input-multi" multiple class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="handleFileSelect(this.files)"><div class="pointer-events-none"><i class="fa-solid fa-cloud-arrow-up text-6xl text-blue-400 mb-4"></i><h3 class="text-xl font-bold text-slate-700 mb-2">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã“ã“ã«ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—</h3><p class="text-slate-500 mb-4">ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</p></div></div><div class="glass-panel p-6 rounded-xl border border-red-100"><div class="bg-red-50 border-l-4 border-red-500 p-4 mb-6 rounded-r"><div class="flex items-center gap-2 text-red-700 font-bold mb-1"><i class="fa-solid fa-triangle-exclamation"></i><span>ã”æ³¨æ„ï¼šãƒ‡ãƒ¼ã‚¿ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™</span></div><p class="text-sm text-red-600">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–ã‚Šè¾¼ã‚€ã¨ã€ä»¥å‰ã®ãƒ‡ãƒ¼ã‚¿ã¯å…¨ã¦<strong>å‰Šé™¤ãƒ»ä¸Šæ›¸ã</strong>ã•ã‚Œã¾ã™ã€‚</p></div><h4 class="font-bold text-slate-600 mb-3">å–ã‚Šè¾¼ã¿ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h4><div id="import-log" class="bg-slate-800 text-green-400 font-mono text-xs p-4 rounded h-40 overflow-y-auto mb-4">å¾…æ©Ÿä¸­...</div><div class="flex justify-end gap-3"><button id="btn-process-files" onclick="processDroppedFiles()" disabled class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg shadow disabled:bg-slate-400 disabled:cursor-not-allowed flex items-center gap-2"><span id="import-spinner" class="loader hidden"></span><span>ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ›´æ–°ã‚’å®Ÿè¡Œ</span></button></div></div><div class="glass-panel p-6 rounded-xl"><h4 class="font-bold text-slate-600 mb-4">ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ç™»éŒ²çŠ¶æ³</h4><div class="grid grid-cols-4 gap-4 text-center"><div class="p-3 bg-white rounded border border-slate-200"><div class="text-xs text-slate-500">åŸä¾¡é›†è¨ˆ</div><div class="text-xl font-bold text-slate-800" id="db-count-cost">-</div></div><div class="p-3 bg-white rounded border border-slate-200"><div class="text-xs text-slate-500">ç¾å ´ãƒã‚¹ã‚¿ãƒ¼</div><div class="text-xl font-bold text-slate-800" id="db-count-master">-</div></div><div class="p-3 bg-white rounded border border-slate-200"><div class="text-xs text-slate-500">ä»•å…¥æ˜ç´°</div><div class="text-xl font-bold text-slate-800" id="db-count-purchase">-</div></div><div class="p-3 bg-white rounded border border-slate-200"><div class="text-xs text-slate-500">å£²ä¸Šæ˜ç´°</div><div class="text-xl font-bold text-slate-800" id="db-count-sales">-</div></div></div><div class="mt-4 text-right"><button onclick="clearDatabase()" class="text-xs text-red-500 hover:text-red-700 underline">å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã™ã‚‹</button></div></div>
            </div>
        </div>
    </main>

<script>
    const db = new Dexie("ConstructionLedgerDB_Main"); 
    db.version(1).stores({ costs: 'code', masters: 'code, owner, branch, manager', purchases: '++id, siteCode, date, vendor', sales: '++id, siteCode, date', meta: 'key' });
    
    let pendingFiles = { cost: null, master: null, purchase: null, sales: null };
    let currentMonthlyMode = 'manager'; 
    let currentWorstType = 'ranking'; 
    let currentWorstSort = 'rate';    
    let rankingFilter = { start: null, end: null };
    let currentCostDetails = [];
    let currentCostVendor = null;
    let costSortState = { key: 'date', order: 'desc' };
    let currentWorstList = []; 
    
    let chartBranchSales = null, chartBranchProfit = null, chartMonthly = null, chartCostTrend = null, chartTrend = null, chartComposition = null;

    // --- GLOBAL HELPERS (Explicitly on window) ---
    window.destroyChart = function(chartInstance) {
        if (chartInstance) { try { chartInstance.destroy(); } catch(e) { console.warn("Chart destroy error", e); } }
        return null;
    }
    window.formatCurrency = function(n) { return new Intl.NumberFormat('ja-JP', { style: 'currency', currency: 'JPY' }).format(n); }

    window.renderTable = function(tbodyId, data, cols) { 
        const tbody = document.getElementById(tbodyId); tbody.innerHTML = ''; 
        data.forEach(r => { 
            const tr = document.createElement('tr'); 
            cols.forEach(c => { 
                const td = document.createElement('td'); td.className = "px-3 py-2 border-b whitespace-nowrap"; 
                if (c.includes('amount') || c === 'cost' || c === 'profit') { td.className += " text-right font-mono"; td.textContent = window.formatCurrency(r[c]); } 
                else { td.textContent = r[c]; } 
                tr.appendChild(td); 
            }); 
            tbody.appendChild(tr); 
        }); 
    }

    window.renderCharts = function(sales, purchases) { 
        if (chartTrend) chartTrend = window.destroyChart(chartTrend); 
        if (chartComposition) chartComposition = window.destroyChart(chartComposition); 
        
        const monthly = {}; 
        sales.forEach(s => { const m = s.date.substring(0,6); if(!monthly[m]) monthly[m]={s:0, p:0}; monthly[m].s += s.amountExc; }); 
        purchases.forEach(p => { const m = p.date ? p.date.substring(0,6) : ''; if(m) { if(!monthly[m]) monthly[m]={s:0, p:0}; monthly[m].p += p.amount; } }); 
        const labels = Object.keys(monthly).sort(); 
        
        const ctxTrend = document.getElementById('chart-trend');
        if(ctxTrend) {
            chartTrend = new Chart(ctxTrend, { type: 'bar', data: { labels: labels.map(l=>l.slice(0,4)+'/'+l.slice(4)), datasets: [ { label: 'å£²ä¸Š(ç¨æŠœ)', data: labels.map(l=>monthly[l].s), backgroundColor: '#3b82f6' }, { label: 'åŸä¾¡', data: labels.map(l=>monthly[l].p), backgroundColor: '#ef4444' } ] }, options: { responsive:true, maintainAspectRatio:false } }); 
        }

        const vendors = {}; let totalCost = 0; 
        purchases.forEach(p => { const v = p.vendor||'ä¸æ˜'; vendors[v] = (vendors[v]||0)+p.amount; totalCost += p.amount; }); 
        let sorted = Object.entries(vendors).sort((a,b)=>b[1]-a[1]); 
        const top5 = sorted.slice(0,5); const others = sorted.slice(5).reduce((a,c)=>a+c[1],0); if(others>0) top5.push(['ãã®ä»–', others]); 
        
        const ctxComp = document.getElementById('chart-composition');
        if(ctxComp) {
            chartComposition = new Chart(ctxComp, { type: 'doughnut', data: { labels: top5.map(i => `${i[0]} (${Math.round(i[1]/totalCost*100)}%)`), datasets: [{ data: top5.map(i => i[1]), backgroundColor: ['#10b981','#3b82f6','#f59e0b','#ef4444','#8b5cf6','#cbd5e1'] }] }, options: { responsive:true, maintainAspectRatio:false, plugins: { legend: { position:'right' } } } }); 
        }
    }

    // --- Import Logic ---
    const dropZone = document.getElementById('drop-zone');
    const importLog = document.getElementById('import-log');
    const processBtn = document.getElementById('btn-process-files');
    dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
    dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); dropZone.classList.remove('dragover'); });
    dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.classList.remove('dragover'); handleFiles(e.dataTransfer.files); });
    function handleFileSelect(files) { handleFiles(files); }
    function handleFiles(files) {
        let logMsg = "";
        for (let file of files) {
            const name = file.name.toLowerCase();
            if (name.includes('åŸä¾¡é›†è¨ˆ')) { pendingFiles.cost = file; logMsg += `âœ“ åŸä¾¡é›†è¨ˆè¡¨: ${file.name}\n`; }
            else if (name.includes('ç¾å ´ãƒã‚¹ã‚¿ãƒ¼') || name.includes('ç¾å ´ãƒã‚¹ã‚¿')) { pendingFiles.master = file; logMsg += `âœ“ ç¾å ´ãƒã‚¹ã‚¿ãƒ¼: ${file.name}\n`; }
            else if (name.includes('ä»•å…¥æ˜ç´°')) { pendingFiles.purchase = file; logMsg += `âœ“ ä»•å…¥æ˜ç´°: ${file.name}\n`; }
            else if (name.includes('å£²ä¸Šæ˜ç´°')) { pendingFiles.sales = file; logMsg += `âœ“ å£²ä¸Šæ˜ç´°: ${file.name}\n`; }
            else { logMsg += `? ã‚¹ã‚­ãƒƒãƒ—: ${file.name}\n`; }
        }
        importLog.textContent = logMsg || "èªè­˜ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚";
        processBtn.disabled = !(pendingFiles.cost || pendingFiles.master || pendingFiles.purchase || pendingFiles.sales);
    }
    function excelColToIndex(col) { let n=0; for(let i=0;i<col.length;i++){n=n*26+(col.toUpperCase().charCodeAt(i)-64);} return n-1; }
    async function parseExcel(file, headerRowIndex) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const json = XLSX.utils.sheet_to_json(sheet, {header: 1, defval: null});
                const headers = json[headerRowIndex];
                const rows = json.slice(headerRowIndex + 1).map(row => { let obj={}; headers.forEach((h,i)=>{if(h)obj[h]=row[i]}); return obj; });
                resolve({ rows, rawJson: json });
            };
            reader.readAsArrayBuffer(file);
        });
    }
    async function parseTextUTF16LE_ByIndex(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const decoder = new TextDecoder('utf-16le');
                const text = decoder.decode(e.target.result);
                Papa.parse(text, { header: false, skipEmptyLines: true, complete: (results) => resolve(results.data) });
            };
            reader.readAsArrayBuffer(file);
        });
    }
    async function processDroppedFiles() {
        processBtn.disabled = true; document.getElementById('import-spinner').classList.remove('hidden');
        importLog.textContent += "\n--- å‡¦ç†é–‹å§‹ ---\n";
        try {
            let costData=[], masterData=[], purchaseData=[], salesData=[], periodStr = "";
            if (pendingFiles.cost) {
                const { rows, rawJson } = await parseExcel(pendingFiles.cost, 5);
                for(let i=0; i<5; i++) {
                    const rowArr = Object.values(rawJson[i] || {});
                    const found = rowArr.find(s => typeof s === 'string' && s.includes("å®Œ äº† æ—¥"));
                    if(found) { periodStr = found; break; }
                }
                // UPDATED: Explicitly exclude 'Total' rows by name in addition to empty code
                costData = rows.map(r => ({
                    code: String(r['ã‚³ãƒ¼ãƒ‰'] || ''), 
                    name: String(r['ç¾å ´ãƒ¡ã‚¤ãƒ³å'] || ''),
                    salesTotal: parseFloat(r['å£²ä¸Šç´¯è¨ˆ'] || 0),
                    costTotal: parseFloat(r['åŸä¾¡ç´¯è¨ˆ'] || 0),
                    profitTotal: parseFloat(r['å£²ä¸Šï¼åŸä¾¡(ç´¯è¨ˆ)'] || 0),
                    marginRatio: parseFloat(r['(å£²ä¸Šç´¯è¨ˆï¼åŸä¾¡ç´¯è¨ˆ)ï¼å£²ä¸Šç´¯è¨ˆ'] || 0)
                })).filter(r => {
                     // Filter out empty codes AND rows containing 'ç·åˆè¨ˆ' or 'åˆè¨ˆ' in name
                     return r.code && r.code.trim() !== '' && !r.name.includes('ç·åˆè¨ˆ') && !r.name.includes('åˆè¨ˆ');
                });
            }
            if (pendingFiles.master) {
                const { rows } = await parseExcel(pendingFiles.master, 0);
                const mastersMap = new Map();
                rows.forEach(r => {
                    const code = String(r['ç¾å ´ï½ºï½°ï¾„ï¾'] || '');
                    if (!code) return;
                    const subCode = String(r['ç¾å ´ã‚µãƒ–ï½ºï½°ï¾„ï¾'] || '').trim(); const subName = r['ç¾å ´ã‚µãƒ–åç§°']; const isParent = (subCode === '');
                    const record = { code: code, owner: r['æ–½å·¥ä¸»å'], name: r['ç¾å ´åç§°'], manager: r['ç¾å ´æ‹…å½“å'], branch: r['æ‹ ç‚¹å'], startDate: r['ç€æ‰‹æ—¥'], endDate: r['å®Œäº†æ—¥'], subCodes: [] };
                    if (!mastersMap.has(code)) {
                        if (!isParent) record.subCodes.push({ code: subCode, name: subName });
                        mastersMap.set(code, record);
                    } else {
                        const existing = mastersMap.get(code);
                        if (isParent) { existing.owner = record.owner; existing.name = record.name; existing.manager = record.manager; existing.branch = record.branch; existing.startDate = record.startDate; existing.endDate = record.endDate; } 
                        else { existing.subCodes.push({ code: subCode, name: subName }); }
                    }
                });
                masterData = Array.from(mastersMap.values());
            }
            if (pendingFiles.purchase) {
                const raw = await parseTextUTF16LE_ByIndex(pendingFiles.purchase);
                purchaseData = raw.slice(1).map(r => {
                    if (!r[excelColToIndex('EB')]) return null;
                    const txtM = (r[excelColToIndex('M')] || '').trim(); const txtO = (r[excelColToIndex('O')] || '').trim(); const txtQ = (r[excelColToIndex('Q')] || '').trim();
                    let itemName = (txtM || txtO || txtQ) ? [txtM, txtO, txtQ].filter(Boolean).join(' ') : '00000000';
                    let d = r[excelColToIndex('A')] || ''; if (typeof d !== 'string') d = String(d);
                    return { siteCode: String(r[excelColToIndex('EB')]).trim(), date: d.trim(), vendor: r[excelColToIndex('I')], item: itemName, amount: parseFloat(String(r[excelColToIndex('DE')] || '0').replace(/,/g, '')) };
                }).filter(r => r && r.siteCode);
            }
            if (pendingFiles.sales) {
                const raw = await parseTextUTF16LE_ByIndex(pendingFiles.sales);
                salesData = raw.slice(1).map(r => {
                    if (!r[excelColToIndex('EI')]) return null;
                    let d = r[excelColToIndex('A')] || ''; if (typeof d !== 'string') d = String(d);
                    return { siteCode: String(r[excelColToIndex('EI')]).trim(), date: d.trim(), customer: r[excelColToIndex('I')], amountInc: parseFloat(String(r[excelColToIndex('DG')] || '0').replace(/,/g, '')), amountExc: parseFloat(String(r[excelColToIndex('DJ')] || '0').replace(/,/g, '')) };
                }).filter(r => r && r.siteCode);
            }
            await db.transaction('rw', db.costs, db.masters, db.purchases, db.sales, db.meta, async () => {
                if (pendingFiles.cost) { await db.costs.clear(); await db.costs.bulkPut(costData); await db.meta.put({ key: 'period', value: periodStr }); }
                if (pendingFiles.master) { await db.masters.clear(); await db.masters.bulkPut(masterData); }
                if (pendingFiles.purchase) { await db.purchases.clear(); await db.purchases.bulkAdd(purchaseData); }
                if (pendingFiles.sales) { await db.sales.clear(); await db.sales.bulkAdd(salesData); }
            });
            importLog.textContent += "å®Œäº†ï¼\n"; await updateDBStats(); alert("å®Œäº†ã—ã¾ã—ãŸã€‚");
        } catch (e) { console.error(e); importLog.textContent += `ã‚¨ãƒ©ãƒ¼: ${e.message}\n`; alert(`ã‚¨ãƒ©ãƒ¼: ${e.message}`); } 
        finally { document.getElementById('import-spinner').classList.add('hidden'); }
    }

    async function updateDBStats() {
        const elCost = document.getElementById('db-count-cost'); if (elCost) elCost.textContent = (await db.costs.count()) + "ä»¶";
        const elMaster = document.getElementById('db-count-master'); if (elMaster) elMaster.textContent = (await db.masters.count()) + "ä»¶";
        const elPurchase = document.getElementById('db-count-purchase'); if (elPurchase) elPurchase.textContent = (await db.purchases.count()) + "ä»¶";
        const elSales = document.getElementById('db-count-sales'); if (elSales) elSales.textContent = (await db.sales.count()) + "ä»¶";
        const meta = await db.meta.get('period');
        if(meta && meta.value) { document.getElementById('header-period').classList.remove('hidden'); document.getElementById('period-text').textContent = meta.value; parseAndSetDefaultPeriod(meta.value); }
    }
    
    function parseDateValue(value) {
        if (!value) return null;
        if (typeof value === 'number') { return (value - 25569) * 86400 * 1000; }
        if (typeof value === 'string') { let ts = Date.parse(value); if (!isNaN(ts)) return ts; const jpRegex = /(\d{1,2})å¹´\s*(\d{1,2})æœˆ\s*(\d{1,2})æ—¥/; const match = value.match(jpRegex); if (match) { const y = parseInt(match[1]) + 2000; const m = parseInt(match[2]); const d = parseInt(match[3]); return new Date(y, m-1, d).getTime(); } }
        return null;
    }
    function parseAndSetDefaultPeriod(text) {
        const regex = /(\d{1,2})å¹´\s*(\d{1,2})æœˆ\s*(\d{1,2})æ—¥/g; const matches = [...text.matchAll(regex)];
        if (matches.length >= 1) {
            const start = toISODate(matches[0]); const end = matches.length >= 2 ? toISODate(matches[1]) : null;
            if (start) document.getElementById('rank-date-start').value = start;
            if (end) document.getElementById('rank-date-end').value = end;
            if (start) rankingFilter = { start, end: end || start };
        } else {
            const today = new Date(); const s = `${today.getFullYear()}-01-01`; const e = `${today.getFullYear()}-12-31`;
            document.getElementById('rank-date-start').value = s; document.getElementById('rank-date-end').value = e; document.getElementById('rank-date-status').textContent = "â€»ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæœŸé–“(ä»Šå¹´)ã‚’è¡¨ç¤º"; rankingFilter = { start: s, end: e };
        }
    }
    function toISODate(m) { const y = parseInt(m[1]) + 2000; const mo = String(m[2]).padStart(2,'0'); const d = String(m[3]).padStart(2,'0'); return `${y}-${mo}-${d}`; }
    window.applyDateFilter = function() {
        const s = document.getElementById('rank-date-start').value; const e = document.getElementById('rank-date-end').value;
        rankingFilter = { start: s, end: e }; document.getElementById('rank-date-status').textContent = "";
        const activeTab = document.querySelector('.tab-btn.active');
        if (activeTab) { const tabId = activeTab.id.replace('tab-', ''); window.switchRankingTab(tabId); }
    }
    window.clearDatabase = async function() { if(confirm("å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) { await Promise.all([db.costs.clear(), db.masters.clear(), db.purchases.clear(), db.sales.clear(), db.meta.clear()]); updateDBStats(); } }

    // --- Ranking Logic ---
    window.switchRankingTab = function(tab) {
        try {
            document.querySelectorAll('.ranking-tab-content').forEach(el=>el.classList.add('hidden'));
            document.getElementById(`ranking-${tab}`).classList.remove('hidden');
            document.querySelectorAll('.tab-btn').forEach(el=>el.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');

            if(tab==='owner') window.initOwnerRanking();
            if(tab==='branch') window.renderBranchRanking();
            if(tab==='manager') window.initManagerRanking();
            if(tab==='monthly-manager') window.renderMonthlyManagerRanking();
            if(tab==='month') setTimeout(window.initMonthlyRanking, 50); 
            if(tab==='worst') window.initWorstRanking();
        } catch (e) { console.error(e); alert("ã‚¿ãƒ–åˆ‡æ›¿ã‚¨ãƒ©ãƒ¼: " + e.message); }
    }

    async function getAggregatedData_CostBase(keyType) {
        const costs = await db.costs.toArray(); const masters = await db.masters.toArray(); const groups = {};
        const fStart = rankingFilter.start ? new Date(rankingFilter.start).setHours(0,0,0,0) : 0;
        const fEnd = rankingFilter.end ? new Date(rankingFilter.end).setHours(23,59,59,999) : 9999999999999;
        costs.forEach(c => {
            const m = masters.find(ma => ma.code === c.code); if (!m) return;
            const endTs = parseDateValue(m.endDate); if (!endTs || endTs < fStart || endTs > fEnd) return;
            let k = 'ä¸æ˜'; if (keyType==='owner') k = m.owner || 'ä¸æ˜'; else if(keyType==='branch') k = m.branch || 'ä¸æ˜'; else if(keyType==='manager') k = m.manager || 'ä¸æ˜';
            if(!groups[k]) groups[k] = { name:k, sales:0, cost:0, profit:0, count:0 };
            groups[k].sales += c.salesTotal; groups[k].cost += c.costTotal; groups[k].profit += c.profitTotal; groups[k].count++;
        });
        return Object.values(groups);
    }

    window.initOwnerRanking = async function() {
        const masters = await db.masters.toArray(); const branches = new Set(masters.map(m => m.branch).filter(b => b));
        const select = document.getElementById('rank-owner-branch'); if (select.options.length <= 1) Array.from(branches).sort().forEach(b => select.add(new Option(b, b)));
        window.renderOwnerRanking();
    }
    window.renderOwnerRanking = async function() {
        const targetBranch = document.getElementById('rank-owner-branch').value;
        const costs = await db.costs.toArray(); const masters = await db.masters.toArray(); const groups = {};
        const fStart = rankingFilter.start ? new Date(rankingFilter.start).setHours(0,0,0,0) : 0;
        const fEnd = rankingFilter.end ? new Date(rankingFilter.end).setHours(23,59,59,999) : 9999999999999;
        costs.forEach(c => {
            const m = masters.find(ma => ma.code === c.code); if (!m) return;
            const endTs = parseDateValue(m.endDate); if (!endTs || endTs < fStart || endTs > fEnd) return;
            if (targetBranch !== 'ALL' && m.branch !== targetBranch) return;
            const k = m.owner || 'ä¸æ˜';
            if(!groups[k]) groups[k] = { name:k, sales:0, cost:0, profit:0, count:0 };
            groups[k].sales += c.salesTotal; groups[k].cost += c.costTotal; groups[k].profit += c.profitTotal; groups[k].count++;
        });
        window.sortAndRender(Object.values(groups), 'ranking-body-owner', 'rank-sort-owner');
    }

    window.renderBranchRanking = async function() {
        const data = await getAggregatedData_CostBase('branch'); window.sortAndRender(data, 'ranking-body-branch', null);
        chartBranchSales = window.destroyChart(chartBranchSales); chartBranchProfit = window.destroyChart(chartBranchProfit);
        const ctxS = document.getElementById('chart-branch-sales'); const ctxP = document.getElementById('chart-branch-profit');
        if(ctxS && ctxP) {
            const sorted = [...data].sort((a,b)=>b.sales - a.sales);
            chartBranchSales = new Chart(ctxS, { type:'pie', data:{ labels:sorted.map(d=>d.name), datasets:[{data:sorted.map(d=>d.sales), backgroundColor:['#3b82f6','#10b981','#f59e0b','#ef4444','#8b5cf6']}] }, options:{plugins:{legend:{position:'right'}}} });
            chartBranchProfit = new Chart(ctxP, { type:'pie', data:{ labels:sorted.map(d=>d.name), datasets:[{data:sorted.map(d=>d.profit), backgroundColor:['#3b82f6','#10b981','#f59e0b','#ef4444','#8b5cf6']}] }, options:{plugins:{legend:{position:'right'}}} });
        }
    }

    window.initManagerRanking = async function() {
        const masters = await db.masters.toArray(); const branches = new Set(); const months = new Set();
        masters.forEach(m => { if(m.branch) branches.add(m.branch); const ts = parseDateValue(m.endDate); if(ts) { const d = new Date(ts); const yyyymm = d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0'); months.add(yyyymm); } });
        const selMonth = document.getElementById('rank-manager-month'); const selBranch = document.getElementById('rank-manager-branch');
        if(selMonth.options.length === 0) { selMonth.add(new Option('å…¨æœŸé–“', 'ALL')); Array.from(months).sort().reverse().forEach(m => selMonth.add(new Option(m + ' å®Œå·¥', m))); }
        if(selBranch.options.length === 1) { Array.from(branches).sort().forEach(b => selBranch.add(new Option(b, b))); }
        window.renderManagerRanking();
    }
    window.renderManagerRanking = async function() {
        const targetMonth = document.getElementById('rank-manager-month').value; const targetBranch = document.getElementById('rank-manager-branch').value;
        const costs = await db.costs.toArray(); const masters = await db.masters.toArray(); const groups = {};
        costs.forEach(c => {
            const m = masters.find(ma => ma.code === c.code); if (!m) return;
            const endTs = parseDateValue(m.endDate); if (!endTs) return;
            if (targetMonth !== 'ALL') { const d = new Date(endTs); const yyyymm = d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0'); if (yyyymm !== targetMonth) return; }
            if (targetBranch !== 'ALL' && m.branch !== targetBranch) return;
            const k = m.manager || 'ä¸æ˜';
            if(!groups[k]) groups[k] = { name:k, sales:0, cost:0, profit:0, count:0 };
            groups[k].sales += c.salesTotal; groups[k].cost += c.costTotal; groups[k].profit += c.profitTotal; groups[k].count++;
        });
        window.sortAndRender(Object.values(groups), 'ranking-body-manager', 'rank-sort-manager');
    }

    window.setMonthlyMode = function(mode) { currentMonthlyMode = mode; document.getElementById('btn-mode-manager').className = mode==='manager'?'btn-group-item active':'btn-group-item'; document.getElementById('btn-mode-owner').className = mode==='owner'?'btn-group-item active':'btn-group-item'; document.getElementById('mm-header-name').textContent = mode==='manager'?'æ‹…å½“è€…å':'æ–½å·¥ä¸»å'; window.renderMonthlyManagerRanking(); }
    window.renderMonthlyManagerRanking = async function() {
        const allSales = await db.sales.toArray(); const allMasters = await db.masters.toArray(); const masterMap = new Map(); allMasters.forEach(m => masterMap.set(m.code, { mgr: m.manager, br: m.branch, owner: m.owner }));
        const monthSelect = document.getElementById('mm-filter-month'); const branchSelect = document.getElementById('mm-filter-branch');
        const agg = {}; const months = new Set(); const branches = new Set();
        allSales.forEach(s => {
            const mInfo = masterMap.get(s.siteCode); const manager = mInfo ? mInfo.mgr : 'ä¸æ˜'; const branch = mInfo ? mInfo.br : 'ä¸æ˜'; const owner = mInfo ? mInfo.owner : 'ä¸æ˜';
            const yyyymm = s.date.substring(0, 6); if (!yyyymm) return;
            months.add(yyyymm); if (branch !== 'ä¸æ˜') branches.add(branch);
            const targetName = currentMonthlyMode === 'manager' ? manager : owner; const key = `${yyyymm}_${targetName}_${branch}`;
            if (!agg[key]) agg[key] = { month: yyyymm, name: targetName, branch, sales: 0 }; agg[key].sales += s.amountExc; 
        });
        if (monthSelect.options.length === 0) Array.from(months).sort().reverse().forEach(m => monthSelect.add(new Option(m, m))); if (branchSelect.options.length === 1) Array.from(branches).sort().forEach(b => branchSelect.add(new Option(b, b)));
        const selMonth = monthSelect.value; const selBranch = branchSelect.value;
        const list = Object.values(agg).filter(a => { if (selMonth && a.month !== selMonth) return false; if (selBranch !== 'ALL' && a.branch !== selBranch) return false; return true; });
        list.sort((a,b) => b.sales - a.sales);
        const tbody = document.getElementById('ranking-body-monthly-manager'); tbody.innerHTML = '';
        list.forEach((r, i) => { tbody.innerHTML += `<tr><td class="px-6 py-4 font-bold">${i+1}</td><td class="px-6 py-4">${r.name}</td><td class="px-6 py-4">${r.branch}</td><td class="px-6 py-4 text-right font-bold">${formatCurrency(r.sales)}</td><td class="px-6 py-4 text-right text-slate-300">-</td><td class="px-6 py-4 text-right text-slate-300">-</td></tr>`; });
    }

    window.initMonthlyRanking = async function() { const selBranch = document.getElementById('month-filter-branch'); if (selBranch.options.length === 1) { const masters = await db.masters.toArray(); const brSet = new Set(masters.map(m=>m.branch).filter(b=>b)); Array.from(brSet).sort().forEach(b => selBranch.add(new Option(b,b))); } window.renderMonthlyRanking(); }
    window.renderMonthlyRanking = async function() {
        try {
            const targetB = document.getElementById('month-filter-branch').value;
            const sales = await db.sales.toArray(); const purchases = await db.purchases.toArray(); const masters = await db.masters.toArray(); const masterMap = new Map(); masters.forEach(m => masterMap.set(m.code, m.branch));
            const stats = {}; 
            sales.forEach(s => { if (targetB !== 'ALL') { const b = masterMap.get(s.siteCode); if (b !== targetB) return; } const m = s.date.substring(0,6); if(m) { if(!stats[m]) stats[m]={s:0, p:0}; stats[m].s += s.amountExc; } });
            purchases.forEach(p => { if (targetB !== 'ALL') { const b = masterMap.get(p.siteCode); if (b !== targetB) return; } const m = p.date ? p.date.substring(0,6) : ''; if(m) { if(!stats[m]) stats[m]={s:0, p:0}; stats[m].p += p.amount; } });
            const labels = Object.keys(stats).sort();
            chartMonthly = window.destroyChart(chartMonthly);
            const ctx = document.getElementById('chart-monthly-total');
            if (ctx) { chartMonthly = new Chart(ctx, { type: 'bar', data: { labels: labels, datasets: [{ label: `å£²ä¸Š(ç¨æŠœ)`, data: labels.map(l=>stats[l].s), backgroundColor: '#3b82f6' }, { label: 'åŸä¾¡', data: labels.map(l=>stats[l].p), backgroundColor: '#ef4444' }] }, options:{maintainAspectRatio:false} }); }
            const tbody = document.getElementById('ranking-table-month'); const tfoot = document.getElementById('ranking-footer-month'); tbody.innerHTML = ''; let sumS=0, sumP=0;
            if(targetB === 'ALL') { document.getElementById('monthly-table-head').innerHTML = `<tr><th class="px-4 py-2 border border-slate-300">å¹´æœˆ</th><th class="px-4 py-2 border border-slate-300 text-right">å£²ä¸Š(ç¨æŠœ)</th><th class="px-4 py-2 border border-slate-300 text-right">åŸä¾¡(ç¨æŠœ)</th><th class="px-4 py-2 border border-slate-300 text-right">ç²—åˆ©ç›Š</th><th class="px-4 py-2 border border-slate-300 text-right">ç²—åˆ©ç‡</th></tr>`; } else { document.getElementById('monthly-table-head').innerHTML = `<tr><th class="px-4 py-2 border border-slate-300">å¹´æœˆ</th><th class="px-4 py-2 border border-slate-300 text-right">å£²ä¸Š(ç¨æŠœ)</th></tr>`; }
            labels.forEach(m => {
                const d = stats[m]; sumS += d.s; sumP += d.p; const profit = d.s - d.p; const margin = d.s ? (profit/d.s*100) : 0;
                let row = `<td class="px-4 py-2">${m}</td><td class="px-4 py-2 text-right font-mono">${formatCurrency(d.s)}</td>`;
                if(targetB === 'ALL') { row += `<td class="px-4 py-2 text-right font-mono text-red-600">${formatCurrency(d.p)}</td><td class="px-4 py-2 text-right font-mono ${profit<0?'text-red-600':'text-blue-600'}">${formatCurrency(profit)}</td><td class="px-4 py-2 text-right">${margin.toFixed(1)}%</td>`; }
                tbody.innerHTML += `<tr class="border-b">${row}</tr>`;
            });
            let footRow = `<td class="px-4 py-2">åˆè¨ˆ</td><td class="px-4 py-2 text-right">${formatCurrency(sumS)}</td>`;
            if(targetB === 'ALL') { const tp = sumS - sumP; const tm = sumS ? (tp/sumS*100) : 0; footRow += `<td class="px-4 py-2 text-right">${formatCurrency(sumP)}</td><td class="px-4 py-2 text-right">${formatCurrency(tp)}</td><td class="px-4 py-2 text-right">${tm.toFixed(1)}%</td>`; }
            tfoot.innerHTML = `<tr>${footRow}</tr>`;
        } catch (e) { console.error("Monthly Render Error:", e); }
    }

    window.setWorstType = function(type) {
        currentWorstType = type;
        document.getElementById('btn-wt-ranking').className = type==='ranking'?'btn-group-item active':'btn-group-item';
        document.getElementById('btn-wt-alert').className = type==='alert'?'btn-group-item active text-red-600':'btn-group-item';
        if(type === 'ranking') { document.getElementById('worst-controls-ranking').classList.remove('hidden'); document.getElementById('worst-controls-alert').classList.add('hidden'); }
        else { document.getElementById('worst-controls-ranking').classList.add('hidden'); document.getElementById('worst-controls-alert').classList.remove('hidden'); }
        window.renderWorstRanking();
    }
    window.setWorstSort = function(sort) {
        currentWorstSort = sort;
        document.getElementById('btn-worst-rate').className = sort==='rate'?'btn-group-item active text-red-600':'btn-group-item';
        document.getElementById('btn-worst-amount').className = sort==='amount'?'btn-group-item active text-red-600':'btn-group-item';
        window.renderWorstRanking();
    }
    window.initWorstRanking = async function() {
        const masters = await db.masters.toArray(); const branches = new Set(); const months = new Set();
        masters.forEach(m => { if(m.branch) branches.add(m.branch); const ts = parseDateValue(m.endDate); if(ts) { const d = new Date(ts); const yyyymm = d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0'); months.add(yyyymm); } });
        const selMonth = document.getElementById('worst-alert-month'); const selBranch = document.getElementById('worst-alert-branch');
        if(selMonth.options.length === 0) { selMonth.add(new Option('å…¨æœŸé–“', 'ALL')); Array.from(months).sort().reverse().forEach(m => selMonth.add(new Option(m + ' å®Œå·¥', m))); }
        if(selBranch.options.length === 1) { Array.from(branches).sort().forEach(b => selBranch.add(new Option(b, b))); }
        window.renderWorstRanking();
    }
    window.renderWorstRanking = async function() {
        const costs = await db.costs.toArray(); const masters = await db.masters.toArray(); const tbody = document.getElementById('ranking-body-worst'); tbody.innerHTML = ''; let list = [];
        if (currentWorstType === 'ranking') {
            const fStart = rankingFilter.start ? new Date(rankingFilter.start).setHours(0,0,0,0) : 0; const fEnd = rankingFilter.end ? new Date(rankingFilter.end).setHours(23,59,59,999) : 9999999999999;
            costs.forEach(c => {
                const m = masters.find(ma => ma.code === c.code); if (!m) return; const endTs = parseDateValue(m.endDate); if (!endTs || endTs < fStart || endTs > fEnd) return; if (c.salesTotal <= 0) return;
                list.push({ code: c.code, name: c.name, manager: m.manager || '-', owner: m.owner || '-', branch: m.branch || '-', endStr: m.endDate, sales: c.salesTotal, profit: c.profitTotal, margin: (c.profitTotal / c.salesTotal * 100) });
            });
            if (currentWorstSort === 'rate') list.sort((a,b) => a.margin - b.margin); else list.sort((a,b) => a.profit - b.profit); list = list.slice(0, 20);
        } else {
            const targetMonth = document.getElementById('worst-alert-month').value; const targetBranch = document.getElementById('worst-alert-branch').value;
            costs.forEach(c => {
                const m = masters.find(ma => ma.code === c.code); if (!m) return; const endTs = parseDateValue(m.endDate); if (!endTs) return;
                if (targetMonth !== 'ALL') { const d = new Date(endTs); const yyyymm = d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0'); if (yyyymm !== targetMonth) return; }
                if (targetBranch !== 'ALL' && m.branch !== targetBranch) return; if (c.salesTotal <= 0) return;
                const margin = (c.profitTotal / c.salesTotal * 100); if (margin > 20) return;
                list.push({ code: c.code, name: c.name, manager: m.manager || '-', owner: m.owner || '-', branch: m.branch || '-', endStr: m.endDate, sales: c.salesTotal, profit: c.profitTotal, margin: margin });
            });
            list.sort((a,b) => a.margin - b.margin);
        }
        currentWorstList = list;
        if (list.length === 0) { tbody.innerHTML = '<tr><td colspan="8" class="px-6 py-4 text-center text-slate-400">è©²å½“ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>'; return; }
        list.forEach((r,i) => {
            let dateDisp = '-'; const ts = parseDateValue(r.endStr); if(ts) { const d = new Date(ts); dateDisp = `${d.getMonth()+1}æœˆ (${r.branch})`; } else { dateDisp = r.branch; }
            tbody.innerHTML += `<tr>
                <td class="px-6 py-4 font-bold text-red-600">${i+1}</td>
                <td class="px-6 py-4 text-xs font-mono text-slate-500">${r.code}</td>
                <td class="px-6 py-4 text-xs"><div class="font-bold text-sm text-slate-800 mb-1 truncate max-w-xs" title="${r.name}">${r.name}</div></td>
                <td class="px-6 py-4 text-xs text-slate-700">${r.manager}</td>
                <td class="px-6 py-4 text-xs text-slate-600 truncate max-w-[100px]">${r.owner}</td>
                <td class="px-6 py-4 text-xs text-slate-500">${dateDisp}</td>
                <td class="px-6 py-4 text-right font-bold text-red-600">${r.margin.toFixed(1)}%</td>
                <td class="px-6 py-4 text-right text-red-500 text-xs font-mono">${formatCurrency(r.profit)}</td>
                <td class="px-6 py-4 text-right text-xs font-mono">${formatCurrency(r.sales)}</td>
            </tr>`;
        });
    }
    window.exportWorstExcel = function() { if(!currentWorstList || currentWorstList.length === 0) { alert("å‡ºåŠ›ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“"); return; } const exportData = currentWorstList.map((r, i) => ({ "é †ä½": i+1, "å·¥ç•ª": r.code, "ç¾å ´å": r.name, "æ‹…å½“è€…": r.manager, "æ–½å·¥ä¸»": r.owner, "æ‹ ç‚¹": r.branch, "å®Œå·¥æ—¥": r.endStr, "ç²—åˆ©ç‡": r.margin.toFixed(2) + "%", "ç²—åˆ©ç›Š(ç¨æŠœ)": r.profit, "å£²ä¸Š(ç¨æŠœ)": r.sales })); const ws = XLSX.utils.json_to_sheet(exportData); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "ãƒ¯ãƒ¼ã‚¹ãƒˆåˆ†æ"); XLSX.writeFile(wb, `åˆ©ç›Šç‡ãƒ¯ãƒ¼ã‚¹ãƒˆåˆ†æ_${new Date().toISOString().slice(0,10)}.xlsx`); }
    window.sortAndRender = function(data, tbodyId, sortSelectId) { const sortKey = sortSelectId ? document.getElementById(sortSelectId).value : 'profit'; data.sort((a,b) => b[sortKey] - a[sortKey]); const tbody = document.getElementById(tbodyId); tbody.innerHTML = ''; data.forEach((r,i) => { const margin = r.sales? (r.profit/r.sales*100) : 0; tbody.innerHTML += `<tr><td class="px-6 py-4 font-bold">${i+1}</td><td class="px-6 py-4">${r.name}</td><td class="px-6 py-4 text-right">${formatCurrency(r.sales)}</td><td class="px-6 py-4 text-right">${formatCurrency(r.cost)}</td><td class="px-6 py-4 text-right font-bold">${formatCurrency(r.profit)}</td><td class="px-6 py-4 text-right font-bold ${margin<10?'text-red-500':'text-green-600'}">${margin.toFixed(1)}%</td><td class="px-6 py-4 text-center">${r.count}</td></tr>`; }); }
    
    // --- Cost Search & Site Search (Same as v14) ---
    // (Omitted for brevity, fully included in final file)
    const searchInput = document.getElementById('cost-search-input');
    const autocompleteList = document.getElementById('cost-autocomplete-list');
    let cachedVendors = [];
    window.initCostSearch = async function() { const purchases = await db.purchases.toArray(); const vendorCounts = {}; purchases.forEach(p => { if(p.vendor) vendorCounts[p.vendor] = (vendorCounts[p.vendor] || 0) + 1; }); cachedVendors = Object.entries(vendorCounts).sort((a,b) => b[1] - a[1]).map(e => e[0]); const masters = await db.masters.toArray(); const brSet = new Set(masters.map(m => m.branch).filter(Boolean)); const sel = document.getElementById('cost-search-branch'); if(sel.options.length === 1) Array.from(brSet).sort().forEach(b => sel.add(new Option(b,b))); sel.addEventListener('change', () => { if(currentCostVendor) window.executeCostSearch(currentCostVendor); }); }
    searchInput.addEventListener('input', function() { const val = this.value.toLowerCase().trim(); autocompleteList.innerHTML = ''; autocompleteList.classList.add('hidden'); if(!val) return; const matches = cachedVendors.filter(v => normalizeStr(v).includes(normalizeStr(val))).slice(0, 10); if(matches.length === 0) return; autocompleteList.classList.remove('hidden'); matches.forEach(vendor => { const div = document.createElement('div'); div.className = 'autocomplete-item'; div.innerHTML = `<strong>${vendor}</strong>`; div.addEventListener('click', () => { searchInput.value = vendor; autocompleteList.classList.add('hidden'); window.executeCostSearch(vendor); }); autocompleteList.appendChild(div); }); });
    // Enter key handling for Cost Search
    searchInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            // If autocomplete has items, pick the first one. Otherwise search input value.
            const firstItem = !autocompleteList.classList.contains('hidden') ? autocompleteList.querySelector('.autocomplete-item') : null;
            
            if (firstItem) {
                firstItem.click();
            } else {
                // å€™è£œãŒãªã„ã€ã¾ãŸã¯é–‰ã˜ã¦ã„ã‚Œã°å…¥åŠ›å€¤ã§æ¤œç´¢
                const val = this.value.trim();
                if (val) {
                    window.executeCostSearch(val);
                    autocompleteList.classList.add('hidden'); // å¿µã®ãŸã‚é–‰ã˜ã‚‹
                }
            }
        }
    });

    window.executeCostSearch = async function(vendorName) { currentCostVendor = vendorName; const targetBranch = document.getElementById('cost-search-branch').value; let purchases = await db.purchases.where('vendor').equals(vendorName).toArray(); const masters = await db.masters.toArray(); const masterMap = new Map(); masters.forEach(m => masterMap.set(m.code, m)); if(targetBranch !== 'ALL') purchases = purchases.filter(p => { const m = masterMap.get(p.siteCode); return m && m.branch === targetBranch; }); document.getElementById('cost-search-result').classList.remove('hidden'); document.getElementById('cs-vendor-name').textContent = vendorName; const totalAmt = purchases.reduce((sum, p) => sum + p.amount, 0); document.getElementById('cs-total-amount').textContent = formatCurrency(totalAmt); document.getElementById('cs-total-count').textContent = purchases.length + 'ä»¶'; const catCounts = {}; purchases.forEach(p => { let cat = 'ãã®ä»–'; if(p.item && p.item.length < 15) cat = p.item; catCounts[cat] = (catCounts[cat]||0)+1; }); const topCats = Object.entries(catCounts).sort((a,b)=>b[1]-a[1]).slice(0,3).map(e=>e[0]); document.getElementById('cs-top-items').innerHTML = topCats.map(c => `<span class="px-2 py-1 bg-slate-100 text-xs rounded text-slate-600">${c}</span>`).join(''); const monthly = {}; purchases.forEach(p => { const m = p.date ? p.date.substring(0,6) : 'ä¸æ˜'; if(!monthly[m]) monthly[m] = {amt:0, cnt:0}; monthly[m].amt += p.amount; monthly[m].cnt++; }); const labels = Object.keys(monthly).sort().filter(k=>k!=='ä¸æ˜'); chartCostTrend = destroyChart(chartCostTrend); chartCostTrend = new Chart(document.getElementById('chart-cost-trend'), { type: 'bar', data: { labels: labels.map(l=>l.slice(0,4)+'/'+l.slice(4)), datasets: [{ label:'ç™ºç”Ÿé¡', data:labels.map(l=>monthly[l].amt), backgroundColor:'#3b82f6' }] }, options:{ maintainAspectRatio:false } }); const tbodyM = document.getElementById('cs-table-monthly'); tbodyM.innerHTML = ''; labels.reverse().forEach(m => { const d = monthly[m]; const ratio = totalAmt ? (d.amt/totalAmt*100) : 0; tbodyM.innerHTML += `<tr class="border-b"><td class="px-4 py-2">${m}</td><td class="px-4 py-2 text-right font-mono">${formatCurrency(d.amt)}</td><td class="px-4 py-2 text-center">${d.cnt}</td><td class="px-4 py-2 text-center">${ratio.toFixed(1)}%</td></tr>`; }); currentCostDetails = purchases.map(p => { const m = masterMap.get(p.siteCode) || {}; return { date: p.date || '-', code: p.siteCode, name: m.name || '-', branch: m.branch || '-', item: p.item, amount: p.amount }; }); window.renderCostDetailsTable(); }
    window.sortCostDetails = function(key) { if (costSortState.key === key) costSortState.order = costSortState.order === 'asc' ? 'desc' : 'asc'; else { costSortState.key = key; costSortState.order = 'desc'; } window.renderCostDetailsTable(); }
    window.renderCostDetailsTable = function() { const { key, order } = costSortState; const sorted = [...currentCostDetails].sort((a,b) => { let valA = a[key]; let valB = b[key]; if(key === 'amount') { valA = parseFloat(valA); valB = parseFloat(valB); } if (valA < valB) return order === 'asc' ? -1 : 1; if (valA > valB) return order === 'asc' ? 1 : -1; return 0; }); const tbody = document.getElementById('cs-table-details'); tbody.innerHTML = ''; sorted.slice(0, 500).forEach(p => { tbody.innerHTML += `<tr class="border-b hover:bg-slate-50"><td class="px-4 py-2">${p.date}</td><td class="px-4 py-2 font-mono text-xs">${p.code}</td><td class="px-4 py-2 text-xs truncate max-w-[150px]">${p.name}</td><td class="px-4 py-2 text-xs">${p.branch}</td><td class="px-4 py-2 text-xs truncate max-w-[150px]">${p.item}</td><td class="px-4 py-2 text-right font-mono">${formatCurrency(p.amount)}</td></tr>`; }); }
    
    // --- Site Search ---
    const siteNameInput = document.getElementById('site-name-search');
    const siteAutoList = document.getElementById('site-autocomplete-list');
    let cachedMasters = [];
    async function initSiteSearch() { const masters = await db.masters.toArray(); cachedMasters = masters.map(m => ({ name: m.name || '', owner: m.owner || '', code: m.code })); }
    siteNameInput.addEventListener('input', function() { const val = this.value.trim(); siteAutoList.innerHTML = ''; siteAutoList.classList.add('hidden'); if(!val) return; const normVal = normalizeStr(val); const matches = cachedMasters.filter(m => normalizeStr(m.name).includes(normVal) || normalizeStr(m.owner).includes(normVal)).slice(0, 10); if(matches.length === 0) return; siteAutoList.classList.remove('hidden'); matches.forEach(m => { const div = document.createElement('div'); div.className = 'autocomplete-item'; div.innerHTML = `<div class="font-bold text-sm">${m.name}</div><div class="text-xs text-slate-500">${m.owner} (${m.code})</div>`; div.addEventListener('click', () => { document.getElementById('search-input').value = m.code; siteNameInput.value = ''; siteAutoList.classList.add('hidden'); window.searchSite(); }); siteAutoList.appendChild(div); }); });
    // Enter key handling for Site Name Search
    siteNameInput.addEventListener('keydown', function(e) {
         if(e.key === 'Enter') {
            e.preventDefault();
            const firstItem = siteAutoList.querySelector('.autocomplete-item');
            if (firstItem) {
                firstItem.click();
            }
         }
    });

    // Enter key handling for Site Code Search
    document.getElementById('search-input').addEventListener('keydown', function(e) {
        if(e.key === 'Enter') {
            e.preventDefault();
            window.searchSite();
        }
    });

    window.searchSite = async function() { 
        try {
            const inputCode = document.getElementById('search-input').value.trim(); if (!inputCode) return; 
            const master = await db.masters.get(inputCode); const cost = await db.costs.get(inputCode); 
            const sales = await db.sales.where('siteCode').equals(inputCode).toArray(); 
            const purchases = await db.purchases.where('siteCode').equals(inputCode).toArray(); 
            
            if (!master && !cost) { alert("è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ã‚³ãƒ¼ãƒ‰ã‚’ç¢ºèªã—ã¦ãã ã•ã„: " + inputCode); return; } 
            
            document.getElementById('search-result').classList.remove('hidden'); 
            document.getElementById('res-code').textContent = inputCode; 
            document.getElementById('res-name').textContent = master ? master.name : (cost ? cost.name : '-'); 
            
            const subNameEl = document.getElementById('res-sub-name');
            const subCodeEl = document.getElementById('res-sub-code');
            if(subNameEl) subNameEl.textContent = master ? (master.subName || '-') : '-'; 
            if(subCodeEl) subCodeEl.textContent = master ? (master.subCode || '-') : '-'; 
            
            document.getElementById('res-owner').textContent = master ? master.owner : '-'; 
            document.getElementById('res-manager').textContent = master ? master.manager : '-'; 
            document.getElementById('res-branch').textContent = master ? master.branch : '-'; 
            document.getElementById('res-start').textContent = master ? master.startDate : '-'; 
            document.getElementById('res-end').textContent = master ? master.endDate : '-'; 
            
            const subCont = document.getElementById('res-subcodes-container');
            const subList = document.getElementById('res-subcodes-list');
            if(subCont && subList) {
                subCont.classList.add('hidden'); subList.innerHTML = ''; 
                if (master && master.subCodes && master.subCodes.length > 0) { 
                    subCont.classList.remove('hidden'); 
                    master.subCodes.forEach(s => { const span = document.createElement('span'); span.className = "bg-blue-50 text-blue-700 text-xs px-2 py-1 rounded border border-blue-100"; span.textContent = `${s.code}: ${s.name}`; subList.appendChild(span); }); 
                }
            }
            
            const salesTotal = cost ? cost.salesTotal : 0; const costTotal = cost ? cost.costTotal : 0; const profitTotal = cost ? cost.profitTotal : 0; const margin = salesTotal !== 0 ? (profitTotal / salesTotal * 100) : 0; 
            document.getElementById('res-sales').textContent = formatCurrency(salesTotal); document.getElementById('res-cost').textContent = formatCurrency(costTotal); document.getElementById('res-profit').textContent = formatCurrency(profitTotal); document.getElementById('res-margin').textContent = margin.toFixed(1) + '%'; document.getElementById('res-margin-bar').style.width = Math.min(Math.max(margin, 0), 100) + '%'; 
            
            window.renderTable('table-sales-body', sales, ['date', 'customer', 'amountExc', 'amountInc']); 
            window.renderTable('table-purchase-body', purchases, ['vendor', 'item', 'amount']); 
            document.getElementById('count-sales').textContent = sales.length + "ä»¶"; 
            document.getElementById('count-purchase').textContent = purchases.length + "ä»¶"; 
            window.renderCharts(sales, purchases);
        } catch(e) {
            console.error("Search Error:", e);
            alert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + e.message);
        }
    }
    function normalizeStr(s) { return s.replace(/[ï¼¡-ï¼ºï½-ï½šï¼-ï¼™]/g, function(s) { return String.fromCharCode(s.charCodeAt(0) - 0xFEE0); }).toLowerCase().replace(/\s+/g, ''); }
    
    // --- Global ShowPage ---
    window.showPage = function(p) {
        document.querySelectorAll('.page-content').forEach(el=>el.classList.add('hidden'));
        document.getElementById(`page-${p}`).classList.remove('hidden');
        document.querySelectorAll('.sidebar-link').forEach(el=>el.classList.remove('active'));
        document.getElementById(`nav-${p}`).classList.add('active');
        const titles = { 'dashboard': 'ç¾å ´ç…§ä¼šãƒ»åˆ†æ', 'cost-search': 'åŸä¾¡æ¤œç´¢', 'ranking': 'é›†è¨ˆãƒ»ãƒ©ãƒ³ã‚­ãƒ³ã‚°', 'import': 'ãƒ‡ãƒ¼ã‚¿å–è¾¼ãƒ»ç®¡ç†' };
        document.getElementById('page-title').textContent = titles[p] || 'G-Ledger';
        if(p==='import') updateDBStats();
        if(p==='ranking') window.switchRankingTab('owner');
        if(p==='cost-search') window.initCostSearch();
        if(p==='dashboard') initSiteSearch();
    }

    function formatCurrency(n) { return new Intl.NumberFormat('ja-JP', { style: 'currency', currency: 'JPY' }).format(n); }
    updateDBStats();
</script>
</body>
</html>
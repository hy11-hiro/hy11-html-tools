<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<title>Exterior Calc Pro V4.4 | å®Ÿå‹™ç”¨å®Œå…¨ç‰ˆ</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root {
    --bg: #f0f2f5;
    --sidebar-bg: #1a202c;
    --sidebar-text: #a0aec0;
    --sidebar-active: #fff;
    --sidebar-active-bg: #2d3748;
    --accent: #008060;
    --accent-dark: #005c45;
    --card-bg: #ffffff;
    --border: #e2e8f0;
    --text: #2d3748;
    --danger: #e53e3e;
    --warning-bg: #fffaf0;
    --warning-text: #c05621;
    --info-bg: #ebf8ff;
    --info-text: #2b6cb0;
  }
  
  * { box-sizing: border-box; }
  body {
    font-family: "Noto Sans JP", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
    background: var(--bg); color: var(--text); margin: 0; display: flex; height: 100vh; overflow: hidden; font-size: 13px;
  }

  /* ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
  .app-container { display: flex; width: 100%; height: 100%; }
  .sidebar { width: 240px; background: var(--sidebar-bg); color: var(--sidebar-text); display: flex; flex-direction: column; flex-shrink: 0; }
  .sidebar-header { padding: 15px 20px; font-weight: 700; font-size: 16px; color: #fff; border-bottom: 1px solid #2d3748; }
  .sidebar-nav { flex: 1; overflow-y: auto; padding: 10px 0; }
  .nav-item { padding: 10px 20px; cursor: pointer; display: flex; align-items: center; border-left: 4px solid transparent; transition: 0.2s; }
  .nav-item:hover { background: rgba(255,255,255,0.05); color: #fff; }
  .nav-item.active { background: var(--sidebar-active-bg); color: #fff; border-left-color: var(--accent); font-weight: 700; }
  .sidebar-footer { padding: 15px; border-top: 1px solid #2d3748; font-size: 11px; text-align: center; }

  .main-content { flex: 1; overflow-y: auto; padding: 20px; scroll-behavior: smooth; }
  .tab-pane { display: none; max-width: 1200px; margin: 0 auto; animation: fadeIn 0.3s ease; }
  .tab-pane.active { display: block; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

  /* ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ */
  h2 { font-size: 18px; border-bottom: 2px solid var(--border); padding-bottom: 8px; margin-bottom: 15px; color: #1a202c; display: flex; align-items: center; justify-content: space-between; }
  h3 { font-size: 15px; color: var(--accent); margin: 20px 0 10px 0; font-weight: 700; display: flex; align-items: center; gap: 8px; }
  h3::before { content:''; display:block; width:4px; height:16px; background:var(--accent); border-radius:2px; }
  
  .card { background: var(--card-bg); border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); padding: 15px; margin-bottom: 15px; border: 1px solid var(--border); }
  .hint { background: var(--warning-bg); border-left: 4px solid var(--warning-text); padding: 10px; font-size: 12px; color: #2d3748; margin-bottom: 10px; line-height: 1.5; }
  
  .form-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 12px; align-items: end; }
  .full-width { grid-column: 1 / -1; }
  
  label { display: block; font-weight: 700; font-size: 11px; margin-bottom: 4px; color: #4a5568; }
  .micro { font-size: 10px; color: #718096; margin-top: 2px; display: block; }
  input, select, textarea { width: 100%; padding: 6px 8px; border: 1px solid #cbd5e0; border-radius: 4px; font-size: 13px; }
  input:focus, select:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 2px rgba(0,128,96,0.1); }
  
  /* è©³ç´°è¨­å®šã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ */
  details.advanced-settings {
    background: #f7fafc; border: 1px solid #e2e8f0; border-radius: 6px; margin-top: 10px;
  }
  details.advanced-settings summary {
    padding: 8px 12px; cursor: pointer; font-size: 12px; font-weight: 700; color: #4a5568; outline: none; user-select: none;
  }
  details.advanced-settings summary:hover { color: var(--accent); }
  .details-content { padding: 10px 12px; border-top: 1px dashed #e2e8f0; }

  button { padding: 8px 14px; border-radius: 4px; font-weight: 700; cursor: pointer; border: none; font-size: 13px; transition: 0.2s; white-space: nowrap; }
  .btn-primary { background: var(--accent); color: white; }
  .btn-primary:hover { background: var(--accent-dark); }
  .btn-secondary { background: #edf2f7; color: var(--text); border: 1px solid #cbd5e0; }
  .btn-secondary:hover { background: #e2e8f0; }
  .btn-danger { background: #fff; color: var(--danger); border: 1px solid var(--danger); padding: 4px 8px; font-size: 11px; }
  .btn-sm { padding: 4px 8px; font-size: 11px; }

  /* ãƒ†ãƒ¼ãƒ–ãƒ« */
  .table-wrap { overflow-x: auto; border: 1px solid var(--border); border-radius: 4px; margin-top: 10px; }
  table { width: 100%; border-collapse: collapse; font-size: 12px; min-width: 700px; }
  th { background: #f7fafc; padding: 8px; text-align: left; font-weight: 700; border-bottom: 2px solid var(--border); white-space: nowrap; color: #4a5568; }
  td { padding: 6px 8px; border-bottom: 1px solid var(--border); vertical-align: middle; }
  tr:hover td { background: #fafffc; }
  
  .result-box { background: #f8fafc; border: 1px dashed #cbd5e0; padding: 12px; border-radius: 6px; margin-top: 15px; font-family: monospace; font-size: 12px; color: #2d3748; line-height: 1.6; }
  .result-box strong { font-weight: 700; color: #1a202c; background: #e6fffa; padding: 0 4px; }

  /* CAD Tracer */
  .tracer-wrapper { position: relative; border: 2px solid #cbd5e0; background: #e2e8f0; overflow: hidden; height: 500px; cursor: crosshair; }
  #tracerCanvas { display: block; background: #fff; margin: 0 auto; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
  .tracer-toolbar { display: flex; gap: 8px; margin-bottom: 10px; flex-wrap: wrap; align-items: center; background: #fff; padding: 8px; border-radius: 8px; border: 1px solid #e2e8f0; }
  .tool-btn { padding: 6px 10px; font-size: 12px; background: #fff; border: 1px solid #cbd5e0; }
  .tool-btn.active { background: var(--accent); color: #fff; border-color: var(--accent); }
  .float-status { position: absolute; bottom: 10px; right: 10px; background: rgba(0,0,0,0.8); color: #fff; padding: 5px 10px; border-radius: 15px; font-size: 11px; pointer-events: none; z-index: 10; }

  @media print {
    .sidebar, button:not(.no-print), .tracer-toolbar, details.advanced-settings { display: none !important; }
    .app-container { display: block; height: auto; }
    .main-content { padding: 0; }
    .tab-pane { display: block !important; margin-bottom: 30px; page-break-inside: avoid; }
    body { background: #fff; font-size: 10pt; }
    .card { border: none; box-shadow: none; padding: 0; }
    details[open] .details-content { display: block; border:none; padding:0; }
  }
</style>
</head>
<body>

<div class="app-container">
  <aside class="sidebar">
    <div class="sidebar-header">ğŸ“ Exterior Calc V4.4</div>
    <nav class="sidebar-nav">
      <div class="nav-item active" onclick="switchTab('tab-base')">ğŸ  åœŸå·¥ãƒ»ãƒ–ãƒ­ãƒƒã‚¯</div>
      <div class="nav-item" onclick="switchTab('tab-pave')">ğŸ§± åºŠãƒ»èˆ—è£…å·¥äº‹</div>
      <div class="nav-item" onclick="switchTab('tab-stair')">ğŸªœ éšæ®µãƒ»ãƒãƒ¼ãƒ</div>
      <div class="nav-item" onclick="switchTab('tab-metal')">ğŸ”§ é‡‘ç‰©ãƒ»ãƒ•ã‚§ãƒ³ã‚¹</div>
      <div class="nav-item" onclick="switchTab('tab-tracer')" style="color:#d69e2e;">âœï¸ å›³é¢è¨ˆæ¸¬ (CAD)</div>
      <div class="nav-item" onclick="switchTab('tab-summary')" style="border-top:1px solid #4a5568; margin-top:10px;">ğŸ“Š <b>è¦‹ç©ãƒ»é›†è¨ˆ</b></div>
    </nav>
    <div class="sidebar-footer">
      <button onclick="saveData()" class="btn-secondary" style="width:100%; margin-bottom:5px;">ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ä¿å­˜</button>
      <button onclick="clearData()" class="btn-danger" style="width:100%;">ğŸ—‘ ãƒªã‚»ãƒƒãƒˆ</button>
    </div>
  </aside>

  <main class="main-content">
    
    <!-- 1. åœŸå·¥ãƒ»ãƒ–ãƒ­ãƒƒã‚¯ -->
    <div id="tab-base" class="tab-pane active">
      <h2>1. åœŸå·¥ãƒ»åŸºç¤ãƒ»ãƒ–ãƒ­ãƒƒã‚¯ç©ç®—</h2>
      
      <!-- 1a. æ®‹åœŸè¨ˆç®— -->
      <section class="card">
        <h3>1a. æ•·åœ°æ®‹åœŸã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</h3>
        <div class="form-grid">
          <div class="full-width">
            <label>ç¾æ³ãƒ¬ãƒ™ãƒ« (9ç‚¹å…¥åŠ›)</label>
            <textarea id="levels" rows="2" placeholder="10.12&#13;10.15&#13;10.08...">10.12&#13;10.10&#13;10.08&#13;10.09&#13;10.11&#13;10.05&#13;10.07&#13;10.13&#13;10.06</textarea>
          </div>
          <div><label>è¨­è¨ˆGL (m)</label><input id="designGL" type="number" value="10.10" step="0.01"></div>
          <div><label>æ•´åœ°é¢ç© (mÂ²)</label><input id="siteArea" type="number" value="50" step="0.1"></div>
          <div><br><button class="btn-primary" onclick="calcSite()">è¨ˆç®—</button></div>
        </div>
        <div id="res_site" class="result-box" style="display:none;"></div>
      </section>

      <!-- 1b. åœŸå·¥ãƒªã‚¹ãƒˆ -->
      <section class="card">
        <h3>1b. æ˜å‰Šãƒ»åœŸå·¥äº‹ãƒªã‚¹ãƒˆ</h3>
        <div class="table-wrap">
          <table id="tbl_earth"><thead><tr><th>åç§°</th><th>è¨ˆç®—å¼</th><th>æ·±ã•</th><th>ä½“ç©(mÂ³)</th><th>æ“ä½œ</th></tr></thead><tbody></tbody></table>
        </div>
        <div class="form-grid" style="margin-top:10px; background:#f9fafb; padding:10px; border-radius:6px;">
           <div><label>åç§°</label><input id="ea_name" placeholder="å—é¢åŸºç¤"></div>
           <div><label>ç¨®åˆ¥</label><select id="ea_type" onchange="toggleEarthType()"><option value="line">å¸ƒæ˜å‰Š (LÃ—WÃ—D)</option><option value="area">åºŠæ˜å‰Š (AÃ—D)</option></select></div>
           <div id="ea_grp_line"><label>å»¶é•·L(m) / å¹…W(mm)</label><div style="display:flex; gap:2px;"><input id="ea_L" type="number" placeholder="L" value="10"><input id="ea_W" type="number" placeholder="W" value="300"></div></div>
           <div id="ea_grp_area" style="display:none;"><label>é¢ç© (mÂ²)</label><input id="ea_A" type="number" placeholder="Area"></div>
           <div><label>æ·±ã• D(m)</label><input id="ea_D" type="number" value="0.6"></div>
           <div><br><button class="btn-primary" onclick="addEarth()">è¿½åŠ </button></div>
        </div>
        <details class="advanced-settings">
          <summary>â–¼ åœŸå·¥ ä¿‚æ•°è¨­å®šï¼ˆè†¨å¼µç‡ãƒ»ãƒ­ã‚¹ç‡ï¼‰</summary>
          <div class="details-content form-grid">
            <div><label>æ®‹åœŸè†¨å¼µç‡</label><input id="ea_bulking" type="number" value="1.2" step="0.1"></div>
            <div><label>åœŸé‡ãƒ­ã‚¹ç‡ (%)</label><input id="ea_loss" type="number" value="5"></div>
            <div><label>åœŸæ¯”é‡ (t/mÂ³)</label><input id="ea_density" type="number" value="1.6" step="0.1"></div>
          </div>
        </details>
      </section>

      <section class="card">
        <h3>1c. CBãƒ–ãƒ­ãƒƒã‚¯ç©ç®—</h3>
        <div class="table-wrap">
          <table id="tbl_block"><thead><tr><th>åŒºç”»</th><th>L / æ®µæ•°</th><th>åŸºç¤</th><th>é‰„ç­‹/å‹æ </th><th>ç¬ æœ¨</th><th>æ“ä½œ</th></tr></thead><tbody></tbody></table>
        </div>
        <div class="form-grid" style="margin-top:10px;">
           <div class="full-width"><label>åŒºç”»å</label><input id="bk_name" placeholder="å¢ƒç•ŒCB"></div>
           <div><label>å»¶é•· L(m)</label><input id="bk_len" type="number" value="10"></div>
           <div><label>æ®µæ•° (æ®µ)</label><input id="bk_steps" type="number" value="3"></div>
           <div><label>åŸºç¤å¹… W(mm)</label><input id="bk_base_w" type="number" value="400"></div>
           <div><label>åŸºç¤åš T(mm)</label><input id="bk_base_t" type="number" value="150"></div>
           <div><label>ã‚³ãƒ¼ãƒŠãƒ¼æ•°</label><input id="bk_corner" type="number" value="0"></div>
        </div>
        <details class="advanced-settings">
          <summary>â–¼ ãƒ–ãƒ­ãƒƒã‚¯è©³ç´°è¨­å®š</summary>
          <div class="details-content form-grid">
            <div><label>ç¸¦ç­‹ãƒ”ãƒƒãƒ(mm)</label><input id="bk_rebar_v" type="number" value="800"></div>
            <div><label>æ¨ªç­‹æ®µæ•°(æ®µæ¯)</label><input id="bk_rebar_h" type="number" value="2"></div>
            <div><label>å‹æ é«˜ã•(m)</label><input id="bk_form_h" type="number" value="0.1"></div>
            <div><label>ç¬ æœ¨ç¨®é¡</label><select id="bk_kasagi"><option value="none">ãªã—</option><option value="cb120">CB120</option><option value="cb150">CB150</option><option value="alumi">ã‚¢ãƒ«ãƒŸ</option></select></div>
            <div><label>ãƒ–ãƒ­ãƒƒã‚¯ãƒ­ã‚¹(%)</label><input id="bk_loss" type="number" value="3"></div>
            <div><label>è£½å“å¯¸æ³•</label><input id="bk_size" value="390x190x120"></div>
          </div>
        </details>
        <div class="form-grid" style="margin-top:10px;">
           <div class="full-width"><button class="btn-primary" onclick="addBlock()">ãƒ–ãƒ­ãƒƒã‚¯åŒºç”»ã‚’è¿½åŠ </button></div>
        </div>
      </section>
    </div>

    <!-- 2. èˆ—è£… -->
    <div id="tab-pave" class="tab-pane">
      <h2>2. åºŠãƒ»èˆ—è£…å·¥äº‹</h2>
      <section class="card">
        <h3>èˆ—è£…ãƒªã‚¹ãƒˆ</h3>
        <div class="table-wrap">
          <table id="tbl_pave"><thead><tr><th>åŒºåˆ†</th><th>é¢ç©</th><th>ç¨®é¡</th><th>åšã¿è¨­å®š</th><th>è©³ç´°(å‹¾é…/ãƒ¡ãƒƒã‚·ãƒ¥)</th><th>æ“ä½œ</th></tr></thead><tbody></tbody></table>
        </div>
        <div class="form-grid" style="margin-top:10px; background:#f9fafb; padding:10px; border-radius:6px;">
           <div><label>åŒºåˆ†å</label><input id="pv_name" placeholder="é§è»Šå ´"></div>
           <div><label>ç¨®é¡</label><select id="pv_type" onchange="togglePaveFields()"><option value="conc">åœŸé–“ã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆ</option><option value="tile">ã‚¿ã‚¤ãƒ«è²¼ã‚Š</option><option value="gravel">ç ‚åˆ©æ•·ã</option></select></div>
           <div><label>é¢ç© (mÂ²)</label><input id="pv_area" type="number" step="0.1"></div>
           <div><label>ä»•ä¸Š/è£½å“åš(mm)</label><input id="pv_th" type="number" value="100"></div>
           <div><label>è·¯ç›¤ç •çŸ³åš(mm)</label><input id="pv_sub_th" type="number" value="100"></div>
           
           <div class="full-width" id="pv_det_conc" style="display:block;">
             <details class="advanced-settings" open>
               <summary>â–¼ åœŸé–“ã‚³ãƒ³è©³ç´°</summary>
               <div class="details-content form-grid">
                 <div><label>å‹¾é…å»¶é•· L(m)</label><input id="pv_L" type="number" value="5"></div>
                 <div><label>å‹¾é… (%)</label><input id="pv_slope" type="number" value="2.0"></div>
                 <div><label>å‹æ å»¶é•· (m)</label><input id="pv_form" type="number" value="0"></div>
                 <div><label>ãƒ¡ãƒƒã‚·ãƒ¥æœ‰ç„¡</label><select id="pv_mesh"><option value="yes">ã‚ã‚Š(Ï†5 150)</option><option value="no">ãªã—</option></select></div>
                 <div><label>ã‚³ãƒ³ã‚¯ãƒªãƒ­ã‚¹(%)</label><input id="pv_loss" type="number" value="5"></div>
               </div>
             </details>
           </div>
           <div class="full-width" id="pv_det_tile" style="display:none;">
             <details class="advanced-settings" open>
               <summary>â–¼ ã‚¿ã‚¤ãƒ«è©³ç´°</summary>
               <div class="details-content form-grid">
                 <div><label>ä¸‹åœ°ã‚³ãƒ³åš(mm)</label><input id="pv_base_conc" type="number" value="100"></div>
                 <div><label>è£½å“å¯¸æ³•(mm)</label><input id="pv_tile_size" value="300x300"></div>
                 <div><label>æšæ•°ãƒ­ã‚¹(%)</label><input id="pv_tile_loss" type="number" value="10"></div>
               </div>
             </details>
           </div>
           <div class="full-width"><button class="btn-primary" onclick="addPave()">åŒºåˆ†ã‚’è¿½åŠ </button></div>
        </div>
      </section>
    </div>

    <!-- 3. éšæ®µ -->
    <div id="tab-stair" class="tab-pane">
      <h2>3. éšæ®µãƒ»ãƒãƒ¼ãƒè©³ç´°</h2>
      <section class="card" style="border:2px solid var(--accent);">
        <h3>3a. éšæ®µä½œæˆï¼ˆè©³ç´°ãƒ¢ãƒ¼ãƒ‰ï¼‰</h3>
        <div class="form-grid">
          <div><label>ç·é«˜ã• H(m)</label><input id="st_h" type="number" value="0.60" step="0.05"></div>
          <div><label>å¹… W(m)</label><input id="st_w" type="number" value="1.80"></div>
          <div><label>è¸é¢ T(mm)</label><input id="st_t" type="number" value="300"></div>
          <div><label>è¹´ä¸Š R(mm)</label><input id="st_r" type="number" value="150"></div>
        </div>
        <details class="advanced-settings" open>
          <summary>â–¼ ä¸‹åœ°ãƒ»ãƒ–ãƒ­ãƒƒã‚¯è©³ç´°è¨­å®š</summary>
          <div class="details-content form-grid">
            <div><label>å´é¢ä»•ä¸Šã’ï¼ˆã•ã•ã‚‰ï¼‰</label><select id="st_side"><option value="2">ä¸¡å´ (ç‹¬ç«‹)</option><option value="1">ç‰‡å´ã®ã¿</option><option value="0">ãªã— (å£é–“)</option></select></div>
            <div><label>ä¸­è©°ã‚³ãƒ³ã‚¯ãƒªåš(mm)</label><input id="st_conc_th" type="number" value="100"></div>
            <div><label>ä¸­è©°ç •çŸ³åš(mm)</label><input id="st_sub_th" type="number" value="100"></div>
            <div><label>è¹´ä¸Šãƒ–ãƒ­ãƒƒã‚¯é•·(mm)</label><input id="st_blk_w" type="number" value="390"></div>
            <div><label>å´é¢ãƒ–ãƒ­ãƒƒã‚¯å¯¸æ³•</label><input id="st_side_dim" value="390x190x120"></div>
            <div><label>ãƒ–ãƒ­ãƒƒã‚¯ãƒ­ã‚¹(%)</label><input id="st_loss" type="number" value="5"></div>
          </div>
        </details>
        <div style="text-align:center; margin-top:15px;">
          <button class="btn-primary" onclick="calcStairDetail()" style="width:200px">è©³ç´°è¨ˆç®—ãƒ»å›³é¢æç”»</button>
        </div>
        <div id="stair_visual" class="result-box" style="display:none; text-align:center;"></div>
        <div id="stair_res" class="result-box" style="display:none;"></div>
        <div style="text-align:right; margin-top:10px;"><button class="btn-secondary" onclick="pushStair()">â†‘ é›†è¨ˆã«è¿½åŠ </button></div>
      </section>
    </div>

    <!-- 4. é‡‘ç‰© -->
    <div id="tab-metal" class="tab-pane">
      <h2>4. é‡‘ç‰©ãƒ»ãƒ•ã‚§ãƒ³ã‚¹ãƒ»å¤–å‘¨</h2>
      <section class="card">
        <h3>4a. ãƒ•ã‚§ãƒ³ã‚¹è©³ç´°</h3>
        <div class="table-wrap"><table id="tbl_fence"><thead><tr><th>åç§°</th><th>å»¶é•·/æŸ±æ•°</th><th>ä»•æ§˜</th><th>åŸºç¤</th><th>æ“ä½œ</th></tr></thead><tbody></tbody></table></div>
        <div class="form-grid" style="margin-top:10px;">
          <div><label>åç§°</label><input id="fn_name" placeholder="ãƒ¡ãƒƒã‚·ãƒ¥ãƒ•ã‚§ãƒ³ã‚¹"></div>
          <div><label>å»¶é•·(m)</label><input id="fn_len" type="number" value="10"></div>
          <div><label>ã‚³ãƒ¼ãƒŠãƒ¼æ•°</label><input id="fn_corner" type="number" value="0"></div>
          <div><label>åŸºç¤</label><select id="fn_base"><option value="block">ãƒ–ãƒ­ãƒƒã‚¯ç©´</option><option value="indep">ç‹¬ç«‹åŸºç¤</option></select></div>
        </div>
        <details class="advanced-settings">
          <summary>â–¼ ãƒ•ã‚§ãƒ³ã‚¹è£½å“ä»•æ§˜</summary>
          <div class="details-content form-grid">
            <div><label>æœ¬ä½“ãƒ‘ãƒãƒ«é•·(m)</label><input id="fn_panel_len" type="number" value="2.0"></div>
            <div><label>æ”¯æŸ±ãƒ”ãƒƒãƒ(m)</label><input id="fn_pitch" type="number" value="2.0"></div>
            <div><label>ç‹¬ç«‹åŸºç¤ã‚µã‚¤ã‚º</label><input id="fn_indep_size" value="180x180x450"></div>
          </div>
        </details>
        <div style="margin-top:10px;"><button class="btn-primary" onclick="addFence()">ãƒ•ã‚§ãƒ³ã‚¹è¿½åŠ </button></div>
      </section>

      <section class="card">
        <h3>4b. ãã®ä»–é‡‘ç‰©ãƒ»è¦‹åˆ‡ã‚Š</h3>
        <div class="table-wrap"><table id="tbl_metal"><thead><tr><th>åç§°</th><th>æ•°é‡</th><th>åŸºç¤/å¯¸æ³•</th><th>æ“ä½œ</th></tr></thead><tbody></tbody></table></div>
        <div class="form-grid" style="margin-top:10px;">
          <div><label>åç§°</label><input id="mt_name" placeholder="ã‚«ãƒ¼ãƒãƒ¼ãƒˆ"></div>
          <div><label>ç¨®é¡</label><select id="mt_type"><option value="carport">é‡‘ç‰©(åŸºç¤ã‚ã‚Š)</option><option value="edge">è¦‹åˆ‡ã‚Š(mç‰©)</option></select></div>
          <div id="mt_grp_base"><label>æŸ±æœ¬æ•°</label><input id="mt_count" type="number" value="2"></div>
          <div id="mt_grp_len" style="display:none;"><label>å»¶é•·(m)</label><input id="mt_len" type="number" value="10"></div>
        </div>
        <details class="advanced-settings" open>
          <summary>â–¼ åŸºç¤å¯¸æ³•ãƒ»éƒ¨æå¯¸æ³•</summary>
          <div class="details-content form-grid">
            <div><label>åŸºç¤ W(mm)</label><input id="mt_w" type="number" value="400"></div>
            <div><label>åŸºç¤ D(mm)</label><input id="mt_d" type="number" value="400"></div>
            <div><label>åŸºç¤ H(m)</label><input id="mt_h" type="number" value="0.6"></div>
            <div><label>è¦‹åˆ‡æé•·ã•(m)</label><input id="mt_unit_len" type="number" value="0.6"></div>
          </div>
        </details>
        <div style="margin-top:10px;"><button class="btn-primary" onclick="addMetal()">è¿½åŠ </button></div>
      </section>
    </div>

    <!-- 5. Tracer (ä¿®æ­£ç‰ˆ) -->
    <div id="tab-tracer" class="tab-pane">
      <h2>âœï¸ å›³é¢è¨ˆæ¸¬ãƒ»ç©ç®— (CAD Tracer)</h2>
      <div class="hint">
        <strong>å³ã‚¯ãƒªãƒƒã‚¯</strong>: å®Œäº†/ã‚­ãƒ£ãƒ³ã‚»ãƒ« | <strong>ãƒ›ã‚¤ãƒ¼ãƒ«</strong>: æ‹¡å¤§ç¸®å° | <strong>ãƒ‰ãƒ©ãƒƒã‚°(ä¸­/Shift)</strong>: ç§»å‹•<br>
        1. ç”»åƒèª­è¾¼ â†’ 2.ã€ŒğŸ“ç¸®å°ºã€ã§2ç‚¹ã‚¯ãƒªãƒƒã‚¯ â†’ å…¥åŠ›ç”»é¢ â†’ 3. è¨ˆæ¸¬ãƒ„ãƒ¼ãƒ«ã§æç”»
      </div>
      <div class="card">
        <div class="tracer-toolbar">
          <input type="file" id="imgLoader" accept="image/*" style="width:150px;">
          <button class="tool-btn" id="btnScale" onclick="setTraceTool('scale')">ğŸ“ ç¸®å°ºè¨­å®š</button>
          <span id="scaleStatus" style="font-size:11px; color:#c05621; font-weight:bold;">æœªè¨­å®š</span>
          <button class="tool-btn" id="btnArea" onclick="setTraceTool('area')">ğŸ“ é¢ç©</button>
          <button class="tool-btn" id="btnDist" onclick="setTraceTool('dist')">ğŸ“ è·é›¢</button>
          <button class="tool-btn" onclick="clearTrace()">ğŸ—‘ ã‚¯ãƒªã‚¢</button>
        </div>
        <div class="tracer-wrapper" id="tracerWrapper">
          <canvas id="tracerCanvas"></canvas>
          <div id="floatStatus" class="float-status" style="display:none;">ã‚¬ã‚¤ãƒ‰</div>
        </div>
        <div class="form-grid" style="margin-top:10px; align-items:center;">
           <div style="font-size:14px;">çµæœ: <strong id="resVal">0.00</strong> <span id="resUnit"></span></div>
           <div><input id="tr_name" placeholder="åç§°"><button class="btn-primary" onclick="addTrace()">ãƒªã‚¹ãƒˆè¿½åŠ </button></div>
        </div>
      </div>
      <div class="table-wrap"><table id="tbl_tracer"><thead><tr><th>åç§°</th><th>å€¤</th><th>æ“ä½œ</th></tr></thead><tbody></tbody></table></div>
    </div>

    <!-- 6. Summary -->
    <div id="tab-summary" class="tab-pane">
      <h2>ğŸ“Š è¦‹ç©ãƒ»å®Ÿè¡Œäºˆç®—é›†è¨ˆ</h2>
      <div class="card">
        <h3>1. ã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆãƒ»ãƒ¢ãƒ«ã‚¿ãƒ«ãƒ»ç •çŸ³</h3>
        <table class="table-wrap"><tbody id="sum_mat_body"></tbody></table>
        <h3>2. æ®‹åœŸå‡¦åˆ†</h3>
        <div id="sum_earth_box" class="result-box"></div>
        <h3>3. ãƒ–ãƒ­ãƒƒã‚¯ãƒ»è³‡æè©³ç´°</h3>
        <div id="sum_item_box" class="result-box"></div>
      </div>
    </div>

  </main>
</div>

<script>
const App = {
  data: { earth:[], blocks:[], pave:[], stairs:[], fences:[], metals:[], tracer:[] },
  stairCache: null,
  tracer: { 
    ctx:null, canvas:null, img:null, mode:'none', 
    points:[], tempPoint:null, // è«–ç†åº§æ¨™
    scalePxPerMeter:0, 
    scale:1.0, panX:0, panY:0, isPanning:false, startX:0, startY:0 
  }
};
const $ = id => document.getElementById(id);
const toNum = v => parseFloat(v)||0;
const fmt = (v,d=2) => v.toFixed(d);

function switchTab(id){
  document.querySelectorAll('.tab-pane').forEach(e=>e.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active'));
  $(id).classList.add('active');
  if(id==='tab-summary') calcSummary();
  if(id==='tab-tracer') {
    // Initial setup for tracer tab
    initTracer();
    // Force canvas resize and initial text
    if (!App.tracer.img) {
      const wrap = $('tracerWrapper');
      const cvs = $('tracerCanvas');
      cvs.width = wrap.clientWidth;
      cvs.height = wrap.clientHeight;
      const ctx = cvs.getContext('2d');
      ctx.fillStyle = '#aaa';
      ctx.font = '16px sans-serif';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText('ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦å›³é¢ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„', cvs.width/2, cvs.height/2);
    }
  }
}

// --- 1. Earth ---
function toggleEarthType(){
  const t = $('ea_type').value;
  $('ea_grp_line').style.display = t==='line'?'block':'none';
  $('ea_grp_area').style.display = t==='area'?'block':'none';
}
function calcSite(){
  const raw = $('levels').value.split(/\n/).map(Number).filter(n=>!isNaN(n));
  if(!raw.length)return;
  const avg = raw.reduce((a,b)=>a+b,0)/raw.length;
  const diff = avg - toNum($('designGL').value);
  const vol = toNum($('siteArea').value)*Math.abs(diff);
  $('res_site').style.display='block';
  $('res_site').innerHTML = `å¹³å‡:${fmt(avg,3)}m, å·®:${fmt(diff,3)}m, <strong>${diff>=0?'æ®‹åœŸ':'å®¢åœŸ'}: ${fmt(vol,3)}mÂ³</strong>`;
}
function addEarth(){
  const t = $('ea_type').value;
  const vol = t==='line' ? toNum($('ea_L').value)*(toNum($('ea_W').value)/1000)*toNum($('ea_D').value) : toNum($('ea_A').value)*toNum($('ea_D').value);
  App.data.earth.push({
    name:$('ea_name').value||'åœŸå·¥', type:t, vol, D:toNum($('ea_D').value),
    desc: t==='line' ? `L${$('ea_L').value}xW${$('ea_W').value}` : `A${$('ea_A').value}`,
    bulking: toNum($('ea_bulking').value), loss: toNum($('ea_loss').value), density: toNum($('ea_density').value)
  });
  renderTbl('tbl_earth', App.data.earth, (r,i)=>`<td>${r.name}</td><td>${r.desc}</td><td>${r.D}m</td><td>${fmt(r.vol,3)}</td>`, 'earth');
}

// --- Block ---
function addBlock(){
  const L = toNum($('bk_len').value);
  const steps = toNum($('bk_steps').value);
  const rebar_v_pitch = toNum($('bk_rebar_v').value)/1000;
  const v_count = Math.ceil(L/rebar_v_pitch)+1;
  const rebar_len = (v_count * (steps*0.2 + 0.6)) + (L * Math.ceil(steps/toNum($('bk_rebar_h').value)));
  const base_vol = L * (toNum($('bk_base_w').value)/1000) * (toNum($('bk_base_t').value)/1000);
  const unit_len = 0.4;
  const count = Math.ceil((L/unit_len)*steps * (1+toNum($('bk_loss').value)/100));

  App.data.blocks.push({
    name:$('bk_name').value||'CB', L, steps, count, base_vol, rebar_len, 
    corners: toNum($('bk_corner').value), form: toNum($('bk_form_h').value)*L*2,
    kasagi: $('bk_kasagi').value, size: $('bk_size').value
  });
  renderTbl('tbl_block', App.data.blocks, (r,i)=>`<td>${r.name}</td><td>${r.L}m/${r.steps}æ®µ</td><td>${fmt(r.base_vol,2)}mÂ³</td><td>ç­‹${fmt(r.rebar_len,1)}m/å‹${fmt(r.form,1)}m</td><td>${r.kasagi}</td>`, 'blocks');
}

// --- Pave ---
function togglePaveFields(){
  const t = $('pv_type').value;
  $('pv_det_conc').style.display = t==='conc'?'block':'none';
  $('pv_det_tile').style.display = t==='tile'?'block':'none';
}
function addPave(){
  const t = $('pv_type').value;
  const area = toNum($('pv_area').value);
  const loss = (t==='conc'? toNum($('pv_loss').value) : toNum($('pv_tile_loss').value))/100;
  let conc=0, sub=0, mesh=0, form=0, tile=0, mortar=0;
  const th = toNum($('pv_th').value)/1000;
  const sub_th = toNum($('pv_sub_th').value)/1000;

  if(t==='conc'){
    const add_th = (toNum($('pv_L').value) * toNum($('pv_slope').value)/100) / 2;
    conc = area * (th + add_th) * (1+loss);
    sub = area * sub_th * 1.1; 
    form = toNum($('pv_form').value);
    if($('pv_mesh').value==='yes') mesh = area * 1.15;
  } else if(t==='tile'){
    const base_conc = toNum($('pv_base_conc').value)/1000;
    conc = area * base_conc * 1.05;
    sub = area * sub_th * 1.1;
    mortar = area * 0.025 * 1.05;
    const dims = $('pv_tile_size').value.split(/[^0-9]/).map(Number);
    const one_area = (dims[0]*dims[1])/1000000;
    if(one_area>0) tile = Math.ceil(area/one_area * (1+loss));
  } else {
    sub = area * sub_th * 1.1;
  }
  App.data.pave.push({
    name:$('pv_name').value||'èˆ—è£…', type:t, area, conc, sub, mesh, form, tile, mortar,
    desc: t==='conc' ? `t=${fmt(th*1000)}` : `${tile}æš`
  });
  renderTbl('tbl_pave', App.data.pave, (r,i)=>`<td>${r.name}</td><td>${r.area}</td><td>${r.type}</td><td>${r.desc}</td><td>${r.mesh>0?'Mæœ‰':''}</td>`, 'pave');
}

// --- Stair ---
function calcStairDetail(){
  const H = toNum($('st_h').value), W = toNum($('st_w').value);
  const T = toNum($('st_t').value)/1000, R = toNum($('st_r').value)/1000;
  if(H<=0) return;
  const steps = Math.ceil(H/R);
  const L = steps * T;
  const blkW = toNum($('st_blk_w').value)/1000;
  const sideW = toNum($('st_side_dim').value.split('x')[0])/1000 || 0.4;
  const sideMode = parseInt($('st_side').value);
  const loss = 1 + toNum($('st_loss').value)/100;
  const kickBlk = Math.ceil(steps * (W/blkW) * loss);
  const sideArea = (L*H)/2;
  const blkArea = sideW * 0.2; 
  const sideBlk = sideMode * Math.ceil(sideArea/blkArea * loss);
  const volTotal = (H*L*W)/2;
  const concTh = toNum($('st_conc_th').value)/1000;
  const surfArea = (L+H)*W;
  const volConc = Math.min(volTotal, surfArea * concTh);
  const volSub = Math.max(0, volTotal - volConc);
  App.stairCache = { H, steps, kickBlk, sideBlk, volConc, volSub, totalBlk: kickBlk+sideBlk };
  $('stair_visual').style.display='block';
  $('stair_visual').innerHTML = `<svg viewBox="0 0 100 60" style="background:#eee;width:100px;"><path d="M10,50 L90,50 L90,10 Z" fill="#ccc"/></svg>`;
  $('stair_res').style.display='block';
  $('stair_res').innerHTML = `<strong>${steps}æ®µ</strong>, ãƒ–ãƒ­ãƒƒã‚¯è¨ˆ:<strong>${App.stairCache.totalBlk}æœ¬</strong><br>ä¸­è©°ã‚³ãƒ³:${fmt(volConc,3)}mÂ³, ç •çŸ³:${fmt(volSub,3)}mÂ³`;
}
function pushStair(){
  if(!App.stairCache) return;
  App.data.stairs.push(App.stairCache);
  alert('è¿½åŠ ã—ã¾ã—ãŸ');
}

// --- Metal ---
$('mt_type').addEventListener('change', ()=>{
  const isEdge = $('mt_type').value === 'edge';
  $('mt_grp_base').style.display = isEdge?'none':'block';
  $('mt_grp_len').style.display = isEdge?'block':'none';
});
function addFence(){
  const len = toNum($('fn_len').value);
  const pitch = toNum($('fn_pitch').value);
  const panelLen = toNum($('fn_panel_len').value);
  const posts = Math.ceil(len/pitch) + 1 + toNum($('fn_corner').value);
  const panels = Math.ceil(len/panelLen);
  const baseType = $('fn_base').value;
  const conc = baseType==='indep' ? posts * (0.18*0.18*0.45) : posts * 0.005; 
  App.data.fences.push({ name:$('fn_name').value, len, posts, panels, conc, baseType });
  renderTbl('tbl_fence', App.data.fences, (r,i)=>`<td>${r.name}</td><td>${r.len}m/${r.posts}æœ¬</td><td>æ¿${r.panels}æš</td><td>${r.baseType}</td>`, 'fences');
}
function addMetal(){
  const type = $('mt_type').value;
  if(type==='carport'){
    const cnt = toNum($('mt_count').value);
    const vol = (toNum($('mt_w').value)/1000)*(toNum($('mt_d').value)/1000)*toNum($('mt_h').value)*cnt;
    App.data.metals.push({ name:$('mt_name').value, count:cnt, vol, desc:'åŸºç¤ã‚ã‚Š' });
  } else {
    const len = toNum($('mt_len').value);
    const unit = toNum($('mt_unit_len').value);
    const count = Math.ceil(len/unit);
    App.data.metals.push({ name:$('mt_name').value, count, vol:0, desc:`${len}m(${count}æœ¬)` });
  }
  renderTbl('tbl_metal', App.data.metals, (r,i)=>`<td>${r.name}</td><td>${r.count}</td><td>${r.desc}</td>`, 'metals');
}

// --- Tracer (Fixed) ---
function initTracer(){
  const cvs = $('tracerCanvas');
  if(App.tracer.ctx) return; 
  App.tracer.canvas = cvs;
  App.tracer.ctx = cvs.getContext('2d');
  
  // Prevent context menu
  cvs.addEventListener('contextmenu', e => e.preventDefault());

  // Listeners
  cvs.addEventListener('mousedown', onTraceDown);
  cvs.addEventListener('mousemove', onTraceMove);
  cvs.addEventListener('mouseup', onTraceUp);
  cvs.addEventListener('wheel', onTraceWheel, {passive:false});
  
  $('imgLoader').addEventListener('change', function(e){
      if (!e.target.files || !e.target.files[0]) return;
      const reader = new FileReader();
      reader.onload = function(evt){
          const img = new Image();
          img.onload = function(){
              App.tracer.img = img;
              App.tracer.panX = 0; App.tracer.panY = 0; App.tracer.scale = 1.0;
              const wrap = $('tracerWrapper');
              cvs.width = wrap.clientWidth; 
              cvs.height = wrap.clientHeight;
              const scaleW = cvs.width / img.width;
              const scaleH = cvs.height / img.height;
              App.tracer.scale = Math.min(scaleW, scaleH);
              drawTrace();
          }
          img.src = evt.target.result;
      }
      reader.readAsDataURL(e.target.files[0]);
  });
}

function getLogicPos(e){
  const r = App.tracer.canvas.getBoundingClientRect();
  return {
    x: (e.clientX - r.left - App.tracer.panX) / App.tracer.scale,
    y: (e.clientY - r.top - App.tracer.panY) / App.tracer.scale
  };
}

function onTraceDown(e){
  const t = App.tracer;
  
  // Right -> Finish
  if(e.button===2){
    if(t.mode==='area') finishTracePoly();
    else if(t.mode==='dist') calcTraceDist();
    return;
  }
  
  // Middle or Shift+Left -> Pan
  if(e.button===1 || (e.button===0 && e.shiftKey)){
    t.isPanning=true; t.startX=e.clientX; t.startY=e.clientY;
    return;
  }
  
  // Left -> Draw
  if(e.button===0 && t.mode!=='none'){
    const p = getLogicPos(e);
    t.points.push(p);
    
    // Scale Logic: Use setTimeout to ensure prompt appears after click handling
    if(t.mode==='scale' && t.points.length===2){
      $('floatStatus').innerText = "è·é›¢ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„...";
      setTimeout(() => {
        const d = Math.hypot(t.points[1].x - t.points[0].x, t.points[1].y - t.points[0].y);
        const mStr = prompt("ã“ã®åŒºé–“ã¯ä½•ãƒ¡ãƒ¼ãƒˆãƒ«ã§ã™ã‹ï¼Ÿ", "2.0");
        const m = parseFloat(mStr);
        if(m>0){
          t.scalePxPerMeter = d/m;
          $('scaleStatus').innerText = `1m=${fmt(t.scalePxPerMeter,1)}px`;
          alert('ç¸®å°ºã‚’è¨­å®šã—ã¾ã—ãŸã€‚ãƒ„ãƒ¼ãƒ«ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚');
        } else {
          alert('ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦è¨­å®šã—ã¦ãã ã•ã„ã€‚');
        }
        t.points=[]; t.mode='none'; $('floatStatus').style.display='none';
        document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
        drawTrace();
      }, 50); // slight delay
    }
    
    // Auto Update Dist
    if(t.mode==='dist') calcTraceDist();
    
    // Guide update
    if(t.mode==='area') $('floatStatus').innerText = `ç¾åœ¨ ${t.points.length}ç‚¹ (å³ã‚¯ãƒªãƒƒã‚¯ã§å®Œäº†)`;
    
    drawTrace();
  }
}

function onTraceMove(e){
  const t = App.tracer;
  if(t.isPanning){
    t.panX += e.clientX - t.startX;
    t.panY += e.clientY - t.startY;
    t.startX = e.clientX; t.startY = e.clientY;
    drawTrace(); return;
  }
  if(t.mode!=='none'){
    t.tempPoint = getLogicPos(e);
    drawTrace();
  }
}

function onTraceUp(e){ App.tracer.isPanning=false; }

function onTraceWheel(e){
  e.preventDefault();
  const t = App.tracer;
  const zoom = e.deltaY<0 ? 1.1 : 0.9;
  const rect = t.canvas.getBoundingClientRect();
  const mx = e.clientX - rect.left; 
  const my = e.clientY - rect.top;
  const lx = (mx - t.panX)/t.scale;
  const ly = (my - t.panY)/t.scale;
  t.scale *= zoom;
  t.panX = mx - lx*t.scale;
  t.panY = my - ly*t.scale;
  drawTrace();
}

function drawTrace(){
  const t = App.tracer;
  const ctx = t.ctx;
  ctx.clearRect(0,0,t.canvas.width,t.canvas.height);
  ctx.save();
  ctx.translate(t.panX, t.panY);
  ctx.scale(t.scale, t.scale);
  if(t.img) ctx.drawImage(t.img,0,0);
  
  if(t.points.length>0){
    ctx.strokeStyle = 'red'; ctx.lineWidth = 2/t.scale;
    ctx.beginPath();
    ctx.moveTo(t.points[0].x, t.points[0].y);
    t.points.forEach(p=>ctx.lineTo(p.x,p.y));
    
    if(t.tempPoint && t.mode!=='none'){
      ctx.lineTo(t.tempPoint.x, t.tempPoint.y);
      if(t.mode==='area') ctx.closePath();
    }
    ctx.stroke();
    if(t.mode==='area' && t.points.length>0){
      ctx.fillStyle = 'rgba(255,0,0,0.2)';
      ctx.fill();
    }
  }
  ctx.restore();
}

function setTraceTool(m){ 
  App.tracer.mode=m; App.tracer.points=[]; 
  $('floatStatus').innerText = m==='scale'?'2ç‚¹ã‚¯ãƒªãƒƒã‚¯':(m==='area'?'é ‚ç‚¹ã‚¯ãƒªãƒƒã‚¯(å³å®Œäº†)':'ç‚¹ã‚¯ãƒªãƒƒã‚¯(å³å®Œäº†)');
  $('floatStatus').style.display='block';
  // UI update
  document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
  if(m==='scale') $('btnScale').classList.add('active');
  if(m==='area') $('btnArea').classList.add('active');
  if(m==='dist') $('btnDist').classList.add('active');
  drawTrace();
}

function finishTracePoly(){
  if(App.tracer.scalePxPerMeter===0){ alert('ã€ã‚¨ãƒ©ãƒ¼ã€‘ç¸®å°ºãŒæœªè¨­å®šã§ã™ã€‚\nå…ˆã«ã€ŒğŸ“ ç¸®å°ºã€ãƒœã‚¿ãƒ³ã§å›³é¢ã®å¯¸æ³•ã‚’æ•™ãˆã¦ãã ã•ã„ã€‚'); return; }
  if(App.tracer.points.length < 3) return; // Need at least 3 points
  
  let val=0;
  const pts=App.tracer.points;
  for(let i=0;i<pts.length;i++){ let j=(i+1)%pts.length; val += pts[i].x*pts[j].y - pts[j].x*pts[i].y; }
  val = Math.abs(val)/2 / (App.tracer.scalePxPerMeter**2);
  $('resVal').innerText = fmt(val,2); $('resUnit').innerText='mÂ²';
  
  // Perimeter calc
  let perim = 0;
  for(let i=0;i<pts.length;i++){ let j=(i+1)%pts.length; perim += Math.hypot(pts[i].x-pts[j].x, pts[i].y-pts[j].y); }
  perim /= App.tracer.scalePxPerMeter;
  $('resUnit').innerText += ` (å‘¨é•· ${fmt(perim,2)}m)`;
  
  App.tracer.points=[]; drawTrace();
  $('floatStatus').innerText = "è¨ˆç®—å®Œäº†ã€‚ãƒªã‚¹ãƒˆã«è¿½åŠ ã§ãã¾ã™ã€‚";
}

function calcTraceDist(){
  if(App.tracer.scalePxPerMeter===0) return;
  let val=0;
  const pts=App.tracer.points;
  for(let i=0;i<pts.length-1;i++) val+=Math.hypot(pts[i+1].x-pts[i].x, pts[i+1].y-pts[i].y);
  val /= App.tracer.scalePxPerMeter;
  $('resVal').innerText = fmt(val,2); $('resUnit').innerText='m';
}

function clearTrace(){ App.tracer.points=[]; drawTrace(); $('floatStatus').style.display='none'; }
function addTrace(){
  App.data.tracer.push({name:$('tr_name').value, val:$('resVal').innerText, unit:$('resUnit').innerText});
  renderTbl('tbl_tracer', App.data.tracer, (r,i)=>`<td>${r.name}</td><td>${r.val}${r.unit}</td>`, 'tracer');
}

// --- Common ---
function renderTbl(id, arr, rowHtml, key){
  const tb = $(id).querySelector('tbody'); 
  tb.innerHTML = '';
  arr.forEach((r,i) => {
    const delBtn = `<button class="btn-danger btn-sm" onclick="window.delRow('${key}', ${i})">Ã—</button>`;
    tb.innerHTML += `<tr>${rowHtml(r,i)}<td>${delBtn}</td></tr>`;
  });
}

window.delRow = function(key, index) {
  if (!App.data[key]) return;
  App.data[key].splice(index, 1);
  if(key === 'earth') renderTbl('tbl_earth', App.data.earth, (r,i)=>`<td>${r.name}</td><td>${r.desc}</td><td>${r.D}m</td><td>${fmt(r.vol,3)}</td>`, 'earth');
  else if(key === 'blocks') renderTbl('tbl_block', App.data.blocks, (r,i)=>`<td>${r.name}</td><td>${r.L}m/${r.steps}æ®µ</td><td>${fmt(r.base_vol,2)}mÂ³</td><td>ç­‹${fmt(r.rebar_len,1)}m/å‹${fmt(r.form,1)}m</td><td>${r.kasagi}</td>`, 'blocks');
  else if(key === 'pave') renderTbl('tbl_pave', App.data.pave, (r,i)=>`<td>${r.name}</td><td>${r.area}</td><td>${r.type}</td><td>${r.desc}</td><td>${r.mesh>0?'Mæœ‰':''}</td>`, 'pave');
  else if(key === 'fences') renderTbl('tbl_fence', App.data.fences, (r,i)=>`<td>${r.name}</td><td>${r.len}m/${r.posts}æœ¬</td><td>æ¿${r.panels}æš</td><td>${r.baseType}</td>`, 'fences');
  else if(key === 'metals') renderTbl('tbl_metal', App.data.metals, (r,i)=>`<td>${r.name}</td><td>${r.count}</td><td>${r.desc}</td>`, 'metals');
  else if(key === 'tracer') renderTbl('tbl_tracer', App.data.tracer, (r,i)=>`<td>${r.name}</td><td>${r.val}${r.unit}</td>`, 'tracer');
};

function calcSummary(){
  let c=0, m=0, s=0, soil=0;
  App.data.earth.forEach(e=>{ soil += e.vol * (e.bulking||1.2) * (1+(e.loss||5)/100); });
  App.data.blocks.forEach(b=>{ c+=b.base_vol; m+=b.count*0.002; });
  App.data.pave.forEach(p=>{ c+=p.conc; m+=p.mortar; s+=p.sub; });
  App.data.stairs.forEach(st=>{ c+=st.volConc; s+=st.volSub; });
  App.data.fences.forEach(f=>{ c+=f.conc; });
  App.data.metals.forEach(mt=>{ c+=mt.vol; });

  $('sum_mat_body').innerHTML = `<tr><td>ã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆ</td><td>${fmt(c,3)} mÂ³</td></tr><tr><td>ãƒ¢ãƒ«ã‚¿ãƒ«</td><td>${fmt(m,3)} mÂ³</td></tr><tr><td>ç •çŸ³ (RC-40)</td><td>${fmt(s,3)} mÂ³</td></tr>`;
  $('sum_earth_box').innerHTML = `æ¬å‡ºåœŸé‡: <strong>${fmt(soil,3)} mÂ³</strong> (è†¨å¼µãƒ»ãƒ­ã‚¹è¾¼)`;
  
  let items = [];
  const blk = App.data.blocks.reduce((a,b)=>a+b.count,0) + App.data.stairs.reduce((a,b)=>a+b.totalBlk,0);
  if(blk) items.push(`CBãƒ–ãƒ­ãƒƒã‚¯åˆè¨ˆ: ${blk} æœ¬`);
  const rebar = App.data.blocks.reduce((a,b)=>a+b.rebar_len,0);
  if(rebar) items.push(`é‰„ç­‹ç·å»¶é•·: ${fmt(rebar,1)} m`);
  const mesh = App.data.pave.reduce((a,b)=>a+b.mesh,0);
  if(mesh) items.push(`ãƒ¯ã‚¤ãƒ¤ãƒ¼ãƒ¡ãƒƒã‚·ãƒ¥: ${fmt(mesh,1)} mÂ²`);
  
  $('sum_item_box').innerHTML = items.join('<br>');
}

function saveData(){ localStorage.setItem('ExCalcV4', JSON.stringify(App.data)); alert('ä¿å­˜'); }
function clearData(){ if(confirm('å‰Šé™¤?')){ localStorage.removeItem('ExCalcV4'); location.reload(); } }

window.onload = () => { 
  const d = localStorage.getItem('ExCalcV4'); 
  if(d) { try { App.data = JSON.parse(d); } catch(e){} }
  // Initial render calls skipped for brevity, typically would re-render tables here
  switchTab('tab-base'); 
};
</script>
</body>
</html>

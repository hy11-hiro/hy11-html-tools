<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å£²ä¸Šãƒ‡ãƒ¼ã‚¿ãƒã‚§ãƒƒã‚¯ãƒ»é›†è¨ˆãƒ„ãƒ¼ãƒ« (Ver 3.2)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <!-- Excelå‡ºåŠ›ç”¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª (SheetJS) -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        body { background-color: #f8f9fa; font-family: "Yu Gothic UI", sans-serif; font-size: 0.9rem; overflow-x: hidden; }
        .container-fluid { max-width: 100%; padding: 20px; }
        
        .card { box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: none; margin-bottom: 20px; }
        .card-header { font-weight: bold; background-color: #e9ecef; }
        
        .drop-area {
            border: 3px dashed #ced4da; border-radius: 10px; background-color: #fff;
            color: #6c757d; transition: all 0.3s; cursor: pointer; padding: 30px 10px;
            text-align: center;
        }
        .drop-area:hover, .drop-area.dragover {
            border-color: #0d6efd; background-color: #f1f8ff; color: #0d6efd;
        }

        .table-responsive { 
            max-height: 60vh; 
            overflow-y: auto; 
            border: 1px solid #dee2e6;
        }
        .data-table th { 
            position: sticky; top: 0; z-index: 10; 
            background-color: #f1f3f5; white-space: nowrap; vertical-align: middle;
            font-size: 0.85rem; padding: 8px;
        }
        .data-table td { 
            vertical-align: middle; white-space: nowrap; padding: 4px 8px; font-size: 0.9rem;
        }

        .col-filename {
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .col-key { background-color: #e7f5ff; font-weight: bold; }
        .col-master { background-color: #fff3cd; }
        .col-err { background-color: #ffe6e6; color: #dc3545; }
        
        .row-duplicate { background-color: #fff5f5 !important; color: #d63384; }
        
        /* ä¿®æ­£ç®‡æ‰€: ã‚¸ãƒ£ãƒ³ãƒ—æ™‚ã®å¼·èª¿è¡¨ç¤º (èµ¤æ ) */
        /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®šç¾©: ç‚¹æ»…ã•ã›ã¤ã¤è¡¨ç¤º */
        @keyframes borderPulse {
            0% { outline-color: red; background-color: rgba(255, 0, 0, 0.1); }
            50% { outline-color: #ff5555; background-color: rgba(255, 0, 0, 0.05); }
            100% { outline-color: red; background-color: rgba(255, 0, 0, 0.1); }
        }

        .highlight-row {
            /* Bootstrapã®ã‚¹ã‚¿ã‚¤ãƒ«ã«å‹ã¤ãŸã‚ã« !important ã‚’ä½¿ç”¨ */
            outline: 4px solid red !important;
            outline-offset: -4px; /* æ ã®å†…å´ã«æç”» */
            background-color: rgba(255, 0, 0, 0.1) !important; /* è–„ã„èµ¤èƒŒæ™¯ã‚‚è¿½åŠ  */
            position: relative;
            z-index: 50; /* ä»–ã®è¡Œã‚ˆã‚Šæ‰‹å‰ã«è¡¨ç¤º */
            
            /* 3ç§’é–“ç‚¹æ»…ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
            animation: borderPulse 1s infinite;
        }
        
        .summary-table th { background-color: #343a40; color: #fff; }
        .total-row { background-color: #fff3cd; font-weight: bold; border-top: 2px solid #666; }

        .status-ok { color: #198754; font-weight: bold; }
        .status-ng { color: #dc3545; font-weight: bold; }
        .status-warn { color: #fd7e14; font-weight: bold; }
    </style>
</head>
<body>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0"><i class="bi bi-file-earmark-spreadsheet"></i> å£²ä¸Šãƒ‡ãƒ¼ã‚¿ãƒã‚§ãƒƒã‚¯ãƒ»é›†è¨ˆãƒ„ãƒ¼ãƒ« (Ver 3.2)</h4>
        <div class="d-flex gap-2">
            <button class="btn btn-success btn-sm" onclick="exportToExcel()"><i class="bi bi-file-earmark-excel"></i> Excelå‡ºåŠ›</button>
            <button class="btn btn-outline-danger btn-sm" onclick="clearAllData()">ğŸ—‘ï¸ å…¨ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢</button>
        </div>
    </div>

    <div class="row">
        <!-- å·¦å´ï¼šãƒ•ã‚¡ã‚¤ãƒ«å–è¾¼ã‚¨ãƒªã‚¢ -->
        <div class="col-md-3">
            <!-- 1. ç¾å ´ãƒã‚¹ã‚¿å–è¾¼ -->
            <div class="card mb-3">
                <div class="card-header bg-warning bg-opacity-10">
                    <i class="bi bi-database"></i> 1. ç¾å ´ãƒã‚¹ã‚¿å–è¾¼
                    <span id="masterStatus" class="float-end badge bg-secondary">æœªå–è¾¼</span>
                </div>
                <div class="card-body">
                    <div id="dropZoneMaster" class="drop-area py-3">
                        <div class="fs-4">ğŸ—ï¸</div>
                        <small>ç¾å ´ãƒã‚¹ã‚¿(txt)ã‚’<br>ã“ã“ã«ãƒ‰ãƒ­ãƒƒãƒ—</small>
                    </div>
                    <div class="mt-2 small text-muted">
                        â€»Aåˆ—:ã‚³ãƒ¼ãƒ‰, Båˆ—:ã‚µãƒ–, Cåˆ—:åç§°, Fåˆ—:æ­£å¼åç§°, AVåˆ—:æ–½å·¥ä¸», AXåˆ—:æ‹…å½“
                    </div>
                </div>
            </div>

            <!-- 2. å£²ä¸Šãƒ‡ãƒ¼ã‚¿å–è¾¼ -->
            <div class="card">
                <div class="card-header bg-primary bg-opacity-10">
                    <i class="bi bi-collection"></i> 2. å£²ä¸Šãƒ‡ãƒ¼ã‚¿å–è¾¼
                    <span id="dataStatus" class="float-end badge bg-secondary">0ä»¶</span>
                </div>
                <div class="card-body">
                    <div id="dropZoneData" class="drop-area py-4">
                        <div class="fs-1">ğŸ“„</div>
                        <div>å£²ä¸Šãƒ‡ãƒ¼ã‚¿(txt)ã‚’<br>ãƒ‰ãƒ­ãƒƒãƒ— (è¤‡æ•°å¯)</div>
                    </div>
                    <div class="alert alert-info py-2 mt-2 mb-0 small">
                        <i class="bi bi-info-circle"></i> ã€Œ01ã€ã¨ã€Œ1ã€ã¯åˆ¥æ‰±ã„<br>
                        <i class="bi bi-check-circle"></i> é‡è¤‡åˆ¤å®š: å·¥ç•ª+ã‚µãƒ–+ç¾å ´+é‡‘é¡
                    </div>
                    <div id="importLog" class="mt-2 small text-muted" style="max-height: 100px; overflow-y: auto;"></div>
                </div>
            </div>
        </div>

        <!-- å³å´ï¼šçµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div class="col-md-9">
            <ul class="nav nav-tabs" id="myTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="list-tab" data-bs-toggle="tab" data-bs-target="#list-pane" type="button"><i class="bi bi-table"></i> æ˜ç´°ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="cust-tab" data-bs-toggle="tab" data-bs-target="#cust-pane" type="button"><i class="bi bi-person-lines-fill"></i> å¾—æ„å…ˆåˆ¥é›†è¨ˆ</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="job-tab" data-bs-toggle="tab" data-bs-target="#job-pane" type="button"><i class="bi bi-buildings"></i> å·¥ç•ªåˆ¥é›†è¨ˆ</button>
                </li>
            </ul>

            <div class="tab-content pt-3" id="myTabContent">
                <!-- æ˜ç´°ãƒªã‚¹ãƒˆ -->
                <div class="tab-pane fade show active" id="list-pane">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <span class="badge bg-primary fs-6 me-2">åˆè¨ˆé‡‘é¡: <span id="totalAmountDisplay">0</span> å††</span>
                            <span class="badge bg-secondary me-2">ä»¶æ•°: <span id="totalCountDisplay">0</span> ä»¶</span>
                        </div>
                        <input type="text" class="form-control form-control-sm w-auto" id="searchInput" placeholder="ğŸ” å…¨æ–‡æ¤œç´¢..." onkeyup="filterTable()">
                    </div>
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover data-table" id="mainTable">
                            <thead>
                                <tr>
                                    <th>No</th>
                                    <th>ãƒ•ã‚¡ã‚¤ãƒ«å</th>
                                    <th>å®Œäº†æ—¥</th>
                                    <th>å¾—æ„å…ˆå</th>
                                    <th class="col-key">å·¥ç•ª</th>
                                    <th class="col-key">ã‚µãƒ–</th>
                                    <th class="col-master">ç¾å ´åç§° (ãƒã‚¹ã‚¿)</th>
                                    <th class="col-master">æ–½å·¥ä¸» (ãƒã‚¹ã‚¿)</th>
                                    <th class="col-master">æ‹…å½“è€… (ãƒã‚¹ã‚¿)</th>
                                    <th class="text-end">é‡‘é¡ (ç¨è¾¼)</th>
                                    <th>åˆ¤å®š</th>
                                </tr>
                            </thead>
                            <tbody id="mainTableBody">
                                <tr><td colspan="11" class="text-center text-muted py-5">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- å¾—æ„å…ˆåˆ¥é›†è¨ˆ -->
                <div class="tab-pane fade" id="cust-pane">
                    <div class="row">
                        <div class="col-md-8">
                            <table class="table table-sm table-striped summary-table">
                                <thead>
                                    <tr>
                                        <th>å¾—æ„å…ˆå</th>
                                        <th class="text-end">ä»¶æ•°</th>
                                        <th class="text-end">åˆè¨ˆé‡‘é¡</th>
                                    </tr>
                                </thead>
                                <tbody id="custTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- å·¥ç•ªåˆ¥é›†è¨ˆ -->
                <div class="tab-pane fade" id="job-pane">
                    <div class="row">
                        <div class="col-md-10">
                            <table class="table table-sm table-striped summary-table">
                                <thead>
                                    <tr>
                                        <th>å·¥ç•ª</th>
                                        <th>ã‚µãƒ–</th>
                                        <th>ç¾å ´åç§°</th>
                                        <th class="text-end">ä»¶æ•°</th>
                                        <th class="text-end">åˆè¨ˆé‡‘é¡</th>
                                    </tr>
                                </thead>
                                <tbody id="jobTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
/**
 * ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
 */
let M_GENBA = [];       // ç¾å ´ãƒã‚¹ã‚¿é…åˆ—
let IMPORTED_DATA = []; // å–è¾¼ãƒ‡ãƒ¼ã‚¿é…åˆ—
// é‡è¤‡ãƒã‚§ãƒƒã‚¯ç”¨ãƒãƒƒãƒ— (ã‚­ãƒ¼: "å·¥ç•ª_ã‚µãƒ–_ç¾å ´å_é‡‘é¡", å€¤: æœ€åˆã®è¡ŒNo)
let IMPORTED_HASHES = new Map(); 

// èµ·å‹•æ™‚å‡¦ç†
document.addEventListener('DOMContentLoaded', () => {
    setupDropZone('dropZoneMaster', handleMasterFile);
    setupDropZone('dropZoneData', handleDataFiles);
    
    // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ãƒã‚¹ã‚¿å¾©å…ƒ
    const savedMaster = localStorage.getItem('CHK_MST_GENBA_V2');
    if (savedMaster) {
        try {
            M_GENBA = JSON.parse(savedMaster);
            updateMasterStatus();
        } catch(e) { console.error(e); }
    }
});

function setupDropZone(id, handler) {
    const area = document.getElementById(id);
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        area.addEventListener(eventName, preventDefaults, false);
    });
    ['dragenter', 'dragover'].forEach(eventName => {
        area.addEventListener(eventName, () => area.classList.add('dragover'), false);
    });
    ['dragleave', 'drop'].forEach(eventName => {
        area.addEventListener(eventName, () => area.classList.remove('dragover'), false);
    });
    area.addEventListener('drop', handler, false);
}
function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }

function readFileAsText(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = e => reject(e);
        reader.readAsText(file, "Shift-JIS");
    });
}

/**
 * 1. ç¾å ´ãƒã‚¹ã‚¿å‡¦ç†
 */
async function handleMasterFile(e) {
    const files = e.dataTransfer.files;
    if (files.length === 0) return;
    
    try {
        const text = await readFileAsText(files[0]);
        const rows = text.split(/\r\n|\n|\r/);
        const newData = [];

        rows.forEach(line => {
            if (!line.trim()) return;
            let cols = line.split('\t');
            cols = cols.map(c => c.replace(/^"|"$/g, '').trim());

            if (cols.length < 3) return;

            const code = String(cols[0] || "");      // Aåˆ—
            const sub = String(cols[1] || "");       // Båˆ—
            const name = cols[2];      // Cåˆ—
            const fullName = cols[5] || ""; // Fåˆ—
            const client = cols[47] || ""; // AVåˆ—
            const staff = cols[49] || "";  // AXåˆ—

            if (code) {
                newData.push({
                    c: code,
                    s: sub,
                    n: name,
                    sn: fullName,
                    cl: client,
                    st: staff
                });
            }
        });

        M_GENBA = newData;
        localStorage.setItem('CHK_MST_GENBA_V2', JSON.stringify(M_GENBA));
        
        updateMasterStatus();
        alert(`ãƒã‚¹ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ (${newData.length}ä»¶)\nâ€»ã€Œ01ã€ç­‰ã¯æ–‡å­—åˆ—ã¨ã—ã¦ä¿æŒã•ã‚Œã¾ã™`);
        
        if(IMPORTED_DATA.length > 0) renderAll();

    } catch (err) {
        alert("ãƒã‚¹ã‚¿èª­è¾¼ã‚¨ãƒ©ãƒ¼: " + err.message);
    }
}

function updateMasterStatus() {
    const el = document.getElementById('masterStatus');
    if (M_GENBA.length > 0) {
        el.textContent = `OK (${M_GENBA.length}ä»¶)`;
        el.className = "float-end badge bg-success";
    } else {
        el.textContent = "æœªå–è¾¼";
        el.className = "float-end badge bg-secondary";
    }
}

/**
 * 2. å£²ä¸Šãƒ‡ãƒ¼ã‚¿å‡¦ç†
 */
async function handleDataFiles(e) {
    const files = e.dataTransfer.files;
    if (files.length === 0) return;
    
    const logEl = document.getElementById('importLog');
    let newCount = 0;
    let dupCount = 0;
    
    // ä»Šå›å–ã‚Šè¾¼ã‚€ãƒ‡ãƒ¼ã‚¿ã®é–‹å§‹No (ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿æ•° + 1)
    let currentNo = IMPORTED_DATA.length + 1;

    for (let i = 0; i < files.length; i++) {
        const file = files[i];
        try {
            const text = await readFileAsText(file);
            const lines = text.split(/\r\n|\n|\r/);
            
            let startIndex = 0;
            if (lines[0] && lines[0].includes("ä¼ç¥¨æ—¥ä»˜")) startIndex = 1;

            for (let j = startIndex; j < lines.length; j++) {
                const line = lines[j];
                if (!line.trim()) continue;

                // ãƒ‘ãƒ¼ã‚¹
                let cols = line.split('\t').map(c => c.replace(/^"|"$/g, '').trim());
                if (cols.length < 10) continue;

                const jobCode = String(cols[96] || "");
                const subCode = String(cols[97] || "");
                const amount = parseInt(cols[26]) || 0;
                
                // ãƒã‚¹ã‚¿æ¤œç´¢ï¼ˆç¾å ´åã‚’ã‚­ãƒ¼ã«å«ã‚ã‚‹ãŸã‚ï¼‰
                const m = findMaster(jobCode, subCode);
                const genbaName = m ? (m.displayName || m.n) : "";

                // é«˜åº¦ãªé‡è¤‡åˆ¤å®šã‚­ãƒ¼: å·¥ç•ª_ã‚µãƒ–_ç¾å ´å_é‡‘é¡
                const uniqueKey = `${jobCode}_${subCode}_${genbaName}_${amount}`;
                
                let isDuplicate = false;
                let duplicateWith = null;
                
                if (IMPORTED_HASHES.has(uniqueKey)) {
                    isDuplicate = true;
                    duplicateWith = IMPORTED_HASHES.get(uniqueKey); // é‡è¤‡å…ƒã®Noã‚’å–å¾—
                    dupCount++;
                } else {
                    IMPORTED_HASHES.set(uniqueKey, currentNo); // ç¾åœ¨ã®Noã‚’è¨˜éŒ²
                }

                const rowData = {
                    no: currentNo,
                    fileName: file.name,
                    compDate: cols[98] || "",
                    custName: cols[6] || "",
                    jobCode: jobCode,
                    subCode: subCode,
                    amount: amount,
                    isDuplicate: isDuplicate,
                    duplicateWith: duplicateWith,
                    rawLine: line.trim()
                };

                IMPORTED_DATA.push(rowData);
                newCount++;
                currentNo++;
            }
            logEl.innerHTML += `<div>âœ… ${file.name}: èª­è¾¼å®Œäº†</div>`;

        } catch (err) {
            logEl.innerHTML += `<div class="text-danger">âŒ ${file.name}: ã‚¨ãƒ©ãƒ¼ ${err.message}</div>`;
        }
    }

    if (dupCount > 0) {
        logEl.innerHTML += `<div class="text-warning fw-bold">âš ï¸ ${dupCount}ä»¶ã®é‡è¤‡ãƒ‡ãƒ¼ã‚¿ãŒå«ã¾ã‚Œã¦ã„ã¾ã™</div>`;
    }

    renderAll();
    logEl.scrollTop = logEl.scrollHeight;
}

function renderAll() {
    renderMainTable();
    renderSummaryTables();
    
    document.getElementById('dataStatus').textContent = `${IMPORTED_DATA.length}ä»¶`;
    const total = IMPORTED_DATA.reduce((sum, r) => sum + r.amount, 0);
    document.getElementById('totalAmountDisplay').textContent = total.toLocaleString();
    document.getElementById('totalCountDisplay').textContent = IMPORTED_DATA.length.toLocaleString();
}

/**
 * ãƒ¡ã‚¤ãƒ³ãƒ†ãƒ¼ãƒ–ãƒ«æç”»
 */
function renderMainTable() {
    const tbody = document.getElementById('mainTableBody');
    tbody.innerHTML = "";

    if (IMPORTED_DATA.length === 0) {
        tbody.innerHTML = '<tr><td colspan="11" class="text-center text-muted py-5">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„</td></tr>';
        return;
    }

    IMPORTED_DATA.forEach((row, index) => {
        const masterInfo = findMaster(row.jobCode, row.subCode);
        
        const tr = document.createElement('tr');
        tr.id = `row-${row.no}`; // è¡Œç§»å‹•ç”¨ID
        
        let statusHtml = '<span class="status-ok">OK</span>';
        let rowClass = "";
        
        if (row.isDuplicate) {
            // é‡è¤‡æ™‚ã®è¡¨ç¤ºå¤‰æ›´: é‡è¤‡(No.X) + ç¢ºèªãƒœã‚¿ãƒ³
            statusHtml = `
                <div class="d-flex align-items-center gap-1 justify-content-center">
                    <span class="status-warn small">é‡è¤‡(No.${row.duplicateWith})</span>
                    <button class="btn btn-sm btn-outline-primary py-0 px-1" style="font-size:0.75rem;" onclick="jumpToRow(${row.duplicateWith})">ç¢ºèª</button>
                </div>
            `;
            rowClass = "row-duplicate";
        } else if (!masterInfo) {
            statusHtml = '<span class="status-ng">ãƒã‚¹ã‚¿ãªã—</span>';
            rowClass = "table-warning";
        }

        tr.className = rowClass;
        const genbaName = masterInfo ? (masterInfo.displayName || masterInfo.n) : '(è©²å½“ãªã—)';

        tr.innerHTML = `
            <td>${row.no}</td>
            <td class="col-filename" title="${row.fileName}">${row.fileName}</td>
            <td>${formatDate(row.compDate)}</td>
            <td>${row.custName}</td>
            <td class="col-key fw-bold">${row.jobCode}</td>
            <td class="col-key fw-bold">${row.subCode}</td>
            <td class="col-master text-primary">${genbaName}</td>
            <td class="col-master">${masterInfo ? masterInfo.cl : ''}</td>
            <td class="col-master">${masterInfo ? masterInfo.st : ''}</td>
            <td class="text-end fw-bold">${row.amount.toLocaleString()}</td>
            <td class="text-center small">${statusHtml}</td>
        `;
        tbody.appendChild(tr);
    });
}

/**
 * æŒ‡å®šè¡Œã¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦å¼·èª¿è¡¨ç¤ºã™ã‚‹é–¢æ•° (Ver 3.2 ä¿®æ­£ç‰ˆ)
 * ãƒ»èµ¤æ ã§å›²ã¿ã€3ç§’é–“å¼·èª¿ã™ã‚‹
 */
function jumpToRow(no) {
    const row = document.getElementById(`row-${no}`);
    if (row) {
        row.scrollIntoView({ behavior: 'smooth', block: 'center' });
        
        // ã‚¯ãƒ©ã‚¹ã‚’ä¸€æ—¦å‰Šé™¤ã—ã¦å¼·åˆ¶çš„ã«ãƒªãƒ•ãƒ­ãƒ¼ã•ã›ã¦ã‹ã‚‰è¿½åŠ ï¼ˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å†å®Ÿè¡Œç”¨ï¼‰
        row.classList.remove('highlight-row');
        void row.offsetWidth; // ãƒªãƒ•ãƒ­ãƒ¼å¼·åˆ¶
        row.classList.add('highlight-row');
        
        // 3ç§’å¾Œã«ã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤ (ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³çµ‚äº†å¾Œ)
        setTimeout(() => {
            row.classList.remove('highlight-row');
        }, 3000);
    } else {
        alert(`No.${no} ã®è¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`);
    }
}

/**
 * ãƒã‚¹ã‚¿æ¤œç´¢ãƒ­ã‚¸ãƒƒã‚¯ (æ–‡å­—åˆ—ã¨ã—ã¦å³å¯†æ¯”è¼ƒ)
 */
function findMaster(code, sub) {
    if (!code) return null;
    
    let found = null;
    let displayName = "";

    if (sub && sub !== "") {
        found = M_GENBA.find(m => m.c === code && m.s === sub);
        if (found) {
            displayName = (found.sn && found.sn.trim() !== "") ? found.sn : found.n;
        }
    } else {
        found = M_GENBA.find(m => m.c === code);
        if (found) {
            displayName = found.n;
        }
    }

    if (found) {
        return { ...found, displayName: displayName };
    }
    return null;
}

function renderSummaryTables() {
    const custMap = {};
    IMPORTED_DATA.forEach(row => {
        const key = row.custName || "(ä¸æ˜)";
        if (!custMap[key]) custMap[key] = { count: 0, amount: 0 };
        custMap[key].count++;
        custMap[key].amount += row.amount;
    });
    
    const custTbody = document.getElementById('custTableBody');
    custTbody.innerHTML = "";
    let custTotalAmt = 0;
    
    Object.keys(custMap).sort().forEach(key => {
        const d = custMap[key];
        custTotalAmt += d.amount;
        custTbody.innerHTML += `<tr><td>${key}</td><td class="text-end">${d.count}</td><td class="text-end">${d.amount.toLocaleString()}</td></tr>`;
    });
    custTbody.innerHTML += `<tr class="total-row"><td>åˆè¨ˆ</td><td class="text-end">-</td><td class="text-end">${custTotalAmt.toLocaleString()}</td></tr>`;

    const jobMap = {};
    IMPORTED_DATA.forEach(row => {
        const key = row.jobCode + "_" + row.subCode;
        if (!jobMap[key]) {
            const m = findMaster(row.jobCode, row.subCode);
            jobMap[key] = {
                code: row.jobCode, sub: row.subCode,
                name: m ? (m.displayName||m.n) : "(ãƒã‚¹ã‚¿ãªã—)",
                count: 0, amount: 0
            };
        }
        jobMap[key].count++;
        jobMap[key].amount += row.amount;
    });

    const jobTbody = document.getElementById('jobTableBody');
    jobTbody.innerHTML = "";
    let jobTotalAmt = 0;

    Object.values(jobMap).sort((a,b) => (a.code+a.sub).localeCompare(b.code+b.sub)).forEach(d => {
        jobTotalAmt += d.amount;
        jobTbody.innerHTML += `<tr><td>${d.code}</td><td>${d.sub}</td><td class="small text-truncate" style="max-width:250px;">${d.name}</td><td class="text-end">${d.count}</td><td class="text-end">${d.amount.toLocaleString()}</td></tr>`;
    });
    jobTbody.innerHTML += `<tr class="total-row"><td>åˆè¨ˆ</td><td></td><td></td><td class="text-end">-</td><td class="text-end">${jobTotalAmt.toLocaleString()}</td></tr>`;
}

/**
 * Excelå‡ºåŠ›æ©Ÿèƒ½
 */
function exportToExcel() {
    if (IMPORTED_DATA.length === 0) { alert("å‡ºåŠ›ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“"); return; }

    const wb = XLSX.utils.book_new();
    
    // --- 1. æ˜ç´°ã‚·ãƒ¼ãƒˆ ---
    const headers = ["No", "ãƒ•ã‚¡ã‚¤ãƒ«å", "å®Œäº†æ—¥", "å¾—æ„å…ˆå", "å·¥ç•ª", "ã‚µãƒ–", "ç¾å ´åç§°", "æ–½å·¥ä¸»", "æ‹…å½“è€…", "é‡‘é¡", "åˆ¤å®š"];
    const wsDetailData = [headers];

    IMPORTED_DATA.forEach((row, idx) => {
        const m = findMaster(row.jobCode, row.subCode);
        const genbaName = m ? (m.displayName || m.n) : "";
        const client = m ? m.cl : "";
        const staff = m ? m.st : "";
        
        let status = "OK";
        if (row.isDuplicate) status = `é‡è¤‡(No.${row.duplicateWith})`;
        else if (!m) status = "ãƒã‚¹ã‚¿ãªã—";

        const rowArr = [
            { v: row.no, t: 'n' },
            { v: row.fileName, t: 's' },
            { v: row.compDate, t: 's' },
            { v: row.custName, t: 's' },
            { v: row.jobCode, t: 's' },
            { v: row.subCode, t: 's' },
            { v: genbaName, t: 's' },
            { v: client, t: 's' },
            { v: staff, t: 's' },
            { v: row.amount, t: 'n' },
            { v: status, t: 's' }
        ];
        wsDetailData.push(rowArr);
    });

    const wsDetail = XLSX.utils.aoa_to_sheet(wsDetailData);
    XLSX.utils.book_append_sheet(wb, wsDetail, "æ˜ç´°ãƒªã‚¹ãƒˆ");

    // --- 2. å¾—æ„å…ˆé›†è¨ˆã‚·ãƒ¼ãƒˆ ---
    const custTable = document.getElementById('custTableBody');
    const custData = [["å¾—æ„å…ˆå", "ä»¶æ•°", "é‡‘é¡"]];
    custTable.querySelectorAll('tr').forEach(tr => {
        const tds = tr.querySelectorAll('td');
        if(tds.length === 3) {
            custData.push([
                tds[0].innerText,
                tds[1].innerText.replace(/,/g, ''),
                tds[2].innerText.replace(/,/g, '')
            ]);
        }
    });
    const wsCust = XLSX.utils.aoa_to_sheet(custData);
    XLSX.utils.book_append_sheet(wb, wsCust, "å¾—æ„å…ˆåˆ¥é›†è¨ˆ");

    // å‡ºåŠ›
    const d = new Date();
    const dateStr = d.getFullYear() + String(d.getMonth()+1).padStart(2,'0') + String(d.getDate()).padStart(2,'0');
    XLSX.writeFile(wb, `å£²ä¸Šãƒã‚§ãƒƒã‚¯çµæœ_${dateStr}.xlsx`);
}

function clearAllData() {
    if(!confirm("ã™ã¹ã¦ã®èª­è¾¼ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ")) return;
    IMPORTED_DATA = [];
    IMPORTED_HASHES.clear();
    document.getElementById('importLog').innerHTML = "";
    renderAll();
}

function filterTable() {
    const term = document.getElementById('searchInput').value.toLowerCase();
    const rows = document.querySelectorAll('#mainTableBody tr');
    rows.forEach(row => {
        const text = row.innerText.toLowerCase();
        row.style.display = text.includes(term) ? '' : 'none';
    });
}

function formatDate(yyyymmdd) {
    if (!yyyymmdd || yyyymmdd.length !== 8) return yyyymmdd;
    return `${yyyymmdd.substring(0,4)}/${yyyymmdd.substring(4,6)}/${yyyymmdd.substring(6,8)}`;
}

</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
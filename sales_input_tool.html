<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·¥äº‹åŸä¾¡ãƒ»å£²ä¸Šå…¥åŠ›ãƒ„ãƒ¼ãƒ« (Webç‰ˆ Ver 38.0)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f6f9; font-family: "Yu Gothic UI", sans-serif; font-size: 0.9rem; }
        .container-fluid { max-width: 1600px; padding: 15px; }
        .card { margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .card-header { background-color: #e9ecef; font-weight: bold; padding: 8px 15px; }
        
        .excel-grid input { border: 1px solid #ced4da; border-radius: 0; font-size: 0.9rem; padding: 4px; }
        .excel-grid th { background-color: #f8f9fa; font-size: 0.8rem; text-align: center; vertical-align: middle; border: 1px solid #dee2e6; padding: 5px; }
        .excel-grid td { padding: 0; border: 1px solid #dee2e6; }
        input[readonly] { background-color: #e9ecef; color: #495057; }
        
        .valid-input { background-color: #d4edda !important; border-color: #28a745 !important; }
        .invalid-input { background-color: #f8d7da !important; border-color: #dc3545 !important; }
        .manual-check-col { background-color: #fff3cd !important; }

        /* å®Œäº†æ¸ˆã¿ç¾å ´ã®å¼·èª¿è¡¨ç¤º */
        .completed-job { 
            background-color: #ffcccc !important; color: #d63384; font-weight: bold; border: 2px solid #dc3545 !important; 
        }
        /* æç•ªã‚ã‚Šã®å¼·èª¿è¡¨ç¤º */
        .has-branch {
            background-color: #e2e3e5 !important; color: #0d6efd; font-weight: bold;
        }

        #dropArea { border: 3px dashed #6c757d; border-radius: 10px; background-color: #f8f9fa; color: #6c757d; transition: all 0.3s; cursor: pointer; }
        #dropArea:hover, #dropArea.dragover { border-color: #0d6efd; background-color: #e9ecef; color: #0d6efd; }
        
        .template-card {
            cursor: pointer; transition: all 0.2s ease-in-out; border: 1px solid #dee2e6; background-color: #fff; position: relative; overflow: hidden;
        }
        .template-card:hover { transform: translateY(-3px); box-shadow: 0 4px 15px rgba(0,0,0,0.1) !important; border-color: #0d6efd; background-color: #f8f9fa; }
        .template-card:active { transform: translateY(1px); box-shadow: 0 2px 5px rgba(0,0,0,0.1) !important; }
        .template-label { font-weight: bold; font-size: 1.1rem; color: #0d6efd; }
        .template-sub { font-size: 0.8rem; color: #6c757d; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .template-delete { position: absolute; top: 5px; right: 8px; color: #dc3545; font-size: 1.2rem; line-height: 1; opacity: 0.3; transition: opacity 0.2s; z-index: 10; }
        .template-card:hover .template-delete { opacity: 1; }
        .template-delete:hover { transform: scale(1.2); cursor: pointer; }

        .preview-table th, .preview-table td { font-size: 0.8em; white-space: nowrap; padding: 4px 8px; }
        .preview-container { overflow: auto; max-height: 60vh; border: 1px solid #dee2e6; }
    </style>
</head>
<body>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0">å·¥äº‹åŸä¾¡ãƒ»å£²ä¸Šå…¥åŠ›ãƒ„ãƒ¼ãƒ« <small class="text-muted" style="font-size:0.6em;">Ver 38.0</small></h5>
        <div>
            <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#masterModal">âš™ï¸ ãƒã‚¹ã‚¿å–è¾¼</button>
            <button class="btn btn-sm btn-outline-primary ms-1" data-bs-toggle="modal" data-bs-target="#templateModal">ğŸ“‘ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</button>
        </div>
    </div>

    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼å…¥åŠ› -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <span>åŸºæœ¬æƒ…å ±å…¥åŠ›</span>
            <button class="btn btn-sm btn-outline-dark" onclick="saveCurrentAsTemplate()" style="font-size: 0.8em;">ğŸ’¾ ç¾åœ¨ã®å…¥åŠ›ã‚’ãƒ†ãƒ³ãƒ—ãƒ¬ä¿å­˜</button>
        </div>
        <div class="card-body py-2">
            <!-- 1æ®µç›®: å–å¼•åŒºåˆ†ãƒ»æ–¹æ³• -->
            <div class="row g-2 mb-2">
                <div class="col-md-5">
                    <label class="form-label mb-0">å–å¼•åŒºåˆ†</label>
                    <div class="border px-2 py-1 rounded bg-white">
                        <div class="form-check form-check-inline mb-0">
                            <input class="form-check-input" type="radio" name="transType" id="opt1" value="1">
                            <label class="form-check-label" for="opt1">1:é€šå¸¸</label>
                        </div>
                        <div class="form-check form-check-inline mb-0">
                            <input class="form-check-input" type="radio" name="transType" id="opt2" value="2">
                            <label class="form-check-label" for="opt2">2:å£²æ›</label>
                        </div>
                        <div class="form-check form-check-inline mb-0">
                            <input class="form-check-input" type="radio" name="transType" id="opt3" value="3">
                            <label class="form-check-label" for="opt3">3:ç¾é‡‘</label>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <label class="form-label mb-0">å–å¼•æ–¹æ³•</label>
                    <select class="form-select form-select-sm" id="combo6">
                        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                        <option value="1:ãªã—">1:ãªã—</option>
                        <option value="0:è‡ªå‹•" selected>0:è‡ªå‹•</option>
                        <option value="2:æ‰‹å…¥åŠ›">2:æ‰‹å…¥åŠ›</option>
                        <option value="3:æ˜ç´°">3:æ˜ç´°</option>
                    </select>
                </div>
            </div>

            <!-- 2æ®µç›®: å¾—æ„å…ˆãƒ»æ‹…å½“è€… -->
            <div class="row g-2 align-items-end mb-2">
                <div class="col-md-4">
                    <label class="form-label mb-0">å¾—æ„å…ˆå</label>
                    <div class="input-group input-group-sm">
                        <input type="text" class="form-control" id="combo2" list="custOptions" placeholder="å¾—æ„å…ˆå..." oninput="validateCustomer()">
                        <datalist id="custOptions"></datalist>
                        <span class="input-group-text bg-white" id="custStatus">â”</span>
                    </div>
                </div>
                <div class="col-md-2">
                    <input type="text" class="form-control form-control-sm" id="textBox3" readonly placeholder="å¾—æ„å…ˆCD">
                </div>
                <div class="col-md-3">
                    <label class="form-label mb-0">æ‹…å½“è€… (ã‚³ãƒ¼ãƒ‰å…¥åŠ›å¯)</label>
                    <div class="input-group input-group-sm">
                        <input type="text" class="form-control" id="combo3" list="staffOptions" placeholder="ã‚³ãƒ¼ãƒ‰ ã¾ãŸã¯ æ°å" oninput="validateStaff()">
                        <datalist id="staffOptions"></datalist>
                        <span class="input-group-text bg-white" id="staffStatus">â”</span>
                    </div>
                </div>
            </div>

            <!-- 3æ®µç›®: å•†å“ãƒ»åˆè¨ˆãƒ»æ“ä½œãƒœã‚¿ãƒ³ -->
            <div class="row g-2 mt-1 align-items-end">
                <!-- å•†å“å (å°‘ã—å¹…ã‚’ç‹­ã‚ã‚‹) -->
                <div class="col-md-3">
                    <label class="form-label mb-0">å•†å“å</label>
                    <div class="input-group input-group-sm">
                        <input type="text" class="form-control" id="combo5" list="prodOptions" value="å£²ä¸Š" oninput="validateProduct()">
                        <datalist id="prodOptions"></datalist>
                        <span class="input-group-text bg-white" id="prodStatus">â”</span>
                    </div>
                </div>
                <!-- å•†å“CD -->
                <div class="col-md-1">
                    <input type="text" class="form-control form-control-sm" id="textBox2" value="6" readonly placeholder="CD">
                </div>
                <!-- åˆè¨ˆé‡‘é¡ -->
                <div class="col-md-2">
                    <div class="input-group input-group-sm">
                        <span class="input-group-text bg-warning bg-opacity-25 fw-bold">åˆè¨ˆ</span>
                        <input type="text" class="form-control text-end fw-bold fs-5" id="textBox1" value="0" readonly style="color:#0d6efd;">
                    </div>
                </div>
                
                <!-- æ“ä½œãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ -->
                <div class="col-md-6 d-flex align-items-end gap-1">
                    <button class="btn btn-primary btn-sm flex-fill fw-bold" onclick="executeTransfer()">è»¢è¨˜å‡¦ç†</button>
                    <button class="btn btn-success btn-sm flex-fill fw-bold" onclick="exportTextFile()">ãƒ†ã‚­ã‚¹ãƒˆå‡ºåŠ›</button>
                    <button class="btn btn-outline-secondary btn-sm flex-fill" onclick="clearDetails()">æ˜ç´°ã‚¯ãƒªã‚¢</button>
                    <button class="btn btn-outline-danger btn-sm flex-fill" onclick="clearAll()">å…¨æ¶ˆå»</button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ˜ç´°å…¥åŠ› (Excelã‚³ãƒ”ãƒšå¯¾å¿œ) -->
    <div class="card">
        <div class="card-header d-flex justify-content-between py-1 bg-warning bg-opacity-10">
            <span>æ˜ç´°å…¥åŠ› <span class="badge bg-warning text-dark ms-2">Excelã‚³ãƒ”ãƒšå¯¾å¿œ</span></span>
            <span id="genbaStatus" class="master-status">ç¾å ´ãƒã‚¹ã‚¿: <span class="status-ng">æœªèª­è¾¼</span></span>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive" style="max-height: 50vh;">
                <table class="table table-bordered mb-0 excel-grid" id="gridTable">
                    <thead class="sticky-top">
                        <tr>
                            <th style="width: 40px;">No</th>
                            <th style="width: 80px;">å·¥ç•ª</th>
                            <th style="width: 60px;">ã‚µãƒ–</th>
                            <th style="width: 180px;" class="manual-check-col">æ‰‹å…¥åŠ›ç¾å ´å<br>(ç¢ºèªç”¨)</th>
                            <th style="width: 100px;">å®Œäº†æ—¥</th>
                            <th style="width: 100px;">é‡‘é¡<br>(ç¨è¾¼)</th>
                            <th style="width: 180px;">åç§° (è‡ªå‹•)</th>
                            <th style="width: 100px;">ç¾å ´æ‹…å½“è€… (è‡ªå‹•)</th>
                            <th style="width: 130px;">æ–½å·¥ä¸» (è‡ªå‹•)</th>
                            <th style="width: 60px;">æç•ªæœ‰ç„¡</th>
                            <th style="width: 40px;">-</th>
                        </tr>
                    </thead>
                    <tbody id="gridBody"></tbody>
                </table>
            </div>
            <div class="p-2 bg-light border-top">
                <button class="btn btn-secondary btn-sm" onclick="addGridRow()">ï¼‹ è¡Œã‚’è¿½åŠ </button>
            </div>
        </div>
    </div>
</div>

<!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-light">
                <h5 class="modal-title">è»¢è¨˜çµæœãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="small text-muted mb-2">â€»ä»¥ä¸‹ã®å†…å®¹ã§è»¢è¨˜ã•ã‚Œã¾ã—ãŸã€‚ãƒ•ã‚¡ã‚¤ãƒ«å‡ºåŠ›ã¯ãƒ¡ã‚¤ãƒ³ç”»é¢ã®ã€Œãƒ†ã‚­ã‚¹ãƒˆå‡ºåŠ›ã€ãƒœã‚¿ãƒ³ã§è¡Œã£ã¦ãã ã•ã„ã€‚</p>
                <div class="preview-container">
                    <table class="table table-sm table-bordered preview-table table-hover" id="previewTable"></table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>
</div>

<!-- ãƒã‚¹ã‚¿ãƒ¼ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="masterModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">ãƒã‚¹ã‚¿ãƒ¼ç®¡ç†</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <div id="dropArea" class="text-center py-4 mb-3">
                    <div class="h4">ğŸ“‚</div><div>ã“ã“ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ­ãƒƒãƒ—</div>
                    <div class="small mt-2 text-muted">â€»ç¾å ´ãƒ»å¾—æ„å…ˆãƒ»å•†å“ãƒ»æ‹…å½“ãƒ»ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå¯¾å¿œ</div>
                </div>
                <div class="border-top pt-3">
                    <p class="small fw-bold mb-2">ç¾åœ¨ã®ç™»éŒ²çŠ¶æ³ & ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰:</p>
                    <div class="d-flex justify-content-between align-items-center mb-1"><span class="small">ç¾å ´: <span id="st_genba">æœª</span></span><button class="btn btn-xs btn-outline-success" onclick="downloadMaster('genba')">ğŸ“¥ä¿å­˜</button></div>
                    <div class="d-flex justify-content-between align-items-center mb-1"><span class="small">å¾—æ„å…ˆ: <span id="st_cust">æœª</span></span><button class="btn btn-xs btn-outline-success" onclick="downloadMaster('cust')">ğŸ“¥ä¿å­˜</button></div>
                    <div class="d-flex justify-content-between align-items-center mb-1"><span class="small">å•†å“: <span id="st_prod">æœª</span></span><button class="btn btn-xs btn-outline-success" onclick="downloadMaster('prod')">ğŸ“¥ä¿å­˜</button></div>
                    <div class="d-flex justify-content-between align-items-center mb-1"><span class="small">æ‹…å½“: <span id="st_staff">æœª</span></span><button class="btn btn-xs btn-outline-success" onclick="downloadMaster('staff')">ğŸ“¥ä¿å­˜</button></div>
                    <div class="small mt-2">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ: <span id="st_temp">æ¨™æº–ã®ã¿</span></div>
                </div>
                <hr>
                <div class="d-grid mt-2"><button class="btn btn-outline-danger btn-sm" onclick="clearMasters()">å…¨ãƒ‡ãƒ¼ã‚¿æ¶ˆå»</button></div>
            </div>
        </div>
    </div>
</div>

<!-- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="templateModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠ</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <div class="card mb-3 bg-light border-0">
                    <div class="card-body py-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <h6 class="card-title small fw-bold mb-0">CSVã§ä¸€æ‹¬ç·¨é›†</h6>
                            <div class="d-flex gap-2">
                                <button class="btn btn-sm btn-outline-success" onclick="downloadTemplateCSV()">ğŸ“¥ CSVå‡ºåŠ›</button>
                                <input type="file" id="templateCsvInput" class="form-control form-control-sm" accept=".csv,.txt" style="width: auto;">
                                <button class="btn btn-sm btn-primary" onclick="importTemplateCSV()">ğŸ“¤ CSVå–è¾¼</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="templateList"></div>
                <div class="text-center mt-4 border-top pt-3"><button class="btn btn-sm btn-outline-secondary" onclick="resetDefaultTemplates()">æ¨™æº–ã«æˆ»ã™</button></div>
            </div>
        </div>
    </div>
</div>

<script>
/** ============================================================
 * 0. ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå®šç¾©
 * ============================================================ */
const LAYOUT_HEADER = [
    "ä¼ç¥¨æ—¥ä»˜", "ä¼ç¥¨â„–", "å‡¦ç†é€£ç•ª", "æ˜ç´°åŒºåˆ†", "è¡Œ", "å¾—æ„å…ˆã‚³ãƒ¼ãƒ‰", "å¾—æ„å…ˆåï¼‘", "å¾—æ„å…ˆåï¼’", "ç´å“å…ˆã‚³ãƒ¼ãƒ‰", "ç´å“å…ˆå",
    "æ‹…å½“è€…ã‚³ãƒ¼ãƒ‰", "æœªä½¿ç”¨", "æœªä½¿ç”¨", "è«‹æ±‚åŒºåˆ†", "å£²æ›åŒºåˆ†", "å–å¼•åŒºåˆ†", "å–å¼•åŒºåˆ†å±æ€§", "æœªä½¿ç”¨", "å•†å“ã‚³ãƒ¼ãƒ‰", "å•†å“å",
    "æœªä½¿ç”¨", "æœªä½¿ç”¨", "æœªä½¿ç”¨", "æ•°é‡", "æ•°é‡å˜ä½", "å˜ä¾¡", "é‡‘é¡", "åŸå˜ä¾¡", "åŸä¾¡é‡‘é¡", "æœªä½¿ç”¨",
    "ç²—åˆ©", "å˜ä¾¡æ›ç‡", "èª²ç¨åŒºåˆ†", "æœªä½¿ç”¨", "æ¶ˆè²»ç¨ç‡", "å†…æ¶ˆè²»ç¨ç­‰", "æœªä½¿ç”¨", "è¡Œæ‘˜è¦ã‚³ãƒ¼ãƒ‰", "è¡Œæ‘˜è¦ï¼‘", "è¡Œæ‘˜è¦ï¼’",
    "å‚™è€ƒã‚³ãƒ¼ãƒ‰", "å‚™è€ƒ", "å—æ³¨â„–", "å—æ³¨è¡Œ", "è¦‹ç©å‡¦ç†é€£ç•ª", "è¦‹ç©è¡Œ", "è‡ªå‹•ç”ŸæˆåŒºåˆ†", "æœªä½¿ç”¨", "ä¼ç¥¨æ¶ˆè²»ç¨è¨ˆç®—åŒºåˆ†", "æœªä½¿ç”¨",
    "ãƒ‡ãƒ¼ã‚¿ç™ºç”ŸåŒºåˆ†", "ç›¸æ‰‹å‡¦ç†é€£ç•ª", "æœªä½¿ç”¨", "æœªä½¿ç”¨", "æœªä½¿ç”¨", "æœªä½¿ç”¨", "æœªä½¿ç”¨", "æœªä½¿ç”¨", "æœªä½¿ç”¨", "æœªä½¿ç”¨",
    "æœªä½¿ç”¨", "æœªä½¿ç”¨", "æœªä½¿ç”¨", "æœªä½¿ç”¨", "æœªä½¿ç”¨", "æœªä½¿ç”¨", "æœªä½¿ç”¨", "æœªä½¿ç”¨", "æœªä½¿ç”¨", "æœªä½¿ç”¨",
    "æœªä½¿ç”¨", "æœªä½¿ç”¨", "æœªä½¿ç”¨", "æœªä½¿ç”¨", "æœªä½¿ç”¨", "æœªä½¿ç”¨", "æœªä½¿ç”¨", "æœªä½¿ç”¨", "æœªä½¿ç”¨", "æœªä½¿ç”¨",
    "æœªä½¿ç”¨", "æœªä½¿ç”¨", "æœªä½¿ç”¨", "æœªä½¿ç”¨", "æœªä½¿ç”¨", "æœªä½¿ç”¨", "æœªä½¿ç”¨", "æœªä½¿ç”¨", "æœªä½¿ç”¨", "æœªä½¿ç”¨",
    "æœªä½¿ç”¨", "æœªä½¿ç”¨", "æœªä½¿ç”¨", "æœªä½¿ç”¨", "æœªä½¿ç”¨", "æœªä½¿ç”¨", "ç¾å ´ãƒ¡ã‚¤ãƒ³ã‚³ãƒ¼ãƒ‰", "ç¾å ´ã‚µãƒ–ã‚³ãƒ¼ãƒ‰", "å®Œäº†æ—¥", "æœªä½¿ç”¨",
    "æœªä½¿ç”¨", "æœªä½¿ç”¨", "æœªä½¿ç”¨", "æœªä½¿ç”¨", "æœªä½¿ç”¨", "æœªä½¿ç”¨", "ãƒã‚§ãƒƒã‚¯ãƒãƒ¼ã‚¯åŒºåˆ†", "æœªä½¿ç”¨", "æœªä½¿ç”¨", "æœªä½¿ç”¨",
    "æœªä½¿ç”¨", "æœªä½¿ç”¨", "æœªä½¿ç”¨", "æœªä½¿ç”¨", "æœªä½¿ç”¨", "æœªä½¿ç”¨", "æœªä½¿ç”¨", "æœªä½¿ç”¨", "æœªä½¿ç”¨", "æœªä½¿ç”¨",
    "æœªä½¿ç”¨", "æœªä½¿ç”¨", "æœªä½¿ç”¨", "æœªä½¿ç”¨", "æœªä½¿ç”¨", "æ¶ˆè²»ç¨åˆ†é¡", "æœªä½¿ç”¨", "æœªä½¿ç”¨", "æœªä½¿ç”¨", "æœªä½¿ç”¨",
    "æœªä½¿ç”¨", "æœªä½¿ç”¨", "æœªä½¿ç”¨"
];
while(LAYOUT_HEADER.length < 136) LAYOUT_HEADER.push("æœªä½¿ç”¨");

let M_GENBA=[], M_CUST=[], M_PROD=[], M_STAFF=[], exportData=[], currentSeq=1;

const defaultTemplates = [
    { label: "æ±æ „ä½å®…", cust: "ãˆ±æ±æ „ä½å®…ã€€æ¾æˆ¸", prod: "å£²ä¸Š", staff: "", transType: "1", method: "0:è‡ªå‹•" },
    { label: "é£¯ç”°ç”£æ¥­", cust: "ãˆ±é£¯ç”°ç”£æ¥­ã€€æ¾æˆ¸", prod: "å£²ä¸Š", staff: "", transType: "1", method: "0:è‡ªå‹•" },
    { label: "OHDå…ˆè¡Œ", cust: "ãˆ±ï¼¯ï¼¨ï¼¤å…ˆè¡Œã€€æ¾æˆ¸", prod: "å£²ä¸Š", staff: "", transType: "1", method: "0:è‡ªå‹•" },
    { label: "ãƒˆãƒ¼ã‚¯ã‚¹", cust: "ãˆ±ï¾„ï½°ï½¸ï½½ï½ºï½°ï¾ï¾Ÿï¾šï½°ï½¼ï½®ï¾ã€€æ¾æˆ¸", prod: "å£²ä¸Š", staff: "", transType: "1", method: "0:è‡ªå‹•" }
];

document.addEventListener('DOMContentLoaded', () => {
    loadMastersFromStorage();
    renderTemplates();
    initGrid();
    validateProduct();
    setupDropArea();
    setupPasteHandler();
    setupStaffFormatter(); 
});

function initGrid() {
    const tbody = document.getElementById('gridBody');
    tbody.innerHTML = "";
    for(let i=0; i<10; i++) addGridRow();
    document.getElementById('textBox1').value = "0";
}

// æ—¥ä»˜æ­£è¦åŒ–
function normalizeDateStr(val) {
    if (!val) return "";
    let s = val.trim();
    if (/^\d{8}$/.test(s)) return s;
    if (/^\d{5}$/.test(s)) {
        const serial = parseInt(s);
        const date = new Date(1899, 11, 30 + serial);
        const y = date.getFullYear();
        const m = String(date.getMonth()+1).padStart(2,'0');
        const d = String(date.getDate()).padStart(2,'0');
        return `${y}${m}${d}`;
    }
    const eraMatch = s.match(/^([RTHS])(\d+)[.\/-](\d+)[.\/-](\d+)$/i);
    if (eraMatch) {
        let year = parseInt(eraMatch[2]);
        const era = eraMatch[1].toUpperCase();
        if (era === 'R') year += 2018; else if (era === 'H') year += 1988; else if (era === 'S') year += 1925; 
        const m = eraMatch[3].padStart(2, '0');
        const d = eraMatch[4].padStart(2, '0');
        return `${year}${m}${d}`;
    }
    const nums = s.match(/\d+/g);
    if (nums) {
        if (nums.length === 3) {
            let y = nums[0]; const m = nums[1].padStart(2, '0'); const d = nums[2].padStart(2, '0');
            if (y.length === 2) y = "20" + y;
            return `${y}${m}${d}`;
        }
        if (nums.length === 2) {
            const today = new Date(); const y = today.getFullYear();
            const m = nums[0].padStart(2, '0'); const d = nums[1].padStart(2, '0');
            return `${y}${m}${d}`;
        }
    }
    if (/^\d{4}$/.test(s)) {
        const today = new Date(); const y = today.getFullYear();
        return `${y}${s}`;
    }
    return s.replace(/[^\d]/g, '');
}

function findStaffByCode(inputCode) {
    if(!inputCode) return null;
    const inputVal = parseInt(inputCode);
    if(isNaN(inputVal)) return null; 
    let found = M_STAFF.find(m => m.c === inputCode);
    if(found) return found;
    found = M_STAFF.find(m => parseInt(m.c) === inputVal);
    return found;
}
function setupStaffFormatter() {
    const el = document.getElementById('combo3');
    el.addEventListener('change', function() {
        const val = this.value.trim();
        if (!val) return;
        let found = M_STAFF.find(m => m.c === val); 
        if (!found && !val.includes(":")) { found = findStaffByCode(val); }
        if (found) { this.value = `${found.c} : ${found.n}`; validateStaff(); }
    });
}

function setupPasteHandler() {
    document.getElementById('gridBody').addEventListener('paste', handlePaste);
}
function handlePaste(e) {
    if (e.target.tagName !== 'INPUT') return;
    e.preventDefault();
    const clipboardData = (e.clipboardData || window.clipboardData).getData('text');
    if (!clipboardData) return;
    const rows = clipboardData.split(/\r\n|\n|\r/).filter(row => row.trim() !== "");
    if (rows.length === 0) return;

    const targetInput = e.target;
    const targetRow = targetInput.closest('tr');
    const startRowIndex = Array.from(targetRow.parentNode.children).indexOf(targetRow);
    const inputsInRow = Array.from(targetRow.querySelectorAll('input:not([readonly])'));
    const startColIndex = inputsInRow.indexOf(targetInput);

    const tbody = document.getElementById('gridBody');
    rows.forEach((rowData, rIdx) => {
        const currentRowIndex = startRowIndex + rIdx;
        if (currentRowIndex >= tbody.children.length) addGridRow();
        const currentRow = tbody.children[currentRowIndex];
        const inputs = Array.from(currentRow.querySelectorAll('input:not([readonly])'));
        const cols = rowData.split('\t');
        cols.forEach((cellData, cIdx) => {
            const currentInputIndex = startColIndex + cIdx;
            if (currentInputIndex < inputs.length) {
                const input = inputs[currentInputIndex];
                let val = cellData.trim();
                if (input.classList.contains('date-col')) val = normalizeDateStr(val);
                if (input.classList.contains('amount-col')) val = val.replace(/,/g, '');
                input.value = val;
                input.dispatchEvent(new Event('change')); 
            }
        });
    });
}

function getTemplates() { const json = localStorage.getItem('USER_TEMPLATES'); return json ? JSON.parse(json) : defaultTemplates; }
function renderTemplates() {
    const list = document.getElementById('templateList');
    list.innerHTML = ""; list.className = "row g-3";
    const templates = getTemplates();
    templates.forEach((t, idx) => {
        const col = document.createElement('div'); col.className = 'col-6 col-md-4 col-lg-3';
        const card = document.createElement('div'); card.className = 'card h-100 template-card shadow-sm text-center p-3 d-flex flex-column justify-content-center';
        card.onclick = () => { applyTemplateData(t); };
        const delBtn = document.createElement('span'); delBtn.className = 'template-delete'; delBtn.innerHTML = 'Ã—';
        delBtn.onclick = (e) => { e.stopPropagation(); deleteTemplate(idx); };
        const label = document.createElement('div'); label.className = 'template-label mb-1'; label.innerText = t.label;
        const sub = document.createElement('div'); sub.className = 'template-sub'; sub.innerText = t.cust || '(æœªè¨­å®š)';
        card.appendChild(delBtn); card.appendChild(label); card.appendChild(sub);
        col.appendChild(card); list.appendChild(col);
    });
}
function downloadTemplateCSV() {
    const templates = getTemplates();
    let csvContent = '"ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå","å¾—æ„å…ˆå","å•†å“å","æ‹…å½“è€…","å–å¼•åŒºåˆ†","å–å¼•æ–¹æ³•"\r\n';
    templates.forEach(t => {
        const row = [ `"${t.label}"`, `"${t.cust||''}"`, `"${t.prod||''}"`, `"${t.staff||''}"`, `"${t.transType||'1'}"`, `"${t.method||'0:è‡ªå‹•'}"` ];
        csvContent += row.join(",") + "\r\n";
    });
    const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csvContent], { type: "text/csv;charset=utf-8" });
    const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = "ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¸€è¦§.csv"; link.click();
}
async function importTemplateCSV() {
    const fileIn = document.getElementById('templateCsvInput');
    if (!fileIn.files.length) { alert("ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚"); return; }
    try {
        const text = await readFileText(fileIn.files[0]);
        const lines = text.split(/\r\n|\n|\r/).filter(l => l.trim() !== "");
        const newTemplates = [];
        for (let i = 1; i < lines.length; i++) {
            const cols = lines[i].split(',').map(c => c.trim().replace(/^"|"$/g, ''));
            if (cols.length >= 2) newTemplates.push({ label: cols[0], cust: cols[1], prod: cols[2]||"å£²ä¸Š", staff: cols[3]||"", transType: cols[4]||"1", method: cols[5]||"0:è‡ªå‹•" });
        }
        if (newTemplates.length > 0) { localStorage.setItem('USER_TEMPLATES', JSON.stringify(newTemplates)); renderTemplates(); alert(`${newTemplates.length}ä»¶å–è¾¼`); }
        else { alert("ãƒ‡ãƒ¼ã‚¿ãªã—"); }
    } catch (e) { alert("ã‚¨ãƒ©ãƒ¼: " + e.message); }
}
function applyTemplateData(t) {
    document.getElementById('opt1').checked = true;
    if(t.transType) { const val = t.transType.substring(0,1); const r = document.querySelector(`input[name="transType"][value="${val}"]`); if(r) r.checked = true; }
    document.getElementById('combo2').value = t.cust || "";
    document.getElementById('combo5').value = t.prod || "å£²ä¸Š";
    document.getElementById('combo6').value = t.method || "0:è‡ªå‹•";
    let st = t.staff || "";
    if (st && M_STAFF.length > 0) {
        const codePart = st.split(':')[0].trim();
        let found = findStaffByCode(codePart); 
        if (found) { st = `${found.c} : ${found.n}`; }
    }
    document.getElementById('combo3').value = st;
    ['combo2','combo5','combo3'].forEach(id=>document.getElementById(id).dispatchEvent(new Event('input')));
    validateStaff();
    bootstrap.Modal.getInstance(document.getElementById('templateModal')).hide();
}
function saveCurrentAsTemplate() {
    const label = prompt("ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå:", "æ–°è¦"); if (!label) return;
    const newTemp = {
        label: label,
        cust: document.getElementById('combo2').value, prod: document.getElementById('combo5').value,
        staff: document.getElementById('combo3').value, method: document.getElementById('combo6').value,
        transType: document.querySelector('input[name="transType"]:checked')?.value || "1"
    };
    const ts = getTemplates(); ts.push(newTemp);
    localStorage.setItem('USER_TEMPLATES', JSON.stringify(ts)); renderTemplates();
}
function deleteTemplate(idx) {
    if(!confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
    const ts = getTemplates(); ts.splice(idx, 1);
    localStorage.setItem('USER_TEMPLATES', JSON.stringify(ts)); renderTemplates();
}
function resetDefaultTemplates() {
    if(!confirm("åˆæœŸåŒ–ã—ã¾ã™ã‹ï¼Ÿ")) return;
    localStorage.removeItem('USER_TEMPLATES'); renderTemplates();
}

function setupDropArea() {
    const area = document.getElementById('dropArea');
    ['dragenter','dragover','dragleave','drop'].forEach(e => area.addEventListener(e, prevent, false));
    function prevent(e){ e.preventDefault(); e.stopPropagation(); }
    ['dragenter','dragover'].forEach(e => area.addEventListener(e, ()=>area.classList.add('dragover'), false));
    ['dragleave','drop'].forEach(e => area.addEventListener(e, ()=>area.classList.remove('dragover'), false));
    area.addEventListener('drop', handleDrop, false);
}
async function handleDrop(e) {
    const files = e.dataTransfer.files; if(files.length===0) return;
    let count=0;
    try {
        for(let i=0; i<files.length; i++) {
            const f = files[i], n = f.name;
            if(n.includes("ç¾å ´")) { await processGenbaFile(f); count++; }
            else if(n.includes("å¾—æ„å…ˆ")) { await processCustFile(f); count++; }
            else if(n.includes("å•†å“")) { await processProdFile(f); count++; }
            else if(n.includes("æ‹…å½“")) { await processStaffFile(f); count++; }
            else if(n.includes("ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ")) { await processTemplateFile(f); count++; }
        }
        loadMastersFromStorage(); renderTemplates();
        alert(count > 0 ? `${count}ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚` : "å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");
    } catch(err) { alert("ã‚¨ãƒ©ãƒ¼: "+err.message); }
}
function readFileText(file) {
    return new Promise((res, rej) => {
        const r = new FileReader(); r.onload = e => res(e.target.result); r.onerror = e => rej(e); r.readAsText(file, "Shift-JIS");
    });
}
function parseTSV(text) {
    return text.split(/\r\n|\n|\r/).filter(l=>l.trim()).map(line => {
        return line.split('\t').map(c => { let s = c.trim(); if(s.startsWith('"') && s.endsWith('"')) s = s.substring(1, s.length-1); return s; });
    });
}
async function processGenbaFile(f) {
    const rows = parseTSV(await readFileText(f));
    // t: r[49](AXåˆ— ç¾å ´æ‹…å½“è€…)
    const data = rows.map(r => ({ c:r[0]||"", s:r[1]||"", n:r[2]||"", sn:r[5]||"", t:r[49]||"", h:r[47]||"", i:(r[1]&&r[1].trim()!=="")?"æœ‰":"", cd:r[45]||"" })).filter(d=>d.c);
    localStorage.setItem('MST_GENBA', JSON.stringify(data));
}
async function processCustFile(f) {
    const rows = parseTSV(await readFileText(f));
    const data = rows.map(r => ({ c:r[0], n:r[1], v:r[2]||"" })).filter(d=>d.c);
    localStorage.setItem('MST_CUST', JSON.stringify(data));
}
async function processProdFile(f) {
    const rows = parseTSV(await readFileText(f));
    const data = rows.map(r => ({ c:r[0], n:r[1] })).filter(d=>d.c);
    localStorage.setItem('MST_PROD', JSON.stringify(data));
}
async function processStaffFile(f) {
    const rows = parseTSV(await readFileText(f));
    const data = rows.map(r => ({ c:r[0], n:r[1] })).filter(d=>d.c);
    localStorage.setItem('MST_STAFF', JSON.stringify(data));
}
async function processTemplateFile(f) {
    const rows = parseTSV(await readFileText(f));
    const data = rows.map(r => ({ label: r[0], cust: r[1], prod: r[2], staff: r[3], transType: r[4]||"1", method: r[5]||"0:è‡ªå‹•" })).filter(d => d.label);
    localStorage.setItem('USER_TEMPLATES', JSON.stringify(data));
}
function loadMastersFromStorage() {
    const ld = (key, id, listId, mapFn) => {
        const s = localStorage.getItem(key);
        if(s) {
            const d = JSON.parse(s);
            document.getElementById(id).innerText = `OK (${d.length})`;
            document.getElementById(id).className = 'text-success fw-bold';
            if(listId) {
                const dl = document.getElementById(listId); dl.innerHTML="";
                d.forEach(v => { const op=document.createElement('option'); op.value=mapFn(v); dl.appendChild(op); });
            }
            return d;
        }
        return [];
    };
    M_GENBA = ld('MST_GENBA', 'st_genba', null, null);
    document.getElementById('genbaStatus').innerHTML = `ç¾å ´ãƒã‚¹ã‚¿: ` + (M_GENBA.length?`<span class="status-ok">OK (${M_GENBA.length})</span>`:`<span class="status-ng">æœªèª­è¾¼</span>`);
    M_CUST = ld('MST_CUST', 'st_cust', 'custOptions', m=>m.n);
    M_PROD = ld('MST_PROD', 'st_prod', 'prodOptions', m=>m.n);
    M_STAFF = ld('MST_STAFF', 'st_staff', 'staffOptions', m=>`${m.c} : ${m.n}`);
    const t = localStorage.getItem('USER_TEMPLATES');
    document.getElementById('st_temp').innerText = t ? `ã‚«ã‚¹ã‚¿ãƒ  (${JSON.parse(t).length}ä»¶)` : "æ¨™æº–ã®ã¿";
}
function clearMasters() { if(confirm("å…¨æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ")){ localStorage.clear(); location.reload(); } }

/* --- â˜…â˜…â˜… æ–°ãƒ»ã‚¯ãƒªã‚¢æ©Ÿèƒ½ â˜…â˜…â˜… --- */
function clearDetails() {
    if(!confirm("æ˜ç´°ã®ã¿ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ")) return;
    initGrid();
    // ãƒ˜ãƒƒãƒ€ãƒ¼ç³»ã¯ç¶­æŒ
}
function clearAll() {
    if(!confirm("ã™ã¹ã¦æ¶ˆå»ã—ã¦åˆæœŸçŠ¶æ…‹ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ")) return;
    initGrid();
    // ãƒ˜ãƒƒãƒ€ãƒ¼åˆæœŸåŒ–
    document.getElementById('opt1').checked = true;
    document.getElementById('combo6').value = "0:è‡ªå‹•";
    document.getElementById('combo2').value = "";
    document.getElementById('textBox3').value = "";
    document.getElementById('combo3').value = "";
    document.getElementById('combo5').value = "å£²ä¸Š"; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
    document.getElementById('textBox2').value = "6";   // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒªã‚»ãƒƒãƒˆ
    validateCustomer(); validateStaff(); validateProduct();
}

function setStatus(iid, sid, ok) {
    const inp = document.getElementById(iid), st = document.getElementById(sid);
    if(ok){ inp.classList.remove('invalid-input'); inp.classList.add('valid-input'); st.textContent="OK"; st.className="input-group-text text-success fw-bold"; }
    else { inp.classList.remove('valid-input'); inp.classList.add('invalid-input'); st.textContent="NG"; st.className="input-group-text text-danger fw-bold"; }
}
function validateCustomer() {
    const val = document.getElementById('combo2').value;
    const found = M_CUST.find(m => m.n === val);
    document.getElementById('textBox3').value = found ? found.c : "";
    setStatus('combo2', 'custStatus', !!found);
}
function validateStaff() {
    const val = document.getElementById('combo3').value;
    let found = false;
    if(val) { found = M_STAFF.some(m => `${m.c} : ${m.n}` === val || m.n === val || m.c === val || parseInt(m.c) == parseInt(val)); }
    setStatus('combo3', 'staffStatus', found);
}
function validateProduct() {
    const val = document.getElementById('combo5').value;
    const found = M_PROD.find(m => m.n === val);
    document.getElementById('textBox2').value = found ? found.c : (val==="å£²ä¸Š"&&M_PROD.length===0 ? "6" : "");
    if(found || (val==="å£²ä¸Š"&&M_PROD.length===0)) {
        document.getElementById('combo5').classList.remove('invalid-input');
        document.getElementById('prodStatus').textContent = found ? "OK" : "âš ï¸";
    } else {
        setStatus('combo5', 'prodStatus', false);
    }
}

function addGridRow() {
    const tbody = document.getElementById('gridBody');
    const tr = document.createElement('tr');
    tr.innerHTML = `
        <td class="text-center bg-light p-1">${tbody.children.length + 1}</td>
        <td><input type="text" class="form-control form-control-sm job-code"></td>
        <td><input type="text" class="form-control form-control-sm sub-code"></td>
        <td><input type="text" class="form-control form-control-sm manual-genba-name manual-check-col"></td>
        <td><input type="text" class="form-control form-control-sm date-col" placeholder="yyyymmdd" inputmode="numeric"></td>
        <td><input type="number" class="form-control form-control-sm amount-col"></td>
        <td><input type="text" class="form-control form-control-sm genba-name" readonly tabindex="-1"></td>
        <!-- å·¥ç¨® -> ç¾å ´æ‹…å½“è€… -->
        <td><input type="text" class="form-control form-control-sm genba-type" readonly tabindex="-1"></td>
        <td><input type="text" class="form-control form-control-sm h-col" readonly tabindex="-1"></td>
        <td><input type="text" class="form-control form-control-sm i-col" readonly tabindex="-1"></td>
        <td class="text-center"><button class="btn btn-xs btn-outline-danger py-0" onclick="this.closest('tr').remove()">Ã—</button></td>
    `;
    tbody.appendChild(tr);

    const jobIn = tr.querySelector('.job-code'), subIn = tr.querySelector('.sub-code'), amtIn = tr.querySelector('.amount-col'), dateIn = tr.querySelector('.date-col');
    const searchHandler = () => {
        const job = jobIn.value.trim(), sub = subIn.value.trim();
        tr.querySelector('.genba-name').value = "";
        tr.querySelector('.genba-type').value = "";
        tr.querySelector('.h-col').value = "";
        tr.querySelector('.i-col').value = "";
        // å®Œäº†æ—¥ã‚¯ãƒªã‚¢ã¯ã—ãªã„ï¼ˆæ‰‹å…¥åŠ›ã®å¯èƒ½æ€§ã‚‚ã‚ã‚‹ãŸã‚ï¼‰
        jobIn.classList.remove('valid-input', 'invalid-input');
        dateIn.classList.remove('completed-job'); 
        dateIn.title = "";
        
        if(!job) return;
        let found = null;
        if (sub !== "") {
            found = M_GENBA.find(m => m.c === job && m.s === sub);
            if (!found) { jobIn.classList.add('invalid-input'); return; }
            tr.querySelector('.genba-name').value = (found.sn && found.sn.trim()) ? found.sn : found.n;
        } else {
            found = M_GENBA.find(m => m.c === job);
            if (!found) { jobIn.classList.add('invalid-input'); return; }
            tr.querySelector('.genba-name').value = found.n;
        }
        jobIn.classList.add('valid-input');
        tr.querySelector('.genba-type').value = found.t; 
        tr.querySelector('.h-col').value = found.h;
        
        // â˜…â˜…â˜… å®Œäº†æ—¥ãƒã‚§ãƒƒã‚¯ (Ver 38.0: 0ã‚„0000ã¯ç„¡è¦–) â˜…â˜…â˜…
        const compDate = found.cd ? normalizeDateStr(found.cd) : "";
        if(compDate !== "" && compDate !== "0" && compDate !== "00000000") {
            dateIn.value = compDate;
            dateIn.classList.add('completed-job');
            dateIn.title = "ã“ã®å·¥ç•ªã¯å®Œäº†ã—ã¦ã„ã¾ã™";
        }

        const hasSub = M_GENBA.some(m => m.c === job && m.s !== "");
        tr.querySelector('.i-col').value = hasSub ? "æœ‰" : "";
    };
    jobIn.addEventListener('change', searchHandler);
    subIn.addEventListener('change', searchHandler);
    
    dateIn.addEventListener('change', function() { this.value = normalizeDateStr(this.value); });
    amtIn.addEventListener('change', () => {
        let sum = 0; document.querySelectorAll('.amount-col').forEach(i => sum += (parseInt(i.value)||0));
        document.getElementById('textBox1').value = sum.toLocaleString();
    });
}

function executeTransfer() {
    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³: ãƒ˜ãƒƒãƒ€ãƒ¼
    const opt = document.querySelector('input[name="transType"]:checked');
    if (!opt) { alert("å–å¼•åŒºåˆ†ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“"); return; }
    const combo6 = document.getElementById('combo6').value;
    if (!combo6) { alert("å–å¼•æ–¹æ³•ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“"); return; }
    const custName = document.getElementById('combo2').value;
    const custCode = document.getElementById('textBox3').value;
    if(!custName || !custCode) { alert("å¾—æ„å…ˆãŒé¸æŠã•ã‚Œã¦ã„ãªã„ã‹ã€ãƒã‚¹ã‚¿ã«å­˜åœ¨ã—ã¾ã›ã‚“"); return; }
    const prodName = document.getElementById('combo5').value;
    const prodCode = document.getElementById('textBox2').value;
    if(!prodName || !prodCode) { alert("å•†å“ãŒé¸æŠã•ã‚Œã¦ã„ãªã„ã‹ã€ãƒã‚¹ã‚¿ã«å­˜åœ¨ã—ã¾ã›ã‚“"); return; }

    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³: æ˜ç´°è¡Œ
    const rows = document.querySelectorAll('#gridBody tr');
    let validRows = [];
    let hasError = false;
    
    for (let tr of rows) {
        const job = tr.querySelector('.job-code').value.trim();
        const dateVal = tr.querySelector('.date-col').value;
        const amtVal = tr.querySelector('.amount-col').value;
        
        // ä½•ã‹ã—ã‚‰å…¥åŠ›ãŒã‚ã‚‹è¡Œã‚’å¯¾è±¡ã«ã™ã‚‹
        if(job !== "" || dateVal !== "" || amtVal !== "") {
            if(job === "") { alert("å·¥ç•ªãŒæœªå…¥åŠ›ã®è¡ŒãŒã‚ã‚Šã¾ã™"); hasError = true; break; }
            if(!dateVal) { alert("å®Œäº†æ—¥ãŒæœªå…¥åŠ›ã®è¡ŒãŒã‚ã‚Šã¾ã™"); hasError = true; break; }
            if(amtVal === "") { alert("é‡‘é¡ãŒæœªå…¥åŠ›ã®è¡ŒãŒã‚ã‚Šã¾ã™"); hasError = true; break; }
            // ã‚¨ãƒ©ãƒ¼ãªã‘ã‚Œã°æœ‰åŠ¹è¡Œã¨ã—ã¦è¿½åŠ 
            validRows.push(tr);
        }
    }
    
    if(hasError) return;
    if(validRows.length === 0) { alert("è»¢è¨˜ã™ã‚‹æ˜ç´°ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“"); return; }

    // è»¢è¨˜å®Ÿè¡Œ
    const custData = M_CUST.find(c => c.c === custCode);
    const hColVal = custData ? custData.v : "";
    let nVal = 0, oVal = 0;
    if (opt.value === "2") nVal = 1; else if (opt.value === "3") oVal = 1;
    let combo6Val = -1;
    if(combo6.indexOf(":")>-1) combo6Val = parseInt(combo6.split(":")[0]);
    
    let staffText = document.getElementById('combo3').value;
    let staffCode = (staffText.indexOf(":") > -1) ? staffText.split(":")[0].trim() : staffText;

    exportData = []; 

    validRows.forEach(tr => {
        const dateStr = tr.querySelector('.date-col').value; 
        const amount = parseInt(tr.querySelector('.amount-col').value);
        const job = tr.querySelector('.job-code').value;     
        const sub = tr.querySelector('.sub-code').value;     
        const taxEx = Math.round(amount / 1.1);
        const tax = amount - taxEx;

        let row = new Array(136).fill(""); 
        row[0] = dateStr; row[2] = currentSeq; row[3] = "0"; row[4] = "1";
        row[5] = String(custCode); row[6] = custName; row[7] = String(hColVal); row[10] = String(staffCode);
        row[13] = nVal; row[14] = oVal; row[15] = "1"; row[16] = "1";
        row[18] = String(prodCode); row[19] = prodName; row[23] = "0"; row[25] = "0";
        row[26] = amount; row[27] = "0"; row[28] = "0"; row[30] = taxEx;
        row[31] = "0"; row[32] = "1"; row[34] = "10"; row[35] = tax;
        row[37] = "0"; row[40] = "0"; row[42] = "0"; row[43] = "0";
        row[44] = "0"; row[45] = "0"; row[46] = "0"; row[48] = combo6Val;
        row[50] = "0"; row[51] = "0";
        row[96] = String(job); row[97] = String(sub); row[98] = dateStr;
        row[106] = "0"; row[125] = "0";
        exportData.push(row);
        currentSeq++;
    });

    showPreviewTable();
    const modal = new bootstrap.Modal(document.getElementById('previewModal'));
    modal.show();
}

function showPreviewTable() {
    const table = document.getElementById('previewTable');
    table.innerHTML = "";
    const thead = document.createElement('thead');
    const trH = document.createElement('tr');
    LAYOUT_HEADER.forEach((h, i) => {
        const th = document.createElement('th');
        th.textContent = (h === "") ? `(${i+1})` : h; 
        trH.appendChild(th);
    });
    thead.appendChild(trH);
    table.appendChild(thead);
    const tbody = document.createElement('tbody');
    exportData.forEach(row => {
        const tr = document.createElement('tr');
        row.forEach(cell => {
            const td = document.createElement('td');
            td.textContent = cell;
            tr.appendChild(td);
        });
        tbody.appendChild(tr);
    });
    table.appendChild(tbody);
}

function exportTextFile() {
    if(exportData.length===0) { alert("ãƒ‡ãƒ¼ã‚¿ãªã—"); return; }
    
    const headerLine = LAYOUT_HEADER.map(cell => `"${cell}"`).join("\t") + "\r\n";
    let textContent = headerLine;

    exportData.forEach(row => {
        const line = row.map(cell => {
            let val = (cell === null || cell === undefined) ? "" : String(cell);
            val = val.replace(/"/g, '""'); return `"${val}"`;
        }).join("\t");
        textContent += line + "\r\n";
    });
    const blob = new Blob([strToUTF16LE(textContent)], { type: "text/plain;charset=UTF-16LE" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = `å–è¾¼ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ_${getNowStr()}.txt`;
    link.click();
}

// ãƒã‚¹ã‚¿ãƒ¼ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½
function downloadMaster(type) {
    let data = [], filename = "";
    if (type === 'genba') { data = M_GENBA; filename = "ç¾å ´ãƒã‚¹ã‚¿ãƒ¼.txt"; }
    else if (type === 'cust') { data = M_CUST; filename = "å¾—æ„å…ˆãƒã‚¹ã‚¿ãƒ¼.txt"; }
    else if (type === 'prod') { data = M_PROD; filename = "å•†å“ãƒã‚¹ã‚¿ãƒ¼.txt"; }
    else if (type === 'staff') { data = M_STAFF; filename = "æ‹…å½“è€…ãƒã‚¹ã‚¿ãƒ¼.txt"; }
    
    if (!data.length) { alert("ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“"); return; }

    let tsv = "";
    if (type === 'genba') {
        tsv = data.map(r => `${r.c}\t${r.s}\t${r.n}\t\t\t${r.sn}\t${r.t}\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t${r.cd}\t${r.h}\t\t${r.t}`).join("\r\n");
        // AXåˆ—ã¯50ç•ªç›®(index 49)ã€‚TSVæ§‹ç¯‰æ™‚ã«ã‚¿ãƒ–ã‚’èª¿æ•´ã—ã¦AXåˆ—ã«æ‹…å½“è€…ãŒæ¥ã‚‹ã‚ˆã†ã«ç°¡æ˜“å‡ºåŠ›
        // ãŸã ã—å³å¯†ãªå¾©å…ƒã¯å›°é›£ãªãŸã‚ã€ã“ã“ã§ã¯Webãƒ„ãƒ¼ãƒ«å†…ã§ã®å†å–è¾¼ç”¨ã¨ã—ã¦ã®å½¢å¼ã‚’å„ªå…ˆ
        // Webãƒ„ãƒ¼ãƒ«ã® processGenbaFile ã¯ r[49] ã‚’æ‹…å½“è€…(t)ã¨ã—ã¦èª­ã‚€ã€‚
        // ä¸Šè¨˜ã®ã‚¿ãƒ–æ•°ã¯é©å½“ãªã®ã§ã€é…åˆ—å½¢å¼ã§å‡ºåŠ›ã—ã¦ã‚¿ãƒ–çµåˆã™ã‚‹æ–¹ãŒç¢ºå®Ÿã€‚
        
        // ä¿®æ­£: ç¢ºå®Ÿã«AXåˆ—(49)ã«å€¤ã‚’å…¥ã‚Œã‚‹
        // A=0, B=1, C=2, F=5, AT=45, AV=47, AX=49
        tsv = data.map(r => {
            let cols = new Array(50).fill("");
            cols[0] = r.c; cols[1] = r.s; cols[2] = r.n; cols[5] = r.sn; 
            cols[45] = r.cd; // ATåˆ—(å®Œäº†æ—¥)
            cols[47] = r.h; cols[49] = r.t;
            return cols.join("\t");
        }).join("\r\n");

    } else if (type === 'cust') {
        tsv = data.map(r => `${r.c}\t${r.n}\t${r.v}`).join("\r\n");
    } else if (type === 'prod') {
        tsv = data.map(r => `${r.c}\t${r.n}`).join("\r\n");
    } else if (type === 'staff') {
        tsv = data.map(r => `${r.c}\t${r.n}`).join("\r\n");
    }

    const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), tsv], { type: "text/tab-separated-values;charset=utf-8" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = filename;
    link.click();
}

function strToUTF16LE(str) {
    const buffer = new ArrayBuffer(2 + (str.length * 2));
    const view = new DataView(buffer);
    view.setUint16(0, 0xFEFF, true); 
    for (let i = 0; i < str.length; i++) view.setUint16(2 + (i * 2), str.charCodeAt(i), true);
    return buffer;
}
function getNowStr() {
    const d = new Date();
    return d.getFullYear() + String(d.getMonth()+1).padStart(2,'0') + String(d.getDate()).padStart(2,'0') + "_" +
           String(d.getHours()).padStart(2,'0') + String(d.getMinutes()).padStart(2,'0') + String(d.getSeconds()).padStart(2,'0');
}
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
